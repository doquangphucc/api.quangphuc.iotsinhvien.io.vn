# HC Eco System - Nginx Configuration Guide
# This file contains configuration snippets for Nginx server
# Copy the relevant sections to your nginx.conf or site configuration file

# ============================================
# MAIN SERVER BLOCK CONFIGURATION
# ============================================

server {
    listen 80;
    listen [::]:80;
    server_name api.quangphuc.iotsinhvien.io.vn;

    # Force HTTPS (uncomment if SSL is configured)
    # return 301 https://$server_name$request_uri;
}

server {
    # listen 443 ssl http2;
    # listen [::]:443 ssl http2;
    listen 80;
    server_name api.quangphuc.iotsinhvien.io.vn;

    # SSL Configuration (uncomment and configure when ready)
    # ssl_certificate /path/to/ssl/certificate.crt;
    # ssl_certificate_key /path/to/ssl/private.key;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;

    # Root directory
    root /var/www/api.quangphuc.iotsinhvien.io.vn;
    index index.html index.htm;

    # Character encoding
    charset utf-8;

    # ============================================
    # REMOVE .html EXTENSION
    # ============================================

    # Try files without extension first
    location / {
        try_files $uri $uri.html $uri/ /html$uri /html$uri.html =404;
    }

    # Remove .html from URLs (301 redirect)
    if ($request_uri ~ ^/(.*)\.html(\?|$)) {
        return 301 /$1$2;
    }

    # Handle clean URLs - try html folder
    location ~ ^/([^/]+)$ {
        try_files $uri $uri.html /html/$1.html /html/$1 =404;
    }

    # ============================================
    # API CONFIGURATION
    # ============================================

    location /api/ {
        # PHP-FPM configuration
        try_files $uri $uri/ =404;
        
        # Increase client body size for API endpoints
        client_max_body_size 10M;
        
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.3-fpm.sock; # Adjust PHP version
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_index index.php;
            
            # Increase FastCGI buffers for large file uploads
            fastcgi_buffer_size 128k;
            fastcgi_buffers 4 256k;
            fastcgi_busy_buffers_size 256k;
            
            # Increase timeouts for file uploads
            fastcgi_read_timeout 300;
            fastcgi_connect_timeout 300;
            fastcgi_send_timeout 300;
            
            # Session configuration
            fastcgi_param PHP_VALUE "session.cookie_lifetime=86400
                                     session.cookie_httponly=1
                                     session.cookie_samesite=Lax
                                     upload_max_filesize=5M
                                     post_max_size=10M
                                     max_execution_time=300
                                     max_input_time=300";
        }
    }

    # ============================================
    # STATIC ASSETS
    # ============================================

    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* \.(css|js)$ {
        expires 1M;
        add_header Cache-Control "public, must-revalidate";
    }

    # ============================================
    # SECURITY HEADERS
    # ============================================

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ============================================
    # ERROR PAGES
    # ============================================

    error_page 404 /html/404.html;
    error_page 403 /html/403.html;
    error_page 500 502 503 504 /html/500.html;

    location = /html/404.html {
        internal;
    }

    # ============================================
    # DENY ACCESS TO SENSITIVE FILES
    # ============================================

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ \.(htaccess|htpasswd|ini|log|sh|sql|md|git)$ {
        deny all;
    }

    location ~* /(?:uploads|files)/.*\.php$ {
        deny all;
    }

    # ============================================
    # DISABLE DIRECTORY LISTING
    # ============================================

    autoindex off;

    # ============================================
    # GZIP COMPRESSION
    # ============================================

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # ============================================
    # CLIENT BODY SIZE
    # ============================================

    client_max_body_size 100M;

    # ============================================
    # LOGGING
    # ============================================

    access_log /var/log/nginx/hceco_access.log;
    error_log /var/log/nginx/hceco_error.log;
}

# ============================================
# INSTALLATION INSTRUCTIONS
# ============================================

# 1. Copy this configuration to your Nginx sites-available:
#    sudo nano /etc/nginx/sites-available/hcecosystem
#
# 2. Create symbolic link to sites-enabled:
#    sudo ln -s /etc/nginx/sites-available/hcecosystem /etc/nginx/sites-enabled/
#
# 3. Test Nginx configuration:
#    sudo nginx -t
#
# 4. Reload Nginx:
#    sudo systemctl reload nginx
#
# 5. Check Nginx status:
#    sudo systemctl status nginx
