<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch sử khảo sát - HC Eco System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/main.css" />
    <link rel="icon" type="image/jpeg" href="../assets/img/logo.jpg" />
    <style>
        /* Main page styling */
        .history-page { 
            padding: 4rem 0; 
            background: #f9fafb; 
            min-height: calc(100vh - 200px);
        }
        
        .history-container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 0 2rem;
        }
        
        .history-container h1 { 
            color: var(--color-green); 
            text-align: center; 
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }
        
        /* Survey Card */
        .survey-card { 
            background: white; 
            border-radius: 16px; 
            margin-bottom: 2rem; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .survey-card:hover {
            box-shadow: 0 12px 35px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        /* Survey Header */
        .survey-header { 
            background: #f3f4f6; 
            padding: 1.2rem 1.5rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
        }
        
        .survey-header-left {
            flex: 1;
        }
        
        .survey-date {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 0.3rem;
        }
        
        .survey-title {
            font-size: 1.1rem;
            color: #111827;
        }
        
        .survey-header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .survey-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--color-green);
        }
        
        .expand-icon {
            font-size: 1.2rem;
            color: #9ca3af;
            transition: transform 0.3s;
        }
        
        .survey-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        /* Survey Body */
        .survey-body { 
            padding: 1.5rem; 
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .survey-card.expanded .survey-body {
            max-height: 5000px;
        }
        
        .survey-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .meta-item {
            padding: 0.8rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .meta-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.3rem;
        }
        
        .meta-value {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }
        
        /* Results Table */
        .results-table {
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }
        
        .results-table h4 {
            color: #374151;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }
        
        .result-item {
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 3px solid var(--color-green);
        }
        
        .result-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.3rem;
        }
        
        .result-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #111827;
        }
        
        /* Empty State */
        .no-surveys { 
            text-align: center; 
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
        }
        
        .no-surveys-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .no-surveys p {
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        
        .btn-primary {
            display: inline-block;
            padding: 0.9rem 2rem;
            background: linear-gradient(135deg, var(--color-green), #1e5631);
            color: white;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(63, 163, 77, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(63, 163, 77, 0.4);
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1.2rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .survey-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
            }
            
            .survey-header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .results-grid,
            .survey-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <style>
    /* Table Styles */
    .survey-items-list table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .survey-items-list th,
    .survey-items-list td {
        padding: 0.8rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .survey-items-list th {
        background: #fafafa;
        font-weight: 600;
        color: #374151;
    }

    .survey-items-list tr:hover {
        background: #f9fafb;
    }
    </style>
</head>
<body>
    
<header class="topbar">
    <div class="container topbar-layout">
        <a href="../index.html" class="branding">
            <img class="logo-image" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
            <div class="brand-copy">
                <div class="logo">HC<span>ECO SYSTEM</span></div>
                <p>Giải pháp bền vững cho năng lượng tương lai</p>
            </div>
        </a>
        <div class="topbar-actions">
                <nav class="nav">
                    <div class="nav-item nav-item--dropdown">
                        <a href="pricing.html" class="nav-link">Bảng giá sản phẩm</a>
                        <div class="nav-dropdown" role="menu">
                            <a href="product-solar-panels.html">Tấm pin Jinko Solar</a>
                            <a href="product-luxpower-hybrid.html">Inverter LuxPower Hybrid</a>
                            <a href="product-luxpower-1pha.html">LuxPower Hybrid 1 Pha</a>
                            <a href="product-luxpower-3phase.html">LuxPower Hybrid 3 Pha</a>
                            <a href="product-luxpower-3phase-high.html">LuxPower 3 Pha Áp Cao</a>
                            <a href="product-growatt-110kw.html">Growatt MAX 110kW</a>
                            <a href="product-battery-storage.html">Pin lưu trữ A-Cornex</a>
                            <a href="product-battery-byd.html">Pin lưu trữ BYD</a>
                            <a href="product-electrical-cabinet.html">Tủ điện Hybrid</a>
                            <a href="product-cables.html">Phụ kiện &amp; Cáp</a>
                        </div>
                    </div>
                    <a href="index.html#solutions" class="nav-link">Giải pháp</a>
                    <a href="index.html#process" class="nav-link">Quy trình</a>
                    <a href="https://c-homebuild.com/" target="_blank" rel="noopener" class="nav-link">Xây dựng</a>
                    <a href="tin-tuc.html" class="nav-link">Tin tức</a>
                    <a href="#site-footer" class="nav-link">Liên hệ</a>
                </nav>
            <a class="cta" href="khao-sat-dien-mat-troi.html">Nhận tư vấn</a>
        </div>
    </div>
</header>
<div class="auth-floating" id="auth-floating">
    <div class="auth-buttons" id="auth-buttons"></div>
</div>

<aside class="quick-contact" aria-label="Liên hệ nhanh">
    <a class="contact-item contact-item--fanpage" href="https://www.facebook.com/hceco.io.vn" target="_blank" rel="noopener">
        <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
                <path d="M15.6 3H18V0h-2.6C11.8 0 10 2.1 10 5.2V8H7v3h3v9h3v-9h3l.5-3H13V5.4c0-1.2.4-2.4 2.6-2.4z" fill="currentColor" />
            </svg>
        </span>
        <span class="label">
            <strong>Fanpage</strong>
            <span>HC Eco System</span>
        </span>
    </a>
    <a class="contact-item contact-item--zalo" href="https://zalo.me/0988919868" target="_blank" rel="noopener">
        <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
                <path d="M18.5 3H5.5A2.5 2.5 0 003 5.5v9A2.5 2.5 0 005.5 17H9v2.8a1 1 0 001.6.8l4.3-3.6h3.6a2.5 2.5 0 002.5-2.5v-9A2.5 2.5 0 0018.5 3z" fill="currentColor" />
            </svg>
        </span>
        <span class="label">
            <strong>Zalo</strong>
            <span>0988 919 868</span>
        </span>
    </a>
    <a class="contact-item contact-item--tiktok" href="https://www.tiktok.com/@hc.channal" target="_blank" rel="noopener">
        <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
                <path d="M16.5 2h3a4.5 4.5 0 004.5 4.5v3a7.5 7.5 0 01-4.5-1.5V17a6.5 6.5 0 11-6.5-6.5v3a3.5 3.5 0 103.5 3.5V2z" fill="currentColor" />
            </svg>
        </span>
        <span class="label">
            <strong>TikTok</strong>
            <span>@hcecosystem</span>
        </span>
    </a>
    <a class="contact-item contact-item--youtube" href="https://www.youtube.com/@hcecosystem" target="_blank" rel="noopener">
        <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
                <path d="M21.8 8.2a2.5 2.5 0 00-1.8-1.8C18 6 12 6 12 6s-6 0-8 0.4A2.5 2.5 0 002.2 8.2 26.5 26.5 0 002 12a26.5 26.5 0 00.2 3.8 2.5 2.5 0 001.8 1.8C6 18 12 18 12 18s6 0 8-0.4a2.5 2.5 0 001.8-1.8c.2-1.2.2-2.6.2-3.8a26.5 26.5 0 00-.2-3.8zM10 15V9l5 3-5 3z" fill="currentColor" />
            </svg>
        </span>
        <span class="label">
            <strong>YouTube</strong>
            <span>@hcecosystem</span>
        </span>
    </a>
    <a class="contact-item contact-item--phone" href="tel:0988919868">
        <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
                <path d="M6.2 2A2.2 2.2 0 004 4.3c0 9.1 7.6 16.7 16.7 16.7A2.2 2.2 0 0023 18.8v-3.4a1.1 1.1 0 00-.9-1.1l-4.8-1a1.1 1.1 0 00-1 .4l-1.8 2.2a12.9 12.9 0 01-5.4-5.4l2.2-1.8a1.1 1.1 0 00.4-1l-1-4.8A1.1 1.1 0 009.2 2H6.2z" fill="currentColor" />
            </svg>
        </span>
        <span class="label">
            <strong>Hotline</strong>
            <span>0988 919 868</span>
        </span>
    </a>
    <a class="contact-item contact-item--maps" href="https://www.google.com/maps/search/?api=1&query=790+Ng%C3%B4+Quy%E1%BB%81n,+Ph%C6%B0%E1%BB%9Dng+An+H%E1%BA%A3i,+Th%C3%A0nh+Ph%E1%BB%91+%C4%90%C3%A0+N%E1%BA%B5ng" target="_blank" rel="noopener">
        <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
                <path d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z" fill="currentColor" />
        </span>
        <span class="label">
            <strong>Văn phòng</strong>
            <span>790 Ngô Quyền, Đà Nẵng</span>
        </span>
    </a>
</aside>

    <main class="history-page">
        <div class="history-container">
            <h1>📋 Lịch Sử Khảo Sát</h1>
            
            <div id="loading" class="loading">
                ⏳ Đang tải dữ liệu...
            </div>

            <div id="surveyList" style="display: none;">
                <!-- Surveys will be loaded here -->
            </div>

            <div id="emptyState" class="no-surveys" style="display: none;">
                <div class="no-surveys-icon">📭</div>
                <p>Bạn chưa có khảo sát nào</p>
                <a href="khao-sat-dien-mat-troi.html" class="btn-primary">Tạo khảo sát mới</a>
            </div>
        </div>
    </main>

    <footer id="site-footer" class="footer">
    <div class="container footer-layout">
        <div class="footer-left">
            <a href="../index.html" class="footer-branding">
                <img class="footer-logo" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
                <div class="footer-brand-copy">
                    <div class="footer-brand-name">HC<span>ECO SYSTEM</span></div>
                    <p>Giải pháp bền vững cho năng lượng tương lai</p>
                </div>
            </a>
            <p class="copyright">&copy; 2024 HC Eco System. Giữ vững cam kết năng lượng sạch cho mỗi nhà.</p>
        </div>
        <div class="footer-center">
            <h4>Thông tin liên hệ</h4>
            <ul class="contact-info">
                <li><strong>Hotline:</strong> 0988 919 868</li>
                <li><strong>Zalo:</strong> 0988 919 868</li>
                <li><strong>Email:</strong> hcecosystem@gmail.com</li>
                <li><strong>Website:</strong> hcecosystem.vn</li>
                <li><strong>Mã số thuế:</strong> 0123456789</li>
                <li><strong>Địa chỉ Văn phòng:</strong><br>790 Ngô Quyền, Phường An Hải, Thành Phố Đà Nẵng</li>
            </ul>
        </div>
        <div class="footer-right">
            <h4>Chính sách &amp; Dịch vụ</h4>
            <ul class="policy-links">
                    <li><a href="tam-nhin-su-menh.html">Tầm Nhìn &amp; Sứ Mệnh</a></li>
                    <li><a href="dieu-khoan-dieu-kien.html">Điều Khoản &amp; Điều Kiện</a></li>
                    <li><a href="chinh-sach-doi-tra.html">Chính Sách Đổi Trả</a></li>
                    <li><a href="chinh-sach-bao-mat-thong-tin-ca-nhan.html">Chính Sách Bảo Mật Thông Tin Cá Nhân</a></li>
                    <li><a href="chinh-sach-bao-mat-thong-tin-thanh-toan.html">Chính Sách Bảo Mật Thông Tin Thanh Toán</a></li>
                    <li><a href="chinh-sach-bao-hanh.html">Chính Sách Bảo Hành</a></li>
                    <li><a href="tro-thanh-nha-phan-phoi.html">Trở Thành Nhà Phân Phối</a></li>
                </ul>
        </div>
    </div>
</footer>

    <!-- Floating Action Button for Cart -->
<a href="gio-hang.html" class="cart-fab" id="cart-fab">
    🛒
    <span class="fab-badge" id="fab-cart-count" style="display: none;">0</span>
</a>

<script src="../assets/js/shopping-cart.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
        // Format giá tiền
        function formatPrice(price) {
            if (!price) return '0đ';
            // Chuyển sang số nguyên để bỏ phần thập phân .00
            const intPrice = Math.round(parseFloat(price));
            return intPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + 'đ';
        }

        // Format ngày tháng
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Tên region
        function getRegionName(region) {
            const names = {
                'mien-bac': 'Miền Bắc',
                'mien-trung': 'Miền Trung',
                'mien-nam': 'Miền Nam'
            };
            return names[region] || region;
        }

        // Load lịch sử khảo sát
        async function loadSurveyHistory() {
            // Check authentication
            const currentUser = window.authUtils.getUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            const loadingEl = document.getElementById('loading');
            const emptyStateEl = document.getElementById('emptyState');
            
            try {
                // API sử dụng session để xác định user, không cần truyền user_id
                console.log('🔄 Fetching survey history...');
                const response = await fetch('../api/get_survey_history.php');
                
                console.log('📡 Response status:', response.status);
                const data = await response.json();
                console.log('📦 API Response:', data);

                loadingEl.style.display = 'none';

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Không thể tải lịch sử khảo sát.');
                }

                if (!data.surveys || !Array.isArray(data.surveys) || data.surveys.length === 0) {
                    console.log('📭 No surveys found');
                    emptyStateEl.style.display = 'block';
                } else {
                    console.log(`✅ Found ${data.surveys.length} surveys`);
                    displaySurveys(data.surveys);
                }
            } catch (error) {
                console.error('❌ Error loading history:', error);
                loadingEl.style.display = 'none';
                loadingEl.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ Lỗi: ${error.message}</p>`;
                loadingEl.style.display = 'block';
            }
        }

        // Parse billBreakdown nếu là string
        function parseBillBreakdown(billBreakdown) {
            console.log('=== parseBillBreakdown called ===');
            console.log('Input:', billBreakdown);
            console.log('Type:', typeof billBreakdown);
            
            if (!billBreakdown) {
                console.log('billBreakdown is null/undefined');
                return null;
            }
            
            if (typeof billBreakdown === 'string') {
                try {
                    const parsed = JSON.parse(billBreakdown);
                    console.log('✅ Parsed successfully:', parsed);
                    return parsed;
                } catch (e) {
                    console.error('❌ Error parsing billBreakdown:', e);
                    console.error('Original string:', billBreakdown);
                    return null;
                }
            }
            
            if (Array.isArray(billBreakdown)) {
                console.log('✅ billBreakdown is already an array:', billBreakdown);
                return billBreakdown;
            }
            
            console.warn('⚠️ billBreakdown is object (not array):', billBreakdown);
            return billBreakdown;
        }

        // Hiển thị danh sách khảo sát
        function displaySurveys(surveys) {
            const listEl = document.getElementById('surveyList');
            listEl.style.display = 'block';

            listEl.innerHTML = surveys.map((survey, index) => {
                console.log('\n=== Survey #' + index + ' ===' );
                console.log('Survey ID:', survey.id);
                console.log('Has results:', !!survey.results);
                
                // Parse billBreakdown if needed
                if (survey.results) {
                    console.log('Results object:', survey.results);
                    console.log('billBreakdown raw:', survey.results.billBreakdown);
                    
                    if (survey.results.billBreakdown) {
                        survey.results.billBreakdown = parseBillBreakdown(survey.results.billBreakdown);
                        console.log('✅ Final billBreakdown:', survey.results.billBreakdown);
                        
                        if (Array.isArray(survey.results.billBreakdown)) {
                            console.log('Array length:', survey.results.billBreakdown.length);
                            survey.results.billBreakdown.forEach((tier, i) => {
                                console.log(`Tier ${i}:`, tier);
                            });
                        }
                    } else {
                        console.log('❌ No billBreakdown data');
                    }
                }
                
                return `
                <div class="survey-card ${index === 0 ? '' : ''}" data-index="${index}">
                    <div class="survey-header" onclick="toggleSurvey(${index})">
                        <div class="survey-header-left">
                            <div class="survey-date">📅 ${formatDate(survey.createdAt)}</div>
                            <div class="survey-title">Hệ thống ${survey.phase} pha - ${getRegionName(survey.region)} • Panel ${survey.solarPanelType}W</div>
                        </div>
                        <div class="survey-header-right">
                            ${survey.results ? `<div class="survey-price">${formatPrice(survey.results.totalCost)}</div>` : '<div style="color: #9ca3af;">Chưa có kết quả</div>'}
                            <div class="expand-icon">▼</div>
                        </div>
                    </div>
                    <div class="survey-body">
                        <div class="survey-meta">
                            <div class="meta-item">
                                <div class="meta-label">👤 Họ tên</div>
                                <div class="meta-value">${survey.fullName}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">📱 Số điện thoại</div>
                                <div class="meta-value">${survey.phone}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">💰 Hóa đơn điện tháng</div>
                                <div class="meta-value">${formatPrice(survey.monthlyBill)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">⚡ Loại điện</div>
                                <div class="meta-value">${survey.phase} pha</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">📍 Khu vực</div>
                                <div class="meta-value">${getRegionName(survey.region)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">🕐 Thời gian sử dụng</div>
                                <div class="meta-value">${survey.usageTime === 'day' ? 'Ban ngày' : survey.usageTime === 'night' ? 'Ban đêm' : 'Cân bằng'}</div>
                            </div>
                        </div>
                        ${survey.results ? `
                        <div class="results-table">
                            <!-- Hệ thống năng lượng mặt trời -->
                            <h4 style="color: var(--color-green); font-weight: 700; font-size: 1.2rem; margin: 1.5rem 0 1rem 0;">☀️ Hệ Thống Tấm Pin Năng Lượng Mặt Trời</h4>
                            <div class="results-grid">
                                <div class="result-item">
                                    <div class="result-label">⚡ Điện năng/tháng</div>
                                    <div class="result-value">${survey.results.monthlyKWh} kWh</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">☀️ Giờ nắng/ngày</div>
                                    <div class="result-value">${survey.results.sunHours} giờ</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">📍 Khu vực</div>
                                    <div class="result-value">${survey.results.regionName || getRegionName(survey.region)}</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">🔆 Tên tấm pin</div>
                                    <div class="result-value">${survey.results.panelName || 'N/A'}</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">⚡ Công suất tấm pin</div>
                                    <div class="result-value">${survey.results.panelPower || 0}W</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">🔆 Số lượng tấm pin</div>
                                    <div class="result-value">${survey.results.panelsNeeded} tấm</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">🔋 Tổng công suất hệ thống</div>
                                    <div class="result-value">${survey.results.totalCapacity || 0}kW</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">⚡ Năng lượng/tấm/ngày</div>
                                    <div class="result-value">${survey.results.energyPerPanelPerDay || 0} kWh</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">💵 Đơn giá tấm pin</div>
                                    <div class="result-value">${formatPrice(survey.results.panelPrice)}</div>
                                </div>
                                <div class="result-item" style="border-left-color: #10b981; border-left-width: 3px;">
                                    <div class="result-label">💰 Tổng chi phí tấm pin</div>
                                    <div class="result-value" style="color: #10b981; font-weight: 700;">${formatPrice(survey.results.panelCost)}</div>
                                </div>
                            </div>

                            <!-- Thiết bị điện -->
                            <h4 style="color: var(--color-green); font-weight: 700; font-size: 1.2rem; margin: 1.5rem 0 1rem 0;">🔌 Thiết Bị Điện</h4>
                            <div class="results-grid">
                                <div class="result-item">
                                    <div class="result-label">🔌 Biến tần</div>
                                    <div class="result-value">${survey.results.inverterName || 'N/A'}</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">⚡ Công suất biến tần</div>
                                    <div class="result-value">${survey.results.inverterCapacity || 0}kW</div>
                                </div>
                                <div class="result-item" style="border-left-color: #10b981; border-left-width: 3px;">
                                    <div class="result-label">💵 Giá biến tần</div>
                                    <div class="result-value" style="color: #10b981; font-weight: 700;">${formatPrice(survey.results.inverterPrice)}</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">📦 Tủ điện</div>
                                    <div class="result-value">${survey.results.cabinetName || 'N/A'}</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">⚡ Công suất tủ điện</div>
                                    <div class="result-value">${survey.results.cabinetCapacity || 0}kW</div>
                                </div>
                                <div class="result-item" style="border-left-color: #10b981; border-left-width: 3px;">
                                    <div class="result-label">💵 Giá tủ điện</div>
                                    <div class="result-value" style="color: #10b981; font-weight: 700;">${formatPrice(survey.results.cabinetPrice)}</div>
                                </div>
                            </div>

                            <!-- Pin lưu trữ -->
                            ${survey.results.batteryNeeded > 0 ? `
                            <h4 style="color: var(--color-green); font-weight: 700; font-size: 1.2rem; margin: 1.5rem 0 1rem 0;">🔋 Hệ Thống Pin Lưu Trữ</h4>
                            <div class="results-grid">
                                <div class="result-item">
                                    <div class="result-label">🔋 Dung lượng pin cần</div>
                                    <div class="result-value">${survey.results.batteryNeeded} kWh</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">🔋 Loại pin</div>
                                    <div class="result-value">${survey.results.batteryType === '8cell' ? 'BYD 8 Cell' : 'A-Cornex 16 Cell'}</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">📦 Tên pin</div>
                                    <div class="result-value">${survey.results.batteryName || 'N/A'}</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">⚡ Dung lượng/bộ</div>
                                    <div class="result-value">${survey.results.batteryCapacity || 0} kWh</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">📦 Số lượng pin</div>
                                    <div class="result-value">${survey.results.batteryQuantity || 0} bộ</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">💵 Đơn giá</div>
                                    <div class="result-value">${formatPrice(survey.results.batteryUnitPrice)}</div>
                                </div>
                                <div class="result-item" style="border-left-color: #10b981; border-left-width: 3px; grid-column: span 2;">
                                    <div class="result-label">💰 Tổng chi phí pin</div>
                                    <div class="result-value" style="color: #10b981; font-weight: 700;">${formatPrice(survey.results.batteryCost)}</div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- Phụ kiện chi tiết -->
                            <h4 style="color: var(--color-green); font-weight: 700; font-size: 1.2rem; margin: 1.5rem 0 1rem 0;">🔧 Phụ Kiện & Vật Tư</h4>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem; background: #fff; border-radius: 8px; overflow: hidden;">
                                <thead style="background: #f3f4f6;">
                                    <tr>
                                        <th style="padding: 0.8rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Tên phụ kiện</th>
                                        <th style="padding: 0.8rem; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Số lượng</th>
                                        <th style="padding: 0.8rem; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Đơn giá</th>
                                        <th style="padding: 0.8rem; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 0.8rem;">Bach Z</td>
                                        <td style="padding: 0.8rem; text-align: center;">${survey.results.bachZQty || 0}</td>
                                        <td style="padding: 0.8rem; text-align: right;">${formatPrice(survey.results.bachZPrice)}</td>
                                        <td style="padding: 0.8rem; text-align: right; font-weight: 600; color: #10b981;">${formatPrice(survey.results.bachZCost)}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 0.8rem;">Clip (Kẹp tấm pin)</td>
                                        <td style="padding: 0.8rem; text-align: center;">${survey.results.clipQty || 0}</td>
                                        <td style="padding: 0.8rem; text-align: right;">${formatPrice(survey.results.clipPrice)}</td>
                                        <td style="padding: 0.8rem; text-align: right; font-weight: 600; color: #10b981;">${formatPrice(survey.results.clipCost)}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 0.8rem;">Jack MC4 (Đầu nối)</td>
                                        <td style="padding: 0.8rem; text-align: center;">${survey.results.jackMC4Qty || 0}</td>
                                        <td style="padding: 0.8rem; text-align: right;">${formatPrice(survey.results.jackMC4Price)}</td>
                                        <td style="padding: 0.8rem; text-align: right; font-weight: 600; color: #10b981;">${formatPrice(survey.results.jackMC4Cost)}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 0.8rem;">Dây cáp DC</td>
                                        <td style="padding: 0.8rem; text-align: center;">${survey.results.dcCableLength || 0}m</td>
                                        <td style="padding: 0.8rem; text-align: right;">${formatPrice(survey.results.dcCablePrice)}/m</td>
                                        <td style="padding: 0.8rem; text-align: right; font-weight: 600; color: #10b981;">${formatPrice(survey.results.dcCableCost)}</td>
                                    </tr>
                                    <tr style="background: #f9fafb; font-weight: 700;">
                                        <td colspan="3" style="padding: 0.8rem; text-align: right;">Tổng phụ kiện:</td>
                                        <td style="padding: 0.8rem; text-align: right; color: var(--color-green); font-size: 1.1rem;">${formatPrice(survey.results.accessoriesCost)}</td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Phân tích hóa đơn điện -->
                            ${survey.results.billBreakdown && Array.isArray(survey.results.billBreakdown) && survey.results.billBreakdown.length > 0 ? `
                            <h4 style="color: var(--color-green); font-weight: 700; font-size: 1.2rem; margin: 1.5rem 0 1rem 0;">📊 Phân Tích Hóa Đơn Điện</h4>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem; background: #fff; border-radius: 8px; overflow: hidden;">
                                <thead style="background: #f3f4f6;">
                                    <tr>
                                        <th style="padding: 0.8rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Bậc thang</th>
                                        <th style="padding: 0.8rem; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Số kWh</th>
                                        <th style="padding: 0.8rem; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Đơn giá</th>
                                        <th style="padding: 0.8rem; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${survey.results.billBreakdown.map((tier, i) => `
                                        <tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 0.8rem;">${tier.label || `Bậc ${tier.tier || i + 1}`}</td>
                                            <td style="padding: 0.8rem; text-align: right;">${tier.kwhUsed || tier.kwh || 0} kWh</td>
                                            <td style="padding: 0.8rem; text-align: right;">${formatPrice(tier.price || 0)}/kWh</td>
                                            <td style="padding: 0.8rem; text-align: right; font-weight: 600; color: #10b981;">${formatPrice(tier.cost || tier.amount || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ` : ''}

                            <!-- Tổng chi phí -->
                            <h4 style="color: var(--color-green); font-weight: 700; font-size: 1.2rem; margin: 1.5rem 0 1rem 0;">💰 Tổng Chi Phí Dự Án</h4>
                            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--color-green);">
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="font-size: 1rem; color: #374151;">Tấm pin + Biến tần + Tủ điện:</div>
                                    <div style="font-size: 1rem; font-weight: 600; text-align: right;">${formatPrice((parseFloat(survey.results.panelCost) + parseFloat(survey.results.inverterPrice) + parseFloat(survey.results.cabinetPrice)))}</div>
                                    
                                    <div style="font-size: 1rem; color: #374151;">Pin lưu trữ:</div>
                                    <div style="font-size: 1rem; font-weight: 600; text-align: right;">${formatPrice(survey.results.batteryCost)}</div>
                                    
                                    <div style="font-size: 1rem; color: #374151;">Phụ kiện:</div>
                                    <div style="font-size: 1rem; font-weight: 600; text-align: right;">${formatPrice(survey.results.accessoriesCost)}</div>
                                    
                                    <div style="font-size: 1rem; color: #374151;">Công lắp đặt:</div>
                                    <div style="font-size: 1rem; font-weight: 600; text-align: right;">${formatPrice(survey.results.laborCost)}</div>
                                    
                                    ${survey.results.totalCostWithoutBattery ? `
                                    <div style="font-size: 1rem; color: #6b7280; font-style: italic; padding-top: 0.5rem; border-top: 1px dashed #d1d5db;">Tổng không bao gồm pin:</div>
                                    <div style="font-size: 1rem; font-weight: 600; text-align: right; color: #6b7280; font-style: italic; padding-top: 0.5rem; border-top: 1px dashed #d1d5db;">${formatPrice(survey.results.totalCostWithoutBattery)}</div>
                                    ` : ''}
                                    
                                    <div style="font-size: 1.3rem; font-weight: 800; color: var(--color-green); padding-top: 1rem; border-top: 2px solid var(--color-green);">TỔNG CỘNG:</div>
                                    <div style="font-size: 1.8rem; font-weight: 800; color: var(--color-green); text-align: right; padding-top: 1rem; border-top: 2px solid var(--color-green);">${formatPrice(survey.results.totalCost)}</div>
                                </div>
                            </div>
                        </div>
                        ` : '<p style="color: #9ca3af; text-align: center; padding: 2rem;">Khảo sát chưa có kết quả tính toán</p>'}
                    </div>
                </div>
            `;
            }).join('');
        }

        // Toggle mở/đóng chi tiết
        function toggleSurvey(index) {
            const card = document.querySelector(`.survey-card[data-index="${index}"]`);
            card.classList.toggle('expanded');
        }

        // Load dữ liệu khi trang load
        window.addEventListener('DOMContentLoaded', loadSurveyHistory);
    </script>
</body>
</html>
