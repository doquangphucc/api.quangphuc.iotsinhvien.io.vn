<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Khảo sát nhu cầu lắp đặt điện năng lượng mặt trời - HC Eco System" />
    <title>Khảo sát điện mặt trời - HC Eco System</title>
        
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter with Vietnamese subset -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="../assets/img/logo.jpg" />

    <!-- Slideshow CSS -->
    <link rel="stylesheet" href="../assets/css/slideshow.css" />
    
    <!-- Modern CSS Design -->
    <style>
        :root {
            --color-primary: #00C851;
            --color-secondary: #00E676;
            --color-accent: #69F0AE;
            --color-accent-light: #B9F6CA;
            --color-bg-light: #F1F8E9;
            --color-text-dark: #1B5E20;
            --color-text-light: #ffffff;
            --color-card-bg: #ffffff;
            --color-border: #C8E6C9;
            --color-shadow: rgba(0, 200, 81, 0.15);
            --color-shadow-strong: rgba(0, 200, 81, 0.25);
            --gradient-primary: linear-gradient(135deg, #00C851 0%, #00E676 50%, #69F0AE 100%);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #F1F8E9 100%);
            --gradient-bg: linear-gradient(135deg, #E8F5E8 0%, #F1F8E9 25%, #ffffff 50%, #F1F8E9 75%, #E8F5E8 100%);
            --gradient-hero: linear-gradient(135deg, rgba(0,200,81,0.1) 0%, rgba(105,240,174,0.1) 50%, rgba(185,246,202,0.1) 100%);
            --border-radius: 20px;
            --border-radius-sm: 12px;
            --border-radius-lg: 24px;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            position: relative;
            
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5e8 100%);
            color: var(--color-text-dark);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        /* Dark Mode styles */
        body[data-theme="dark"] {
            background-color: #12181B;
            color: var(--color-text-light);
        }
        body[data-theme="dark"] .dark\:bg-gray-900 { background-color: #1a202c; }
        body[data-theme="dark"] .dark\:bg-gray-800 { background-color: #2d3748; }
        body[data-theme="dark"] .dark\:text-gray-100 { color: #f7fafc; }
        body[data-theme="dark"] .dark\:text-gray-300 { color: #d1d5db; }
        body[data-theme="dark"] .dark\:border-gray-700 { border-color: #4a5568; }

        .theme-toggle__icon { display: none; }
        body:not([data-theme="dark"]) .theme-toggle__icon--sun { display: block; }
        body[data-theme="dark"] .theme-toggle__icon--moon { display: block; }

        /* Styles for dynamically injected auth buttons */
        .auth-btn {
            padding: 0.6rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            line-height: 1.25rem;
            text-decoration: none;
        }
        /* Login Button */
        .auth-btn--login {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
        }
        .auth-btn--login:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        /* Register button, also used for logout by auth.js */
        .auth-btn--register {
            background-color: #16a34a; /* green-600 */
            color: white;
        }
        .auth-btn--register:hover {
             background-color: #15803d; /* green-700 */
        }
        /* Logged-in state: username and logout button */
        .auth-user-name {
            font-weight: 600;
            font-size: 0.875rem; /* 14px - smaller font */
            padding: 0.5rem 0.75rem; /* Reduced padding */
            white-space: nowrap;
            text-decoration: none;
            max-width: 120px; /* Limit width */
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }
        /* Specifically target the logout button */
        .auth-user-name + .auth-btn--register { 
             background-color: #fee2e2; /* red-100 */
             color: #b91c1c; /* red-700 */
             font-size: 0.75rem; /* 12px - smaller font */
             padding: 0.5rem 0.75rem; /* Reduced padding */
             min-width: auto; /* Remove minimum width */
        }
         .auth-user-name + .auth-btn--register:hover {
             background-color: #fecaca; /* red-200 */
        }

        /* Dark mode styles for auth buttons */
        body[data-theme="dark"] .auth-btn--login {
            background-color: #374151; /* gray-700 */
            color: #f9fafb; /* gray-100 */
        }
        body[data-theme="dark"] .auth-btn--login:hover {
            background-color: #4b5563; /* gray-600 */
        }
        body[data-theme="dark"] .auth-user-name {
            color: #d1d5db; /* gray-300 */
        }
        body[data-theme="dark"] .auth-user-name + .auth-btn--register { /* Dark mode Logout button */
             background-color: #450a0a; /* red-900 */
             color: #fca5a5; /* red-400 */
        }
        body[data-theme="dark"] .auth-user-name + .auth-btn--register:hover {
             background-color: #7f1d1d; /* red-800 */
        }
        body {
            background: var(--gradient-bg);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Animated background with solar panels */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 15% 20%, rgba(0,200,81,0.08) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(105,240,174,0.06) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(185,246,202,0.04) 0%, transparent 60%),
                linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.05) 75%),
                linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.05) 75%);
            background-size: 800px 800px, 600px 600px, 1000px 1000px, 60px 60px, 60px 60px;
            animation: backgroundMove 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes backgroundMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-10px, -5px) rotate(0.5deg); }
            50% { transform: translate(5px, -10px) rotate(-0.5deg); }
            75% { transform: translate(-5px, 5px) rotate(0.3deg); }
        }
        
        /* Floating solar panel icons */
        body::after {
            content: '☀️';
            position: fixed;
            font-size: 2rem;
            color: rgba(255, 193, 7, 0.3);
            animation: float 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.6; }
        }
        .survey-container {
            max-width: 1400px;
            margin: var(--spacing-lg) auto;
            padding: 0 var(--spacing-lg);
            position: relative;
            z-index: 1;
        }
        
        /* Modern Form Layout */
        .survey-form-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .form-column {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: 0 20px 40px var(--color-shadow), 0 8px 16px rgba(0,0,0,0.05);
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
        }
        
        .form-column:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px var(--color-shadow), 0 12px 24px rgba(0,0,0,0.08);
        }
        
        /* Unified Results Layout */
        .results-wrapper {
            background: var(--gradient-card);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: 0 20px 40px var(--color-shadow), 0 8px 16px rgba(0,0,0,0.05);
            border: 1px solid var(--color-border);
            margin-bottom: var(--spacing-xl);
        }
        
        .results-grid {
            display: block;
            width: 100%;
        }
        
        .results-column {
            width: 100%;
        }
        
        .survey-card {
            background: transparent;
            padding: 0;
            box-shadow: none;
            margin-bottom: 0;
            border: none;
        }
        
        .survey-card {
            background: var(--gradient-hero);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 25px 50px var(--color-shadow-strong), 0 12px 24px rgba(0,0,0,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .survey-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(0,200,81,0.1), transparent, rgba(105,240,174,0.1), transparent);
            animation: rotate 10s linear infinite;
            z-index: -1;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .survey-card h2 {
            color: var(--color-text-dark);
            margin-bottom: 1.5rem;
            font-size: 2.5rem;
            font-weight: 900;
            text-align: center;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        .form-group {
            margin-bottom: 0.9rem;
        }
        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.6rem;
            color: var(--color-text-dark);
            font-size: 1rem;
            position: relative;
        }
        
        .form-group label::before {
            content: '';
            position: absolute;
            left: -1.2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: var(--gradient-primary);
            border-radius: 50%;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem 1.2rem;
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            font-weight: 500;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 6px var(--color-shadow), 0 8px 25px var(--color-shadow-strong);
            transform: translateY(-3px);
            background: rgba(255,255,255,1);
        }
        
        .form-group input:hover,
        .form-group select:hover {
            border-color: var(--color-secondary);
            transform: translateY(-1px);
        }

        .radio-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 1rem 1.2rem;
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            flex: 1;
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }
        
        .radio-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: -1;
        }
        
        .radio-option:hover {
            border-color: var(--color-primary);
            background: rgba(0,200,81,0.05);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--color-shadow-strong);
        }
        
        .radio-option:hover::before {
            left: 0;
            opacity: 0.1;
        }
        
        .radio-option.selected {
            border-color: var(--color-primary);
            background: rgba(0,200,81,0.1);
            box-shadow: 0 8px 25px var(--color-shadow-strong);
        }
        .radio-option input {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            accent-color: #3FA34D;
        }
        .radio-option span {
            font-weight: 600;
            color: #2d3748;
        }
        .btn-calculate {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 12px 30px var(--color-shadow-strong);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-calculate::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        .btn-calculate:hover::before {
            left: 100%;
        }
        .btn-calculate:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px var(--color-shadow-strong);
        }
        .btn-calculate:active {
            transform: translateY(-1px);
        }
        .results {
            display: none;
        }
        .results.show {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* Placeholder khi chưa có kết quả */
        .results-placeholder {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            border: 2px dashed #cbd5e0;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
        }
        .results.show + .results-placeholder {
            display: none;
        }
        .results-placeholder-icon {
            font-size: 4rem;
            opacity: 0.3;
        }
        .results-placeholder-text {
            color: #718096;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .results-placeholder-subtext {
            color: #a0aec0;
            font-size: 0.95rem;
        }
        
        /* Modern Table Design */
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 8px 25px var(--color-shadow), 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--color-border);
        }
        
        .excel-table thead {
            background: var(--gradient-primary);
            color: white;
        }
        
        .excel-table th {
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 700;
            font-size: 0.95rem;
            border-right: 1px solid rgba(255,255,255,0.2);
            letter-spacing: 0.5px;
        }
        
        .excel-table th:last-child {
            border-right: none;
        }
        
        .excel-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .excel-table td:last-child {
            border-right: none;
        }
        
        .excel-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .excel-table tbody tr:hover {
            background: rgba(0,200,81,0.08);
            transform: scale(1.02);
            box-shadow: 0 8px 25px var(--color-shadow);
        }
        .excel-table .label-col {
            font-weight: 600;
            color: #4a5568;
            width: 30%;
        }
        .excel-table .value-col {
            color: #2d3748;
        }
        .excel-table .price-col {
            font-weight: 700;
            color: var(--color-primary);
            text-align: right;
        }
        .excel-table .product-image-cell {
            width: 80px;
            text-align: center;
        }
        .excel-table .product-image-small {
            width: 70px;
            height: 70px;
            object-fit: contain;
            background: #f7fafc;
            border-radius: 8px;
            padding: 0.5rem;
        }
        .section-header {
            background: var(--gradient-hero);
            backdrop-filter: blur(20px);
            padding: 1.5rem 2rem;
            margin: 2rem 0 1.5rem 0;
            border-radius: var(--border-radius);
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 15px 35px var(--color-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .section-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 0 6px 6px 0;
        }
        
        .section-header h3 {
            color: var(--color-text-dark);
            margin: 0;
            font-size: 1.4rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            position: relative;
            z-index: 1;
        }
        .total-summary {
            background: var(--gradient-primary);
            color: white;
            padding: 2.5rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: 0 25px 50px var(--color-shadow-strong);
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .total-summary::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent, rgba(255,255,255,0.05), transparent);
            animation: rotate 15s linear infinite;
            z-index: 0;
        }
        .total-summary h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.8rem;
            font-weight: 900;
            position: relative;
            z-index: 1;
        }
        .total-summary .total-price {
            font-size: 3rem;
            font-weight: 900;
            margin: 1.5rem 0;
            text-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        .total-summary .note {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 1rem;
        }
        
        /* New Summary Styles */
        .summary-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-icon {
            font-size: 2.5rem;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .total-price-section {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background: rgba(255,255,255,0.15);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
        }
        
        .price-label {
            font-size: 1.1rem;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius-sm);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.2);
        }
        
        .summary-card:hover::before {
            opacity: 1;
        }
        
        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }
        
        .card-content {
            position: relative;
            z-index: 1;
        }
        
        .card-label {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .card-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: white;
        }
        
        .summary-notes {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .note-item {
            font-size: 0.85rem;
            opacity: 0.8;
            text-align: center;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius-sm);
            backdrop-filter: blur(5px);
        }
        
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .summary-card {
                padding: 1rem;
            }
            
            .card-icon {
                font-size: 2rem;
                margin-bottom: 0.8rem;
            }
            
            .card-value {
                font-size: 1rem;
            }
            
            .total-price {
                font-size: 2.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .summary-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .summary-icon {
                font-size: 2rem;
            }
        }
        
        /* Compact Battery Selection */
        .battery-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .battery-compact-item {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .battery-compact-item:hover {
            border-color: #3FA34D;
            box-shadow: 0 4px 15px rgba(63,163,77,0.15);
        }
        .battery-compact-item.selected {
            border: 3px solid #3FA34D;
            background: rgba(63,163,77,0.08);
        }
        .battery-compact-item label {
            display: flex;
            gap: 1rem;
            cursor: pointer;
            margin: 0;
            align-items: center;
        }
        .battery-compact-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #3FA34D;
        }
        .battery-compact-info {
            flex: 1;
        }
        .battery-compact-name {
            font-weight: 700;
            color: #2d3748;
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
        }
        .battery-compact-details {
            font-size: 0.85rem;
            color: #4a5568;
        }
        .battery-compact-price {
            font-size: 1.1rem;
            font-weight: 800;
            color: #3FA34D;
            margin-top: 0.3rem;
        }
        .result-section {
            background: transparent;
            padding: 0;
            border-radius: 0;
            margin-bottom: 1.5rem;
            box-shadow: none;
            border: none;
            transition: none;
        }
        .result-section:hover {
            transform: none;
            box-shadow: none;
        }
        .result-section h3 {
            display: none;
        }
        .result-item {
            display: none;
        }
        .result-label {
            display: none;
        }
        .result-value {
            display: none;
        }
        .total-section {
            display: none;
        }
        .total-section h3 {
            display: block;
        }
        .product-image-wrapper {
            display: none;
        }
        .product-image {
            display: none;
        }
        .product-name {
            display: none;
        }
        
        /* Style cho nút Lưu Báo Giá */
        #saveSurveyBtn:hover {
            background: #2d5016 !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(63, 163, 77, 0.4);
        }
        #saveSurveyBtn:active {
            transform: translateY(0);
        }
        
        /* Floating Action Button for Cart */
        .cart-fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #56ab2f, #3FA34D);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(63,163,77,0.4);
            cursor: pointer;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 999;
            text-decoration: none;
        }

        .cart-fab:hover {
            transform: translateY(-5px) scale(1.15);
            box-shadow: 0 15px 40px rgba(63,163,77,0.5);
        }

        .cart-fab .fab-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #a8e063, #ff6b6b);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            font-size: 13px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .survey-container {
                padding: 0 1rem;
                margin: 2rem auto;
            }
            .survey-form-wrapper {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            .results-grid {
                display: block;
                width: 100%;
            }
            .results-wrapper {
                margin-right: 0;
                padding-bottom: 150px;
            }
            .cart-fab {
                bottom: 75px;
                right: 20px;
                width: 58px;
                height: 58px;
                font-size: 1.4rem;
            }
            .survey-card h2 {
                font-size: 1.4rem;
            }
            .result-section {
                padding: 1.8rem;
            }
            .result-section h3 {
                font-size: 1.3rem;
            }
            .result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .result-value {
                text-align: left;
            }
            .total-price {
                font-size: 2.2rem;
            }
            .product-image-wrapper {
                flex-direction: column;
                text-align: center;
            }
            .product-image {
                width: 90px;
                height: 90px;
            }
            .radio-option {
                min-width: 100%;
            }
        }
        
        /* Floating Action Button for Cart */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }
        .custom-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }
        .modal-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        .modal-icon.success {
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
            box-shadow: 0 10px 30px rgba(168, 224, 99, 0.4);
        }
        .modal-icon.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
        }
        .modal-icon.warning {
            background: linear-gradient(135deg, #f9ca24 0%, #f39c12 100%);
            box-shadow: 0 10px 30px rgba(249, 202, 36, 0.4);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-message {
            font-size: 1.05rem;
            color: #4a5568;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 2rem;
        }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .modal-btn {
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1rem;
        }
        .modal-btn.primary {
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
        }
        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(86, 171, 47, 0.4);
        }
        .modal-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        .modal-btn.secondary:hover {
            background: #cbd5e0;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Currency input wrapper */
        .currency-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }
        .currency-input-wrapper input {
            width: 100%;
            padding-right: 2.5rem; /* Space for currency symbol */
        }
        .currency-symbol {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #718096;
            font-weight: 600;
            font-size: 1rem;
            user-select: none;
        }
        /* Slideshow enhancements */
        body {
            background-color: transparent !important;
            background: transparent !important;
        }

        /* Make content sections slightly transparent to show slideshow */
        .bg-gray-50 {
            background-color: rgba(249, 250, 251, 0.95) !important;
        }

        body[data-theme="dark"] .bg-gray-900 {
            background-color: rgba(17, 24, 39, 0.95) !important;
        }

        /* Hero sections with glass effect */
        #hero-section, .hero-gradient {
            backdrop-filter: blur(10px);
        }

        /* Sections with glassmorphism */
        section {
            position: relative;
        }

        section:not(#hero-section):not(.hero-gradient) {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(8px);
        }

        body[data-theme="dark"] section:not(#hero-section):not(.hero-gradient) {
            background: rgba(26, 32, 44, 0.8);
        }

        /* Improve text readability on slideshow */
        main {
            position: relative;
            z-index: 1;
        }
    
        /* Canvas container cho neural network */
        #neural-network-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Đảm bảo content nằm trên background */
        main, header, footer {
            position: relative;
            z-index: 1;
        }
        
        /* Sections trong suốt hoàn toàn - chỉ có viền bao quanh */
        section {
            position: relative;
            background: rgba(255, 255, 255, 0.08) !important;
            backdrop-filter: blur(2px) !important;
            -webkit-backdrop-filter: blur(2px) !important;
            border: 2px solid rgba(34, 197, 94, 0.30) !important;
            border-radius: 16px;
            margin: 2rem auto;
            max-width: 100%;
            width: min(1200px, calc(100% - 2.5rem));
            box-shadow: 0 4px 6px rgba(34, 197, 94, 0.10);
        }
        
        body[data-theme="dark"] section {
            background: rgba(15, 23, 42, 0.55) !important;
            border-color: rgba(74, 222, 128, 0.40) !important;
            box-shadow: 0 4px 6px rgba(74, 222, 128, 0.15);
        }
        
        /* Hero section - trong suốt với viền */
        section.bg-gradient-to-br {
            background: rgba(22, 163, 74, 0.15) !important;
            backdrop-filter: blur(3px) !important;
            border: 2px solid rgba(34, 197, 94, 0.50) !important;
            border-radius: 20px;
        }
        
        /* Các section có bg-white/bg-gray - trong suốt với viền */
        section.bg-white,
        section.bg-gray-50,
        section.bg-gray-100,
        section.bg-gray-900,
        section[class*="bg-white"],
        section[class*="bg-gray"] {
            background: rgba(255, 255, 255, 0.06) !important;
            backdrop-filter: blur(2px) !important;
            -webkit-backdrop-filter: blur(2px) !important;
            border: 2px solid rgba(34, 197, 94, 0.30) !important;
            border-radius: 16px;
        }
        
        body[data-theme="dark"] section.bg-white,
        body[data-theme="dark"] section.bg-gray-50,
        body[data-theme="dark"] section.bg-gray-100,
        body[data-theme="dark"] section.bg-gray-900,
        body[data-theme="dark"] section[class*="bg-white"],
        body[data-theme="dark"] section[class*="bg-gray"] {
            background: rgba(15, 23, 42, 0.45) !important;
            border-color: rgba(74, 222, 128, 0.40) !important;
        }
        
        /* Override tất cả các div có bg-white/bg-gray - trong suốt */
        main section > div[class*="bg-white"],
        main section > div[class*="bg-gray"],
        section div[class*="bg-white"],
        section div[class*="bg-gray"] {
            background: transparent !important;
        }
        
        /* Các card bên trong - trong suốt với viền */
        div.bg-white,
        div[class*="bg-white"],
        .bg-white.dark\:bg-gray-800,
        .dark\:bg-gray-800 {
            background: rgba(255, 255, 255, 0.15) !important;
            backdrop-filter: blur(2px) !important;
            border: 1.5px solid rgba(34, 197, 94, 0.40) !important;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.10);
        }
        
        body[data-theme="dark"] div.bg-white,
        body[data-theme="dark"] div[class*="bg-white"],
        body[data-theme="dark"] .bg-white.dark\:bg-gray-800,
        body[data-theme="dark"] .dark\:bg-gray-800 {
            background: rgba(17, 24, 39, 0.25) !important;
            backdrop-filter: blur(2px) !important;
            border-color: rgba(74, 222, 128, 0.50) !important;
            box-shadow: 0 2px 4px rgba(74, 222, 128, 0.15);
        }
        
        /* Article cards - trong suốt với viền */
        article[class*="bg-"],
        article.bg-gradient-to-br {
            background: rgba(240, 253, 244, 0.20) !important;
            backdrop-filter: blur(3px) !important;
            border: 2px solid rgba(34, 197, 94, 0.40) !important;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.15);
        }
        
        body[data-theme="dark"] article[class*="bg-"],
        body[data-theme="dark"] article.bg-gradient-to-br {
            background: rgba(31, 41, 55, 0.30) !important;
            border-color: rgba(74, 222, 128, 0.50) !important;
            box-shadow: 0 4px 8px rgba(74, 222, 128, 0.20);
        }
        
        /* Container và các div wrapper cũng trong suốt */
        .container {
            background: transparent !important;
        }
        
        /* Main content trong suốt */
        main {
            background: transparent !important;
        }
        
        /* Đảm bảo các phần trống hiển thị nền động */
        body > *:not(header):not(footer):not(.copyright-bar) {
            background: transparent !important;
        }

        .copyright-bar {
            position: relative;
            z-index: 1;
            background: #030712 !important;
            border-top: 1px solid rgba(34, 197, 94, 0.35);
        }
        
        /* Header giữ nguyên trong suốt */
        header {
            background: rgba(255, 255, 255, 0.90) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        /* Footer giữ nguyên nền đen */
        footer {
            background: #1f2937 !important; /* bg-gray-800 - giống index.html */
        }
        
        /* Quy tắc: Chỉ áp dụng viền cho chữ lớn (heading) */
        h1, h2, h3 {
            -webkit-text-stroke: 0.5px rgba(0, 0, 0, 0.2);
            text-stroke: 0.5px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* Ngoại lệ: Giữ chữ trắng cho các trường hợp sau */
        /* 1. Footer - nền đen */
        footer .text-white {
            color: #f3f4f6 !important;
        }
        
        /* 2. Button/Badge với nền màu đậm */
        .bg-green-600 .text-white,
        .bg-orange-500 .text-white,
        .bg-blue-500 .text-white,
        .bg-purple-600 .text-white,
        .bg-teal-600 .text-white,
        .bg-red-500 .text-white,
        button.text-white[class*="bg-"],
        a.text-white[class*="bg-"] {
            color: #ffffff !important;
        }
        
        /* 3. Overlay trên hình ảnh (có gradient đen) */
        [class*="from-black"] .text-white,
        [class*="bg-gradient-to-t"][class*="from-black"] .text-white,
        [class*="bg-black"] .text-white {
            color: #ffffff !important;
        }
        
        body[data-theme="dark"] section h1, 
        body[data-theme="dark"] section h2, 
        body[data-theme="dark"] section h3, 
        body[data-theme="dark"] section h4, 
        body[data-theme="dark"] section h5, 
        body[data-theme="dark"] section h6 {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        body[data-theme="dark"] {
            background: #1a202c;
            color: var(--color-text-light);
        }
        
        body[data-theme="dark"] .dark\:bg-gray-900 { background-color: #1a202c; }
        body[data-theme="dark"] .dark\:bg-gray-800 { background-color: #2d3748; }
        body[data-theme="dark"] .dark\:text-gray-100 { color: #f7fafc; }
        body[data-theme="dark"] .dark\:text-gray-300 { color: #d1d5db; }
        body[data-theme="dark"] .dark\:border-gray-700 { border-color: #4a5568; }

    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900" data-page="survey">

    <!-- Background Slideshow -->
    <div id="slideshow-background" class="slideshow-background"></div>
    
    <!-- Header -->
    <header id="header" class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700 transition-all duration-300">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-20">
                <!-- Branding -->
                <a href="../index.html" class="flex items-center gap-3">
                    <img class="h-12 w-12 rounded-lg object-cover" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
                    <div>
                        <div class="font-bold text-lg text-gray-800 dark:text-white">HC<span class="text-green-600">ECO SYSTEM</span></div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">Hệ sinh thái cho tương lai</p>
                    </div>
                </a>

                <!-- Desktop Navigation -->
                <nav class="hidden lg:flex items-center bg-gray-100 dark:bg-gray-800 p-1 rounded-full">
                    <a href="gioi-thieu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Giới thiệu</a>
                    <a href="pricing.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Sản phẩm</a>
                    <a href="du-an.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Dự án</a>
                    <a href="tin-tuc.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Tin tức</a>
                    <a href="dich-vu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Hệ sinh thái</a>
                    <a href="lien-he.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Liên hệ</a>
                </nav>

                <!-- Actions -->
                <div class="flex items-center gap-2">
                    <a class="cta hidden sm:inline-block bg-green-600 text-white font-semibold px-5 py-2.5 rounded-full hover:bg-green-700 transition-all duration-300 shadow-lg shadow-green-500/20" href="khao-sat-dien-mat-troi.html">Nhận tư vấn</a>
                    
                    <!-- Auth buttons will appear here, integrated into the header -->
                    <div id="auth-buttons" class="hidden sm:flex items-center gap-2">
                        <!-- Dynamically populated by auth.js -->
                    </div>

                    <!-- Mobile Menu Button -->
                    <button id="mobile-menu-button" class="lg:hidden h-10 w-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800">
                         <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Navigation -->
        <div id="mobile-menu" class="lg:hidden hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-4">
            <nav class="flex flex-col gap-2">
                <a href="gioi-thieu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Giới thiệu</a>
                <a href="pricing.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Sản phẩm</a>
                <a href="du-an.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Dự án</a>
                <a href="tin-tuc.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Tin tức</a>
                <a href="dich-vu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Hệ sinh thái</a>
                <a href="lien-he.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Liên hệ</a>

                <!-- Mobile Auth Buttons -->
                <div class="border-t border-gray-200 dark:border-gray-600 pt-4 mt-4">
                    <div id="mobile-auth-buttons" class="flex flex-col gap-2">
                        <!-- Dynamically populated by auth.js -->
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Floating Cart Button -->
    <a href="gio-hang.html" id="cart-fab" class="fixed bottom-6 right-6 z-50 h-14 w-14 bg-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-green-50 transition-all duration-300 border-2 border-green-600">
        <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <span id="fab-cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800" style="display: none;">0</span>
    </a>

    <!-- Main Content -->

    <main>
        <div class="survey-container">
            <div class="survey-card">
                <h2>📋 Khảo Sát Chi Tiết Hệ Thống Điện Mặt Trời</h2>
            </div>
            
            <!-- Form nhập liệu chia 2 cột như quyển vở -->
            <form id="surveyForm">
                <div class="survey-form-wrapper">
                    <!-- Cột trái của form -->
                    <div class="form-column">
                        <!-- Thông tin cơ bản -->
                        <div class="form-group">
                            <label>Họ và Tên *</label>
                            <input type="text" name="fullname" required placeholder="Nguyễn Văn A" />
                        </div>

                        <div class="form-group">
                            <label>Số Điện Thoại *</label>
                            <input type="tel" id="survey-phone" name="phone" required placeholder="0988919868" 
                                   pattern="^0[0-9]{9}$" maxlength="10"
                                   title="Số điện thoại phải có đúng 10 số và bắt đầu bằng số 0" />
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                📱 Nhập đúng 10 số, bắt đầu bằng 0
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="survey-email" name="email" required placeholder="example@gmail.com" 
                                   pattern="[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]{2,}"
                                   title="Vui lòng nhập địa chỉ email hợp lệ" />
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                📧 Báo giá sẽ được gửi đến email này
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Khu Vực *</label>
                            <select name="region" required>
                                <option value="">-- Chọn khu vực --</option>
                                <option value="mien-bac">Miền Bắc (4,4 giờ nắng/ngày)</option>
                                <option value="mien-trung">Miền Trung (6,3 giờ nắng/ngày)</option>
                                <option value="mien-nam">Miền Nam (6,3 giờ nắng/ngày)</option>
                            </select>
                        </div>

                        <!-- Loại điện -->
                        <div class="form-group">
                            <label>Loại Điện *</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="phase" value="1" required />
                                    <span>1 Pha</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="phase" value="3" />
                                    <span>3 Pha</span>
                                </label>
                            </div>
        </div>

                        <!-- Loại tấm pin (Load động từ admin) -->
                        <div class="form-group">
                            <label>Chọn Loại Tấm Pin *</label>
                            <select name="solarPanel" required>
                                <option value="">-- Đang tải dữ liệu... --</option>
                            </select>
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                💡 Danh sách được quản lý trong Admin → Tab Khảo Sát → Loại: Tấm Pin
                            </small>
                        </div>

                        <!-- Loại pin (Load động từ admin) -->
                        <div class="form-group">
                            <label>Chọn Loại Pin *</label>
                            <select name="batteryType" required>
                                <option value="">-- Đang tải dữ liệu... --</option>
                            </select>
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                💡 Danh sách được quản lý trong Admin → Tab Khảo Sát → Loại: Pin Lưu Trữ
                            </small>
                        </div>
        </div>

                    <!-- Cột phải của form -->
                    <div class="form-column">
                        <!-- Tiền điện hàng tháng -->
                        <div class="form-group">
                            <label>Tiền Điện Trung Bình/Tháng (VNĐ) *</label>
                            <div class="currency-input-wrapper">
                                <input type="text" id="monthlyBillInput" name="monthlyBill" required placeholder="VD: 1.500.000" />
                                <span class="currency-symbol">đ</span>
                            </div>
        </div>
                        
                        <!-- Sản phẩm điện EVN -->
                        <div class="form-group">
                            <div style="background: linear-gradient(135deg, rgba(63,163,77,0.08) 0%, rgba(168,224,99,0.08) 100%); border-radius: 12px; padding: 1rem; border: 2px solid rgba(63,163,77,0.2);">
                                <div style="display: flex; flex-direction: column; gap: 0.3rem; margin-bottom: 0.8rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">⚡</span>
                                    <strong style="color: #3FA34D; font-size: 0.95rem;">Bảng Giá Điện Sinh Hoạt EVN (Có VAT 8%)</strong>
                                </div>
                                    <div style="font-size: 0.75rem; color: #718096; font-style: italic; padding-left: 1.7rem;">
                                        Áp dụng từ 10/5/2025
                                    </div>
        </div>
                                <table style="width: 100%; font-size: 0.82rem; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                                    <thead>
                                        <tr style="background: rgba(63,163,77,0.1);">
                                            <th style="padding: 0.5rem; text-align: left; color: #2d3748; font-weight: 600; border-bottom: 2px solid rgba(63,163,77,0.2);">Bậc</th>
                                            <th style="padding: 0.5rem; text-align: right; color: #2d3748; font-weight: 600; border-bottom: 2px solid rgba(63,163,77,0.2);">Chưa VAT</th>
                                            <th style="padding: 0.5rem; text-align: right; color: #1E5631; font-weight: 700; border-bottom: 2px solid rgba(63,163,77,0.2);">Có VAT 8%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="border-bottom: 1px solid rgba(226,232,240,0.5);">
                                            <td style="padding: 0.4rem 0.5rem; color: #4a5568;">Bậc 1: 0-50 kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: #718096;">1.984đ/kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; font-weight: 600; color: #3FA34D;">2.143đ/kWh</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid rgba(226,232,240,0.5);">
                                            <td style="padding: 0.4rem 0.5rem; color: #4a5568;">Bậc 2: 51-100 kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: #718096;">2.050đ/kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; font-weight: 600; color: #3FA34D;">2.214đ/kWh</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid rgba(226,232,240,0.5);">
                                            <td style="padding: 0.4rem 0.5rem; color: #4a5568;">Bậc 3: 101-200 kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: #718096;">2.380đ/kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; font-weight: 600; color: #3FA34D;">2.570đ/kWh</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid rgba(226,232,240,0.5);">
                                            <td style="padding: 0.4rem 0.5rem; color: #4a5568;">Bậc 4: 201-300 kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: #718096;">2.930đ/kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; font-weight: 600; color: #3FA34D;">3.164đ/kWh</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid rgba(226,232,240,0.5);">
                                            <td style="padding: 0.4rem 0.5rem; color: #4a5568;">Bậc 5: 301-400 kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: #718096;">3.270đ/kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; font-weight: 600; color: #3FA34D;">3.532đ/kWh</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.4rem 0.5rem; color: #4a5568;">Bậc 6: Từ 401 kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; color: #718096;">3.460đ/kWh</td>
                                            <td style="padding: 0.4rem 0.5rem; text-align: right; font-weight: 600; color: #3FA34D;">3.737đ/kWh</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div style="margin-top: 0.8rem; padding-top: 0.6rem; border-top: 1px solid rgba(226,232,240,0.5);">
                                    <div style="font-size: 0.8rem; color: #718096; display: flex; align-items: start; gap: 0.3rem;">
                                        <span>💡</span>
                                        <span>Hệ thống sẽ tự động tính toán mức tiêu thụ kWh dựa trên số tiền điện bạn nhập (sử dụng giá có VAT 8% - áp dụng từ 10/5/2025)</span>
                                    </div>
        </div>
                            </div>
        </div>

                        <!-- Thời gian sử dụng -->
                        <div class="form-group">
                            <label>Thời Gian Sử Dụng Điện Chủ Yếu *</label>
                            <select name="usageTime" required>
                                <option value="">-- Chọn thời gian --</option>
                                <option value="day">Ban ngày nhiều (pin = 1/3 điện tạo ra)</option>
                                <option value="balanced">Cả ngày đều (pin = 1/2 điện tạo ra)</option>
                                <option value="night">Ban đêm nhiều (pin = 3/5 điện tạo ra)</option>
                            </select>
                        </div>
                        
                        <!-- Chọn Biến Tần -->
                        <div class="form-group">
                            <label>Chọn Biến Tần *</label>
                            <select name="inverter" id="inverterSelect" required>
                                <option value="">-- Vui lòng chọn Loại Điện trước --</option>
                            </select>
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                💡 Vui lòng chọn Loại Điện (1 Pha hoặc 3 Pha) trước để hiển thị danh sách biến tần phù hợp
                            </small>
                        </div>
        </div>
                </div>
                
                <!-- Nút tính toán và xem lịch sử -->
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button type="submit" class="btn-calculate">🔍 Tính Toán Báo Giá</button>
                    <div style="margin-top: 1rem;">
                        <a href="survey_history.html" style="display: inline-block; background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); color: white; padding: 0.8rem 1.8rem; border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(86, 171, 47, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 15px rgba(86, 171, 47, 0.3)';">
                            📋 Xem Lịch Sử Khảo Sát
                        </a>
                    </div>
        </div>
            </form>

            <!-- Kết quả - cũng chia 2 cột bên dưới -->
            <div class="results-wrapper">
                <div id="results" class="results">
                    <!-- Kết quả sẽ được hiển thị ở đây dạng 2 cột -->
                </div>
                <div class="results-placeholder">
                    <div class="results-placeholder-icon">📊</div>
                    <div class="results-placeholder-text">Kết quả báo giá sẽ hiển thị tại đây</div>
                    <div class="results-placeholder-subtext">Vui lòng điền đầy đủ thông tin và nhấn "Tính Toán Báo Giá"</div>
                </div>
            </div>
        </div>

        <!-- Tại Sao Chọn Năng Lượng Mặt Trời - NEW SECTION -->
        <section class="py-16 bg-gradient-to-br from-green-50 to-blue-50 dark:from-gray-900 dark:to-gray-800">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">
                        ☀️ Tại Sao Nên Chọn Năng Lượng Mặt Trời?
                    </h2>
                    <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                        Tiết kiệm chi phí, bảo vệ môi trường, đầu tư sinh lời bền vững
                    </p>
                </div>

                <!-- Video Demo -->
                <div class="max-w-4xl mx-auto mb-12">
                    <div class="rounded-2xl overflow-hidden shadow-2xl bg-gray-900">
                        <video controls class="w-full" poster="../Photo/residential-solar-home.png">
                            <source src="../Video/Prompt 5.mp4" type="video/mp4">
                            Trình duyệt của bạn không hỗ trợ video.
                        </video>
                        <div class="p-4 bg-gradient-to-r from-green-800 to-blue-800">
                            <p class="text-white text-center">
                                🔌 Xem hệ thống hoạt động: Công tắc bật → Thiết bị chạy → Năng lượng từ tấm pin
                            </p>
                        </div>
        </div>
                </div>

                <!-- 4 Benefits -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                    <!-- Benefit 1 -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300">
                        <div class="h-48 overflow-hidden">
                            <img src="../Photo/benefits-roi.png" alt="Tiết kiệm" class="w-full h-full object-cover" />
                        </div>
                        <div class="p-6">
                            <div class="text-3xl mb-3">💰</div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Tiết Kiệm Chi Phí</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">
                                Giảm đến 80% hóa đơn tiền điện mỗi tháng. Hoàn vốn sau 5-7 năm.
                            </p>
                            <div class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <p class="text-green-700 dark:text-green-400 font-semibold text-sm">
                                    ⚡ Tiết kiệm: 3-8 triệu/tháng
                                </p>
                            </div>
        </div>
                    </div>

                    <!-- Benefit 2 -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300">
                        <div class="h-48 overflow-hidden">
                            <img src="../Photo/solar-farm-field.jpg" alt="Thân thiện môi trường" class="w-full h-full object-cover" />
                        </div>
                        <div class="p-6">
                            <div class="text-3xl mb-3">🌱</div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Thân Thiện Môi Trường</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">
                                Giảm phát thải CO2, không gây ô nhiễm, năng lượng sạch và tái tạo.
                            </p>
                            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <p class="text-blue-700 dark:text-blue-400 font-semibold text-sm">
                                    🌍 Giảm 2-4 tấn CO2/năm
                                </p>
                            </div>
        </div>
                    </div>

                    <!-- Benefit 3 -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300">
                        <div class="h-48 overflow-hidden">
                            <img src="../Photo/solar-panels-sunset.png" alt="Bền vững" class="w-full h-full object-cover" />
                        </div>
                        <div class="p-6">
                            <div class="text-3xl mb-3">🔋</div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Bền Vững Lâu Dài</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">
                                Tuổi thọ 25-30 năm, bảo hành 10 năm. Ít bảo trì, hoạt động ổn định.
                            </p>
                            <div class="mt-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                <p class="text-purple-700 dark:text-purple-400 font-semibold text-sm">
                                    ⏱️ Tuổi thọ: 25-30 năm
                                </p>
                            </div>
        </div>
                    </div>

                    <!-- Benefit 4 -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300">
                        <div class="h-48 overflow-hidden">
                            <img src="../Photo/modern-solar-panels.jpg" alt="Công nghệ hiện đại" class="w-full h-full object-cover" />
                        </div>
                        <div class="p-6">
                            <div class="text-3xl mb-3">🚀</div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Công Nghệ Hiện Đại</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">
                                Pin hiệu suất cao 590-630W, inverter thông minh, giám sát qua app.
                            </p>
                            <div class="mt-4 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                                <p class="text-orange-700 dark:text-orange-400 font-semibold text-sm">
                                    📱 Giám sát 24/7 qua app
                                </p>
                            </div>
        </div>
                    </div>
        </div>
            </div>
        </section>

        <!-- Case Study - Câu Chuyện Khách Hàng - NEW SECTION -->
        <section class="py-16 bg-white dark:bg-gray-900">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">
                        🏠 Câu Chuyện Thành Công
                    </h2>
                    <p class="text-lg text-gray-600 dark:text-gray-300">
                        Gia đình anh Minh - Tiết kiệm 8 triệu đồng/tháng
                    </p>
                </div>

                <div class="max-w-6xl mx-auto">
                    <div class="grid lg:grid-cols-2 gap-8 items-center">
                        <!-- Video -->
                        <div>
                            <div class="rounded-2xl overflow-hidden shadow-2xl bg-gray-900">
                                <video controls class="w-full" poster="../Photo/family-solar-vietnam.png">
                                    <source src="../Video/Prompt 9.mp4" type="video/mp4">
                                    Trình duyệt của bạn không hỗ trợ video.
                                </video>
                                <div class="p-4 bg-gray-800">
                                    <p class="text-gray-300 text-sm text-center">
                                        🎬 Gia đình anh Minh vui vẻ sinh hoạt với năng lượng mặt trời
                                    </p>
                                </div>
        </div>
                        </div>

                        <!-- Content -->
                        <div class="space-y-6">
                            <div class="bg-gradient-to-br from-green-50 to-blue-50 dark:from-gray-800 dark:to-gray-800 p-8 rounded-xl shadow-lg">
                                <div class="flex items-center gap-4 mb-6">
                                    <img src="../Photo/residential-solar-home.png" alt="Nhà anh Minh" class="w-20 h-20 rounded-full object-cover border-4 border-white" />
                                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Anh Nguyễn Văn Minh</h3>
                                        <p class="text-gray-600 dark:text-gray-300">Biệt thự Q7, TP.HCM</p>
                                        <div class="flex gap-1 mt-1">
                                            <span class="text-yellow-500 text-xl">★★★★★</span>
                                        </div>
        </div>
                                </div>

                                <div class="space-y-4">
                                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Hệ thống lắp đặt:</p>
                                        <p class="font-bold text-gray-800 dark:text-white">15 kW - 24 tấm pin 630W</p>
                                    </div>

                                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Tiền điện trước:</p>
                                        <p class="font-bold text-red-600 dark:text-red-400 text-xl">12 triệu/tháng</p>
                                    </div>

                                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Tiền điện sau:</p>
                                        <p class="font-bold text-green-600 dark:text-green-400 text-xl">4 triệu/tháng</p>
                                    </div>

                                    <div class="bg-gradient-to-r from-green-600 to-blue-600 p-4 rounded-lg text-white">
                                        <p class="text-sm mb-1">💰 Tiết kiệm mỗi tháng:</p>
                                        <p class="font-bold text-2xl">8.000.000 VNĐ</p>
                                        <p class="text-xs mt-2 opacity-90">= 96 triệu/năm | Hoàn vốn sau 6 năm</p>
                                    </div>
        </div>

                                <blockquote class="mt-6 border-l-4 border-green-600 pl-4 italic text-gray-700 dark:text-gray-300">
                                    "Quyết định lắp pin mặt trời là một trong những quyết định tốt nhất của gia đình tôi. Tiết kiệm được rất nhiều tiền điện hàng tháng, đồng thời góp phần bảo vệ môi trường. Đội ngũ HC ECO SYSTEM rất chuyên nghiệp!"
                                </blockquote>

                                <div class="mt-6 text-center">
                                    <a href="gioi-thieu.html" class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-full font-semibold shadow-lg transition-all duration-300">
                                        Xem Thêm Câu Chuyện Khách Hàng
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                                        </svg>
                                    </a>
                                </div>
        </div>
                        </div>
        </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="site-footer" class="bg-gray-800 dark:bg-black text-gray-300">
        <div class="container mx-auto px-4 py-12">
            <div class="grid lg:grid-cols-3 md:grid-cols-2 gap-8">
                <!-- Branding & Copyright -->
                <div class="space-y-4">
                     <a href="../index.html" class="flex items-center gap-3">
                        <img class="h-12 w-12 rounded-lg object-cover" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
                        <div>
                            <div class="font-bold text-lg text-white">HC<span class="text-green-500">ECO SYSTEM</span></div>
                        </div>
                    </a>
                    <p class="text-sm text-gray-400">&copy; 2025 HC Eco System. Giữ vững cam kết năng lượng sạch cho mỗi nhà.</p>                    
                    <!-- Ecosystem Logos Animation -->
                    <div class="mt-6 relative overflow-hidden" style="height: 80px;">
                        <div id="ecosystem-logos-container" class="flex gap-6">
                            <!-- Logos will be inserted by JavaScript -->
                        </div>
        </div>
                </div>

                <!-- Contact Info -->
                <div class="space-y-2">
                    <h4 class="font-semibold text-white">Thông tin liên hệ</h4>
                    <ul class="text-sm text-gray-400 space-y-1">
                        <li><strong>Hotline:</strong> 0969 397 434 (Chính)</li>
                        <li><strong>Hotline phụ:</strong> 0988 919 868</li>
                        <li><strong>Zalo:</strong> 0969 397 434</li>
                        <li><strong>Email:</strong> hcecosystem@gmail.com</li>
                        <li><strong>Website:</strong> hceco.io.vn</li>
                        <li><strong>Địa chỉ Văn phòng:</strong><br>790 Ngô Quyền, Phường An Hải, Thành Phố Đà Nẵng</li>
                    </ul>
                </div>

                <!-- Policies -->
                <div class="space-y-2">
                     <h4 class="font-semibold text-white">Chính sách & Dịch vụ</h4>
                    <ul class="text-sm space-y-1">
                        <li><a href="tam-nhin-su-menh.html" class="text-gray-400 hover:text-white">Tầm Nhìn & Sứ Mệnh</a></li>
                        <li><a href="dieu-khoan-dieu-kien.html" class="text-gray-400 hover:text-white">Điều Khoản & Điều Kiện</a></li>
                        <li><a href="chinh-sach-doi-tra.html" class="text-gray-400 hover:text-white">Chính Sách Đổi Trả</a></li>
                        <li><a href="chinh-sach-bao-mat-thong-tin-ca-nhan.html" class="text-gray-400 hover:text-white">Chính Sách Bảo Mật Thông Tin Cá Nhân</a></li>
                        <li><a href="chinh-sach-bao-mat-thong-tin-thanh-toan.html" class="text-gray-400 hover:text-white">Chính Sách Bảo Mật Thông Tin Thanh Toán</a></li>
                        <li><a href="chinh-sach-bao-hanh.html" class="text-gray-400 hover:text-white">Chính Sách Bảo Hành</a></li>
                        <li><a href="tro-thanh-nha-phan-phoi.html" class="text-gray-400 hover:text-white">Trở Thành Nhà Phân Phối</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Copyright Bar -->
    <div class="bg-black border-t border-green-500/30 shadow-inner copyright-bar">
        <div class="container mx-auto px-4 py-4">
            <p class="text-center text-sm text-gray-200 tracking-wide">
                © Bản quyền thuộc về <a href="https://hceco.io.vn" class="text-green-300 hover:text-white underline font-semibold">https://hceco.io.vn</a> | Cung cấp bởi <a href="https://phuture.io.vn" target="_blank" class="text-green-200 hover:text-white hover:underline font-medium transition-colors duration-200">Phuture</a>
            </p>
        </div>
    </div>

    
    <!-- Scripts (IDs preserved) -->
    <script src="../assets/js/shopping-cart.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
        // API Base URL
        const API_BASE = '../api';
        // Bản đồ giờ nắng theo khu vực (mặc định)
        let regionSunHours = { 'mien-bac': 4.4, 'mien-trung': 4.7, 'mien-nam': 6.3 };
        
        // Mobile menu toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const header = document.getElementById('header');
        let menuJustOpened = false; // Flag to prevent immediate closing after user opens menu

        mobileMenuButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event bubbling
            menuJustOpened = true; // Set flag when user manually opens menu
            mobileMenu.classList.toggle('hidden');
            
            // Reset flag after a short delay to allow scroll handler to work again
            setTimeout(() => {
                menuJustOpened = false;
            }, 300);
        });
        
        // Close menu when a link is clicked
        mobileMenu.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                mobileMenu.classList.add('hidden');
            }
        });
        
        // Hide menu on scroll down for better UX (but only if user didn't just open it)
        let lastScrollTop = 0;
        window.addEventListener("scroll", function(){ 
           var st = window.pageYOffset || document.documentElement.scrollTop; 
           if (st > lastScrollTop && !menuJustOpened){
              // downscroll - only close if user didn't just open the menu
              mobileMenu.classList.add('hidden');
           }
           lastScrollTop = st <= 0 ? 0 : st;
        }, false);

        // Highlight active navigation item based on current page
        (function() {
            const currentPath = window.location.pathname;
            const currentPage = currentPath.split('/').pop() || 'index.html';
            
            // Select all nav links (both desktop and mobile)
            const navLinks = document.querySelectorAll('nav a[href*=".html"]');
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                const linkPage = href.split('/').pop();
                
                const isActive = linkPage === currentPage;
                
                if (isActive) {
                    // Remove default classes
                    link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-white', 'dark:hover:bg-gray-700', 'hover:bg-gray-100');
                    // Add active classes
                    link.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
                }
            });
        })();

        // Sản phẩm điện có VAT 8% (giá sau thuế) - Load từ API
        let electricityPrices = {
            1: { price: 2143, range: 50, name: 'Bậc 1 (0-50 kWh)' },      // 2.143đ/kWh - Default
            2: { price: 2214, range: 50, name: 'Bậc 2 (51-100 kWh)' },    // 2.214đ/kWh
            3: { price: 2570, range: 100, name: 'Bậc 3 (101-200 kWh)' },  // 2.570đ/kWh
            4: { price: 3164, range: 100, name: 'Bậc 4 (201-300 kWh)' },  // 3.164đ/kWh
            5: { price: 3532, range: 100, name: 'Bậc 5 (301-400 kWh)' },  // 3.532đ/kWh
            6: { price: 3737, range: Infinity, name: 'Bậc 6 (Từ 401 kWh)' } // 3.737đ/kWh
        };
        let electricityPricesEffectiveDate = '2025-05-10'; // Default date

        // Danh sách inverter theo pha (Giá lắp đặt trọn gói - Từ trang sản phẩm)
        const invertersByPhase = {
            '1': [ // 1 Pha - LUXPOWER
                { name: "LUXPOWER 6K (1 Pha)", power: 6000, price: 21350000, warranty: "12 tháng", image: "../assets/img/products/hybrid-gen-lb-eu-6k.png", phase: "1" },
                { name: "LUXPOWER 8K (1 Pha)", power: 8000, price: 37250000, warranty: "12 tháng", image: "../assets/img/products/hybrid-gen-lb-eu-8k.png", phase: "1" },
                { name: "LUXPOWER 10K (1 Pha)", power: 10000, price: 39350000, warranty: "12 tháng", image: "../assets/img/products/hybrid-gen-lb-eu-10k.png", phase: "1" },
                { name: "LUXPOWER 12K (1 Pha)", power: 12000, price: 44350000, warranty: "12 tháng", image: "../assets/img/products/hybrid-lxp-12k.png", phase: "1" }
            ],
            '3': [ // 3 Pha - LUXPOWER
                { name: "LUXPOWER 12K (3 Pha)", power: 12000, price: 48250000, warranty: "12 tháng", image: "../assets/img/products/hybrid-trip2-lb-3p-12k.png", phase: "3" },
                { name: "LUXPOWER 15K (3 Pha)", power: 15000, price: 51250000, warranty: "12 tháng", image: "../assets/img/products/hybrid-trip2-lb-3p-15k.png", phase: "3" }
            ],
            'both': [ // Cả 2 - LUXPOWER
                { name: "LUXPOWER 12K (Cả 2 Pha)", power: 12000, price: 46300000, warranty: "12 tháng", image: "../assets/img/products/hybrid-lxp-12k.png", phase: "both" }
            ]
        };

        // Danh sách pin lưu trữ (Giá lắp đặt trọn gói - Từ trang sản phẩm)
        const batteries = [
            { name: "PIN LƯU TRỮ A-CORNEX", capacity: 16.3, price: 25500000, warranty: "10 năm", image: "../assets/img/products/pin-luu-tru-acornex.jpg" },
            { name: "PIN LƯU TRỮ BYD", capacity: 8.8, price: 14500000, warranty: "10 năm", image: "../assets/img/products/pin-luu-tru-byd.jpg" },
            { name: "BYD Battery-Box Premium LVS", capacity: 15.36, price: 80000000, warranty: "10 năm", image: "../assets/img/products/cell-byd-173ah-lifepo4.png" },
            { name: "BYD Battery-Box Premium LVS", capacity: 20.48, price: 104600000, warranty: "10 năm", image: "../assets/img/products/cell-byd-173ah-lifepo4.png" }
        ];

        // Phụ kiện khác
        // Danh sách tủ điện theo pha (Giá lắp đặt trọn gói - Từ trang sản phẩm)
        const electricalCabinets = {
            '1': [ // 1 Pha
                { name: "Tủ Điện Hybrid 1 Pha 6kW", power: 6000, price: 1850000, image: "../assets/img/products/electrical-cabinet.jpg" },
                { name: "Tủ Điện Hybrid 1 Pha 8kW", power: 8000, price: 2100000, image: "../assets/img/products/electrical-cabinet.jpg" },
                { name: "Tủ Điện Hybrid 1 Pha 10kW", power: 10000, price: 2350000, image: "../assets/img/products/electrical-cabinet.jpg" },
                { name: "Tủ Điện Hybrid 1 Pha 12kW", power: 12000, price: 2600000, image: "../assets/img/products/electrical-cabinet.jpg" }
            ],
            '3': [ // 3 Pha
                { name: "Tủ Điện Hybrid 3 Pha 12kW", power: 12000, price: 2850000, image: "../assets/img/products/electrical-cabinet.jpg" },
                { name: "Tủ Điện Hybrid 3 Pha 15kW", power: 15000, price: 3100000, image: "../assets/img/products/electrical-cabinet.jpg" }
            ],
            'both': [ // Cả 2
                { name: "Tủ Điện Hybrid Cả 2 Pha 12kW", power: 12000, price: 2725000, image: "../assets/img/products/electrical-cabinet.jpg" }
            ]
        };

        const accessories = [
            // 1. Tấm Pin Mặt Trời (đã tính riêng)
            // 2. Máy Biến Tần Hybrid (đã tính riêng)
            // 3. Pin Lưu Trữ LiFePO4 (đã tính riêng)
            // 4. Pin Lưu Trữ LiFePO4 BYD (đã tính riêng)
            // 5. Tủ Điện (sẽ được chọn động)
            { name: "Bách Z Mạ Kẽm", unit: "cái", price: 80000, quantity: 0, image: "../assets/img/products/bachz.png" },
            { name: "Kẹp Biên & Kẹp Giữa", unit: "bộ", price: 15000, quantity: 0, image: "../assets/img/products/kepbien-tamgiua.png" },
            { name: "Jack Cắm MC4 1500VDC", unit: "bộ", price: 50000, quantity: 0, image: "../assets/img/products/jackcam.png" },
            { name: "Dây Điện (AC/DC)", unit: "mét", price: 30000, quantity: 0, image: "../assets/img/products/daydien.png" },
            { name: "Công Thợ Lắp Đặt Trọn Gói", unit: "dự án", price: 6000000, quantity: 1, image: "🔧" },
            { name: "Vận Chuyển Đến Công Trình", unit: "chuyến", price: 0, quantity: 1, image: "🚛", isTransport: true }
        ];

        // Dynamic accessories loaded from Admin (fallback to hardcoded if empty)
        let dynamicAccessories = [];

        // Hàm tính kWh từ số tiền điện và trả về chi tiết từng bậc
        function calculateKwhFromBill(billAmount) {
            let remainingAmount = billAmount;
            let totalKwh = 0;
            const breakdown = []; // Lưu chi tiết từng bậc
            
            // Duyệt qua từng bậc thang
            for (let tier = 1; tier <= 6; tier++) {
                if (remainingAmount <= 0) break;
                
                const tierInfo = electricityPrices[tier];
                const maxKwh = tierInfo.range;
                const pricePerKwh = tierInfo.price;
                
                // Tính số kWh có thể dùng ở bậc này
                const possibleKwh = remainingAmount / pricePerKwh;
                const actualKwh = Math.min(maxKwh, possibleKwh);
                
                if (actualKwh > 0) {
                    const tierAmount = actualKwh * pricePerKwh;
                    
                    breakdown.push({
                        tier: tier,
                        name: tierInfo.name,
                        pricePerKwh: pricePerKwh,
                        kwh: actualKwh,
                        amount: tierAmount
                    });
                    
                    totalKwh += actualKwh;
                    remainingAmount -= tierAmount;
                }
            }
            
            return {
                totalKwh: Math.round(totalKwh * 10) / 10, // Làm tròn 1 chữ số thập phân
                breakdown: breakdown,
                totalAmount: billAmount
            };
        }

        // Hàm tính toán báo giá hệ thống điện mặt trời
        function calculateSolarSystem(formData) {
            const monthlyBill = parseInt(formData.monthlyBill.replace(/[^\d]/g, ''));
            const kwhCalculation = calculateKwhFromBill(monthlyBill);
            const monthlyKwh = kwhCalculation.totalKwh;
            
            // Lấy thông tin tấm pin từ option được chọn
            const solarPanelSelect = document.querySelector('select[name="solarPanel"]');
            const selectedOption = solarPanelSelect.options[solarPanelSelect.selectedIndex];
            const solarPanelWatt = parseInt(selectedOption.value);
            const solarPanelPrice = parseInt(selectedOption.getAttribute('data-price'));
            const solarPanelImage = selectedOption.getAttribute('data-image');
            const solarPanelProductId = parseInt(selectedOption.getAttribute('data-product-id')) || 0;
            
            // Debug: Log panel product ID
            console.log('Panel Product ID from option:', solarPanelProductId, 'Attr:', selectedOption.getAttribute('data-product-id'));
            
            // Điều chỉnh giờ nắng theo khu vực (ưu tiên dữ liệu từ Admin)
            let peakSunHours = regionSunHours[formData.region] || 4.4;
            
            // Tính toán hệ thống
            const dailyKwh = monthlyKwh / 30;
            // Không làm tròn kWp; chỉ làm tròn khi quy đổi ra số tấm
            const systemSizeKw = (dailyKwh / peakSunHours);
            const systemSizeWatt = systemSizeKw * 1000;
            // Giá trị hiển thị (làm tròn 2 chữ số): VD 3.8560 -> 3.86 kWp
            const systemSizeKwDisplay = Number(systemSizeKw.toFixed(2));
            
            // Số lượng tấm pin cần thiết
            const panelCount = Math.ceil(systemSizeWatt / solarPanelWatt);
            
            // Tính diện tích mái cần thiết (mỗi tấm pin ~2.8m²)
            const roofArea = (panelCount * 2.8).toFixed(1);
            
            // Chọn inverter - ưu tiên inverter user chọn, nếu không có thì tự động chọn
            let selectedInverter;
            let userSelectedInverter = false; // Flag to track if user manually selected
            
            // Kiểm tra xem user có chọn inverter không
            const inverterSelect = document.getElementById('inverterSelect');
            const selectedInverterOption = inverterSelect?.options[inverterSelect.selectedIndex];
            const userSelectedInverterId = selectedInverterOption?.value;
            
            if (userSelectedInverterId && selectedInverterOption && selectedInverterOption.value !== '') {
                // User đã chọn inverter - sử dụng inverter đó
                const inverterId = parseInt(selectedInverterOption.getAttribute('data-inverter-id')) || 0;
                const inverterName = selectedInverterOption.getAttribute('data-inverter-name') || '';
                const inverterPower = parseInt(selectedInverterOption.getAttribute('data-inverter-power')) || 0;
                const inverterPrice = parseFloat(selectedInverterOption.getAttribute('data-inverter-price')) || 0;
                const inverterImage = selectedInverterOption.getAttribute('data-inverter-image') || '';
                const inverterPhase = selectedInverterOption.getAttribute('data-inverter-phase') || formData.phase;
                const inverterWarranty = selectedInverterOption.getAttribute('data-inverter-warranty') || '12 tháng';
                
                selectedInverter = {
                    id: inverterId,
                    name: inverterName,
                    power: inverterPower,
                    price: inverterPrice,
                    warranty: inverterWarranty,
                    image: inverterImage,
                    phase: inverterPhase
                };
                
                userSelectedInverter = true; // Mark as user selected
                console.log('✅ Sử dụng biến tần user chọn:', selectedInverter.name, 'ID:', selectedInverter.id);
            } else {
                // User chưa chọn - tự động chọn theo logic cũ
                let availableInverters = [];
                
                if (formData.phase === '1') {
                    availableInverters = [
                        ...(invertersByPhase['1'] || []),
                        ...(invertersByPhase['both'] || [])
                    ];
                } else if (formData.phase === '3') {
                    availableInverters = [
                        ...(invertersByPhase['3'] || []),
                        ...(invertersByPhase['both'] || [])
                    ];
                }
                
                if (availableInverters.length > 0) {
                    // Chuẩn hóa công suất và sắp xếp tăng dần để luôn chọn inverter NHỎ NHẤT thỏa điều kiện
                    availableInverters = availableInverters.map(inv => {
                        let p = Number(inv.power || 0);
                        if (!p) {
                            const m = (inv.name || '').match(/(\d+)\s*K/i);
                            if (m) p = parseInt(m[1], 10) * 1000;
                        }
                        return { ...inv, power: p };
                    }).sort((a, b) => (a.power || 0) - (b.power || 0));
                    // Tìm inverter phù hợp theo quy tắc 1.5x: inverter có thể kéo tối đa ~1.5 × công suất DC
                    // Điều kiện chọn: inv.power * 1.5 >= systemSizeWatt
                    selectedInverter = availableInverters.find(inv => (inv.power * 1.5) >= systemSizeWatt) || availableInverters[availableInverters.length - 1];
                    // Nếu không parse được công suất (0W), cố gắng suy ra từ tên; nếu vẫn 0 thì gán = systemSizeWatt
                    if (!selectedInverter.power || selectedInverter.power === 0) {
                        const pMatch = (selectedInverter.name || '').match(/(\d+)\s*K/i);
                        if (pMatch) selectedInverter.power = parseInt(pMatch[1], 10) * 1000;
                        if (!selectedInverter.power || selectedInverter.power === 0) selectedInverter.power = systemSizeWatt;
                    }
                    console.log('✅ Tự động chọn biến tần:', selectedInverter.name, 'ID:', selectedInverter.id);
                } else {
                    // Fallback nếu không có inverter phù hợp
                    selectedInverter = { id: 0, name: "Không có biến tần phù hợp", power: 0, price: 0, warranty: "N/A", image: "", phase: formData.phase };
                }
            }
            
            // Tính số lượng biến tần cần thiết dựa trên công suất hệ thống
            // Mỗi biến tần có thể kéo tối đa ~1.5 × công suất DC của nó
            let inverterQuantity = 1;
            let inverterTotalPrice = selectedInverter.price;
            
            if (selectedInverter.power && selectedInverter.power > 0) {
                // Công suất tối đa mà 1 biến tần có thể kéo: power * 1.5
                const maxPowerPerInverter = selectedInverter.power * 1.5;
                // Số lượng biến tần cần thiết = làm tròn lên (công suất hệ thống / công suất tối đa mỗi biến tần)
                inverterQuantity = Math.ceil(systemSizeWatt / maxPowerPerInverter);
                // Đảm bảo ít nhất 1 bộ
                if (inverterQuantity < 1) inverterQuantity = 1;
                // Tính tổng giá biến tần = số lượng × đơn giá
                inverterTotalPrice = inverterQuantity * selectedInverter.price;
                
                console.log(`Tính số lượng biến tần: Hệ thống ${systemSizeKw}kWp (${systemSizeWatt}W), Biến tần ${selectedInverter.power}W (kéo tối đa ${maxPowerPerInverter}W), Cần ${inverterQuantity} bộ`);
            }
            
            // Tính sản lượng điện thực tế
            const actualDailyKwh = (panelCount * solarPanelWatt * peakSunHours) / 1000;
            const actualMonthlyKwh = actualDailyKwh * 30;
            
            // Tính giá tấm pin
            const panelTotalPrice = panelCount * solarPanelPrice;
            
            // Tính dung lượng pin lưu trữ cần thiết dựa trên thời gian sử dụng
            let batteryCapacityNeeded = 0;
            let batteryRatio = 0;
            if (formData.usageTime === 'day') {
                batteryRatio = 1/3; // Dùng ban ngày nhiều: pin = 1/3 điện tạo ra
                batteryCapacityNeeded = actualDailyKwh * batteryRatio; // 1/3 điện tạo ra
            } else if (formData.usageTime === 'balanced') {
                batteryRatio = 1/2; // Dùng cả ngày đều: pin = 1/2 điện tạo ra
                batteryCapacityNeeded = actualDailyKwh * batteryRatio;
            } else if (formData.usageTime === 'night') {
                batteryRatio = 3/5; // Dùng ban đêm nhiều: pin = 3/5 điện tạo ra
                batteryCapacityNeeded = actualDailyKwh * batteryRatio;
            }
            
            // Lấy thông tin pin từ dropdown option (người dùng chọn)
            const batterySelect = document.querySelector('select[name="batteryType"]');
            const selectedBatteryOption = batterySelect.options[batterySelect.selectedIndex];
            const batteryProductId = parseInt(selectedBatteryOption.getAttribute('data-product-id'));
            const batteryPrice = parseFloat(selectedBatteryOption.getAttribute('data-price'));
            const batteryImage = selectedBatteryOption.getAttribute('data-image');
            const batteryTitle = selectedBatteryOption.getAttribute('data-title');
            // Dung lượng 1 bộ (kWh)
            let batteryUnitCapacity = parseFloat(selectedBatteryOption.getAttribute('data-capacity-kwh')) || 0;
            if (!batteryUnitCapacity) {
                // Fallback: cố gắng bắt từ title (kWh hoặc kW) nếu chưa có
                const titleCap = (batteryTitle || '').match(/(\d+\.?\d*)\s*kW(h)?/i);
                if (titleCap) {
                    batteryUnitCapacity = parseFloat(titleCap[1]);
                }
            }
            
            // Tạo object selectedBattery từ dropdown
            // Tính số bộ pin cần, cho phép sai số nhỏ (epsilon) để tránh làm tròn lên khi gần bằng
            const EPS = 1e-3; // 0.001 kWh
            const selectedBatteryUnits = batteryUnitCapacity > 0
                ? Math.max(1, Math.ceil((batteryCapacityNeeded - EPS) / batteryUnitCapacity))
                : 1;
            const selectedBattery = {
                name: batteryTitle || 'Pin lưu trữ',
                capacity: batteryUnitCapacity, // Dung lượng 1 bộ kWh
                units: selectedBatteryUnits,
                price: batteryPrice,
                totalPrice: selectedBatteryUnits * batteryPrice,
                warranty: "10 năm",
                image: batteryImage
            };
            
            // Chọn tủ điện phù hợp với biến tần
            // Logic tương tự inverter: nếu chọn 1 pha → lấy tủ 1 pha hoặc both, nếu chọn 3 pha → lấy tủ 3 pha hoặc both
            let selectedCabinet;
            let cabinetAlternatives = [];
            let availableCabinets = [];
            
            if (formData.phase === '1') {
                // Lấy cả tủ điện 1 pha và both
                availableCabinets = [
                    ...(electricalCabinets['1'] || []),
                    ...(electricalCabinets['both'] || [])
                ];
            } else if (formData.phase === '3') {
                // Lấy cả tủ điện 3 pha và both
                availableCabinets = [
                    ...(electricalCabinets['3'] || []),
                    ...(electricalCabinets['both'] || [])
                ];
            }
            
            if (availableCabinets.length > 0) {
                // Chuẩn hóa và sắp xếp tăng dần theo công suất để chọn NHỎ NHẤT thỏa điều kiện
                availableCabinets = availableCabinets.map(c => ({...c, power: Number(c.power || 0)}))
                    .sort((a,b)=>a.power-b.power);
                const minPower = availableCabinets.filter(c => c.power >= selectedInverter.power)
                    .reduce((min, c) => Math.min(min, c.power), Infinity);
                cabinetAlternatives = availableCabinets.filter(c => c.power >= selectedInverter.power && c.power === minPower);
                selectedCabinet = cabinetAlternatives[0] || availableCabinets[availableCabinets.length-1];
                console.log('Selected Cabinet:', selectedCabinet.name, 'ID:', selectedCabinet.id, 'alts:', cabinetAlternatives.map(c=>c.name));
            } else {
                // Fallback nếu không có tủ điện phù hợp
                selectedCabinet = { id: 0, name: "Không có tủ điện phù hợp", power: 0, price: 0, image: "../assets/img/products/electrical-cabinet.jpg" };
            }
            
            // Xây dựng danh sách phụ kiện: ưu tiên dynamicAccessories từ Admin; luôn thêm Tủ điện + Công thợ + Vận chuyển
            const baseAccessoryList = (Array.isArray(dynamicAccessories) && dynamicAccessories.length > 0) ? dynamicAccessories : accessories;

            // Chỉ hiển thị các phụ kiện được cấu hình (không gộp Tủ điện vào nhóm phụ kiện)
            const accessoriesWithCabinet = [...baseAccessoryList];
            
            // Tính phụ kiện dựa trên số tấm pin
            const calculatedAccessories = accessoriesWithCabinet.map(acc => {
                let quantity = acc.quantity;
                let displayName = acc.name;
                const isDynamic = typeof acc.baseQty !== 'undefined' || typeof acc.depQty !== 'undefined';
                
                // Tính toán số lượng theo từng loại phụ kiện
                if (isDynamic) {
                    const depTarget = (acc.depTarget || 'project');
                    
                    // KIỂM TRA DEPENDENCIES: Nếu có dependent_product_ids, chỉ thêm khi sản phẩm được chọn nằm trong danh sách
                    // dependent_product_ids chứa product_id (từ bảng products), không phải config_id
                    if (acc.dependentProductIds && Array.isArray(acc.dependentProductIds) && acc.dependentProductIds.length > 0) {
                        let shouldInclude = false;
                        
                        if (depTarget === 'inverter') {
                            // Kiểm tra inverter được chọn - selectedInverter.id là product_id
                            const inverterProductId = selectedInverter?.id || selectedInverter?.product_id;
                            shouldInclude = inverterProductId && acc.dependentProductIds.includes(inverterProductId);
                        } else if (depTarget === 'panel') {
                            // Kiểm tra tấm pin được chọn - solarPanelProductId là product_id
                            shouldInclude = solarPanelProductId && acc.dependentProductIds.includes(solarPanelProductId);
                        } else if (depTarget === 'battery') {
                            // Kiểm tra pin lưu trữ được chọn - batteryProductId là product_id
                            shouldInclude = batteryProductId && acc.dependentProductIds.includes(batteryProductId);
                        } else if (depTarget === 'cabinet') {
                            // Kiểm tra tủ điện được chọn - selectedCabinet.id có thể là product_id hoặc config_id
                            // Cần kiểm tra cả 2 trường hợp
                            const cabinetProductId = selectedCabinet?.product_id || null;
                            shouldInclude = cabinetProductId && acc.dependentProductIds.includes(cabinetProductId);
                        }
                        
                        // Nếu không khớp, bỏ qua phụ kiện này (sẽ return null và filter sau)
                        if (!shouldInclude) {
                            return null;
                        }
                    }
                    
                    // TÍNH SỐ LƯỢNG với logic hệ số phụ thuộc
                    let targetCount = 1;
                    if (depTarget === 'panel') targetCount = panelCount;
                    else if (depTarget === 'inverter') targetCount = 1; // Chỉ tính 1 lần cho inverter được chọn
                    else if (depTarget === 'battery') targetCount = selectedBatteryUnits;
                    else if (depTarget === 'cabinet') targetCount = 1;
                    else targetCount = 1; // project
                    
                    const baseQty = Number(acc.baseQty || 0);
                    const depQty = Number(acc.depQty || 0);
                    
                    // Logic hệ số phụ thuộc = 0: Luôn dùng số lượng bản thân, bất kể có bao nhiêu sản phẩm phụ thuộc
                    if (depQty === 0) {
                        quantity = baseQty; // Luôn = số lượng bản thân
                    } else if (depTarget === 'project') {
                        quantity = baseQty; // Project không phụ thuộc
                    } else {
                        // Hệ số != 0: Tính theo công thức
                        quantity = baseQty * targetCount * (depQty || 1);
                    }
                    displayName = acc.name;
                } else {
                    if (acc.name.includes("Bách Z")) {
                        quantity = panelCount * 6; // 6 cái/tấm
                        displayName = acc.name + " (6 cái/tấm)";
                    }
                    if (acc.name.includes("Kẹp Biên")) {
                        quantity = panelCount * 6; // 6 bộ/tấm
                        displayName = acc.name + " (6 bộ/tấm)";
                    }
                    if (acc.name.includes("MC4")) {
                        quantity = panelCount + 3; // Số tấm pin + 3
                        displayName = acc.name + " (Số tấm + 3)";
                    }
                    if (acc.name.includes("Dây Điện (AC/DC)")) {
                        quantity = 100; // Dự trù 100m
                        displayName = acc.name + " (Dự trù 100m, tùy công trình)";
                    }
                }
                if (acc.name.includes("Tủ Điện Hybrid")) {
                    quantity = 1; // 1 tủ/dự án
                    displayName = acc.name;
                }
                if (acc.name.includes("Công Thợ Lắp Đặt")) {
                    quantity = 1; // 1 gói lắp đặt
                    // Tính giá nhân công: ≤16 tấm = 6 triệu, >16 tấm = 6 triệu + (số tấm - 16) × 300k
                    let laborPrice = 6000000; // Giá cơ bản cho ≤16 tấm
                    if (panelCount > 16) {
                        laborPrice = 6000000 + (panelCount - 16) * 300000;
                    }
                    // Cập nhật giá cho item này
                    acc.price = laborPrice;
                    displayName = acc.name;
                }
                if (acc.name.includes("Vận Chuyển")) {
                    quantity = 1; // 1 chuyến
                    displayName = acc.name;
                }
                
                return {
                    ...acc,
                    name: displayName,
                    quantity: quantity,
                    totalPrice: quantity * acc.price
                };
            }).filter(acc => acc !== null); // Lọc bỏ các phụ kiện không khớp với dependencies

            // Đảm bảo luôn có Công thợ và Vận chuyển nếu chưa có trong danh sách dynamic
            const names = calculatedAccessories.map(a => a.name);
            if (!names.some(n => n.includes('Công Thợ'))) {
                // tính theo panelCount
                let laborPrice = 6000000;
                if (panelCount > 16) laborPrice = 6000000 + (panelCount - 16) * 300000;
                calculatedAccessories.push({ name: 'Công Thợ Lắp Đặt Trọn Gói', unit: 'dự án', price: laborPrice, quantity: 1, image: '🔧', totalPrice: laborPrice });
            }
            if (!names.some(n => n.includes('Vận Chuyển'))) {
                calculatedAccessories.push({ name: 'Vận Chuyển Đến Công Trình', unit: 'chuyến', price: 0, quantity: 1, image: '🚛', isTransport: true, totalPrice: 0 });
            }
            
            const accessoriesTotal = calculatedAccessories.reduce((sum, acc) => sum + acc.totalPrice, 0);
            
            // Tổng cộng (đã bao gồm tất cả 12 thành phần)
            // Tổng giá = Thiết bị (tấm pin + inverter + tủ điện + pin lưu trữ) + Phụ kiện
            // inverterQuantity và inverterTotalPrice đã được tính ở trên
            const deviceTotal = panelTotalPrice + inverterTotalPrice + (selectedCabinet?.price || 0) + selectedBattery.totalPrice;
            const totalPrice = deviceTotal + accessoriesTotal;
            
            // Tính tiết kiệm hàng năm (tiết kiệm 80% tiền điện)
            const annualSavings = monthlyBill * 12 * 0.8;
            const paybackPeriod = Math.ceil(totalPrice / annualSavings);
            
            // Tính tiết kiệm mỗi tháng
            const monthlySavings = monthlyBill * 0.8;
            
            return {
                monthlyKwh,
                monthlyBill,
                kwhBreakdown: kwhCalculation.breakdown, // Chi tiết phân bổ từng bậc
                systemSizeKw: systemSizeKwDisplay,
                systemSizeWatt,
                panelCount,
                solarPanelWatt,
                solarPanelPrice,
                solarPanelImage,
                solarPanelProductId, // Product ID của tấm pin
                panelTotalPrice,
                roofArea,
                selectedInverter,
                inverterQuantity, // Số lượng biến tần cần thiết
                inverterTotalPrice, // Tổng giá biến tần (số lượng × đơn giá)
                selectedCabinet,
                cabinetAlternatives,
                selectedBattery,
                batteryProductId, // Product ID của pin lưu trữ
                batteryCapacityNeeded,
                batteryRatio,
                actualDailyKwh,
                actualMonthlyKwh,
                accessories: calculatedAccessories,
                accessoriesTotal,
                totalPrice,
                annualSavings,
                monthlySavings,
                paybackPeriod,
                dailyKwh,
                peakSunHours,
                solarPanelName: selectedOption.textContent.split(' - ')[0],
                region: formData.region,
                phase: formData.phase,
                usageTime: formData.usageTime,
                userSelectedInverter: userSelectedInverter // Flag indicating if inverter was manually selected
            };
        }

        // Xử lý form submit
        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Validate form
            if (!data.fullname || !data.phone || !data.email || !data.region || !data.phase || 
                !data.solarPanel || !data.monthlyBill || !data.usageTime) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            // Validate inverter selection
            const inverterSelect = document.getElementById('inverterSelect');
            const selectedInverter = inverterSelect?.value;
            if (!selectedInverter || selectedInverter === '') {
                alert('Vui lòng chọn biến tần!');
                if (inverterSelect) {
                    inverterSelect.focus();
                    inverterSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            // Validate email format
            const emailPattern = /^[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]{2,}$/i;
            if (!emailPattern.test(data.email)) {
                alert('Vui lòng nhập địa chỉ email hợp lệ.');
                const emailInput = document.getElementById('survey-email');
                if (emailInput) {
                    emailInput.focus();
                    emailInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            // Validate phone number (10 digits, starts with 0)
            const phoneRegex = /^0[0-9]{9}$/;
            if (!phoneRegex.test(data.phone)) {
                alert('Số điện thoại phải có đúng 10 số và bắt đầu bằng số 0.');
                // Scroll to phone input
                const phoneInput = document.getElementById('survey-phone');
                if (phoneInput) {
                    phoneInput.focus();
                    phoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            // Tính toán
            const result = calculateSolarSystem(data);
            
            // Hiển thị kết quả
            displayResults(result, data);
            
            // Tự động gửi email với toàn bộ dữ liệu
            sendSurveyEmailToAdmin(data, result);
        });

        // Helper functions for accessory descriptions
        function getAccessoryDescription(name) {
            const descriptions = {
                'Tủ Điện Hybrid': 'Tủ điện điều khiển và bảo vệ hệ thống điện mặt trời, chứa các thiết bị đóng cắt, bảo vệ và giám sát',
                'Bách Z Mạ Kẽm': 'Thanh ray nhôm mạ kẽm để lắp đặt và định vị tấm pin mặt trời trên mái nhà',
                'Kẹp Biên & Kẹp Giữa': 'Phụ kiện kẹp giữ tấm pin mặt trời, đảm bảo tấm pin được cố định chắc chắn',
                'Jack Cắm MC4': 'Đầu nối MC4 chuẩn quốc tế để kết nối các tấm pin mặt trời với nhau',
                'Dây Điện (AC/DC)': 'Dây điện chuyên dụng cho hệ thống điện mặt trời, chịu được tải cao và thời tiết',
                'Công Thợ Lắp Đặt Trọn Gói': 'Dịch vụ lắp đặt hoàn chỉnh bao gồm nhân công, thiết kế, khảo sát và giám sát',
                'Vận Chuyển Đến Công Trình': 'Dịch vụ vận chuyển thiết bị từ kho đến công trình lắp đặt'
            };
            return descriptions[name] || 'Phụ kiện hỗ trợ cho hệ thống điện mặt trời';
        }
        
        function getAccessoryCalculation(name, quantity, panelCount) {
            const calculations = {
                'Tủ Điện Hybrid': '1 tủ điện cho mỗi hệ thống, được chọn phù hợp với công suất biến tần',
                'Bách Z Mạ Kẽm': `${quantity} cái = ${panelCount} tấm × 6 cái/tấm (thanh ray định vị)`,
                'Kẹp Biên & Kẹp Giữa': `${quantity} bộ = ${panelCount} tấm × 6 bộ/tấm (kẹp giữ tấm pin)`,
                'Jack Cắm MC4': `${quantity} bộ = ${panelCount} tấm + 3 bộ dự phòng (đầu vào + đầu ra + dự phòng)`,
                'Dây Điện (AC/DC)': `${quantity}m dự trù cho toàn bộ hệ thống, có thể điều chỉnh theo thực tế`,
                'Công Thợ Lắp Đặt Trọn Gói': '1 gói dịch vụ hoàn chỉnh cho toàn bộ hệ thống',
                'Vận Chuyển Đến Công Trình': '1 chuyến vận chuyển tất cả thiết bị đến công trình'
            };
            return calculations[name] || `Số lượng: ${quantity}`;
        }

        // Hiển thị kết quả
        function displayResults(result, formData) {
            const resultsDiv = document.getElementById('results');
            const placeholder = document.querySelector('.results-placeholder');
            
            // Ẩn placeholder
            placeholder.style.display = 'none';
            
            // Tạo HTML cho bảng phụ kiện chi tiết
            let accessoriesHTML = '';
            result.accessories.forEach(acc => {
                    // Special handling for transport (Vận chuyển)
                    const isTransport = acc.isTransport || acc.name === 'Vận Chuyển Đến Công Trình';
                    
                    accessoriesHTML += `
                        <tr>
                            <td class="center">${(acc.image && (acc.image.includes('../') || acc.image.startsWith('/') || acc.image.startsWith('http'))) ? 
                                `<img src="${acc.image}" alt="${acc.name}" style="width: 50px; height: 50px; object-fit: contain; border-radius: 6px; padding: 3px; background: #f7fafc;">` : 
                                `<span style="font-size: 30px; display: block; text-align: center; padding: 10px;">${acc.image || '📦'}</span>`
                            }</td>
                            <td class="label-col">
                                <div style="line-height: 1.4;">
                                    <strong style="color: #2d3748; font-size: 1rem;">${acc.name}</strong><br>
                                    <div style="margin: 0.3rem 0; padding: 0.4rem; background: rgba(63,163,77,0.08); border-radius: 4px; border-left: 2px solid #3FA34D;">
                                        <small style="color: #4a5568; font-weight: 600;">📝 Mô tả:</small><br>
                                        <small style="color: #718096;">${getAccessoryDescription(acc.name)}</small>
                                    </div>
                                    ${isTransport ? `
                                        <div style="margin: 0.3rem 0; padding: 0.4rem; background: rgba(255,152,0,0.1); border-radius: 4px; border-left: 2px solid #ff9800;">
                                            <small style="color: #e65100; font-weight: 600;">⚠️ Lưu ý:</small><br>
                                            <small style="color: #f57c00;">Chi phí vận chuyển tùy thuộc vào khoảng cách từ kho đến công trình</small>
                                        </div>
                                    ` : `
                                        <div style="margin: 0.3rem 0; padding: 0.4rem; background: rgba(255,193,7,0.08); border-radius: 4px; border-left: 2px solid #ffc107;">
                                            <small style="color: #4a5568; font-weight: 600;">🧮 Cách tính:</small><br>
                                            <small style="color: #718096;">${getAccessoryCalculation(acc.name, acc.quantity, result.panelCount)}</small>
                                        </div>
                                    `}
        </div>
                            </td>
                            <td class="center">${acc.quantity} ${acc.unit}</td>
                            <td class="price-col">${isTransport ? '<span style="color: #ff9800; font-style: italic;">Tùy xa gần</span>' : acc.price.toLocaleString() + 'đ'}</td>
                            <td class="price-col">${isTransport ? '<span style="color: #ff9800; font-style: italic;">Tùy xa gần</span>' : acc.totalPrice.toLocaleString() + 'đ'}</td>
                        </tr>
                    `;
            });
            
            // Tên khu vực
            const regionName = {
                'mien-bac': 'Miền Bắc',
                'mien-trung': 'Miền Trung',
                'mien-nam': 'Miền Nam'
            }[result.region] || '';
            
            // Thời gian sử dụng
            const usageTimeName = {
                'day': 'Ban ngày nhiều',
                'balanced': 'Cả ngày đều',
                'night': 'Ban đêm nhiều'
            }[result.usageTime] || '';
            
            // Hiển thị kết quả
            resultsDiv.innerHTML = `
                <div class="results-grid">
                    <div class="results-column">
                        <!-- Thông tin khách hàng & hệ thống -->
                        <div class="section-header">
                            <h3>👤 Thông Tin Khách Hàng</h3>
                        </div>
                        <table class="excel-table">
                            <tbody>
                                <tr>
                                    <td class="label-col">Họ và tên</td>
                                    <td class="value-col">${formData.fullname}</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Số điện thoại</td>
                                    <td class="value-col">${formData.phone}</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Khu vực</td>
                                    <td class="value-col">${regionName}</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Loại điện</td>
                                    <td class="value-col">${result.phase === 'both' ? 'Cả 2 pha' : result.phase + ' pha'}</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Thời gian sử dụng điện</td>
                                    <td class="value-col">${usageTimeName}</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Phân tích nhu cầu -->
                        <div class="section-header">
                            <h3>📊 Phân Tích Nhu Cầu</h3>
                        </div>
                        
                        <!-- Bảng chi tiết tính kWh từ tiền điện -->
                        <div style="background: linear-gradient(135deg, rgba(63,163,77,0.08) 0%, rgba(168,224,99,0.08) 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 2px solid rgba(63,163,77,0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem;">
                                <span style="font-size: 1.2rem;">⚡</span>
                                <strong style="color: #3FA34D; font-size: 0.95rem;">Chi Tiết Tính Toán Số kWh Từ Tiền Điện</strong>
                            </div>
                            <table class="excel-table" style="font-size: 0.9rem;">
                                <thead>
                                    <tr>
                                        <th>Bậc Thang</th>
                                        <th class="right">Giá/kWh</th>
                                        <th class="right">Sản Lượng (kWh)</th>
                                        <th class="right">Thành Tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.kwhBreakdown.map(tier => `
                                        <tr>
                                            <td class="label-col">${tier.name}</td>
                                            <td class="right">${tier.pricePerKwh.toLocaleString()}đ</td>
                                            <td class="right"><strong>${tier.kwh.toFixed(2)}</strong></td>
                                            <td class="price-col">${Math.round(tier.amount).toLocaleString()}đ</td>
                                        </tr>
                                    `).join('')}
                                    <tr style="background: rgba(63,163,77,0.15); font-weight: 700; font-size: 1.05em;">
                                        <td class="label-col">TỔNG CỘNG</td>
                                        <td></td>
                                        <td class="right" style="color: #1E5631;">${result.monthlyKwh.toFixed(1)} kWh</td>
                                        <td class="price-col" style="color: #1E5631;">${result.monthlyBill.toLocaleString()}đ</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div style="margin-top: 0.6rem; font-size: 0.8rem; color: #718096; display: flex; align-items: start; gap: 0.3rem;">
                                <span>💡</span>
                                <span>Tính toán dựa trên bảng giá điện sinh hoạt EVN áp dụng từ ${new Date(electricityPricesEffectiveDate).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })} (đã bao gồm VAT 8%)</span>
                            </div>
        </div>
                        
                        <!-- Tóm tắt phân tích -->
                        <table class="excel-table">
                            <tbody>
                                <tr>
                                    <td class="label-col">Hóa đơn điện/tháng</td>
                                    <td class="price-col">${result.monthlyBill.toLocaleString()}đ</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Mức tiêu thụ điện/tháng</td>
                                    <td class="value-col"><strong style="color: #3FA34D;">${result.monthlyKwh.toFixed(1)} kWh</strong></td>
                                </tr>
                                <tr>
                                    <td class="label-col">Tiêu thụ điện/ngày</td>
                                    <td class="value-col">${result.dailyKwh.toFixed(1)} kWh</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Giờ nắng trung bình (${regionName})</td>
                                    <td class="value-col">${result.peakSunHours} giờ/ngày</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Diện tích mái cần thiết</td>
                                    <td class="value-col">${result.roofArea} m²</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- BẢNG BÁO GIÁ CHI TIẾT -->
                        <div class="section-header" style="margin-top: 2rem;">
                            <h3>📋 BẢNG BÁO GIÁ CHI TIẾT HỆ THỐNG ĐIỆN MẶT TRỜI</h3>
                        </div>
                        
                        <!-- 1. Tấm pin -->
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th class="center" style="width: 80px">Ảnh</th>
                                    <th style="width: 40%">Tên thiết bị</th>
                                    <th class="center" style="width: 12%">Số lượng</th>
                                    <th class="right" style="width: 17%">Đơn giá</th>
                                    <th class="right" style="width: 17%">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: linear-gradient(135deg, rgba(0,200,81,0.1) 0%, rgba(105,240,174,0.1) 100%); border: 2px solid rgba(0,200,81,0.3);">
                                    <td colspan="5" class="label-col" style="font-weight: 800; color: var(--color-primary); font-size: 1.1rem; padding: 1rem;">
                                        <span style="font-size: 1.3em; margin-right: 0.5rem;">⚡</span> Tấm Pin Mặt Trời
                                        <div style="font-size: 0.8rem; color: #4a5568; margin-top: 0.3rem; font-weight: 500;">Thiết bị chính tạo ra điện từ năng lượng mặt trời</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="center"><img src="${result.solarPanelImage}" alt="${result.solarPanelName}" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; padding: 4px; background: #f7fafc;"></td>
                                    <td class="label-col">
                                        <div style="line-height: 1.4;">
                                            <strong style="color: #2d3748; font-size: 1.05rem;">${result.solarPanelName}</strong><br>
                                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(63,163,77,0.1); border-radius: 6px; border-left: 3px solid #3FA34D;">
                                                <small style="color: #4a5568; font-weight: 600;">📊 Thông số kỹ thuật:</small><br>
                                                <small style="color: #718096;">• Công suất: ${result.solarPanelWatt}W/tấm</small><br>
                                                <small style="color: #718096;">• Diện tích: ${result.solarPanelWatt === 590 ? '2,583m²' : '2,702m²'}/tấm</small><br>
                                                <small style="color: #718096;">• Bảo hành: 12 năm</small>
                                            </div>
                                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,193,7,0.1); border-radius: 6px; border-left: 3px solid #ffc107;">
                                                <small style="color: #4a5568; font-weight: 600;">🧮 Cách tính số tấm:</small><br>
                                                <small style="color: #718096;">• Nhu cầu: ${result.dailyKwh.toFixed(1)}kWh/ngày</small><br>
                                                <small style="color: #718096;">• Giờ nắng: ${result.peakSunHours}h/ngày</small><br>
                                                <small style="color: #718096;">• Công suất cần: ${result.dailyKwh.toFixed(1)} ÷ ${result.peakSunHours} = ${result.systemSizeKw}kWp</small><br>
                                                <small style="color: #718096;">• Số tấm: ${result.systemSizeKw}kW ÷ ${(result.solarPanelWatt/1000).toFixed(2)}kW = ${result.panelCount} tấm</small>
                                            </div>
                                            
                                            <small style="color: #3FA34D; font-weight: 600;">💰 Giá lắp đặt trọn gói</small>
                                        </div>
                                    </td>
                                    <td class="center">${result.panelCount} tấm</td>
                                    <td class="price-col">${result.solarPanelPrice.toLocaleString()}đ</td>
                                    <td class="price-col"><strong>${result.panelTotalPrice.toLocaleString()}đ</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- 2. Inverter (Biến tần) -->
                        <table class="excel-table" style="margin-top: 1rem;">
                            <tbody>
                                <tr style="background: linear-gradient(135deg, rgba(0,200,81,0.1) 0%, rgba(105,240,174,0.1) 100%); border: 2px solid rgba(0,200,81,0.3);">
                                    <td colspan="5" class="label-col" style="font-weight: 800; color: var(--color-primary); font-size: 1.1rem; padding: 1rem;">
                                        <span style="font-size: 1.3em; margin-right: 0.5rem;">🔌</span> Biến Tần (Inverter)
                                        <div style="font-size: 0.8rem; color: #4a5568; margin-top: 0.3rem; font-weight: 500;">Chuyển đổi dòng điện DC từ tấm pin thành AC cho gia đình</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="center" style="width: 80px"><img src="${result.selectedInverter.image}" alt="${result.selectedInverter.name}" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; padding: 4px; background: #f7fafc;"></td>
                                    <td class="label-col" style="width: 40%">
                                        <div style="line-height: 1.4;">
                                            <strong style="color: #2d3748; font-size: 1.05rem;">${result.selectedInverter.name}</strong><br>
                                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(63,163,77,0.1); border-radius: 6px; border-left: 3px solid #3FA34D;">
                                                <small style="color: #4a5568; font-weight: 600;">📊 Thông số kỹ thuật:</small><br>
                                                <small style="color: #718096;">• Công suất: ${result.selectedInverter.power}W</small><br>
                                                <small style="color: #718096;">• Loại điện: ${result.selectedInverter.phase === '1' ? '1 Pha' : result.selectedInverter.phase === '3' ? '3 Pha' : 'Cả 2 Pha'}</small><br>
                                                <small style="color: #718096;">• Bảo hành: ${result.selectedInverter.warranty}</small>
                                            </div>
                                            
                                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(33,150,243,0.1); border-radius: 6px; border-left: 3px solid #2196f3;">
                                                <small style="color: #4a5568; font-weight: 600;">${result.userSelectedInverter ? '✅ Biến tần bạn đã chọn:' : '🎯 Biến tần được chọn tự động:'}</small><br>
                                                <small style="color: #718096;">• Hệ thống cần: ${result.systemSizeKw}kWp (${result.systemSizeWatt.toLocaleString()}W)</small><br>
                                                <small style="color: #718096;">• Biến tần: ${result.selectedInverter.power}W (kéo tối đa ≈ ${(result.selectedInverter.power*1.5/1000).toFixed(1)}kWp = ${(result.selectedInverter.power*1.5).toLocaleString()}W)</small><br>
                                                <small style="color: #718096;">• Số lượng cần: ${result.systemSizeKw}kWp ÷ ${(result.selectedInverter.power*1.5/1000).toFixed(1)}kWp/bộ = <strong>${result.inverterQuantity} bộ</strong></small><br>
                                                <small style="color: #718096;">• Phù hợp với loại điện ${result.selectedInverter.phase === '1' ? '1 pha' : result.selectedInverter.phase === '3' ? '3 pha' : 'cả 2 pha'} đã chọn</small>
                                            </div>
                                            <small style="color: #3FA34D; font-weight: 600;">💰 Giá lắp đặt trọn gói</small>
                                        </div>
                                    </td>
                                    <td class="center" style="width: 12%">${result.inverterQuantity} bộ</td>
                                    <td class="price-col" style="width: 17%">${result.selectedInverter.price.toLocaleString()}đ</td>
                                    <td class="price-col" style="width: 17%"><strong>${result.inverterTotalPrice.toLocaleString()}đ</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- 3. Tủ điện -->
                        <table class="excel-table" style="margin-top: 1rem;">
                            <tbody>
                                <tr style="background: linear-gradient(135deg, rgba(0,200,81,0.1) 0%, rgba(105,240,174,0.1) 100%); border: 2px solid rgba(0,200,81,0.3);">
                                    <td colspan="5" class="label-col" style="font-weight: 800; color: var(--color-primary); font-size: 1.1rem; padding: 1rem;">
                                        <span style="font-size: 1.3em; margin-right: 0.5rem;">🧰</span> Tủ Điện Hybrid
                                        <div style="font-size: 0.8rem; color: #4a5568; margin-top: 0.3rem; font-weight: 500;">Tủ phân phối và bảo vệ, phù hợp với công suất biến tần</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="center" style="width: 80px"><img src="${result.selectedCabinet.image}" alt="${result.selectedCabinet.name}" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; padding: 4px; background: #f7fafc;"></td>
                                    <td class="label-col" style="width: 40%">
                                        <div style="line-height: 1.4;">
                                            <strong style="color: #2d3748; font-size: 1.05rem;">${result.selectedCabinet.name}</strong><br>
                                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(63,163,77,0.1); border-radius: 6px; border-left: 3px solid #3FA34D;">
                                                <small style="color: #4a5568; font-weight: 600;">📊 Thông số:</small><br>
                                                <small style="color: #718096;">• Công suất hỗ trợ: ${result.selectedCabinet.power}W</small><br>
                                                <small style="color: #718096;">• Khuyến nghị cho inverter: ≥ ${result.selectedInverter.power}W</small>
                                            </div>
                                            
                                            <small style="color: #3FA34D; font-weight: 600;">💰 Giá lắp đặt trọn gói</small>
                                        </div>
                                    </td>
                                    <td class="center" style="width: 12%">1 cái</td>
                                    <td class="price-col" style="width: 17%">${result.selectedCabinet.price.toLocaleString()}đ</td>
                                    <td class="price-col" style="width: 17%"><strong>${result.selectedCabinet.price.toLocaleString()}đ</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- 4. Pin lưu trữ -->
                        <table class="excel-table" style="margin-top: 1rem;">
                            <tbody>
                                <tr style="background: linear-gradient(135deg, rgba(0,200,81,0.1) 0%, rgba(105,240,174,0.1) 100%); border: 2px solid rgba(0,200,81,0.3);">
                                    <td colspan="5" class="label-col" style="font-weight: 800; color: var(--color-primary); font-size: 1.1rem; padding: 1rem;">
                                        <span style="font-size: 1.3em; margin-right: 0.5rem;">🔋</span> Pin Lưu Trữ (Battery)
                                        <div style="font-size: 0.8rem; color: #4a5568; margin-top: 0.3rem; font-weight: 500;">Lưu trữ điện để sử dụng khi không có nắng</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="center" style="width: 80px"><img src="${result.selectedBattery.image}" alt="${result.selectedBattery.name}" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; padding: 4px; background: #f7fafc;"></td>
                                    <td class="label-col" style="width: 40%">
                                        <div style="line-height: 1.4;">
                                            <strong style="color: #2d3748; font-size: 1.05rem;">${result.selectedBattery.name}</strong><br>
                                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(63,163,77,0.1); border-radius: 6px; border-left: 3px solid #3FA34D;">
                                            <small style="color: #4a5568; font-weight: 600;">📊 Thông số kỹ thuật:</small><br>
                                            <small style="color: #718096;">• Dung lượng 1 bộ: ${result.selectedBattery.capacity} kWh</small><br>
                                                <small style="color: #718096;">• Bảo hành: ${result.selectedBattery.warranty}</small>
                                            </div>
                                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(156,39,176,0.1); border-radius: 6px; border-left: 3px solid #9c27b0;">
                                                <small style="color: #4a5568; font-weight: 600;">🧮 Cách tính dung lượng pin:</small><br>
                                                <small style="color: #718096;">• Điện tạo ra: ${result.actualDailyKwh.toFixed(1)}kWh/ngày</small><br>
                                                <small style="color: #718096;">• Thời gian dùng: ${usageTimeName}</small><br>
                                                <small style="color: #718096;">• Tỷ lệ pin: ${(result.batteryRatio * 100).toFixed(0)}% điện tạo ra</small><br>
                                                <small style="color: #718096;">• Pin cần: ${result.actualDailyKwh.toFixed(1)} × ${result.batteryRatio} = ${result.batteryCapacityNeeded.toFixed(2)}kWh</small><br>
                                                <small style="color: #718096;">• Chọn pin: ${result.selectedBattery.units} bộ × ${result.selectedBattery.capacity}kWh = ${(result.selectedBattery.units * result.selectedBattery.capacity).toFixed(2)}kWh ${ (result.selectedBattery.units * result.selectedBattery.capacity) + 1e-6 >= result.batteryCapacityNeeded ? '(≥' : '(<'} ${result.batteryCapacityNeeded.toFixed(2)}kWh${ (result.selectedBattery.units * result.selectedBattery.capacity) + 1e-6 >= result.batteryCapacityNeeded ? ')' : ')'} </small>
                                            </div>
                                            
                                            <small style="color: #3FA34D; font-weight: 600;">💰 Giá lắp đặt trọn gói</small>
                                        </div>
                                    </td>
                                    <td class="center" style="width: 12%">${result.selectedBattery.units} bộ</td>
                                    <td class="price-col" style="width: 17%">${result.selectedBattery.price.toLocaleString()}đ</td>
                                    <td class="price-col" style="width: 17%"><strong>${result.selectedBattery.totalPrice.toLocaleString()}đ</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- 5. Phụ kiện & Vật Tư Lắp Đặt -->
                        <table class="excel-table" style="margin-top: 1rem;">
                            <tbody>
                                <tr style="background: linear-gradient(135deg, rgba(0,200,81,0.1) 0%, rgba(105,240,174,0.1) 100%); border: 2px solid rgba(0,200,81,0.3);">
                                    <td colspan="5" class="label-col" style="font-weight: 800; color: var(--color-primary); font-size: 1.1rem; padding: 1rem;">
                                        <span style="font-size: 1.3em; margin-right: 0.5rem;">🔧</span> Phụ Kiện & Vật Tư Lắp Đặt
                                        <div style="font-size: 0.8rem; color: #4a5568; margin-top: 0.3rem; font-weight: 500;">Các thiết bị phụ trợ và dịch vụ lắp đặt hoàn chỉnh</div>
                                    </td>
                                </tr>
                                ${accessoriesHTML}
                                <tr style="background: rgba(168,224,99,0.1); font-weight: 600;">
                                    <td class="label-col" colspan="4">Tổng phụ kiện</td>
                                    <td class="price-col"><strong>${result.accessoriesTotal.toLocaleString()}đ</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Tổng cộng -->
                        <div class="section-header" style="margin-top: 2rem;">
                            <h3>💰 Tổng Kết Chi Phí</h3>
                        </div>
                        <table class="excel-table">
                            <tbody>
                                <tr>
                                    <td class="label-col">Tổng thiết bị</td>
                                    <td class="price-col">${(result.totalPrice - result.accessoriesTotal).toLocaleString()}đ</td>
                                </tr>
                                <tr>
                                    <td class="label-col">Phụ kiện & lắp đặt</td>
                                    <td class="price-col">${result.accessoriesTotal.toLocaleString()}đ</td>
                                </tr>
                                <tr style="background: linear-gradient(135deg, rgba(63,163,77,0.15) 0%, rgba(168,224,99,0.15) 100%); font-weight: 700; font-size: 1.1em;">
                                    <td class="label-col" style="color: #1E5631;">TỔNG CHI PHÍ ĐẦU TƯ</td>
                                    <td class="price-col" style="color: #1E5631; font-size: 1.2em;">${result.totalPrice.toLocaleString()}đ</td>
                                </tr>
                                <tr style="background: rgba(255,152,0,0.08);">
                                    <td colspan="2" class="label-col" style="padding: 0.8rem 1rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-size: 1.2rem;">⚠️</span>
                                            <span style="color: #e65100; font-weight: 600; font-size: 0.95rem;">
                                                Lưu ý: Báo giá chưa bao gồm chi phí vận chuyển đến công trình
                                            </span>
                                        </div>
                                        <div style="margin-top: 0.3rem; margin-left: 2rem;">
                                            <small style="color: #f57c00;">
                                                Chi phí vận chuyển sẽ được tính dựa trên khoảng cách từ kho đến công trình của bạn
                                            </small>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>
        </div>

                <!-- Tổng kết nổi bật -->
                <div class="total-summary">
                    <div class="summary-header">
                        <div class="summary-icon">🎯</div>
                        <h3>TỔNG QUAN HỆ THỐNG</h3>
                    </div>
                    
                    <div class="total-price-section">
                        <div class="price-label">Tổng đầu tư</div>
                        <div class="total-price">${result.totalPrice.toLocaleString()}đ</div>
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="card-icon">⚡</div>
                            <div class="card-content">
                                <div class="card-label">Hệ thống</div>
                                <div class="card-value">${result.systemSizeKw} kWp</div>
                            </div>
        </div>
                        
                        <div class="summary-card">
                            <div class="card-icon">📦</div>
                            <div class="card-content">
                                <div class="card-label">Tấm pin</div>
                                <div class="card-value">${result.panelCount} tấm</div>
                            </div>
        </div>
                        
                        <div class="summary-card">
                            <div class="card-icon">🔌</div>
                            <div class="card-content">
                                <div class="card-label">Inverter</div>
                                <div class="card-value">${result.inverterQuantity} bộ × ${(result.selectedInverter.power/1000).toFixed(1)}kW</div>
                            </div>
        </div>
                        
                        <div class="summary-card">
                            <div class="card-icon">🔋</div>
                            <div class="card-content">
                                <div class="card-label">Pin lưu trữ</div>
                                <div class="card-value">${(result.selectedBattery.units * result.selectedBattery.capacity).toFixed(2)} kWh (${result.selectedBattery.units} bộ)</div>
                            </div>
        </div>
                        
                        <div class="summary-card">
                            <div class="card-icon">💰</div>
                            <div class="card-content">
                                <div class="card-label">Tiết kiệm/năm</div>
                                <div class="card-value">${(result.annualSavings/1000000).toFixed(1)}M đ</div>
                            </div>
        </div>
                        
                        <div class="summary-card">
                            <div class="card-icon">⏱️</div>
                            <div class="card-content">
                                <div class="card-label">Hoàn vốn</div>
                                <div class="card-value">${result.paybackPeriod} năm</div>
                            </div>
        </div>
                    </div>
                    
                    <div class="summary-notes">
                        <div class="note-item">Giá thiết bị là giá lắp đặt trọn gói (đã bao gồm VAT)</div>
                        <div class="note-item">Tính toán dựa trên bảng giá điện EVN áp dụng từ ${new Date(electricityPricesEffectiveDate).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
                        <div class="note-item">Bảo hành tấm pin 12 năm, hiệu suất sau 25-30 năm ≥ 80%</div>
                    </div>
        </div>

                <!-- Nút lưu báo giá và mua gói -->
                <div style="text-align: center; margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button id="saveSurveyBtn" style="background: linear-gradient(135deg, #56ab2f 0%, #3FA34D 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 50px; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: 0 6px 20px rgba(63,163,77,0.4); transition: all 0.3s;">
                        📤 Gửi Cho Đơn Vị Tư Vấn Và Lưu Báo Giá
                    </button>
                    <button id="buyPackageBtn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 50px; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: 0 6px 20px rgba(37,99,235,0.4); transition: all 0.3s;">
                        🛒 Mua Gói Này
                    </button>
                </div>
            `;
            
            // Hiển thị kết quả với animation
            resultsDiv.classList.add('show');
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Store result for later use
            window.currentSurveyResult = result;
            window.currentFormData = formData;
            // Cho phép chọn giữa các tủ điện cùng mức công suất (nếu có)
            const cabinetRadios = document.querySelectorAll('input[name="cabinetChoice"]');
            if (cabinetRadios && cabinetRadios.length > 1) {
                cabinetRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.value, 10) || 0;
                        const oldPrice = result.selectedCabinet.price || 0;
                        result.selectedCabinet = result.cabinetAlternatives[idx];
                        const newPrice = result.selectedCabinet.price || 0;
                        // Cập nhật tổng nhanh mà không cần tính lại tất cả
                        result.totalPrice = result.totalPrice - oldPrice + newPrice;
                        // Re-render kết quả
                        displayResults(result, formData);
                    });
                });
            }
            
            // Add event listener to save button (after it's created)
            const saveSurveyBtn = document.getElementById('saveSurveyBtn');
            if (saveSurveyBtn) {
                console.log('Save button found after creation, adding event listener');
                saveSurveyBtn.addEventListener('click', function(e) {
                    console.log('Save button clicked!', e);
                    saveSurvey();
                });
            } else {
                console.error('Save button still not found after creation!');
            }
            
            // Add event listener to buy package button
            const buyPackageBtn = document.getElementById('buyPackageBtn');
            if (buyPackageBtn) {
                console.log('Buy package button found, adding event listener');
                buyPackageBtn.addEventListener('click', function(e) {
                    console.log('Buy package button clicked!', e);
                    buyPackage();
                });
            } else {
                console.error('Buy package button not found after creation!');
            }
        }

        // Format currency input
        document.getElementById('monthlyBillInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('vi-VN');
                e.target.value = value;
            }
        });

        // Phone number validation
        const surveyPhoneInput = document.getElementById('survey-phone');
        if (surveyPhoneInput) {
            // Only allow numbers in phone input
            surveyPhoneInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length > 10) {
                    this.value = this.value.slice(0, 10);
                }
            });

            // Prevent paste of non-numeric characters
            surveyPhoneInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const numbersOnly = pastedText.replace(/[^0-9]/g, '').slice(0, 10);
                this.value = numbersOnly;
            });
        }

        // Auto-fill user info if logged in
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/get_current_user_info.php`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success && data.logged_in && data.user) {
                    const user = data.user;
                    
                    // Tự động điền fullname (ưu tiên full_name, nếu không có thì dùng username)
                    // Chỉ điền khi có giá trị string hợp lệ (không phải boolean hoặc empty)
                    const fullnameInput = document.querySelector('input[name="fullname"]');
                    if (fullnameInput) {
                        const fullName = typeof user.full_name === 'string' && user.full_name.trim() 
                            ? user.full_name.trim() 
                            : (typeof user.username === 'string' && user.username.trim() ? user.username.trim() : '');
                        
                        if (fullName) {
                            fullnameInput.value = fullName;
                        }
                    }
                    
                    // Tự động điền phone - chỉ điền khi có giá trị string hợp lệ
                    const phoneInput = document.getElementById('survey-phone');
                    if (phoneInput && typeof user.phone === 'string' && user.phone.trim()) {
                        phoneInput.value = user.phone.trim();
                    }
                    
                    // Tự động điền email - chỉ điền khi có giá trị string hợp lệ
                    const emailInput = document.getElementById('survey-email');
                    if (emailInput && typeof user.email === 'string' && user.email.trim()) {
                        emailInput.value = user.email.trim();
                    }
                    
                    console.log('✅ Đã tự động điền thông tin user:', { 
                        full_name: user.full_name, 
                        phone: user.phone,
                        email: user.email,
                        username: user.username 
                    });
                } else {
                    console.log('ℹ️ User chưa đăng nhập hoặc không có thông tin');
                }
            } catch (error) {
                console.error('Lỗi khi lấy thông tin user:', error);
                // Không làm gì nếu lỗi - form vẫn để trống
            }
        }

        // Load inverters when phase is selected
        function loadInvertersByPhase(phase) {
            const inverterSelect = document.getElementById('inverterSelect');
            if (!inverterSelect) return;
            
            // Clear existing options
            inverterSelect.innerHTML = '<option value="">-- Đang tải dữ liệu... --</option>';
            
            // Check if invertersByPhase has been populated yet
            if (!invertersByPhase || (!invertersByPhase['1'] && !invertersByPhase['3'] && !invertersByPhase['both'])) {
                inverterSelect.innerHTML = '<option value="">-- Vui lòng đợi dữ liệu tải xong --</option>';
                // Retry after a short delay
                setTimeout(() => loadInvertersByPhase(phase), 500);
                return;
            }
            
            // Get available inverters based on phase
            let availableInverters = [];
            if (phase === '1') {
                availableInverters = [
                    ...(invertersByPhase['1'] || []),
                    ...(invertersByPhase['both'] || [])
                ];
            } else if (phase === '3') {
                availableInverters = [
                    ...(invertersByPhase['3'] || []),
                    ...(invertersByPhase['both'] || [])
                ];
            }
            
            // Populate dropdown
            if (availableInverters.length > 0) {
                inverterSelect.innerHTML = '<option value="">-- Chọn biến tần --</option>';
                availableInverters.forEach(inv => {
                    const option = document.createElement('option');
                    option.value = inv.id || inv.name; // Use ID if available, otherwise name
                    // Format display text with power and price
                    const powerText = inv.power ? `${(inv.power / 1000).toFixed(1)}kW` : '';
                    option.textContent = `${inv.name}${powerText ? ` (${powerText})` : ''} - ${(inv.price || 0).toLocaleString()}đ`;
                    option.setAttribute('data-inverter-id', inv.id || 0);
                    option.setAttribute('data-inverter-name', inv.name || '');
                    option.setAttribute('data-inverter-power', inv.power || 0);
                    option.setAttribute('data-inverter-price', inv.price || 0);
                    option.setAttribute('data-inverter-image', inv.image || '');
                    option.setAttribute('data-inverter-phase', inv.phase || phase);
                    option.setAttribute('data-inverter-warranty', inv.warranty || '12 tháng');
                    inverterSelect.appendChild(option);
                });
                console.log('✅ Đã load', availableInverters.length, 'biến tần cho pha', phase);
            } else {
                inverterSelect.innerHTML = '<option value="">-- Không có biến tần phù hợp --</option>';
            }
        }
        
        // Add event listeners for phase radio buttons
        function setupPhaseChangeListener() {
            const phaseRadios = document.querySelectorAll('input[name="phase"]');
            phaseRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const selectedPhase = this.value;
                    console.log('Phase changed to:', selectedPhase);
                    loadInvertersByPhase(selectedPhase);
                });
            });
        }
        
        // Enhanced page animations and effects
        document.addEventListener('DOMContentLoaded', function() {
            // Load electricity prices from API
            loadElectricityPricesData();
            
            // Load survey products from API
            loadSurveyProducts().then(() => {
                // After products are loaded, setup phase change listener
                setupPhaseChangeListener();
                
                // If a phase is already selected (e.g., from auto-fill), load inverters for it
                const selectedPhase = document.querySelector('input[name="phase"]:checked')?.value;
                if (selectedPhase) {
                    loadInvertersByPhase(selectedPhase);
                }
            });
            // Load sun hours from Admin
            loadSurveyRegionsPublic();
            
            // Load user info and auto-fill form (if logged in)
            // Đợi một chút để đảm bảo auth.js đã load xong
            setTimeout(loadUserInfo, 300);
            
            // Add floating elements
            createFloatingElements();
            
            // Add scroll animations
            addScrollAnimations();
            
            // Add form interaction effects
            addFormEffects();
        });

        // Load electricity prices from API
        async function loadElectricityPricesData() {
            try {
                const response = await fetch(`${API_BASE}/get_electricity_prices_public.php`);
                const data = await response.json();
                
                if (data.success && data.prices && data.prices.length > 0) {
                    // Convert API data to format used by calculator
                    electricityPrices = {};
                    data.prices.forEach(price => {
                        const range = price.kwh_to ? (price.kwh_to - price.kwh_from) : Infinity;
                        electricityPrices[price.tier] = {
                            price: price.price_with_vat,
                            range: range,
                            name: price.tier_name
                        };
                    });
                    
                    // Update effective date
                    if (data.prices[0].effective_date) {
                        electricityPricesEffectiveDate = data.prices[0].effective_date;
                    }
                    
                    // Update the displayed table
                    updateElectricityPricesTable(data.prices);
                    
                    console.log('Electricity prices loaded from API:', electricityPrices);
                } else {
                    console.log('Using default electricity prices');
                }
            } catch (error) {
                console.error('Error loading electricity prices:', error);
                console.log('Using default electricity prices');
            }
        }

        // Load survey regions (sun hours) from Admin and update option labels
        async function loadSurveyRegionsPublic() {
            try {
                const res = await fetch(`${API_BASE}/get_survey_regions_public.php`);
                const data = await res.json();
                if (data.success && Array.isArray(data.regions)) {
                    // API đã lọc is_active = TRUE ở database level, nên không cần filter lại
                    data.regions.forEach(r => {
                        // Ưu tiên sử dụng giá trị từ API nếu hợp lệ (> 0), ngược lại dùng giá trị mặc định
                        if (r.sun_hours && r.sun_hours > 0) {
                            regionSunHours[r.region_code] = Number(r.sun_hours);
                        }
                        // Nếu không có hoặc không hợp lệ, giữ nguyên giá trị mặc định đã khởi tạo
                    });
                    console.log('✅ Đã cập nhật giờ nắng từ Admin:', regionSunHours);
                    const regionSelect = document.querySelector('select[name="region"]');
                    if (regionSelect) {
                        Array.from(regionSelect.options).forEach(opt => {
                            const code = opt.value;
                            const match = data.regions.find(r => r.region_code === code);
                            if (match) {
                                const display = match.display_content || `${match.region_name} (${match.sun_hours} giờ nắng/ngày)`;
                                opt.textContent = display;
                            }
                        });
                    }
                }
            } catch (err) {
                console.warn('Load survey regions failed, use defaults', err);
            }
        }
        
        // Update the electricity prices table in HTML
        function updateElectricityPricesTable(prices) {
            const tableHTML = prices.map(price => `
                <tr style="border-bottom: 1px solid rgba(226,232,240,0.5);">
                    <td style="padding: 0.4rem 0.5rem; color: #4a5568;">${price.tier_name}</td>
                    <td style="padding: 0.4rem 0.5rem; text-align: right; color: #718096;">${price.price_no_vat.toLocaleString()}đ/kWh</td>
                    <td style="padding: 0.4rem 0.5rem; text-align: right; font-weight: 600; color: #3FA34D;">${price.price_with_vat.toLocaleString()}đ/kWh</td>
                </tr>
            `).join('');
            
            // Find the table tbody and update it
            const tbody = document.querySelector('table tbody');
            if (tbody) {
                tbody.innerHTML = tableHTML;
            }
            
            // Update the effective date text
            const dateText = document.querySelector('div[style*="font-size: 0.75rem"]');
            if (dateText && electricityPricesEffectiveDate) {
                const date = new Date(electricityPricesEffectiveDate);
                const formattedDate = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                dateText.innerHTML = `Áp dụng từ ${formattedDate}`;
            }
        }

        // Load survey products from API and populate form
        async function loadSurveyProducts() {
            try {
                const response = await fetch(`${API_BASE}/get_survey_products_public.php`);
                const data = await response.json();
                
                if (data.success && data.products) {
                    populateSurveyForm(data.products);
                    return Promise.resolve();
                } else {
                    console.error('Failed to load survey products:', data.message);
                    // Keep using hardcoded data as fallback
                    return Promise.resolve();
                }
            } catch (error) {
                console.error('Error loading survey products:', error);
                // Keep using hardcoded data as fallback
                return Promise.resolve();
            }
        }

        // Helper function to fix image URL path
        function fixImageUrl(imageUrl) {
            if (!imageUrl) return '';
            
            // Remove leading '../', '..//', './', etc.
            imageUrl = imageUrl.replace(/^(\.\.\/)+/, '').replace(/^\.\//, '');
            
            // If already starts with http or https, return as is
            if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                return imageUrl;
            }
            
            // Add leading slash if not present
            if (!imageUrl.startsWith('/')) {
                imageUrl = '/' + imageUrl;
            }
            
            return imageUrl;
        }
        
        // Helper function to create display text from technical description
        function formatDisplayText(title, technicalDescription) {
            if (!technicalDescription) return title;
            
            // Extract key info from technical description
            const specs = [];
            
            // Extract capacity (Dung lượng)
            const capacityMatch = technicalDescription.match(/Dung lượng:\s*([^\n]+)/i);
            if (capacityMatch) {
                specs.push(capacityMatch[1].trim());
            }
            
            // Extract voltage (Điện áp)
            const voltageMatch = technicalDescription.match(/Điện áp[^\n]*:\s*([^\n]+)/i);
            if (voltageMatch && !specs.length) { // Only add voltage if no capacity found
                specs.push(voltageMatch[1].trim());
            }
            
            // Extract power (Công suất)
            const powerMatch = technicalDescription.match(/Công suất:\s*([^\n]+)/i);
            if (powerMatch && !specs.length) { // Only add power if no other specs found
                specs.push(powerMatch[1].trim());
            }
            
            // Extract efficiency (Hiệu suất)
            const efficiencyMatch = technicalDescription.match(/Hiệu suất:\s*([^\n]+)/i);
            if (efficiencyMatch && specs.length > 0) { // Add efficiency as 2nd spec if we have 1st spec
                specs.push(efficiencyMatch[1].trim());
            }
            
            // Format display text
            if (specs.length > 0) {
                return `${title} (${specs.slice(0, 2).join(' | ')})`; // Max 2 specs to keep it readable
            }
            
            return title;
        }

        function populateSurveyForm(products) {
            // Populate Solar Panels (Tấm Pin)
            const solarPanelSelect = document.querySelector('select[name="solarPanel"]');
            if (solarPanelSelect && products.solar_panel) {
                solarPanelSelect.innerHTML = '<option value="">-- Chọn loại tấm pin --</option>';
                products.solar_panel.forEach(panel => {
                    // Extract watt from title (e.g., "Jinko Solar 590W" -> 590)
                    const wattMatch = panel.title.match(/(\d+)W/i);
                    const watt = wattMatch ? wattMatch[1] : panel.id;
                    
                    // Create formatted display text with tech specs
                    const displayText = formatDisplayText(panel.title, panel.technical_description);
                    
                    const option = document.createElement('option');
                    option.value = watt;
                    option.textContent = displayText;
                    option.setAttribute('data-product-id', panel.id);
                    option.setAttribute('data-price', panel.price);
                    option.setAttribute('data-watt', watt);
                    option.setAttribute('data-title', panel.title); // Store original title
                    option.setAttribute('data-image', fixImageUrl(panel.image_url));
                    
                    solarPanelSelect.appendChild(option);
                });
                console.log('✅ Đã load', products.solar_panel.length, 'loại tấm pin từ admin');
            }

            // Populate Batteries (Pin Lưu Trữ)
            const batterySelect = document.querySelector('select[name="batteryType"]');
            if (batterySelect && products.battery) {
                batterySelect.innerHTML = '<option value="">-- Chọn loại pin lưu trữ --</option>';
                products.battery.forEach(battery => {
                    // Create formatted display text with tech specs
                    const displayText = formatDisplayText(battery.title, battery.technical_description);
                    const unitCap = (typeof battery.battery_capacity_kwh === 'number' && battery.battery_capacity_kwh > 0)
                        ? battery.battery_capacity_kwh
                        : ((battery.title || battery.technical_description || '').match(/(\d+\.?\d*)\s*kW(h)?/i)?.[1]
                            ? parseFloat((battery.title || battery.technical_description || '').match(/(\d+\.?\d*)\s*kW(h)?/i)[1])
                            : 0);
                    
                    // Use product_id as value for better tracking
                    const option = document.createElement('option');
                    option.value = battery.id;
                    option.textContent = displayText;
                    option.setAttribute('data-product-id', battery.id);
                    option.setAttribute('data-price', battery.price);
                    option.setAttribute('data-capacity-kwh', unitCap);
                    
                    option.setAttribute('data-title', battery.title); // Store original title
                    option.setAttribute('data-image', fixImageUrl(battery.image_url));
                    batterySelect.appendChild(option);
                });
                console.log('✅ Đã load', products.battery.length, 'loại pin lưu trữ từ admin');
            }

            // Update invertersByPhase with API data
            if (products.inverter) {
                invertersByPhase['1'] = [];
                invertersByPhase['3'] = [];
                invertersByPhase['both'] = [];
                
                products.inverter['1_phase']?.forEach(inv => {
                    invertersByPhase['1'].push({
                        id: inv.id,
                        name: inv.title,
                        power: (inv.inverter_power_watt && inv.inverter_power_watt > 0) ? inv.inverter_power_watt : (parseInt(inv.title.match(/(\d+)K/i)?.[1] || '0') * 1000),
                        price: inv.price,
                        warranty: "12 tháng",
                        image: fixImageUrl(inv.image_url),
                        
                        phase: "1"
                    });
                });
                
                products.inverter['3_phase']?.forEach(inv => {
                    invertersByPhase['3'].push({
                        id: inv.id,
                        name: inv.title,
                        power: (inv.inverter_power_watt && inv.inverter_power_watt > 0) ? inv.inverter_power_watt : (parseInt(inv.title.match(/(\d+)K/i)?.[1] || '0') * 1000),
                        price: inv.price,
                        warranty: "12 tháng",
                        image: fixImageUrl(inv.image_url),
                        
                        phase: "3"
                    });
                });
                
                products.inverter['both']?.forEach(inv => {
                    invertersByPhase['both'].push({
                        id: inv.id,
                        name: inv.title,
                        power: (inv.inverter_power_watt && inv.inverter_power_watt > 0) ? inv.inverter_power_watt : (parseInt(inv.title.match(/(\d+)K/i)?.[1] || '0') * 1000),
                        price: inv.price,
                        warranty: "12 tháng",
                        image: fixImageUrl(inv.image_url),
                        
                        phase: "both"
                    });
                });
                
                const inverterCount = (products.inverter['1_phase']?.length || 0) + 
                                     (products.inverter['3_phase']?.length || 0) + 
                                     (products.inverter['both']?.length || 0);
                console.log('✅ Đã load', inverterCount, 'loại biến tần từ admin');
            }

            // Update batteries with API data
            if (products.battery) {
                batteries.length = 0;
                products.battery.forEach(bat => {
                    // Extract capacity from title or description (kWh hoặc kW)
                    let capacity = 0;
                    const capTitle = (bat.title || '').match(/(\d+\.?\d*)\s*kW(h)?/i);
                    if (capTitle) capacity = parseFloat(capTitle[1]);
                    if (!capacity && bat.technical_description) {
                        const capDesc = bat.technical_description.match(/(\d+\.?\d*)\s*kW(h)?/i);
                        if (capDesc) capacity = parseFloat(capDesc[1]);
                    }
                    
                    batteries.push({
                        name: bat.title,
                        capacity: capacity,
                        price: bat.price,
                        warranty: "10 năm",
                        image: fixImageUrl(bat.image_url)
                    });
                });
            }

            // Update electricalCabinets with API data
            if (products.electrical_cabinet) {
                electricalCabinets['1'] = [];
                electricalCabinets['3'] = [];
                electricalCabinets['both'] = [];
                
                products.electrical_cabinet['1_phase']?.forEach(cab => {
                    electricalCabinets['1'].push({
                        id: cab.id,
                        name: cab.title,
                        power: (cab.cabinet_power_kw && cab.cabinet_power_kw > 0) ? (cab.cabinet_power_kw * 1000) : (parseInt(cab.title.match(/(\d+)kW/i)?.[1] || '0') * 1000),
                        price: cab.price,
                        image: fixImageUrl(cab.image_url)
                    });
                });
                
                products.electrical_cabinet['3_phase']?.forEach(cab => {
                    electricalCabinets['3'].push({
                        id: cab.id,
                        name: cab.title,
                        power: (cab.cabinet_power_kw && cab.cabinet_power_kw > 0) ? (cab.cabinet_power_kw * 1000) : (parseInt(cab.title.match(/(\d+)kW/i)?.[1] || '0') * 1000),
                        price: cab.price,
                        image: fixImageUrl(cab.image_url)
                    });
                });
                
                products.electrical_cabinet['both']?.forEach(cab => {
                    electricalCabinets['both'].push({
                        id: cab.id,
                        name: cab.title,
                        power: (cab.cabinet_power_kw && cab.cabinet_power_kw > 0) ? (cab.cabinet_power_kw * 1000) : (parseInt(cab.title.match(/(\d+)kW/i)?.[1] || '0') * 1000),
                        price: cab.price,
                        image: fixImageUrl(cab.image_url)
                    });
                });
                
                const cabinetCount = (products.electrical_cabinet['1_phase']?.length || 0) + 
                                    (products.electrical_cabinet['3_phase']?.length || 0) + 
                                    (products.electrical_cabinet['both']?.length || 0);
                console.log('✅ Đã load', cabinetCount, 'loại tủ điện từ admin');
            }

            // Build dynamic accessories from API
            if (products.accessory && Array.isArray(products.accessory)) {
                dynamicAccessories = products.accessory.map(acc => ({
                    id: acc.id,
                    name: acc.title,
                    unit: acc.accessory_unit || 'cái',
                    price: acc.price || 0,
                    image: fixImageUrl(acc.image_url),
                    baseQty: typeof acc.accessory_base_qty === 'number' ? acc.accessory_base_qty : 0,
                    depQty: typeof acc.accessory_dependent_qty === 'number' ? acc.accessory_dependent_qty : 0,
                    depTarget: acc.accessory_dependent_target || 'project',
                    dependentProductIds: acc.dependent_product_ids || null, // Array các product_id phụ thuộc (null nếu không có)
                    config_id: acc.config_id || null, // ID của survey_product_configs
                    notes: acc.notes || null
                }));
                console.log('✅ Đã load', dynamicAccessories.length, 'phụ kiện từ admin:', dynamicAccessories.map(a => ({name: a.name, deps: a.dependentProductIds})));
            } else {
                console.log('⚠️ Không có phụ kiện nào được load từ API');
            }
        }

        function createFloatingElements() {
            const symbols = ['☀️', '⚡', '🔋', '🔌', '🌱', '💚'];
            const container = document.body;
            
            for (let i = 0; i < 6; i++) {
                const element = document.createElement('div');
                element.innerHTML = symbols[i];
                element.style.cssText = `
                    position: fixed;
                    font-size: ${Math.random() * 1 + 1.5}rem;
                    color: rgba(0, 200, 81, 0.2);
                    pointer-events: none;
                    z-index: 0;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    animation: floatRandom ${8 + Math.random() * 4}s ease-in-out infinite;
                    animation-delay: ${Math.random() * 2}s;
                `;
                container.appendChild(element);
            }
            
            // Add CSS for random floating animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes floatRandom {
                    0%, 100% { 
                        transform: translateY(0px) rotate(0deg) scale(1); 
                        opacity: 0.2; 
                    }
                    25% { 
                        transform: translateY(-30px) rotate(90deg) scale(1.1); 
                        opacity: 0.4; 
                    }
                    50% { 
                        transform: translateY(-60px) rotate(180deg) scale(0.9); 
                        opacity: 0.3; 
                    }
                    75% { 
                        transform: translateY(-30px) rotate(270deg) scale(1.05); 
                        opacity: 0.5; 
                    }
                }
            `;
            document.head.appendChild(style);
        }

        function addScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'fadeInUp 0.8s ease-out forwards';
                    }
                });
            }, { threshold: 0.1 });

            // Observe all form groups and sections
            document.querySelectorAll('.form-group, .section-header, .excel-table').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                observer.observe(el);
            });
            
            // Add fadeInUp animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInUp {
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
        }

        function addFormEffects() {
            // Add ripple effect to buttons
            document.addEventListener('click', function(e) {
                if (e.target.matches('.btn-calculate, .radio-option')) {
                    const ripple = document.createElement('span');
                    const rect = e.target.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.cssText = `
                        position: absolute;
                        width: ${size}px;
                        height: ${size}px;
                        left: ${x}px;
                        top: ${y}px;
                        background: rgba(255,255,255,0.6);
                        border-radius: 50%;
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        pointer-events: none;
                    `;
                    
                    e.target.style.position = 'relative';
                    e.target.style.overflow = 'hidden';
                    e.target.appendChild(ripple);
                    
                    setTimeout(() => ripple.remove(), 600);
                }
            });
            
            // Add ripple animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes ripple {
                    to {
                        transform: scale(4);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    </script>

    <!-- Slideshow Scripts -->
    <script>
        // Set path prefix for pages in html/ directory
        window.SLIDESHOW_PATH_PREFIX = '../';
    </script>
    <script src="../assets/js/slideshow-config.js"></script>
    <script src="../assets/js/slideshow.js"></script>
    <script src="../assets/js/cache-buster.js"></script>

    <!-- Survey Save Logic -->
    <script>
        // Debug: Check if button exists
        console.log('Survey save script loaded');
        
        // Note: Event listener will be added when button is created dynamically
        // No need to add it on DOMContentLoaded since button doesn't exist yet

        async function saveSurvey() {
            console.log('saveSurvey function called');
            let originalText = '📤 Gửi Cho Đơn Vị Tư Vấn Và Lưu Báo Giá'; // Default text
            
            try {
                // Show loading state
                const saveBtn = document.getElementById('saveSurveyBtn');
                console.log('Save button element:', saveBtn);
                
                if (!saveBtn) {
                    console.error('Save button not found in saveSurvey function');
                    return;
                }
                
                originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '⏳ Đang lưu...';
                saveBtn.disabled = true;

                // Collect survey data from form
                const surveyData = collectSurveyData();
                console.log('Survey data collected:', surveyData);
                
                // Collect calculation results
                const results = collectCalculationResults();
                console.log('Calculation results collected:', results);
                
                // Prepare data for API
                const apiData = {
                    ...surveyData,
                    results: results
                };

                console.log('Saving survey data:', apiData);

                // Call API to save survey
                const response = await fetch('../api/save_survey.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(apiData)
                });

                console.log('API response:', response);
                const result = await response.json();
                console.log('API result:', result);

                if (result.success) {
                    // Show success message
                    showNotification('✅ Đã lưu báo giá thành công!', 'success');
                    
                    // Optional: Redirect to survey history
                    setTimeout(() => {
                        window.location.href = 'survey_history.html';
                    }, 2000);
                } else {
                    showNotification('❌ Lỗi: ' + result.message, 'error');
                }

            } catch (error) {
                console.error('Error saving survey:', error);
                showNotification('❌ Lỗi kết nối server', 'error');
            } finally {
                // Restore button state
                const saveBtn = document.getElementById('saveSurveyBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        function collectSurveyData() {
            // Get form values
            const region = document.querySelector('select[name="region"]')?.value || '';
            const phase = document.querySelector('input[name="phase"]:checked')?.value || '';
            const solarPanel = document.querySelector('select[name="solarPanel"]')?.value || '';
            const monthlyBill = document.getElementById('monthlyBillInput')?.value || '';
            const usageTime = document.querySelector('select[name="usageTime"]')?.value || '';

            console.log('Form values collected:', {
                region, phase, solarPanel, monthlyBill, usageTime
            });

            return {
                region: region,
                phase: parseInt(phase),
                solarPanel: parseInt(solarPanel),
                monthlyBill: parseFloat(monthlyBill.replace(/[^\d]/g, '')), // Remove formatting
                usageTime: usageTime
            };
        }

        function collectCalculationResults() {
            // Try to get results from global variables (from calculateSolarSystem)
            if (window.currentSurveyResult) {
                console.log('Using currentSurveyResult:', window.currentSurveyResult);
                const result = window.currentSurveyResult;
                
                // Debug: Log all product IDs before sending to API
                console.log('collectCalculationResults - Panel ID:', result.solarPanelProductId);
                console.log('collectCalculationResults - Inverter ID:', result.selectedInverter?.id);
                console.log('collectCalculationResults - Cabinet ID:', result.selectedCabinet?.id);
                console.log('collectCalculationResults - Battery ID:', result.batteryProductId);
                // Resolve cabinet from selectedCabinet (no longer inside accessories list)
                const cabinetName = result.selectedCabinet?.name || 'Tủ điện';
                const cabinetPrice = Number(result.selectedCabinet?.price || 0);
                
                // Transform to old format for API
                return {
                    monthlyKWh: result.monthlyKwh,
                    sunHours: result.peakSunHours,
                    panelsNeeded: result.panelCount,
                    panelCost: result.panelTotalPrice,
                    panelInfo: {
                        id: result.solarPanelProductId || 0,
                        name: result.solarPanelName,
                        power: result.solarPanelWatt / 1000, // Convert to kW
                        price: result.solarPanelPrice
                    },
                    energyPerPanelPerDay: result.actualDailyKwh / result.panelCount,
                    totalCapacity: result.systemSizeWatt / 1000, // Convert to kW
                    inverter: {
                        id: (result.selectedInverter && result.selectedInverter.id) ? result.selectedInverter.id : 0,
                        name: result.selectedInverter.name,
                        capacity: result.selectedInverter.power / 1000,
                        price: result.selectedInverter.price,
                        quantity: result.inverterQuantity || 1,
                        totalPrice: result.inverterTotalPrice || result.selectedInverter.price
                    },
                    cabinet: {
                        id: (result.selectedCabinet && result.selectedCabinet.id) ? result.selectedCabinet.id : 0,
                        name: cabinetName,
                        capacity: result.selectedCabinet?.power ? (result.selectedCabinet.power/1000) : result.systemSizeKw,
                        price: cabinetPrice
                    },
                    batteryNeeded: result.batteryCapacityNeeded,
                    totalCost: result.totalPrice,
                    batteryOptions: [
                        {
                            id: result.batteryProductId,
                            name: result.selectedBattery.name,
                            capacity: result.selectedBattery.capacity,
                            quantity: result.selectedBattery.units, // Use units instead of hardcoded 1
                            price: result.selectedBattery.price,
                            totalCost: result.selectedBattery.totalPrice // Use totalPrice instead of price
                        }
                    ],
                    accessories: {
                        bachZ: {
                            qty: result.accessories.find(a => a.name.includes('Bách Z'))?.quantity || 0,
                            price: result.accessories.find(a => a.name.includes('Bách Z'))?.price || 0,
                            cost: result.accessories.find(a => a.name.includes('Bách Z'))?.totalPrice || 0
                        },
                        clip: {
                            qty: result.accessories.find(a => a.name.includes('Kẹp Biên'))?.quantity || 0,
                            price: result.accessories.find(a => a.name.includes('Kẹp Biên'))?.price || 0,
                            cost: result.accessories.find(a => a.name.includes('Kẹp Biên'))?.totalPrice || 0
                        },
                        jackMC4: {
                            qty: result.accessories.find(a => a.name.includes('MC4'))?.quantity || 0,
                            price: result.accessories.find(a => a.name.includes('MC4'))?.price || 0,
                            cost: result.accessories.find(a => a.name.includes('MC4'))?.totalPrice || 0
                        }
                    },
                    dcCable: {
                        length: result.accessories.find(a => a.name.includes('Dây Điện'))?.quantity || 100,
                        price: result.accessories.find(a => a.name.includes('Dây Điện'))?.price || 0,
                        cost: result.accessories.find(a => a.name.includes('Dây Điện'))?.totalPrice || 0
                    },
                    accessoriesCost: result.accessoriesTotal,
                    laborCost: result.accessories.find(a => a.name.includes('Công Thợ'))?.totalPrice || 0,
                    billBreakdown: []
                };
            }

            // Fallback: Show error if no results available
            console.error('No survey results available');
            return null;
        }

        // Helper functions for calculations
        function calculateMonthlyKWh(monthlyBill, region) {
            // Estimate kWh based on monthly bill and region
            // This is a simplified calculation
            const avgPricePerKWh = getAvgPricePerKWh(region);
            return monthlyBill / avgPricePerKWh;
        }

        function getAvgPricePerKWh(region) {
            // Average electricity price per kWh by region (VND)
            const prices = {
                'mien-bac': 2500,
                'mien-trung': 2400,
                'mien-nam': 2300
            };
            return prices[region] || 2500;
        }

        function getSunHours(region) {
            // Average sun hours per day by region
            const sunHours = {
                'mien-bac': 4.5,
                'mien-trung': 5.0,
                'mien-nam': 5.5
            };
            return sunHours[region] || 5.0;
        }

        function calculatePanelsNeeded(monthlyKWh, panelPower, sunHours) {
            // Calculate panels needed based on monthly consumption
            const dailyConsumption = monthlyKWh / 30;
            const dailyProductionPerPanel = panelPower * sunHours;
            const panelsNeeded = Math.ceil(dailyConsumption / dailyProductionPerPanel);
            return Math.max(panelsNeeded, 1); // At least 1 panel
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Function to send survey email to admin - Gửi trực tiếp qua FormSubmit như dự án My Web
        async function sendSurveyEmailToAdmin(formData, result) {
            try {
                // Helper function để format số tiền
                const formatCurrency = (num) => {
                    return new Intl.NumberFormat('vi-VN').format(num || 0);
                };
                
                // Helper function để format label từ key (ví dụ: "monthlyBill" -> "Hóa đơn điện/tháng")
                const formatLabel = (key) => {
                    const labelMap = {
                        'fullname': 'Họ và tên',
                        'phone': 'Số điện thoại',
                        'email': 'Email',
                        'region': 'Khu vực',
                        'phase': 'Loại điện',
                        'usageTime': 'Thời gian sử dụng',
                        'monthlyBill': 'Hóa đơn điện/tháng',
                        'monthlyKwh': 'Mức tiêu thụ điện/tháng',
                        'dailyKwh': 'Tiêu thụ điện/ngày',
                        'peakSunHours': 'Giờ nắng trung bình',
                        'roofArea': 'Diện tích mái cần thiết',
                        'solarPanelName': 'Tấm Pin - Tên',
                        'solarPanelWatt': 'Tấm Pin - Công suất',
                        'panelCount': 'Tấm Pin - Số lượng',
                        'solarPanelPrice': 'Tấm Pin - Đơn giá',
                        'panelTotalPrice': 'Tấm Pin - Thành tiền',
                        'inverterName': 'Biến Tần - Tên',
                        'inverterPower': 'Biến Tần - Công suất',
                        'inverterPrice': 'Biến Tần - Đơn giá',
                        'cabinetName': 'Tủ Điện - Tên',
                        'cabinetPrice': 'Tủ Điện - Đơn giá',
                        'batteryName': 'Pin Lưu Trữ - Tên',
                        'batteryCapacity': 'Pin Lưu Trữ - Dung lượng',
                        'batteryUnits': 'Pin Lưu Trữ - Số lượng',
                        'batteryPrice': 'Pin Lưu Trữ - Đơn giá',
                        'batteryTotalPrice': 'Pin Lưu Trữ - Thành tiền',
                        'accessoriesTotal': 'Phụ kiện & lắp đặt',
                        'totalPrice': 'TỔNG CHI PHÍ ĐẦU TƯ',
                        'systemSizeKw': 'Hệ thống',
                        'annualSavings': 'Tiết kiệm/năm',
                        'paybackPeriod': 'Hoàn vốn'
                    };
                    return labelMap[key] || key;
                };
                
                // Helper để convert sang số an toàn (dùng chung)
                const toNumber = (val) => {
                    if (typeof val === 'number') return val;
                    if (typeof val === 'string') {
                        const num = parseFloat(val);
                        return isNaN(num) ? 0 : num;
                    }
                    return 0;
                };
                
                // Helper function để format giá trị
                const formatValue = (key, value) => {
                    if (value === null || value === undefined) return 'N/A';
                    
                    // Format số tiền
                    if (key.includes('Price') || key.includes('Bill') || key.includes('Savings') || key.includes('Cost') || key === 'totalPrice') {
                        return formatCurrency(toNumber(value)) + ' VNĐ';
                    }
                    
                    // Format số lượng với đơn vị
                    if (key === 'panelCount') return toNumber(value) + ' tấm';
                    if (key === 'batteryUnits') return toNumber(value) + ' bộ';
                    if (key === 'peakSunHours') return toNumber(value).toFixed(1) + ' giờ/ngày';
                    if (key === 'roofArea') return toNumber(value).toFixed(1) + ' m²';
                    if (key === 'monthlyKwh' || key === 'dailyKwh') return toNumber(value).toFixed(1) + ' kWh';
                    if (key === 'systemSizeKw') return toNumber(value).toFixed(2) + ' kWp';
                    if (key === 'annualSavings') return (toNumber(value) / 1000000).toFixed(1) + ' triệu VNĐ';
                    if (key === 'paybackPeriod') return toNumber(value) + ' năm';
                    if (key === 'batteryCapacity') return toNumber(value).toFixed(2) + ' kWh/bộ';
                    if (key === 'solarPanelWatt') return toNumber(value) + 'W';
                    if (key === 'inverterPower') return toNumber(value) + 'W';
                    
                    // Format boolean
                    if (typeof value === 'boolean') return value ? 'Có' : 'Không';
                    
                    // Format object/array thành string
                    if (typeof value === 'object') {
                        if (Array.isArray(value)) {
                            return value.length + ' mục';
                        }
                        return JSON.stringify(value);
                    }
                    
                    return String(value);
                };
                
                // Danh sách các field cần bỏ qua (không gửi trong email)
                const fieldsToSkip = [
                    'id', 'image', 'images', 'img', 'photo', 'photos', 'url', 'link', 'href',
                    'productId', 'solarPanelProductId', 'batteryProductId', 'inverterId', 'cabinetId',
                    'kwhBreakdown', 'cabinetAlternatives', 'actualDailyKwh', 'systemSizeWatt',
                    'batteryCapacityNeeded', 'selectedInverter', 'selectedCabinet', 'selectedBattery',
                    'usageTime' // Bỏ qua vì đã gửi thủ công với tên đã map
                ];
                
                // Danh sách các field quan trọng cần gửi (chỉ gửi các field này)
                const importantFields = [
                    'monthlyBill', 'monthlyKwh', 'dailyKwh', 'peakSunHours', 'roofArea',
                    'solarPanelName', 'solarPanelWatt', 'panelCount', 'solarPanelPrice', 'panelTotalPrice',
                    'systemSizeKw', 'accessories', 'accessoriesTotal', 'totalPrice',
                    'annualSavings', 'paybackPeriod'
                ];
                
                // Helper function để kiểm tra field có nên bỏ qua không
                const shouldSkipField = (key) => {
                    const lowerKey = key.toLowerCase();
                    // Bỏ qua nếu có trong danh sách skip
                    if (fieldsToSkip.some(skip => lowerKey.includes(skip.toLowerCase()))) {
                        return true;
                    }
                    // Bỏ qua nếu là field kỹ thuật (có chứa 'Id', 'id', 'image', 'url', etc.)
                    if (lowerKey.includes('id') && !lowerKey.includes('kwh')) {
                        return true;
                    }
                    if (lowerKey.includes('image') || lowerKey.includes('img') || lowerKey.includes('photo') || lowerKey.includes('url') || lowerKey.includes('link')) {
                        return true;
                    }
                    return false;
                };
                
                // Helper function để tự động duyệt qua object và thêm vào FormData (chỉ các field quan trọng)
                const addObjectToFormData = (formDataToSend, obj, prefix = '') => {
                    for (const [key, value] of Object.entries(obj)) {
                        if (value === null || value === undefined) continue;
                        
                        // Bỏ qua các field không cần thiết
                        if (shouldSkipField(key)) continue;
                        
                        const fullKey = prefix ? `${prefix} - ${key}` : key;
                        
                        // Xử lý nested objects (selectedInverter, selectedCabinet, selectedBattery)
                        if (typeof value === 'object' && !Array.isArray(value) && value !== null) {
                            // Nếu là object có các property cơ bản (name, price, etc.) thì xử lý riêng
                            if (key === 'selectedInverter' || key === 'selectedCabinet' || key === 'selectedBattery') {
                                const itemName = value.name || 'N/A';
                                const itemPower = value.power || value.capacity || 0;
                                const itemPrice = value.price || 0;
                                const itemTotal = value.totalPrice || value.price || 0;
                                const itemUnits = value.units || 1;
                                
                                if (key === 'selectedInverter') {
                                    const invQuantity = result.inverterQuantity || 1;
                                    const invTotalPrice = result.inverterTotalPrice || itemPrice;
                                    formDataToSend.append('Biến Tần - Tên', itemName + (itemPower ? ` (${toNumber(itemPower)}W)` : ''));
                                    formDataToSend.append('Biến Tần - Số lượng', invQuantity + ' bộ');
                                    formDataToSend.append('Biến Tần - Đơn giá', formatCurrency(itemPrice) + ' đ');
                                    formDataToSend.append('Biến Tần - Thành tiền', formatCurrency(invTotalPrice) + ' đ');
                                } else if (key === 'selectedCabinet') {
                                    formDataToSend.append('Tủ Điện - Tên', itemName);
                                    formDataToSend.append('Tủ Điện - Số lượng', '1 cái');
                                    formDataToSend.append('Tủ Điện - Đơn giá', formatCurrency(itemPrice) + ' đ');
                                    formDataToSend.append('Tủ Điện - Thành tiền', formatCurrency(itemPrice) + ' đ');
                                } else if (key === 'selectedBattery') {
                                    formDataToSend.append('Pin Lưu Trữ - Tên', itemName + (itemPower ? ` (${toNumber(itemPower).toFixed(2)} kWh/bộ)` : ''));
                                    formDataToSend.append('Pin Lưu Trữ - Số lượng', itemUnits + ' bộ');
                                    formDataToSend.append('Pin Lưu Trữ - Đơn giá', formatCurrency(itemPrice) + ' đ');
                                    formDataToSend.append('Pin Lưu Trữ - Thành tiền', formatCurrency(itemTotal) + ' đ');
                                }
                            }
                            // Không recursive cho các nested objects khác (tránh gửi quá nhiều field)
                        }
                        // Xử lý arrays (accessories)
                        else if (Array.isArray(value)) {
                            if (key === 'accessories') {
                                value.forEach((acc, index) => {
                                    // Chỉ gửi name, quantity, price, totalPrice (bỏ qua image, id, etc.)
                                    formDataToSend.append(`Phụ Kiện ${index + 1} - Tên`, acc.name || 'N/A');
                                    formDataToSend.append(`Phụ Kiện ${index + 1} - Số lượng`, (acc.quantity || 0) + ' ' + (acc.unit || 'cái'));
                                    formDataToSend.append(`Phụ Kiện ${index + 1} - Đơn giá`, formatCurrency(acc.price || 0) + ' đ');
                                    formDataToSend.append(`Phụ Kiện ${index + 1} - Thành tiền`, formatCurrency(acc.totalPrice || 0) + ' đ');
                                });
                            }
                            // Bỏ qua các arrays khác (tránh gửi quá nhiều field)
                        }
                        // Xử lý primitive values - chỉ gửi các field quan trọng
                        else {
                            // Chỉ gửi nếu là field quan trọng hoặc không có trong danh sách skip
                            if (importantFields.includes(key) || !shouldSkipField(key)) {
                                const label = formatLabel(key);
                                const formattedValue = formatValue(key, value);
                                formDataToSend.append(label, formattedValue);
                            }
                        }
                    }
                };
                
                // Lấy email từ form (đã được validate)
                const email = formData.email;
                const fullname = formData.fullname || 'N/A';
                const phone = formData.phone || 'N/A';
                
                // Map region name
                const regionMap = {
                    'mien-bac': 'Miền Bắc',
                    'mien-trung': 'Miền Trung',
                    'mien-nam': 'Miền Nam'
                };
                const regionName = regionMap[formData.region] || formData.region || 'N/A';
                
                // Map phase name
                const phaseName = (formData.phase == 1 || formData.phase == '1') ? '1 Pha' : '3 Pha';
                
                // Map usage time name
                const usageTimeMap = {
                    'day': 'Ban ngày nhiều',
                    'balanced': 'Cả ngày đều',
                    'night': 'Ban đêm nhiều'
                };
                const usageTimeName = usageTimeMap[formData.usageTime] || formData.usageTime || 'N/A';
                
                // Gửi trực tiếp qua FormSubmit với các field riêng lẻ (giống My Web)
                // FormSubmit sẽ tự động format thành bảng đẹp với _template: 'table'
                const formSubmitUrl = 'https://formsubmit.co/ajax/doquangphuc21@gmail.com';
                const subject = `Báo Giá Điện Mặt Trời - Khách hàng: ${fullname} (${phone})`;
                
                const formDataToSend = new FormData();
                formDataToSend.append('_subject', subject);
                formDataToSend.append('_template', 'table'); // FormSubmit sẽ format thành bảng
                formDataToSend.append('_captcha', 'false');
                
                // ========== 👤 THÔNG TIN KHÁCH HÀNG ==========
                formDataToSend.append('👤 THÔNG TIN KHÁCH HÀNG', '');
                formDataToSend.append('Họ và tên', fullname);
                formDataToSend.append('Số điện thoại', phone);
                formDataToSend.append('Email', email);
                formDataToSend.append('Khu vực', regionName);
                formDataToSend.append('Loại điện', phaseName);
                formDataToSend.append('Thời gian sử dụng', usageTimeName);
                
                // ========== 📊 PHÂN TÍCH NHU CẦU ==========
                formDataToSend.append('📊 PHÂN TÍCH NHU CẦU', '');
                formDataToSend.append('Hóa đơn điện/tháng', formatCurrency(result.monthlyBill || 0) + ' VNĐ');
                formDataToSend.append('Mức tiêu thụ điện/tháng', toNumber(result.monthlyKwh || 0).toFixed(1) + ' kWh');
                formDataToSend.append('Tiêu thụ điện/ngày', toNumber(result.dailyKwh || 0).toFixed(1) + ' kWh');
                formDataToSend.append('Giờ nắng trung bình', toNumber(result.peakSunHours || 0).toFixed(1) + ' giờ/ngày');
                formDataToSend.append('Diện tích mái cần thiết', toNumber(result.roofArea || 0).toFixed(1) + ' m²');
                
                // Debug: Log result object để kiểm tra
                console.log('Email - Full result object:', result);
                console.log('Email - selectedInverter:', result.selectedInverter);
                console.log('Email - selectedCabinet:', result.selectedCabinet);
                console.log('Email - selectedBattery:', result.selectedBattery);
                
                // ========== 📋 BẢNG BÁO GIÁ CHI TIẾT ==========
                formDataToSend.append('📋 BẢNG BÁO GIÁ CHI TIẾT', '');
                
                // Tấm Pin
                formDataToSend.append('⚡ Tấm Pin Mặt Trời', '');
                formDataToSend.append('Tấm Pin - Tên thiết bị', (result.solarPanelName || 'N/A') + ' (' + toNumber(result.solarPanelWatt || 0) + 'W)');
                formDataToSend.append('Tấm Pin - Số lượng', toNumber(result.panelCount || 0) + ' tấm');
                formDataToSend.append('Tấm Pin - Đơn giá', formatCurrency(result.solarPanelPrice || 0) + ' đ');
                formDataToSend.append('Tấm Pin - Thành tiền', formatCurrency(result.panelTotalPrice || 0) + ' đ');
                
                // Biến Tần (Inverter)
                const selectedInverter = result.selectedInverter || {};
                const inverterName = selectedInverter.name || 'N/A';
                const inverterPower = selectedInverter.power || 0;
                const inverterPrice = selectedInverter.price || 0;
                
                console.log('Email - Inverter data:', { name: inverterName, power: inverterPower, price: inverterPrice });
                
                formDataToSend.append('🔌 Biến Tần (Inverter)', '');
                const inverterQuantity = result.inverterQuantity || 1;
                const inverterTotalPrice = result.inverterTotalPrice || inverterPrice;
                formDataToSend.append('Biến Tần - Tên thiết bị', inverterName + (inverterPower ? ` (${toNumber(inverterPower)}W)` : ''));
                formDataToSend.append('Biến Tần - Số lượng', inverterQuantity + ' bộ');
                formDataToSend.append('Biến Tần - Đơn giá', formatCurrency(inverterPrice) + ' đ');
                formDataToSend.append('Biến Tần - Thành tiền', formatCurrency(inverterTotalPrice) + ' đ');
                
                // Tủ Điện
                const selectedCabinet = result.selectedCabinet || {};
                const cabinetName = selectedCabinet.name || 'N/A';
                const cabinetPrice = selectedCabinet.price || 0;
                
                console.log('Email - Cabinet data:', { name: cabinetName, price: cabinetPrice });
                
                formDataToSend.append('🧰 Tủ Điện Hybrid', '');
                formDataToSend.append('Tủ Điện - Tên thiết bị', cabinetName);
                formDataToSend.append('Tủ Điện - Số lượng', '1 cái');
                formDataToSend.append('Tủ Điện - Đơn giá', formatCurrency(cabinetPrice) + ' đ');
                formDataToSend.append('Tủ Điện - Thành tiền', formatCurrency(cabinetPrice) + ' đ');
                
                // Pin Lưu Trữ (Battery)
                const selectedBattery = result.selectedBattery || {};
                const batteryName = selectedBattery.name || 'N/A';
                const batteryCapacity = selectedBattery.capacity || 0;
                const batteryUnits = selectedBattery.units || 0;
                const batteryPrice = selectedBattery.price || 0;
                const batteryTotalPrice = selectedBattery.totalPrice || 0;
                
                console.log('Email - Battery data:', { name: batteryName, capacity: batteryCapacity, units: batteryUnits, price: batteryPrice, totalPrice: batteryTotalPrice });
                
                formDataToSend.append('🔋 Pin Lưu Trữ (Battery)', '');
                formDataToSend.append('Pin Lưu Trữ - Tên thiết bị', batteryName + (batteryCapacity ? ` (${toNumber(batteryCapacity).toFixed(2)} kWh/bộ)` : ''));
                formDataToSend.append('Pin Lưu Trữ - Số lượng', batteryUnits + ' bộ');
                formDataToSend.append('Pin Lưu Trữ - Đơn giá', formatCurrency(batteryPrice) + ' đ');
                formDataToSend.append('Pin Lưu Trữ - Thành tiền', formatCurrency(batteryTotalPrice) + ' đ');
                
                // Phụ Kiện
                const accessories = result.accessories || [];
                if (accessories.length > 0) {
                    formDataToSend.append('🔧 Phụ Kiện & Vật Tư Lắp Đặt', '');
                    accessories.forEach((acc, index) => {
                        formDataToSend.append(`Phụ kiện ${index + 1} - Tên thiết bị`, acc.name || 'N/A');
                        formDataToSend.append(`Phụ kiện ${index + 1} - Số lượng`, (acc.quantity || 0) + ' ' + (acc.unit || 'cái'));
                        formDataToSend.append(`Phụ kiện ${index + 1} - Đơn giá`, formatCurrency(acc.price || 0) + ' đ');
                        formDataToSend.append(`Phụ kiện ${index + 1} - Thành tiền`, formatCurrency(acc.totalPrice || 0) + ' đ');
                    });
                }
                
                // ========== 💰 TỔNG KẾT CHI PHÍ ==========
                const accessoriesTotal = result.accessoriesTotal || 0;
                const totalPrice = result.totalPrice || 0;
                formDataToSend.append('💰 TỔNG KẾT CHI PHÍ', '');
                formDataToSend.append('Tổng thiết bị', formatCurrency(totalPrice - accessoriesTotal) + ' đ');
                formDataToSend.append('Phụ kiện & lắp đặt', formatCurrency(accessoriesTotal) + ' đ');
                formDataToSend.append('TỔNG CHI PHÍ ĐẦU TƯ', formatCurrency(totalPrice) + ' VNĐ');
                
                console.log('Sending survey email via FormSubmit (table template)...');
                
                const response = await fetch(formSubmitUrl, {
                    method: 'POST',
                    body: formDataToSend,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const responseData = await response.json();
                
                if (responseData && responseData.success) {
                    console.log('✅ Email đã được gửi thành công qua FormSubmit!');
                } else {
                    console.error('❌ Lỗi khi gửi email qua FormSubmit:', responseData?.message || 'Unknown error');
                }
            } catch (error) {
                console.error('❌ Lỗi khi gửi email:', error);
                // Không hiển thị lỗi cho user để không làm gián đoạn trải nghiệm
            }
        }

        // Function to prepare survey package and go to checkout
        function buyPackage() {
            console.log('buyPackage function called');
            
            if (!window.currentSurveyResult) {
                showNotification('⚠️ Vui lòng tính toán báo giá trước khi mua', 'error');
                return;
            }

            const result = window.currentSurveyResult;
            const formData = window.currentFormData;
            
            try {
                showNotification('⏳ Đang chuẩn bị gói khảo sát...', 'info');

                // Prepare survey package data with all items
                const surveyPackage = {
                    fromSurvey: true,
                    items: [
                        // Tấm pin
                        {
                            id: result.solarPanelProductId,
                            title: result.solarPanelName,
                            price: result.solarPanelPrice,
                            quantity: result.panelCount,
                            image_url: result.solarPanelImage
                        },
                        // Inverter
                        {
                            id: result.selectedInverter?.id || ('inverter_' + Date.now()),
                            title: result.selectedInverter.name,
                            price: result.selectedInverter.price,
                            quantity: result.inverterQuantity || 1,
                            image_url: result.selectedInverter.image,
                            isVirtual: true
                        },
                        // Tủ điện
                        {
                            id: result.selectedCabinet?.id || ('cabinet_' + Date.now()),
                            title: result.selectedCabinet?.name || 'Tủ điện',
                            price: result.selectedCabinet?.price || 0,
                            quantity: 1,
                            image_url: result.selectedCabinet?.image || '',
                            isVirtual: true
                        },
                        // Pin lưu trữ
                        {
                            id: result.batteryProductId,
                            title: result.selectedBattery.name,
                            price: result.selectedBattery.price,
                            quantity: result.selectedBattery.units || 1,
                            image_url: result.selectedBattery.image
                        }
                    ],
                    // Add all accessories
                    accessories: result.accessories.map(acc => ({
                        id: 'accessory_' + acc.name.replace(/\s+/g, '_'),
                        title: acc.name,
                        price: acc.price,
                        quantity: acc.quantity,
                        image_url: acc.image,
                        isVirtual: true
                    })),
                    // Summary info
                    summary: {
                        inverter: result.selectedInverter.name,
                        invertorPrice: result.selectedInverter.price,
                        cabinet: result.selectedCabinet?.name || 'Tủ điện',
                        cabinetPrice: result.selectedCabinet?.price || 0,
                        totalEstimate: result.totalPrice,
                        systemSizeKw: result.systemSizeKw,
                        panelCount: result.panelCount,
                        region: formData.region,
                        phase: formData.phase
                    },
                    note: `Gói khảo sát điện mặt trời - ${result.systemSizeKw}kWp - ${result.panelCount} tấm pin - Inverter: ${result.selectedInverter.name} - Pin: ${result.selectedBattery.name}`
                };

                // Save to localStorage
                localStorage.setItem('surveyPackage', JSON.stringify(surveyPackage));
                console.log('Survey package saved to localStorage:', surveyPackage);
                console.log('Inverter quantity:', result.inverterQuantity, 'Price:', result.selectedInverter.price, 'Total:', result.inverterTotalPrice);
                console.log('Battery units:', result.selectedBattery.units, 'Price:', result.selectedBattery.price, 'Total:', result.selectedBattery.totalPrice);
                console.log('Panel count:', result.panelCount);

                showNotification('✅ Đã chuẩn bị gói khảo sát!', 'success');
                
                // Redirect to checkout page after a short delay
                setTimeout(() => {
                    window.location.href = 'dat-hang.html';
                }, 1000);

            } catch (error) {
                console.error('Error preparing package:', error);
                showNotification('❌ Lỗi khi chuẩn bị gói: ' + error.message, 'error');
            }
        }
    </script>

    <!-- Ecosystem Logos Carousel - Load from Product Categories API -->
    <script src="../assets/js/ecosystem-logos.js"></script>

    <!-- Neural Network Canvas -->
    <canvas id="neural-network-canvas"></canvas>
    
    <script>
        // Neural Network Animation
        (function() {
            const canvas = document.getElementById('neural-network-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Node class
            class Node {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.radius = Math.random() * 3 + 2;
                }
                
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    // Bounce off edges
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                    
                    // Keep in bounds
                    this.x = Math.max(0, Math.min(canvas.width, this.x));
                    this.y = Math.max(0, Math.min(canvas.height, this.y));
                }
                
                draw() {
                    // Draw node glow
                    const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius * 3);
                    gradient.addColorStop(0, 'rgba(134, 239, 172, 0.8)');
                    gradient.addColorStop(0.5, 'rgba(74, 222, 128, 0.4)');
                    gradient.addColorStop(1, 'rgba(134, 239, 172, 0)');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius * 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw node core
                    ctx.fillStyle = 'rgba(74, 222, 128, 0.9)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Create nodes - tăng số lượng nơ-ron nhiều hơn
            const nodeCount = 120;
            const nodes = [];
            for (let i = 0; i < nodeCount; i++) {
                nodes.push(new Node(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height
                ));
            }
            
            // Connection distance threshold - tăng khoảng cách kết nối
            const connectionDistance = 180;
            
            // Animation loop
            function animate() {
                // Clear canvas with slight fade for trail effect
                ctx.fillStyle = 'rgba(249, 250, 251, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Update and draw connections
                for (let i = 0; i < nodes.length; i++) {
                    for (let j = i + 1; j < nodes.length; j++) {
                        const dx = nodes[i].x - nodes[j].x;
                        const dy = nodes[i].y - nodes[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < connectionDistance) {
                            const opacity = (1 - distance / connectionDistance) * 0.3;
                            ctx.strokeStyle = `rgba(74, 222, 128, ${opacity})`;
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(nodes[i].x, nodes[i].y);
                            ctx.lineTo(nodes[j].x, nodes[j].y);
                            ctx.stroke();
                        }
                    }
                }
                
                // Update and draw nodes
                nodes.forEach(node => {
                    node.update();
                    node.draw();
                });
                
                requestAnimationFrame(animate);
            }
            
            // Start animation
            animate();
        })();
    </script>

</body>
</html>


