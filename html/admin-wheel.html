<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vòng Quay Admin - HC Eco System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/jpeg" href="../assets/img/logo.jpg" />
    <style>
        * {
            font-family: 'Times New Roman', Times, serif;
        }
        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 50%, #fff9c4 100%);
        }
        #wheel-graphic {
            transition: transform 4.5s cubic-bezier(0.23, 1, 0.32, 1);
            transform-origin: 50% 50%;
        }
        .pointer {
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #558b2f;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4));
        }
        .result-box {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border: 3px solid #7cb342;
            transition: all 0.3s ease;
        }
        .result-box.show-result {
            animation: resultPulse 0.6s ease-in-out;
            border-color: #558b2f;
            box-shadow: 0 0 20px rgba(124, 179, 66, 0.5);
        }
        @keyframes resultPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 50%, #fff9c4 100%);">
    <div class="min-h-screen flex flex-col">
        <header style="background: linear-gradient(135deg, #8bc34a 0%, #9ccc65 100%); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="container mx-auto px-6 py-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <p class="text-sm uppercase tracking-widest text-white font-bold" style="letter-spacing: 0.2em;">HC ECO SYSTEM</p>
                    <h1 class="text-3xl font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Bảng Điều Khiển Vòng Quay</h1>
                </div>
                <div class="flex flex-wrap gap-3">
                    <a href="admin.html" class="px-5 py-2 rounded-lg bg-white text-green-700 font-bold hover:bg-green-50 transition shadow-md">
                        Quay về Admin
                    </a>
                    <button id="refresh-prizes" class="px-5 py-2 rounded-lg bg-yellow-400 text-green-900 font-bold hover:bg-yellow-300 transition shadow-md">
                        Tải lại phần thưởng
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 container mx-auto px-6 py-10">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Wheel Section - 2/3 width -->
                <section class="lg:col-span-2 rounded-3xl p-12 flex items-center justify-center" style="background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%); box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid #c5e1a5;">
                    <div class="relative">
                        <div class="absolute left-1/2 -translate-x-1/2 -top-12 pointer"></div>
                        <svg id="wheel-svg" viewBox="0 0 420 420" width="560" height="560" style="filter: drop-shadow(0 10px 25px rgba(0,0,0,0.15));">
                            <g id="wheel-graphic"></g>
                            <circle cx="210" cy="210" r="45" fill="#558b2f" stroke="#7cb342" stroke-width="5"></circle>
                            <text x="210" y="218" text-anchor="middle" fill="#ffffff" font-size="16" font-weight="bold" style="font-family: 'Times New Roman', Times, serif;">HC-ECO</text>
                        </svg>
                    </div>
                </section>

                <!-- Controls Section - 1/3 width -->
                <section class="rounded-3xl p-8 flex flex-col justify-center space-y-6" style="background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%); box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid #c5e1a5;">
                    <div>
                        <h2 class="text-3xl font-bold mb-2" style="color: #558b2f;">Vòng Quay May Mắn</h2>
                        <p class="text-base" style="color: #7cb342;">Nhấn nút bên dưới để bắt đầu quay</p>
                    </div>
                    
                    <button id="spin-wheel-btn" class="w-full py-5 rounded-xl text-white text-xl font-bold shadow-lg transition transform hover:scale-105" style="background: linear-gradient(135deg, #7cb342 0%, #9ccc65 100%); box-shadow: 0 6px 20px rgba(124, 179, 66, 0.4);">
                        Click chuột hoặc nhấn Enter để quay
                    </button>
                    
                    <div id="wheel-result" class="result-box rounded-2xl p-6 min-h-[220px] flex flex-col justify-center" style="display: none;">
                        <p class="text-sm uppercase tracking-widest mb-3 font-bold" style="color: #558b2f; letter-spacing: 0.2em;">KẾT QUẢ</p>
                        <div id="wheel-result-content" class="text-2xl font-bold" style="color: #33691e;"></div>
                    </div>
                    
                    <p class="text-sm text-center" style="color: #9e9e9e;">Vòng quay dùng dữ liệu thực tế từ tab "Vòng quay" trong Admin.</p>
                </section>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '../api';
        let wheelData = [];
        let wheelSegments = [];
        let currentRotation = 0;
        let isSpinning = false;
        const wheelColors = ['#22c55e', '#6366f1', '#f97316', '#14b8a6', '#eab308', '#38bdf8', '#f43f5e', '#8b5cf6'];

        document.addEventListener('DOMContentLoaded', () => {
            initWheelAdmin();
            document.getElementById('spin-wheel-btn').addEventListener('click', spinWheel);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !isSpinning) {
                    spinWheel();
                }
            });
            document.getElementById('refresh-prizes').addEventListener('click', fetchWheelPrizes);
        });

        async function initWheelAdmin() {
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                fetchWheelPrizes();
            }
        }

        async function checkAdminAccess() {
            try {
                const url = API_BASE + '/check_admin_access.php?t=' + Date.now();
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                if (!data.success || !data.has_access) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Admin check failed:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        async function fetchWheelPrizes() {
            try {
                const url = API_BASE + '/admin/get_wheel_prizes.php?status=active&t=' + Date.now();
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (!data.success) {
                    showResultMessage(data.message || 'Khong the tai phan thuong', true);
                    disableSpinButton(true);
                    return;
                }
                wheelData = data.data?.prizes || [];
                buildWheel(wheelData);
                disableSpinButton(wheelData.length === 0);
                
                // Hide result box initially
                const resultBox = document.getElementById('wheel-result');
                if (resultBox) {
                    resultBox.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading wheel prizes:', error);
                showResultMessage('Khong the tai du lieu phan thuong.', true);
                disableSpinButton(true);
            }
        }

        function buildWheel(prizes) {
            const svgGroup = document.getElementById('wheel-graphic');
            if (!svgGroup) return;
            svgGroup.innerHTML = '';
            wheelSegments = [];

            if (prizes.length === 0) return;

            const sliceAngle = 360 / prizes.length;
            let startAngle = -90;

            prizes.forEach((prize, index) => {
                const endAngle = startAngle + sliceAngle;
                const color = wheelColors[index % wheelColors.length];

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', describeArc(210, 210, 180, startAngle, endAngle));
                path.setAttribute('fill', color);
                path.setAttribute('stroke', '#0f172a');
                path.setAttribute('stroke-width', '2');
                svgGroup.appendChild(path);

                const midAngle = startAngle + sliceAngle / 2;
                const textPoint = polarToCartesian(210, 210, 120, midAngle);
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', textPoint.x);
                text.setAttribute('y', textPoint.y);
                text.setAttribute('fill', '#0f172a');
                text.setAttribute('font-size', '11');
                text.setAttribute('font-weight', '700');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('transform', 'rotate(' + midAngle + ' ' + textPoint.x + ' ' + textPoint.y + ')');
                text.textContent = prize.prize_name;
                svgGroup.appendChild(text);

                wheelSegments.push({
                    prize,
                    startAngle,
                    endAngle,
                    midAngle,
                    weight: 1,
                });

                startAngle = endAngle;
            });
        }

        function renderPrizeList(prizes) {
            // Prize list removed - no longer needed in new layout
        }

        function spinWheel() {
            if (isSpinning || wheelSegments.length === 0) return;
            isSpinning = true;
            disableSpinButton(true, 'Đang quay...');

            const winner = pickRandomSegment();
            const extraSpins = 4 + Math.random() * 2;
            const rotationAmount = extraSpins * 360 + (winner.midAngle + 90);
            currentRotation -= rotationAmount;

            const wheelGraphic = document.getElementById('wheel-graphic');
            wheelGraphic.style.transform = 'rotate(' + currentRotation + 'deg)';

            setTimeout(() => {
                isSpinning = false;
                disableSpinButton(false, 'Click chuột hoặc nhấn Enter để quay');
                showResultMessage(formatWinnerMessage(winner.prize), false);
            }, 4600);
        }

        function pickRandomSegment() {
            const total = wheelSegments.reduce((sum, seg) => sum + seg.weight, 0);
            let random = Math.random() * total;
            for (const segment of wheelSegments) {
                random -= segment.weight;
                if (random <= 0) return segment;
            }
            return wheelSegments[wheelSegments.length - 1];
        }

        function formatWinnerMessage(prize) {
            if (!prize) return 'Khong xac dinh ket qua.';
            if (prize.prize_name?.toLowerCase().includes('chuc may man')) {
                return 'Khong trung thuong lan nay.<br><small class="text-slate-400 block mt-1">Hay thu quay lai nhe.</small>';
            }
            return '<strong>' + prize.prize_name + '</strong>' +
                '<div class="text-slate-400 text-sm mt-1">Chuc mung! Ban da trung phan thuong nay.</div>';
        }

        function showResultMessage(message, isError = false) {
            const resultBox = document.getElementById('wheel-result');
            const resultArea = document.getElementById('wheel-result-content');
            if (!resultArea || !resultBox) return;
            
            resultBox.style.display = 'flex';
            resultBox.classList.remove('show-result');
            
            setTimeout(() => {
                resultArea.innerHTML = message;
                resultBox.classList.add('show-result');
            }, 100);
        }

        function disableSpinButton(state, text) {
            const button = document.getElementById('spin-wheel-btn');
            if (!button) return;
            button.disabled = state;
            if (text) button.textContent = text;
            button.classList.toggle('opacity-60', state);
            button.classList.toggle('cursor-not-allowed', state);
        }

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees) * Math.PI / 180.0;
            return {
                x: centerX + radius * Math.cos(angleInRadians),
                y: centerY + radius * Math.sin(angleInRadians)
            };
        }

        function describeArc(x, y, radius, startAngle, endAngle) {
            const start = polarToCartesian(x, y, radius, endAngle);
            const end = polarToCartesian(x, y, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';

            return [
                'M', x, y,
                'L', start.x, start.y,
                'A', radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                'Z'
            ].join(' ');
        }

    </script>
</body>
</html>