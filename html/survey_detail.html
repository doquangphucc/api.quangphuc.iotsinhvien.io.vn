<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt kh·∫£o s√°t - HC Eco System</title>
        
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter with Vietnamese subset -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="../assets/img/logo.jpg" />
    
    <style>
        :root {
            --color-primary: #1E5631;
            --color-secondary: #3FA34D;
            --color-accent: #C5E384;
            --color-bg-light: #F4F9E9;
            --color-text-dark: #1a202c;
            --color-text-light: #f7fafc;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        body[data-theme="dark"] {
            background-color: #12181B;
            color: var(--color-text-light);
        }
        body[data-theme="dark"] .dark\:bg-gray-900 { background-color: #1a202c; }
        body[data-theme="dark"] .dark\:bg-gray-800 { background-color: #2d3748; }
        body[data-theme="dark"] .dark\:bg-gray-700 { background-color: #374151; }
        body[data-theme="dark"] .dark\:text-gray-100 { color: #f7fafc; }
        body[data-theme="dark"] .dark\:text-gray-300 { color: #d1d5db; }
        body[data-theme="dark"] .dark\:border-gray-700 { border-color: #4a5568; }
        body[data-theme="dark"] .dark\:border-gray-600 { border-color: #4b5563; }

        .theme-toggle__icon { display: none; }
        body:not([data-theme="dark"]) .theme-toggle__icon--sun { display: block; }
        body[data-theme="dark"] .theme-toggle__icon--moon { display: block; }

        .auth-btn {
            padding: 0.6rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            line-height: 1.25rem;
            text-decoration: none;
        }
        .auth-btn--login {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .auth-btn--login:hover {
            background-color: #e5e7eb;
        }
        .auth-btn--register {
            background-color: #16a34a;
            color: white;
        }
        .auth-btn--register:hover {
             background-color: #15803d;
        }
        .auth-user-name {
            font-weight: 600;
            font-size: 0.875rem; /* 14px - smaller font */
            padding: 0.5rem 0.75rem; /* Reduced padding */
            white-space: nowrap;
            text-decoration: none;
            max-width: 120px; /* Limit width */
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }
        .auth-user-name + .auth-btn--register { 
             background-color: #fee2e2;
             color: #b91c1c;
             font-size: 0.75rem; /* 12px - smaller font */
             padding: 0.5rem 0.75rem; /* Reduced padding */
             min-width: auto; /* Remove minimum width */
        }
         .auth-user-name + .auth-btn--register:hover {
             background-color: #fecaca;
        }
        body[data-theme="dark"] .auth-btn--login {
            background-color: #374151;
            color: #f9fafb;
        }
        body[data-theme="dark"] .auth-btn--login:hover {
            background-color: #4b5563;
        }
        body[data-theme="dark"] .auth-user-name {
            color: #d1d5db;
        }
        body[data-theme="dark"] .auth-user-name + .auth-btn--register {
             background-color: #450a0a;
             color: #fca5a5;
        }
        body[data-theme="dark"] .auth-user-name + .auth-btn--register:hover {
             background-color: #7f1d1d;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">

    <!-- Header -->
    <header id="header" class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700 transition-all duration-300">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-20">
                <a href="../index.html" class="flex items-center gap-3">
                    <img class="h-12 w-12 rounded-lg object-cover" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
                    <div>
                        <div class="font-bold text-lg text-gray-800 dark:text-white">HC<span class="text-green-600">ECO SYSTEM</span></div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">Gi·∫£i ph√°p b·ªÅn v·ªØng cho nƒÉng l∆∞·ª£ng t∆∞∆°ng lai</p>
                    </div>
                </a>

                <nav class="hidden lg:flex items-center bg-gray-100 dark:bg-gray-800 p-1 rounded-full">
                    <a href="gioi-thieu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Gi·ªõi thi·ªáu</a>
                    <a href="pricing.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">S·∫£n ph·∫©m</a>
                    <a href="du-an.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">D·ª± √°n</a>
                    <a href="tin-tuc.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Tin t·ª©c</a>
                    <a href="dich-vu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">H·ªá sinh th√°i</a>
                    <a href="lien-he.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Li√™n h·ªá</a>
                </nav>

                <div class="flex items-center gap-2">
                    <button class="theme-toggle h-10 w-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700" type="button" data-theme-toggle aria-label="Chuy·ªÉn giao di·ªán">
                        <svg class="theme-toggle__icon theme-toggle__icon--sun w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg class="theme-toggle__icon theme-toggle__icon--moon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                    <a class="cta hidden sm:inline-block bg-green-600 text-white font-semibold px-5 py-2.5 rounded-full hover:bg-green-700 transition-all duration-300 shadow-lg shadow-green-500/20" href="khao-sat-dien-mat-troi.html">Nh·∫≠n t∆∞ v·∫•n</a>
                    
                    <div id="auth-buttons" class="hidden sm:flex items-center gap-2"></div>

                    <button id="mobile-menu-button" class="lg:hidden h-10 w-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800">
                         <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="lg:hidden hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-4">
            <nav class="flex flex-col gap-2">
                <a href="gioi-thieu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Gi·ªõi thi·ªáu</a>
                <a href="pricing.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">S·∫£n ph·∫©m</a>
                <a href="du-an.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">D·ª± √°n</a>
                <a href="tin-tuc.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Tin t·ª©c</a>
                <a href="dich-vu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">H·ªá sinh th√°i</a>
                <a href="lien-he.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Li√™n h·ªá</a>

                <!-- Mobile Auth Buttons -->
                <div class="border-t border-gray-200 dark:border-gray-600 pt-4 mt-4">
                    <div id="mobile-auth-buttons" class="flex flex-col gap-2">
                        <!-- Dynamically populated by auth.js -->
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Floating Cart Button -->
    <a href="gio-hang.html" id="cart-fab" class="fixed bottom-6 right-6 z-50 h-14 w-14 bg-green-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-green-700 transition-all duration-300">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <span id="fab-cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800" style="display: none;">0</span>
    </a>

    <!-- Main Content -->
    <main class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 py-8 px-3">
        <div class="container mx-auto max-w-5xl">
            <!-- Back Button -->
            <div class="mb-6">
                <a href="survey_history.html" class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-semibold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Quay l·∫°i l·ªãch s·ª≠ kh·∫£o s√°t
                </a>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block w-16 h-16 border-4 border-green-200 border-t-green-600 rounded-full animate-spin"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">ƒêang t·∫£i chi ti·∫øt kh·∫£o s√°t...</p>
            </div>

            <!-- Survey Detail Content -->
            <div id="surveyDetail" class="hidden">
                <!-- Company Header -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 mb-4 shadow-lg">
                    <div class="flex items-center justify-between border-b-2 border-green-600 pb-3">
                        <div class="flex items-center gap-4">
                            <img src="../assets/img/logo.jpg" alt="SOLAR B·∫¢O DUY" class="w-20 h-20 object-cover rounded-lg">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">SOLAR B·∫¢O DUY</h1>
                                <p class="text-gray-600 dark:text-gray-400">Hotline: 0969 397 434</p>
                                <p class="text-gray-600 dark:text-gray-400">Email: baoduysolar@gmail.com</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-600 dark:text-gray-400">Ng√†y BG: <span id="quoteDate"></span></p>
                            <p class="text-gray-600 dark:text-gray-400">S·ªë BG: BG<span id="quoteNumber"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Title -->
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">B·∫¢NG B√ÅO GI√Å H·ªÜ TH·ªêNG ƒêI·ªÜN NLMT H√íA L∆Ø·ªöI C√ì L∆ØU TR·ªÆ</h2>
                </div>

                <!-- Customer Info -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 mb-4 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">K√çNH G·ª¨I</h3>
                    <div class="grid md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Qu√Ω Kh√°ch H√†ng: </span>
                            <span class="font-semibold text-gray-800 dark:text-white" id="customerName">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">S·ªê ƒêI·ªÜN THO·∫†I: </span>
                            <span class="font-semibold text-gray-800 dark:text-white" id="customerPhone">-</span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600 dark:text-gray-400">ƒê·ªäA CH·ªà: </span>
                            <span class="font-semibold text-gray-800 dark:text-white" id="customerAddress">-</span>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 mb-4 shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                                    <th class="p-2 text-left text-sm border-r border-white/30">T√äN V·∫¨T T∆Ø</th>
                                    <th class="p-2 text-left text-sm border-r border-white/30">TH∆Ø∆†NG HI·ªÜU</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30">B·∫¢O H√ÄNH</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30">ƒêVT</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30">SL</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30" style="width: 60px;">·∫¢NH</th>
                                    <th class="p-2 text-right text-sm border-r border-white/30">ƒê∆†N GI√Å (ƒë)</th>
                                    <th class="p-2 text-right text-sm">TH√ÄNH TI·ªÄN (ƒë)</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be loaded here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-emerald-100 dark:bg-emerald-900/30 font-bold">
                                    <td colspan="7" class="p-3 text-right pr-6 text-sm">T·ªîNG C·ªòNG:</td>
                                    <td class="p-3 text-right text-xl text-emerald-600" id="totalAmount">0ƒë</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Summary Info -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl p-4 mb-4 border-2 border-emerald-200 dark:border-emerald-800">
                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">T√ìM T·∫ÆT H·ªÜ TH·ªêNG</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">S·ªë KW ƒëi·ªán t·∫°o ra/ng√†y:</p>
                            <p class="text-xl font-bold text-emerald-600" id="dailyKWh">-</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">S·ªë KW ƒëi·ªán t·∫°o ra/th√°ng:</p>
                            <p class="text-xl font-bold text-emerald-600" id="monthlyKWhGen">-</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Ti·∫øt ki·ªám trung b√¨nh/th√°ng:</p>
                            <p class="text-xl font-bold text-emerald-600" id="monthlySavings">-</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Ti·∫øt ki·ªám m√πa h√®/th√°ng:</p>
                            <p class="text-xl font-bold text-emerald-600" id="summerSavings">-</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-4 mb-6">
                    <button onclick="window.print()" class="flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                        üìÑ In b√°o gi√°
                    </button>
                    <button onclick="buyPackageFromDetail()" id="buyPackageBtn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                        üõí Mua g√≥i n√†y
                    </button>
                    <a href="khao-sat-dien-mat-troi.html" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-200 text-center flex items-center justify-center">
                        ‚ú® T·∫°o kh·∫£o s√°t m·ªõi
                    </a>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-white dark:bg-gray-800 rounded-3xl p-12 text-center shadow-xl">
                <div class="w-32 h-32 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-3">Kh√¥ng t√¨m th·∫•y kh·∫£o s√°t</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-8" id="errorMessage">Kh·∫£o s√°t kh√¥ng t·ªìn t·∫°i ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn xem.</p>
                <a href="survey_history.html" class="inline-block bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold px-8 py-4 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    Quay l·∫°i l·ªãch s·ª≠
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="site-footer" class="bg-gray-800 dark:bg-black text-gray-300">
        <div class="container mx-auto px-4 py-12">
            <div class="grid lg:grid-cols-3 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                     <a href="../index.html" class="flex items-center gap-3">
                        <img class="h-12 w-12 rounded-lg object-cover" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
                        <div>
                            <div class="font-bold text-lg text-white">HC<span class="text-green-500">ECO SYSTEM</span></div>
                        </div>
                    </a>
                    <p class="text-sm text-gray-400">&copy; 2024 HC Eco System. Gi·ªØ v·ªØng cam k·∫øt nƒÉng l∆∞·ª£ng s·∫°ch cho m·ªói nh√†.</p>                    
                    <!-- Ecosystem Logos Animation -->
                    <div class="mt-6 relative overflow-hidden" style="height: 80px;">
                        <div id="ecosystem-logos-container" class="flex gap-6">
                            <!-- Logos will be inserted by JavaScript -->
                        </div>
        </div>
                </div>

                <div class="space-y-2">
                    <h4 class="font-semibold text-white">Th√¥ng tin li√™n h·ªá</h4>
                    <ul class="text-sm text-gray-400 space-y-1">
                        <li><strong>Hotline:</strong> 0969 397 434 (Ch√≠nh)</li>
                        <li><strong>Hotline ph·ª•:</strong> 0988 919 868</li>
                        <li><strong>Zalo:</strong> 0969 397 434</li>
                        <li><strong>Email:</strong> hcecosystem@gmail.com</li>
                        <li><strong>Website:</strong> hcecosystem.vn</li>
                        <li><strong>ƒê·ªãa ch·ªâ VƒÉn ph√≤ng:</strong><br>790 Ng√¥ Quy·ªÅn, Ph∆∞·ªùng An H·∫£i, Th√†nh Ph·ªë ƒê√† N·∫µng</li>
                    </ul>
                </div>

                <div class="space-y-2">
                     <h4 class="font-semibold text-white">Ch√≠nh s√°ch & D·ªãch v·ª•</h4>
                    <ul class="text-sm space-y-1">
                        <li><a href="tam-nhin-su-menh.html" class="text-gray-400 hover:text-white">T·∫ßm Nh√¨n & S·ª© M·ªánh</a></li>
                        <li><a href="dieu-khoan-dieu-kien.html" class="text-gray-400 hover:text-white">ƒêi·ªÅu Kho·∫£n & ƒêi·ªÅu Ki·ªán</a></li>
                        <li><a href="chinh-sach-doi-tra.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch ƒê·ªïi Tr·∫£</a></li>
                        <li><a href="chinh-sach-bao-mat-thong-tin-ca-nhan.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch B·∫£o M·∫≠t Th√¥ng Tin C√° Nh√¢n</a></li>
                        <li><a href="chinh-sach-bao-mat-thong-tin-thanh-toan.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch B·∫£o M·∫≠t Th√¥ng Tin Thanh To√°n</a></li>
                        <li><a href="chinh-sach-bao-hanh.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch B·∫£o H√†nh</a></li>
                        <li><a href="tro-thanh-nha-phan-phoi.html" class="text-gray-400 hover:text-white">Tr·ªü Th√†nh Nh√† Ph√¢n Ph·ªëi</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="../assets/js/theme.js"></script>
    <script src="../assets/js/shopping-cart.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/cache-buster.js"></script>
    
    <!-- Survey Detail Logic -->
    <script>
        let surveyData = null;
        let surveyId = null;
        let surveyProducts = null; // Cache survey products for image fallback
        
        // Get survey ID from URL parameters
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            surveyId = urlParams.get('id');
            
            if (!surveyId) {
                showError('Kh√¥ng t√¨m th·∫•y ID kh·∫£o s√°t');
                return;
            }
            
            // Load survey products for image fallback (same as khao-sat-dien-mat-troi.html)
            try {
                const productsResponse = await fetch('../api/get_survey_products_public.php');
                const productsData = await productsResponse.json();
                if (productsData.success && productsData.products) {
                    surveyProducts = productsData.products;
                    console.log('Loaded survey products for image fallback');
                }
            } catch (err) {
                console.error('Error loading survey products:', err);
            }
            
            await loadSurveyDetail(surveyId);
        });
        
        async function loadSurveyDetail(id) {
            try {
                console.log('Loading survey detail for ID:', id);
                
                const response = await fetch(`../api/get_survey_detail.php?id=${id}`, {
                    credentials: 'include'
                });
                
                console.log('API response:', response);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('API result:', result);
                    
                    if (result.success && result.data && result.data.survey) {
                        surveyData = result.data.survey;
                        displaySurveyDetail(surveyData);
                    } else {
                        showError(result.message || 'Kh√¥ng t√¨m th·∫•y kh·∫£o s√°t');
                    }
                } else if (response.status === 401) {
                    window.location.href = 'login.html';
                } else {
                    const errorResult = await response.json();
                    showError(errorResult.message || 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt kh·∫£o s√°t');
                }
            } catch (error) {
                console.error('Error loading survey detail:', error);
                showError('L·ªói k·∫øt n·ªëi server');
            }
        }
        
        function displaySurveyDetail(survey) {
            const loadingEl = document.getElementById('loading');
            const surveyDetailEl = document.getElementById('surveyDetail');
            const errorStateEl = document.getElementById('errorState');
            
            // Hide loading and error
            loadingEl.classList.add('hidden');
            errorStateEl.classList.add('hidden');
            
            // Show survey detail
            surveyDetailEl.classList.remove('hidden');
            
            // Populate data
            populateSurveyData(survey);
        }
        
        function populateSurveyData(survey) {
            // Debug: Log full API response
            console.log('populateSurveyData - Full survey object:', survey);
            console.log('populateSurveyData - Results:', survey.results);
            
            // Set quote date and number
            const createdAt = new Date(survey.createdAt);
            document.getElementById('quoteDate').textContent = createdAt.toLocaleDateString('vi-VN');
            document.getElementById('quoteNumber').textContent = survey.id;
            
            // Customer info
            document.getElementById('customerName').textContent = survey.fullName || '-';
            document.getElementById('customerPhone').textContent = survey.phone || '-';
            document.getElementById('customerAddress').textContent = `Khu v·ª±c: ${survey.regionName || '-'}`;
            
            const r = survey.results;
            
            // Debug: Log image URLs from API
            console.log('populateSurveyData - panelImage:', r?.panelImage);
            console.log('populateSurveyData - inverterImage:', r?.inverterImage);
            console.log('populateSurveyData - batteryImage:', r?.batteryImage);
            console.log('populateSurveyData - cabinetImage:', r?.cabinetImage);
            
            // Helper function to find image from survey products (fallback)
            function findImageFromProductsForDisplay(productName, category, phaseType = null) {
                if (!surveyProducts) return null;
                
                let productsToSearch = [];
                
                if (category === 'solar_panel' && surveyProducts.solar_panel) {
                    productsToSearch = surveyProducts.solar_panel;
                } else if (category === 'inverter' && surveyProducts.inverter) {
                    const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                    productsToSearch = [
                        ...(surveyProducts.inverter[phaseKey] || []),
                        ...(surveyProducts.inverter['both'] || [])
                    ];
                } else if (category === 'battery' && surveyProducts.battery) {
                    productsToSearch = surveyProducts.battery;
                } else if (category === 'electrical_cabinet' && surveyProducts.electrical_cabinet) {
                    const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                    productsToSearch = [
                        ...(surveyProducts.electrical_cabinet[phaseKey] || []),
                        ...(surveyProducts.electrical_cabinet['both'] || [])
                    ];
                }
                
                // Find product by matching title
                const found = productsToSearch.find(p => {
                    const titleLower = (p.title || '').toLowerCase();
                    const nameLower = (productName || '').toLowerCase();
                    return titleLower.includes(nameLower) || nameLower.includes(titleLower);
                });
                
                if (found && found.image_url) {
                    console.log(`Found image from survey products for display '${productName}':`, found.image_url);
                    return found.image_url;
                }
                
                return null;
            }
            
            // Helper function to fix image URL path for survey_detail.html
            function fixImageUrlForDetailPage(imageUrl) {
                if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined' || imageUrl.trim() === '') {
                    return null;
                }
                
                // If already absolute URL, return as is
                if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                    return imageUrl;
                }
                
                // If starts with /assets, convert to relative path (from html/ directory)
                if (imageUrl.startsWith('/assets/')) {
                    return '..' + imageUrl;
                }
                
                // If starts with assets/ (no leading slash), add ../
                if (imageUrl.startsWith('assets/')) {
                    return '../' + imageUrl;
                }
                
                // If already relative path, return as is
                if (imageUrl.startsWith('../')) {
                    return imageUrl;
                }
                
                // Otherwise, assume it's relative to assets
                return '../assets/img/products/' + imageUrl;
            }
            
            // Helper to get image URL with fallback
            function getImageUrlForDisplay(apiImage, productName, category, phaseType = null) {
                // First, try API image
                if (apiImage && apiImage !== 'null' && apiImage.trim() !== '') {
                    return fixImageUrlForDetailPage(apiImage);
                }
                
                // Fallback: find from survey products
                const fallbackImage = findImageFromProductsForDisplay(productName, category, phaseType);
                if (fallbackImage) {
                    return fixImageUrlForDetailPage(fallbackImage);
                }
                
                return null;
            }
            
            // T√≠nh danh s√°ch t·ªß ƒëi·ªán ph√π h·ª£p v√† ph∆∞∆°ng √°n thay th·∫ø (n·∫øu c√≥)
            let cabinetAlternatives = [];
            let selectedCabinetIdx = 0;
            (function buildCabinetAlternatives(){
                if (!surveyProducts || !surveyProducts.electrical_cabinet) return;
                // ∆Øu ti√™n ƒë√∫ng pha + c·∫£ hai pha
                const phaseKey = survey.phase === 1 ? '1_phase' : survey.phase === 3 ? '3_phase' : 'both';
                let available = [
                    ...((surveyProducts.electrical_cabinet[phaseKey] || [])),
                    ...((surveyProducts.electrical_cabinet['both'] || []))
                ].map(c => ({
                    id: c.id,
                    name: c.title,
                    power: (c.cabinet_power_kw && c.cabinet_power_kw > 0) ? c.cabinet_power_kw*1000 : (parseInt((c.title||'').match(/(\d+)kW/i)?.[1]||'0')*1000),
                    price: Number(c.price||0),
                    image: c.image_url ? (c.image_url.startsWith('/') ? '..'+c.image_url : (c.image_url.startsWith('..')? c.image_url : ('../'+c.image_url))) : null
                })).filter(c=>c.power>0).sort((a,b)=>a.power-b.power);

                // Suy ra c√¥ng su·∫•t inverter (W)
                let inverterPowerW = 0;
                if (typeof r?.inverterCapacity === 'number' && r.inverterCapacity > 0) {
                    inverterPowerW = r.inverterCapacity * 1000;
                } else if (r?.inverterName) {
                    const m = r.inverterName.match(/(\d+)\s*K/i);
                    if (m) inverterPowerW = parseInt(m[1],10)*1000;
                }
                if (!inverterPowerW) return;

                const minPower = available.filter(c=>c.power>=inverterPowerW).reduce((min,c)=>Math.min(min,c.power), Infinity);
                cabinetAlternatives = available.filter(c=>c.power>=inverterPowerW && c.power===minPower);
                if (cabinetAlternatives.length===0 && available.length>0) {
                    cabinetAlternatives = [available[available.length-1]];
                }
            })();

            // L∆∞u v√†o window ƒë·ªÉ d√πng cho mua g√≥i
            window.currentCabinetAlternatives = cabinetAlternatives;
            window.selectedCabinetIdxFromDetail = selectedCabinetIdx;

            // Build products table
            const productsTableBody = document.getElementById('productsTableBody');
            let totalAmount = 0;
            
            // Build strictly from database fields to avoid mismatch
            // Recompute accessories from Admin configs to align with khao-sat-dien-mat-troi.html logic
            const panelCount = Number(r?.panelsNeeded ?? 0);
            const selectedBatteryUnits = Number(r?.batteryQuantity ?? 1);
            let computedAccessories = [];
            if (surveyProducts && surveyProducts.accessory && Array.isArray(surveyProducts.accessory)) {
                computedAccessories = surveyProducts.accessory.map(acc => {
                    const depTarget = acc.accessory_dependent_target || 'project';
                    const baseQty = typeof acc.accessory_base_qty === 'number' ? acc.accessory_base_qty : 0;
                    const depQty = typeof acc.accessory_dependent_qty === 'number' && acc.accessory_dependent_qty !== null ? acc.accessory_dependent_qty : 1;
                    let targetCount = 1;
                    if (depTarget === 'panel') targetCount = panelCount;
                    else if (depTarget === 'inverter') targetCount = 1;
                    else if (depTarget === 'battery') targetCount = selectedBatteryUnits;
                    else if (depTarget === 'cabinet') targetCount = 1;
                    else targetCount = 1; // project
                    const qty = (depTarget === 'project') ? baseQty : baseQty * targetCount * depQty;
                    const unitPrice = Number(acc.price || 0);
                    return {
                        name: acc.title,
                        unit: acc.accessory_unit || '',
                        quantity: qty,
                        price: unitPrice,
                        totalPrice: qty * unitPrice,
                        image: acc.image_url ? fixImageUrlForDetailPage(acc.image_url) : null
                    };
                });
            }

            const chosenCabinet = (cabinetAlternatives && cabinetAlternatives.length>0) ? cabinetAlternatives[selectedCabinetIdx] : null;
            const products = [
                {
                    name: r?.panelName || 'T·∫•m Pin',
                    brand: r?.panelName ? (r.panelName.split(' ')[0] || '-') : '-',
                    warranty: '12 nƒÉm',
                    unit: 'T·∫•m',
                    qty: Number(r?.panelsNeeded ?? 0),
                    image: getImageUrlForDisplay(r?.panelImage, r?.panelName, 'solar_panel'),
                    unitPrice: Number(r?.panelPrice ?? 0),
                    totalPrice: Number(r?.panelCost ?? 0)
                },
                {
                    name: r?.inverterName || 'Inverter',
                    brand: '-',
                    warranty: '5 nƒÉm',
                    unit: 'B·ªô',
                    qty: 1,
                    image: getImageUrlForDisplay(r?.inverterImage, r?.inverterName, 'inverter', survey.phase),
                    unitPrice: Number(r?.inverterPrice ?? 0),
                    totalPrice: Number(r?.inverterPrice ?? 0)
                },
                {
                    name: r?.batteryName || 'Pin l∆∞u tr·ªØ',
                    brand: '-',
                    warranty: '10 nƒÉm',
                    unit: 'B·ªô',
                    qty: Number(r?.batteryQuantity ?? 1),
                    image: getImageUrlForDisplay(r?.batteryImage, r?.batteryName, 'battery'),
                    unitPrice: Number(r?.batteryUnitPrice ?? 0),
                    totalPrice: Number(r?.batteryCost ?? 0)
                },
                {
                    name: (chosenCabinet?.name) || r?.cabinetName || 'T·ªß ƒëi·ªán',
                    brand: '-',
                    warranty: '3 nƒÉm',
                    unit: 'T·ªß',
                    qty: 1,
                    image: getImageUrlForDisplay((chosenCabinet?.image)||r?.cabinetImage, (chosenCabinet?.name)||r?.cabinetName, 'electrical_cabinet', survey.phase),
                    unitPrice: Number((chosenCabinet?.price) ?? (r?.cabinetPrice ?? 0)),
                    totalPrice: Number((chosenCabinet?.price) ?? (r?.cabinetPrice ?? 0)),
                    __isCabinet: true
                },
                // Push computed accessories as individual rows (always show all configured)
                ...computedAccessories.map(a => ({
                    name: a.name,
                    brand: '-',
                    warranty: '1 nƒÉm',
                    unit: a.unit || 'm·ª•c',
                    qty: a.quantity,
                    image: a.image,
                    unitPrice: a.price,
                    totalPrice: a.totalPrice
                })),
                {
                    name: 'Chi ph√≠ c√¥ng th·ª£ l·∫Øp ƒë·∫∑t tr·ªçn g√≥i',
                    brand: '-',
                    warranty: '-',
                    unit: 'ƒê·ªôi',
                    qty: 1,
                    image: null,
                    unitPrice: Number(r?.laborCost ?? 0),
                    totalPrice: Number(r?.laborCost ?? 0)
                },
                {
                    name: 'Chi ph√≠ v·∫≠n chuy·ªÉn thi·∫øt b·ªã',
                    brand: '-',
                    warranty: '-',
                    unit: 'Chuy·∫øn',
                    qty: 1,
                    image: null,
                    unitPrice: 0,
                    totalPrice: 0,
                    note: 'T√πy ƒëi·ªÅu ki·ªán'
                },
                {
                    name: 'Chi ph√≠ Gia c√¥ng khung s∆∞·ªùn gi√° ƒë·ª° t·∫•m pin',
                    brand: '-',
                    warranty: '-',
                    unit: 'B·ªô',
                    qty: 1,
                    image: null,
                    unitPrice: 0,
                    totalPrice: 0,
                    note: 'T√πy c√¥ng tr√¨nh'
                },
                {
                    name: 'D√¢y DC chuy√™n d·ª•ng',
                    brand: '-',
                    warranty: '-',
                    unit: 'M√©t',
                    qty: Number(r?.dcCableLength ?? 100),
                    image: null,
                    unitPrice: Number(r?.dcCablePrice ?? 0),
                    totalPrice: Number(r?.dcCableCost ?? 0)
                }
            ];
            
            productsTableBody.innerHTML = products.map(item => {
                totalAmount += item.totalPrice;
                
                // Check if image is emoji
                const isEmoji = item.image && item.image.length <= 3 && !item.image.includes('/');
                
                let imageHtml;
                if (isEmoji && item.image) {
                    imageHtml = `<div class="w-10 h-10 mx-auto flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded text-2xl">${item.image}</div>`;
                } else if (item.image) {
                    // Handle different path formats
                    let imgSrc;
                    if (item.image.startsWith('http://') || item.image.startsWith('https://')) {
                        imgSrc = item.image;
                    } else if (item.image.startsWith('/')) {
                        imgSrc = '..' + item.image;
                    } else if (item.image.startsWith('../')) {
                        imgSrc = item.image;
                    } else {
                        imgSrc = '../' + item.image;
                    }
                    imageHtml = `<img 
                        src="${imgSrc}" 
                        alt="${item.name}" 
                        class="w-10 h-10 object-contain mx-auto rounded"
                        onerror="this.src='../assets/img/logo.jpg'"
                    >`;
                } else {
                    imageHtml = '<div class="w-10 h-10 mx-auto flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded text-[10px] text-gray-400">No Image</div>';
                }
                
                const cabinetChoiceHtml = (item.__isCabinet && cabinetAlternatives && cabinetAlternatives.length>1) ? `
                    <div style="margin:6px 0; padding:6px; background:#f7fafc; border:1px dashed #cbd5e0; border-radius:6px;">
                        <small style="color:#4a5568; font-weight:600;">Ch·ªçn t·ªß ƒëi·ªán (c√πng m·ª©c c√¥ng su·∫•t):</small><br>
                        ${cabinetAlternatives.map((cab, idx)=>`
                            <label style='margin-right:10px; display:inline-flex; align-items:center; gap:6px;'>
                                <input type="radio" name="cabinetChoice" value="${idx}" ${idx===selectedCabinetIdx?'checked':''}>
                                <span>${cab.name}</span>
                            </label>
                        `).join('')}
                    </div>
                ` : '';

                return `
                    <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700">${item.name}${cabinetChoiceHtml}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700">${item.brand}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${item.warranty}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${item.unit}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${item.qty}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${imageHtml}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-right">${item.unitPrice > 0 ? item.unitPrice.toLocaleString('vi-VN') : item.note || '-'}</td>
                        <td class="p-2 text-right font-semibold">${item.totalPrice > 0 ? item.totalPrice.toLocaleString('vi-VN') : item.note || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            // Update totals
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString('vi-VN');

            // L·∫Øng nghe ch·ªçn t·ªß ƒëi·ªán n·∫øu c√≥ nhi·ªÅu ph∆∞∆°ng √°n
            const cabRadios = document.querySelectorAll('input[name="cabinetChoice"]');
            if (cabRadios && cabRadios.length>1) {
                cabRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        window.selectedCabinetIdxFromDetail = parseInt(e.target.value,10)||0;
                        // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t t√™n/gi√°/t·ªïng
                        populateSurveyData(survey);
                    });
                });
            }
            
            // Summary calculations
            const dailyKWh = (r?.totalCapacity || 0) * (r?.sunHours || 4.4);
            const monthlyKWh = dailyKWh * 30;
            const monthlySavings = survey.monthlyBill * 0.8;
            const summerSavings = monthlySavings * 1.25;
            
            document.getElementById('dailyKWh').textContent = `${dailyKWh.toFixed(1)} KW`;
            document.getElementById('monthlyKWhGen').textContent = `${monthlyKWh.toFixed(0)} KW`;
            document.getElementById('monthlySavings').textContent = `${Math.round(monthlySavings).toLocaleString('vi-VN')}ƒë`;
            document.getElementById('summerSavings').textContent = `${Math.round(summerSavings).toLocaleString('vi-VN')}ƒë`;
        }
        
        function getUsageTimeText(usageTime) {
            const timeMap = {
                'day': 'Ban ng√†y',
                'night': 'Ban ƒë√™m',
                'balanced': 'C√¢n b·∫±ng'
            };
            return timeMap[usageTime] || usageTime || '-';
        }
        
        function showError(message) {
            const loadingEl = document.getElementById('loading');
            const surveyDetailEl = document.getElementById('surveyDetail');
            const errorStateEl = document.getElementById('errorState');
            
            loadingEl.classList.add('hidden');
            surveyDetailEl.classList.add('hidden');
            errorStateEl.classList.remove('hidden');
            
            document.getElementById('errorMessage').textContent = message;
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Function to prepare survey package from detail page and go to checkout
        async function buyPackageFromDetail() {
            console.log('buyPackageFromDetail function called');
            
            if (!surveyData) {
                showNotification('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu kh·∫£o s√°t', 'error');
                return;
            }

            const survey = surveyData;
            const r = survey.results;
            
            // Debug: Log image URLs from API response
            console.log('API Response - panelImage:', r?.panelImage);
            console.log('API Response - inverterImage:', r?.inverterImage);
            console.log('API Response - batteryImage:', r?.batteryImage);
            console.log('API Response - cabinetImage:', r?.cabinetImage);
            
            try {
                showNotification('‚è≥ ƒêang chu·∫©n b·ªã g√≥i kh·∫£o s√°t...', 'info');

                // Calculate system size from panels
                const systemSizeKw = r?.totalCapacity || 0;
                const panelCount = r?.panelsNeeded || 0;
                
                // Load survey products from API (same as khao-sat-dien-mat-troi.html)
                // This ensures we can find images even if API response has null images
                let surveyProducts = null;
                try {
                    const productsResponse = await fetch('../api/get_survey_products_public.php');
                    const productsData = await productsResponse.json();
                    if (productsData.success && productsData.products) {
                        surveyProducts = productsData.products;
                        console.log('Loaded survey products for fallback:', surveyProducts);
                    }
                } catch (err) {
                    console.error('Error loading survey products:', err);
                }

                // Helper function to find image from survey products (same logic as khao-sat-dien-mat-troi.html)
                function findImageFromProducts(productName, category, phaseType = null) {
                    if (!surveyProducts) return null;
                    
                    let productsToSearch = [];
                    
                    if (category === 'solar_panel' && surveyProducts.solar_panel) {
                        productsToSearch = surveyProducts.solar_panel;
                    } else if (category === 'inverter' && surveyProducts.inverter) {
                        const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                        productsToSearch = [
                            ...(surveyProducts.inverter[phaseKey] || []),
                            ...(surveyProducts.inverter['both'] || [])
                        ];
                    } else if (category === 'battery' && surveyProducts.battery) {
                        productsToSearch = surveyProducts.battery;
                    } else if (category === 'electrical_cabinet' && surveyProducts.electrical_cabinet) {
                        const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                        productsToSearch = [
                            ...(surveyProducts.electrical_cabinet[phaseKey] || []),
                            ...(surveyProducts.electrical_cabinet['both'] || [])
                        ];
                    }
                    
                    // Find product by matching title
                    const found = productsToSearch.find(p => {
                        const titleLower = (p.title || '').toLowerCase();
                        const nameLower = (productName || '').toLowerCase();
                        return titleLower.includes(nameLower) || nameLower.includes(titleLower);
                    });
                    
                    if (found && found.image_url) {
                        console.log(`Found image from survey products for '${productName}':`, found.image_url);
                        return found.image_url;
                    }
                    
                    return null;
                }
                
                // Helper function to fix image URL path (same as khao-sat-dien-mat-troi.html)
                function fixImageUrl(imageUrl) {
                    // Debug: log original imageUrl
                    console.log('fixImageUrl input:', imageUrl);
                    
                    if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined' || imageUrl.trim() === '') {
                        console.log('fixImageUrl: returning null for empty imageUrl');
                        return null;
                    }
                    
                    // If already absolute URL, return as is
                    if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                        console.log('fixImageUrl: absolute URL, returning as is');
                        return imageUrl;
                    }
                    
                    // Remove leading '../', '..//', './', etc. (same as khao-sat-dien-mat-troi.html)
                    imageUrl = imageUrl.replace(/^(\.\.\/)+/, '').replace(/^\.\//, '');
                    
                    // Add leading slash if not present (same as khao-sat-dien-mat-troi.html)
                    if (!imageUrl.startsWith('/')) {
                        imageUrl = '/' + imageUrl;
                    }
                    
                    console.log('fixImageUrl: final result:', imageUrl);
                    return imageUrl;
                }
                
                // Helper to get image with fallback
                function getImageUrl(apiImage, productName, category, phaseType = null) {
                    // First, try API image
                    if (apiImage && apiImage !== 'null' && apiImage.trim() !== '') {
                        return fixImageUrl(apiImage);
                    }
                    
                    // Fallback: find from survey products
                    const fallbackImage = findImageFromProducts(productName, category, phaseType);
                    if (fallbackImage) {
                        return fixImageUrl(fallbackImage);
                    }
                    
                    return null;
                }

                // Prepare survey package data with all items
                const chosenIdx = window.selectedCabinetIdxFromDetail || 0;
                const chosenCabinet = (window.currentCabinetAlternatives && window.currentCabinetAlternatives.length>0) ? window.currentCabinetAlternatives[chosenIdx] : null;

                const surveyPackage = {
                    fromSurvey: true,
                    items: [
                        // T·∫•m pin
                        {
                            id: r?.panelId || null,
                            title: r?.panelName || 'T·∫•m Pin',
                            price: Number(r?.panelPrice || 0),
                            quantity: panelCount,
                            image_url: getImageUrl(r?.panelImage, r?.panelName, 'solar_panel')
                        },
                        // Inverter
                        {
                            id: r?.inverterId || null,
                            title: r?.inverterName || 'Inverter',
                            price: Number(r?.inverterPrice || 0),
                            quantity: 1,
                            image_url: getImageUrl(r?.inverterImage, r?.inverterName, 'inverter', survey.phase),
                            isVirtual: true
                        },
                        // Pin l∆∞u tr·ªØ
                        {
                            id: r?.batteryId || null,
                            title: r?.batteryName || 'Pin l∆∞u tr·ªØ',
                            price: Number(r?.batteryUnitPrice || 0),
                            quantity: Number(r?.batteryQuantity || 1),
                            image_url: getImageUrl(r?.batteryImage, r?.batteryName, 'battery')
                        }
                    ],
                    // Add all accessories as separate items (recomputed to match survey page)
                    accessories: [
                        // T·ªß ƒëi·ªán
                        {
                            id: (chosenCabinet?.id) || (r?.cabinetId || null),
                            title: (chosenCabinet?.name) || (r?.cabinetName || 'T·ªß ƒëi·ªán'),
                            price: Number((chosenCabinet?.price) || (r?.cabinetPrice || 0)),
                            quantity: 1,
                            image_url: getImageUrl((chosenCabinet?.image)||r?.cabinetImage, (chosenCabinet?.name)||r?.cabinetName, 'electrical_cabinet', survey.phase),
                            isVirtual: true
                        },
                        // C√°c ph·ª• ki·ªán c·∫•u h√¨nh t·ª´ Admin (computedAccessories)
                        ...computedAccessories.map(a => ({
                            id: 'accessory_' + a.name.replace(/\s+/g, '_'),
                            title: a.name,
                            price: a.price,
                            quantity: a.quantity,
                            image_url: a.image,
                            isVirtual: true
                        })),
                        // V·∫≠t t∆∞ v√† ph·ª• ki·ªán ƒëi k√®m (t·ªïng)
                        {
                            id: 'accessory_phukien',
                            title: 'V·∫≠t t∆∞ v√† ph·ª• ki·ªán ƒëi k√®m',
                            price: Number(r?.accessoriesCost || 0),
                            quantity: 1,
                            image_url: null,
                            isVirtual: true
                        },
                        // K·∫πp bi√™n
                        {
                            id: 'accessory_clip',
                            title: 'K·∫πp bi√™n, K·∫πp gi·ªØa t·∫•m PIN',
                            price: Number(r?.clipPrice || 0),
                            quantity: Number(r?.clipQty || 0),
                            image_url: null,
                            isVirtual: true
                        },
                        // C√¥ng th·ª£
                        {
                            id: 'accessory_labor',
                            title: 'Chi ph√≠ c√¥ng th·ª£ l·∫Øp ƒë·∫∑t tr·ªçn g√≥i',
                            price: Number(r?.laborCost || 0),
                            quantity: 1,
                            image_url: 'üîß',
                            isVirtual: true
                        },
                        // V·∫≠n chuy·ªÉn
                        {
                            id: 'accessory_transport',
                            title: 'Chi ph√≠ v·∫≠n chuy·ªÉn thi·∫øt b·ªã',
                            price: 0,
                            quantity: 1,
                            image_url: 'üöõ',
                            isVirtual: true
                        },
                        // D√¢y DC
                        {
                            id: 'accessory_dc_cable',
                            title: 'D√¢y DC chuy√™n d·ª•ng',
                            price: Number(r?.dcCablePrice || 0),
                            quantity: Number(r?.dcCableLength || 100),
                            image_url: null,
                            isVirtual: true
                        }
                    ],
                    // Summary info
                    summary: {
                        inverter: r?.inverterName || 'Inverter',
                        invertorPrice: Number(r?.inverterPrice || 0),
                        cabinet: r?.cabinetName || 'T·ªß ƒëi·ªán',
                        cabinetPrice: Number(r?.cabinetPrice || 0),
                        totalEstimate: Number(r?.totalCost || 0),
                        systemSizeKw: systemSizeKw,
                        panelCount: panelCount,
                        region: survey.region,
                        phase: survey.phase
                    },
                    note: `G√≥i kh·∫£o s√°t ƒëi·ªán m·∫∑t tr·ªùi - ${systemSizeKw}kWp - ${panelCount} t·∫•m pin - Inverter: ${r?.inverterName || 'N/A'} - Pin: ${r?.batteryName || 'N/A'}`
                };

                // Save to localStorage
                localStorage.setItem('surveyPackage', JSON.stringify(surveyPackage));
                console.log('Survey package saved to localStorage:', surveyPackage);

                showNotification('‚úÖ ƒê√£ chu·∫©n b·ªã g√≥i kh·∫£o s√°t!', 'success');
                
                // Redirect to checkout page after a short delay
                setTimeout(() => {
                    window.location.href = 'dat-hang.html';
                }, 1000);

            } catch (error) {
                console.error('Error preparing package:', error);
                showNotification('‚ùå L·ªói khi chu·∫©n b·ªã g√≥i: ' + error.message, 'error');
            }
        }
    </script>
    
    <script>
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        mobileMenu.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                mobileMenu.classList.add('hidden');
            }
        });

        // Highlight active navigation item based on current page
        (function() {
            const currentPath = window.location.pathname;
            const currentPage = currentPath.split('/').pop() || 'index.html';
            
            // Select all nav links (both desktop and mobile)
            const navLinks = document.querySelectorAll('nav a[href*=".html"]');
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                const linkPage = href.split('/').pop();
                
                const isActive = linkPage === currentPage;
                
                if (isActive) {
                    // Remove default classes
                    link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-white', 'dark:hover:bg-gray-700', 'hover:bg-gray-100');
                    // Add active classes
                    link.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
                }
            });
        })();
    </script>

    <!-- Ecosystem Logos Carousel -->
    <script>
        (function() {
            const logos = [
                { src: '../assets/img/ecosystem/baoduy-solar-logo.jpg', alt: 'B·∫£o Duy Solar' },
                { src: '../assets/img/ecosystem/hc-travel-logo.jpg', alt: 'HC Travel' },
                { src: '../assets/img/ecosystem/hc-cafe-logo.jpg', alt: 'HC Coffee & Restaurant' },
                { src: '../assets/img/ecosystem/c-home-logo.jpg', alt: 'C Home Build' }
            ];
            const container = document.getElementById('ecosystem-logos-container');
            if (!container) return;
            let currentIndex = 0;
            function createLogos() {
                container.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    const logoIndex = (currentIndex + i) % logos.length;
                    const img = document.createElement('img');
                    img.src = logos[logoIndex].src;
                    img.alt = logos[logoIndex].alt;
                    img.className = 'h-16 w-auto object-contain opacity-80 hover:opacity-100 transition-all duration-500';
                    container.appendChild(img);
                }
            }
            function slideNext() {
                currentIndex = (currentIndex + 1) % logos.length;
                createLogos();
            }
            createLogos();
            setInterval(slideNext, 2000);
        })();
    </script>
</body>
</html>
