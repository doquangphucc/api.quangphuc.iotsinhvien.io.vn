<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt kh·∫£o s√°t - HC Eco System</title>
        
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter with Vietnamese subset -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="../assets/img/logo.jpg" />
    
    <style>
        :root {
            --color-primary: #1E5631;
            --color-secondary: #3FA34D;
            --color-accent: #C5E384;
            --color-bg-light: #F4F9E9;
            --color-text-dark: #1a202c;
            --color-text-light: #f7fafc;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        body[data-theme="dark"] {
            background-color: #12181B;
            color: var(--color-text-light);
        }
        body[data-theme="dark"] .dark\:bg-gray-900 { background-color: #1a202c; }
        body[data-theme="dark"] .dark\:bg-gray-800 { background-color: #2d3748; }
        body[data-theme="dark"] .dark\:bg-gray-700 { background-color: #374151; }
        body[data-theme="dark"] .dark\:text-gray-100 { color: #f7fafc; }
        body[data-theme="dark"] .dark\:text-gray-300 { color: #d1d5db; }
        body[data-theme="dark"] .dark\:border-gray-700 { border-color: #4a5568; }
        body[data-theme="dark"] .dark\:border-gray-600 { border-color: #4b5563; }

        .theme-toggle__icon { display: none; }
        body:not([data-theme="dark"]) .theme-toggle__icon--sun { display: block; }
        body[data-theme="dark"] .theme-toggle__icon--moon { display: block; }

        .auth-btn {
            padding: 0.6rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            line-height: 1.25rem;
            text-decoration: none;
        }
        .auth-btn--login {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .auth-btn--login:hover {
            background-color: #e5e7eb;
        }
        .auth-btn--register {
            background-color: #16a34a;
            color: white;
        }
        .auth-btn--register:hover {
             background-color: #15803d;
        }
        .auth-user-name {
            font-weight: 600;
            font-size: 0.875rem; /* 14px - smaller font */
            padding: 0.5rem 0.75rem; /* Reduced padding */
            white-space: nowrap;
            text-decoration: none;
            max-width: 120px; /* Limit width */
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }
        .auth-user-name + .auth-btn--register { 
             background-color: #fee2e2;
             color: #b91c1c;
             font-size: 0.75rem; /* 12px - smaller font */
             padding: 0.5rem 0.75rem; /* Reduced padding */
             min-width: auto; /* Remove minimum width */
        }
         .auth-user-name + .auth-btn--register:hover {
             background-color: #fecaca;
        }
        body[data-theme="dark"] .auth-btn--login {
            background-color: #374151;
            color: #f9fafb;
        }
        body[data-theme="dark"] .auth-btn--login:hover {
            background-color: #4b5563;
        }
        body[data-theme="dark"] .auth-user-name {
            color: #d1d5db;
        }
        body[data-theme="dark"] .auth-user-name + .auth-btn--register {
             background-color: #450a0a;
             color: #fca5a5;
        }
        body[data-theme="dark"] .auth-user-name + .auth-btn--register:hover {
             background-color: #7f1d1d;
        }
        
        /* Print Styles - Ch·ªâ hi·ªÉn th·ªã n·ªôi dung b√°o gi√° */
        @media print {
            @page {
                margin: 0;
                size: A4;
            }
            
            /* CSS cho wrapper A4 khi in */
            #printA4Wrapper { 
                width: 210mm !important; 
                height: 297mm !important; 
                padding: 5mm !important; 
                box-sizing: border-box !important; 
                margin: 0 auto !important;
            }
            
            html, body { 
                margin: 0 !important; 
                padding: 0 !important;
            }
            
            /* ·∫®n t·∫•t c·∫£ navigation, header, footer, buttons */
            header,
            #cart-fab,
            .theme-toggle,
            .auth-btn,
            #mobile-menu-button,
            #mobile-menu,
            nav,
            .cta,
            #auth-buttons,
            #mobile-auth-buttons,
            .back-button,
            button,
            a[href*="survey_history"],
            a[href*="khao-sat-dien-mat-troi"] {
                display: none !important;
            }
            
            /* ·∫®n n√∫t Actions */
            #actionButtons,
            .flex.gap-4.mb-6:has(button) {
                display: none !important;
            }
            
            /* ƒê·∫£m b·∫£o body kh√¥ng c√≥ background khi in */
            body {
                background: white !important;
                color: black !important;
            }
            
            /* ƒê·∫£m b·∫£o c√°c container kh√¥ng c√≥ shadow khi in */
            .bg-white,
            .bg-gray-50,
            .bg-gradient-to-br,
            .rounded-2xl,
            .shadow-lg,
            .shadow-xl {
                background: white !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            /* ƒê·∫£m b·∫£o ·∫£nh hi·ªÉn th·ªã khi in */
            img {
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid;
            }
            
            /* ·∫¢nh s·∫£n ph·∫©m trong b·∫£ng */
            table img {
                display: block !important;
                max-width: 60px !important;
                max-height: 60px !important;
                object-fit: cover !important;
            }
            
            /* ƒê·∫£m b·∫£o b·∫£ng kh√¥ng b·ªã c·∫Øt */
            table {
                page-break-inside: avoid;
            }
            
            /* ·∫®n loading state */
            #loading {
                display: none !important;
            }
            
            /* Hi·ªÉn th·ªã survey detail */
            #surveyDetail {
                display: block !important;
            }
            
            /* ƒê·∫£m b·∫£o text m√†u ƒëen khi in */
            .text-gray-800,
            .text-gray-700,
            .text-gray-600,
            .text-emerald-600,
            .text-blue-600,
            .dark\:text-white,
            .dark\:text-gray-300 {
                color: black !important;
            }
            
            /* Header c√¥ng ty n·ªïi b·∫≠t khi in */
            .bg-white.rounded-2xl.p-4.mb-4.shadow-lg:first-of-type {
                border: 2px solid #16a34a !important;
                margin-bottom: 1rem !important;
            }
            
            /* ƒê·∫£m b·∫£o logo hi·ªÉn th·ªã khi in */
            .bg-white.rounded-2xl.p-4.mb-4.shadow-lg:first-of-type img {
                display: block !important;
                max-width: 80px !important;
                height: auto !important;
            }
            
            /* B·∫£ng s·∫£n ph·∫©m */
            table {
                border-collapse: collapse !important;
                width: 100% !important;
            }
            
            th, td {
                border: 1px solid #d1d5db !important;
                padding: 0.5rem !important;
            }
            
            thead tr {
                background: #16a34a !important;
                color: white !important;
            }
            
            /* T·ªïng c·ªông */
            tfoot tr {
                background: #d1fae5 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">

    <!-- Header -->
    <header id="header" class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700 transition-all duration-300">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-20">
                <a href="../index.html" class="flex items-center gap-3">
                    <img class="h-12 w-12 rounded-lg object-cover" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
                    <div>
                        <div class="font-bold text-lg text-gray-800 dark:text-white">HC<span class="text-green-600">ECO SYSTEM</span></div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">H·ªá sinh th√°i cho t∆∞∆°ng lai</p>
                    </div>
                </a>

                <nav class="hidden lg:flex items-center bg-gray-100 dark:bg-gray-800 p-1 rounded-full">
                    <a href="gioi-thieu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Gi·ªõi thi·ªáu</a>
                    <a href="pricing.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">S·∫£n ph·∫©m</a>
                    <a href="du-an.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">D·ª± √°n</a>
                    <a href="tin-tuc.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Tin t·ª©c</a>
                    <a href="dich-vu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">H·ªá sinh th√°i</a>
                    <a href="lien-he.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-all duration-200">Li√™n h·ªá</a>
                </nav>

                <div class="flex items-center gap-2">
                    <a class="cta hidden sm:inline-block bg-green-600 text-white font-semibold px-5 py-2.5 rounded-full hover:bg-green-700 transition-all duration-300 shadow-lg shadow-green-500/20" href="khao-sat-dien-mat-troi.html">Nh·∫≠n t∆∞ v·∫•n</a>
                    
                    <div id="auth-buttons" class="hidden sm:flex items-center gap-2"></div>

                    <button id="mobile-menu-button" class="lg:hidden h-10 w-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800">
                         <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="lg:hidden hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-4">
            <nav class="flex flex-col gap-2">
                <a href="gioi-thieu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Gi·ªõi thi·ªáu</a>
                <a href="pricing.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">S·∫£n ph·∫©m</a>
                <a href="du-an.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">D·ª± √°n</a>
                <a href="tin-tuc.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Tin t·ª©c</a>
                <a href="dich-vu.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">H·ªá sinh th√°i</a>
                <a href="lien-he.html" class="px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Li√™n h·ªá</a>

                <!-- Mobile Auth Buttons -->
                <div class="border-t border-gray-200 dark:border-gray-600 pt-4 mt-4">
                    <div id="mobile-auth-buttons" class="flex flex-col gap-2">
                        <!-- Dynamically populated by auth.js -->
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Floating Cart Button -->
    <a href="gio-hang.html" id="cart-fab" class="fixed bottom-6 right-6 z-50 h-14 w-14 bg-green-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-green-700 transition-all duration-300">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <span id="fab-cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800" style="display: none;">0</span>
    </a>

    <!-- Main Content -->
    <main class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 py-8 px-3">
        <div class="container mx-auto max-w-5xl">
            <!-- Back Button -->
            <div class="mb-6 back-button">
                <a id="backLink" href="survey_history.html" class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-semibold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    <span id="backLinkText">Quay l·∫°i l·ªãch s·ª≠ kh·∫£o s√°t</span>
                </a>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block w-16 h-16 border-4 border-green-200 border-t-green-600 rounded-full animate-spin"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">ƒêang t·∫£i chi ti·∫øt kh·∫£o s√°t...</p>
            </div>

            <!-- Survey Detail Content -->
            <div id="surveyDetail" class="hidden">
                <!-- Company Header -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 mb-4 shadow-lg">
                    <div class="flex items-center justify-between border-b-2 border-green-600 pb-3">
                        <div class="flex items-center gap-4">
                            <img src="../assets/img/logo.jpg" alt="SOLAR B·∫¢O DUY" class="w-20 h-20 object-cover rounded-lg">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">SOLAR B·∫¢O DUY</h1>
                                <p class="text-gray-600 dark:text-gray-400">Hotline: 0969 397 434</p>
                                <p class="text-gray-600 dark:text-gray-400">Email: baoduysolar@gmail.com</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-600 dark:text-gray-400">Ng√†y BG: <span id="quoteDate"></span></p>
                            <p class="text-gray-600 dark:text-gray-400">S·ªë BG: BG<span id="quoteNumber"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Title -->
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">B·∫¢NG B√ÅO GI√Å H·ªÜ TH·ªêNG ƒêI·ªÜN NLMT H√íA L∆Ø·ªöI C√ì L∆ØU TR·ªÆ</h2>
                </div>

                <!-- Customer Info -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 mb-4 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">K√çNH G·ª¨I</h3>
                    <div class="grid md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Qu√Ω Kh√°ch H√†ng: </span>
                            <span class="font-semibold text-gray-800 dark:text-white" id="customerName">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">S·ªê ƒêI·ªÜN THO·∫†I: </span>
                            <span class="font-semibold text-gray-800 dark:text-white" id="customerPhone">-</span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="text-gray-600 dark:text-gray-400">ƒê·ªäA CH·ªà: </span>
                            <span class="font-semibold text-gray-800 dark:text-white" id="customerAddress">-</span>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 mb-4 shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                                    <th class="p-2 text-left text-sm border-r border-white/30">T√äN V·∫¨T T∆Ø</th>
                                    <th class="p-2 text-left text-sm border-r border-white/30">TH∆Ø∆†NG HI·ªÜU</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30">B·∫¢O H√ÄNH</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30">ƒêVT</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30">SL</th>
                                    <th class="p-2 text-center text-sm border-r border-white/30" style="width: 60px;">·∫¢NH</th>
                                    <th class="p-2 text-right text-sm border-r border-white/30">ƒê∆†N GI√Å (ƒë)</th>
                                    <th class="p-2 text-right text-sm">TH√ÄNH TI·ªÄN (ƒë)</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be loaded here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-emerald-100 dark:bg-emerald-900/30 font-bold">
                                    <td colspan="7" class="p-3 text-right pr-6 text-sm">T·ªîNG C·ªòNG:</td>
                                    <td class="p-3 text-right text-xl text-emerald-600" id="totalAmount">0ƒë</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Summary Info -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl p-4 mb-4 border-2 border-emerald-200 dark:border-emerald-800">
                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">T√ìM T·∫ÆT H·ªÜ TH·ªêNG</h3>
                    <div class="grid md:grid-cols-3 gap-3">
                        <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                            <p class="text-xs text-gray-600 dark:text-gray-400">S·ªë KW ƒëi·ªán t·∫°o ra/ng√†y:</p>
                            <p class="text-base font-bold text-emerald-600" id="dailyKWh">-</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                            <p class="text-xs text-gray-600 dark:text-gray-400">S·ªë KW ƒëi·ªán t·∫°o ra/th√°ng:</p>
                            <p class="text-base font-bold text-emerald-600" id="monthlyKWhGen">-</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                            <p class="text-xs text-gray-600 dark:text-gray-400">Ti·∫øt ki·ªám trung b√¨nh/th√°ng:</p>
                            <p class="text-base font-bold text-emerald-600" id="monthlySavings">-</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-2 rounded-lg">
                            <p class="text-xs text-gray-600 dark:text-gray-400">Ti·∫øt ki·ªám m√πa h√®/th√°ng:</p>
                            <p class="text-base font-bold text-emerald-600" id="summerSavings">-</p>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 p-2 rounded-lg border-2 border-emerald-400 dark:border-emerald-500 shadow-md">
                            <p class="text-xs text-gray-700 dark:text-gray-300 font-bold">Ho√†n v·ªën d·ª± ki·∫øn</p>
                            <p class="text-sm font-extrabold text-emerald-700 dark:text-emerald-400 leading-5" id="paybackSimple">-</p>
                            <p class="text-[10px] text-gray-600 dark:text-gray-400 mt-0.5">= T·ªïng ƒë·∫ßu t∆∞ √∑ H√≥a ƒë∆°n ƒëi·ªán ban ƒë·∫ßu/th√°ng</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 p-2 rounded-lg border-2 border-blue-400 dark:border-blue-500 shadow-md">
                            <p class="text-xs text-gray-700 dark:text-gray-300 font-bold">Ho√†n v·ªën khi vay 10%/nƒÉm</p>
                            <p class="text-sm font-extrabold text-blue-700 dark:text-blue-400 leading-5" id="paybackLoan">-</p>
                            <p class="text-[10px] text-gray-600 dark:text-gray-400 mt-0.5">Vay to√†n b·ªô v·ªõi l√£i 10%/nƒÉm, tr·∫£ b·∫±ng ti·ªÅn ƒëi·ªán ban ƒë·∫ßu</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-4 mb-6" id="actionButtons">
                    <!-- Edit mode: ch·ªâ hi·ªÉn th·ªã n√∫t Save -->
                    <div id="editModeButtons" class="hidden w-full">
                        <button onclick="saveSurveyChanges()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                            üíæ L∆∞u thay ƒë·ªïi
                        </button>
                    </div>
                    <!-- View mode: hi·ªÉn th·ªã c√°c n√∫t th√¥ng th∆∞·ªùng -->
                    <div id="viewModeButtons" class="flex gap-4 w-full">
                        <button onclick="exportToPDF()" class="flex-1 bg-gradient-to-r from-red-600 to-pink-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                            üì• Xu·∫•t PDF
                        </button>
                        <button onclick="exportToImage()" class="flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                            üñºÔ∏è Xu·∫•t ·∫£nh
                        </button>
                        <button onclick="buyPackageFromDetail()" id="buyPackageBtn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                            üõí Mua g√≥i n√†y
                        </button>
                        <a href="khao-sat-dien-mat-troi.html" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-200 text-center flex items-center justify-center">
                            ‚ú® T·∫°o kh·∫£o s√°t m·ªõi
                        </a>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-white dark:bg-gray-800 rounded-3xl p-12 text-center shadow-xl">
                <div class="w-32 h-32 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-3">Kh√¥ng t√¨m th·∫•y kh·∫£o s√°t</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-8" id="errorMessage">Kh·∫£o s√°t kh√¥ng t·ªìn t·∫°i ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn xem.</p>
                <a href="survey_history.html" class="inline-block bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold px-8 py-4 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    Quay l·∫°i l·ªãch s·ª≠
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="site-footer" class="bg-gray-800 dark:bg-black text-gray-300">
        <div class="container mx-auto px-4 py-12">
            <div class="grid lg:grid-cols-3 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                     <a href="../index.html" class="flex items-center gap-3">
                        <img class="h-12 w-12 rounded-lg object-cover" src="../assets/img/logo.jpg" alt="Logo HC Eco System" />
                        <div>
                            <div class="font-bold text-lg text-white">HC<span class="text-green-500">ECO SYSTEM</span></div>
                        </div>
                    </a>
                    <p class="text-sm text-gray-400">&copy; 2025 HC Eco System. Gi·ªØ v·ªØng cam k·∫øt nƒÉng l∆∞·ª£ng s·∫°ch cho m·ªói nh√†.</p>                    
                    <!-- Ecosystem Logos Animation -->
                    <div class="mt-6 relative overflow-hidden" style="height: 80px;">
                        <div id="ecosystem-logos-container" class="flex gap-6">
                            <!-- Logos will be inserted by JavaScript -->
                        </div>
        </div>
                </div>

                <div class="space-y-2">
                    <h4 class="font-semibold text-white">Th√¥ng tin li√™n h·ªá</h4>
                    <ul class="text-sm text-gray-400 space-y-1">
                        <li><strong>Hotline:</strong> 0969 397 434 (Ch√≠nh)</li>
                        <li><strong>Hotline ph·ª•:</strong> 0988 919 868</li>
                        <li><strong>Zalo:</strong> 0969 397 434</li>
                        <li><strong>Email:</strong> hcecosystem@gmail.com</li>
                        <li><strong>Website:</strong> hceco.io.vn</li>
                        <li><strong>ƒê·ªãa ch·ªâ VƒÉn ph√≤ng:</strong><br>790 Ng√¥ Quy·ªÅn, Ph∆∞·ªùng An H·∫£i, Th√†nh Ph·ªë ƒê√† N·∫µng</li>
                    </ul>
                </div>

                <div class="space-y-2">
                     <h4 class="font-semibold text-white">Ch√≠nh s√°ch & D·ªãch v·ª•</h4>
                    <ul class="text-sm space-y-1">
                        <li><a href="tam-nhin-su-menh.html" class="text-gray-400 hover:text-white">T·∫ßm Nh√¨n & S·ª© M·ªánh</a></li>
                        <li><a href="dieu-khoan-dieu-kien.html" class="text-gray-400 hover:text-white">ƒêi·ªÅu Kho·∫£n & ƒêi·ªÅu Ki·ªán</a></li>
                        <li><a href="chinh-sach-doi-tra.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch ƒê·ªïi Tr·∫£</a></li>
                        <li><a href="chinh-sach-bao-mat-thong-tin-ca-nhan.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch B·∫£o M·∫≠t Th√¥ng Tin C√° Nh√¢n</a></li>
                        <li><a href="chinh-sach-bao-mat-thong-tin-thanh-toan.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch B·∫£o M·∫≠t Th√¥ng Tin Thanh To√°n</a></li>
                        <li><a href="chinh-sach-bao-hanh.html" class="text-gray-400 hover:text-white">Ch√≠nh S√°ch B·∫£o H√†nh</a></li>
                        <li><a href="tro-thanh-nha-phan-phoi.html" class="text-gray-400 hover:text-white">Tr·ªü Th√†nh Nh√† Ph√¢n Ph·ªëi</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Copyright Bar -->
    <div class="bg-gray-900 dark:bg-black border-t border-gray-700">
        <div class="container mx-auto px-4 py-3">
            <p class="text-center text-sm text-gray-400">
                ¬© B·∫£n quy·ªÅn thu·ªôc v·ªÅ <a href="https://hceco.io.vn" class="text-gray-300 hover:text-white underline">https://hceco.io.vn</a> | Cung c·∫•p b·ªüi <a href="https://phuture.io.vn" target="_blank" class="text-gray-400 hover:text-white hover:underline font-medium transition-colors duration-200">Phuture</a>
            </p>
        </div>
    </div>
    
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- html2canvas and jsPDF for direct PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="../assets/js/shopping-cart.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/cache-buster.js"></script>
    
    <!-- Fit to A4 utility -->
    <script>
        // Thu nh·ªè 1 element ƒë·ªÉ v·ª´a A4 (mm). D√πng ƒë∆∞·ª£c cho in & html2pdf.
        function fitElementToA4(el, {marginMm = 5} = {}) {
            const DPI = 96;                           // ~dpi tr√¨nh duy·ªát
            const mm2px = mm => (mm/25.4)*DPI;

            const A4W = mm2px(210);
            const A4H = mm2px(297);
            const M   = mm2px(marginMm);
            const availW = A4W - 2*M;
            const availH = A4H - 2*M;

            // B·ªè m·ªçi scale c≈© ƒë·ªÉ ƒëo ƒë√∫ng
            el.style.transform = 'none';
            el.style.width = '';
            el.style.height = '';

            const r = el.getBoundingClientRect();
            
            // T√≠nh scale d·ª±a tr√™n width v√† height, ∆∞u ti√™n fit height tr∆∞·ªõc
            const scaleW = availW / r.width;
            const scaleH = availH / r.height;
            let finalScale = Math.min(scaleW, scaleH, 1);
            
            // ƒê·∫£m b·∫£o sau scale kh√¥ng v∆∞·ª£t qu√° A4 - th√™m buffer nh·ªè
            const buffer = 2; // 2px buffer
            let scaledHeight = r.height * finalScale;
            let scaledWidth = r.width * finalScale;
            
            // N·∫øu v∆∞·ª£t qu√°, t√≠nh l·∫°i scale ch√≠nh x√°c h∆°n
            if (scaledHeight > (availH - buffer) || scaledWidth > (availW - buffer)) {
                finalScale = Math.min(
                    (availW - buffer) / r.width, 
                    (availH - buffer) / r.height, 
                    1
                );
                scaledHeight = r.height * finalScale;
                scaledWidth = r.width * finalScale;
            }
            
            // ƒê·∫£m b·∫£o finalScale kh√¥ng qu√° nh·ªè (t·ªëi thi·ªÉu 0.3)
            finalScale = Math.max(finalScale, 0.3);
            scaledHeight = r.height * finalScale;
            scaledWidth = r.width * finalScale;

            // C·ªë ƒë·ªãnh k√≠ch th∆∞·ªõc g·ªëc ƒë·ªÉ khi scale kh√¥ng b·ªã c·∫Øt
            el.style.width  = r.width  + 'px';
            el.style.height = r.height + 'px';

            // Scale t·ª´ top left (gi·ªØ nguy√™n), cƒÉn gi·ªØa s·∫Ω do flexbox wrapper x·ª≠ l√Ω
            el.style.transformOrigin = 'top left';
            el.style.transform = `scale(${finalScale})`;
            el.style.overflow = 'hidden'; // ·∫®n ph·∫ßn v∆∞·ª£t qu√°

            // T·∫°o khung A4 ƒë·ªÉ html2pdf c·∫Øt ƒë√∫ng trang
            const wrapper = el.parentElement; // L·∫•y wrapper t·ª´ parent element
            wrapper.style.width  = '210mm';
            wrapper.style.height = '297mm';
            wrapper.style.maxHeight = '297mm'; // Gi·ªõi h·∫°n kh√¥ng v∆∞·ª£t qu√° A4
            wrapper.style.minHeight = '297mm'; // C·ªë ƒë·ªãnh height
            wrapper.style.padding = `${marginMm}mm`;
            wrapper.style.boxSizing = 'border-box';
            wrapper.style.background = 'white';
            wrapper.style.overflow = 'hidden'; // ·∫®n ph·∫ßn v∆∞·ª£t qu√°
            wrapper.style.position = 'relative';
            
            return finalScale;
        }
    </script>

    <!-- Print fit logic -->
    <script>
        let _printWrapper = null, _origParent = null, _origNext = null;

        function preparePrintFit() {
            const el = document.getElementById('surveyDetail');
            if (!el) return;

            // T·∫°o wrapper A4 t·∫°m
            _printWrapper = document.createElement('div');
            _printWrapper.id = 'printA4Wrapper';
            _printWrapper.style.margin = '0 auto';
            _printWrapper.style.pageBreakInside = 'avoid';

            _origParent = el.parentNode;
            _origNext = el.nextSibling;
            _printWrapper.appendChild(el);
            document.body.appendChild(_printWrapper);

            fitElementToA4(el, {marginMm: 5});
        }

        function cleanupPrintFit() {
            if (_printWrapper && _origParent) {
                const el = document.getElementById('surveyDetail');
                // reset style
                el.style.transform = '';
                el.style.width = '';
                el.style.height = '';
                _printWrapper.style.width = '';
                _printWrapper.style.height = '';
                _printWrapper.style.padding = '';
                // ƒë∆∞a v·ªÅ ch·ªó c≈©
                if (_origNext) _origParent.insertBefore(el, _origNext);
                else _origParent.appendChild(el);
                _printWrapper.remove();
            }
            _printWrapper = _origParent = _origNext = null;
        }

        // T·ª± ƒë·ªông fit tr∆∞·ªõc/ sau in
        window.addEventListener('beforeprint', preparePrintFit);
        window.addEventListener('afterprint', cleanupPrintFit);
    </script>
    
    <!-- Survey Detail Logic -->
    <script>
        let surveyData = null;
        let surveyId = null;
        let surveyProducts = null; // Cache survey products for image fallback
        let isEditMode = false; // Edit mode khi truy c·∫≠p t·ª´ admin
        
        // Get survey ID from URL parameters
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            surveyId = urlParams.get('id');
            const source = urlParams.get('source');
            
            // Ki·ªÉm tra n·∫øu truy c·∫≠p t·ª´ admin
            isEditMode = (source === 'admin');
            
            if (isEditMode) {
                // Th√™m badge edit mode v√†o header
                const header = document.getElementById('surveyDetail');
                if (header) {
                    header.style.border = '2px solid #f59e0b';
                    header.style.borderRadius = '0.75rem';
                }
                
                // Thay ƒë·ªïi back link ƒë·ªÉ quay l·∫°i admin thay v√¨ survey_history
                const backLink = document.getElementById('backLink');
                const backLinkText = document.getElementById('backLinkText');
                if (backLink) {
                    backLink.href = 'admin.html#survey'; // Jump to Survey tab in admin
                }
                if (backLinkText) {
                    backLinkText.textContent = 'Quay l·∫°i trang qu·∫£n l√Ω';
                }
            }
            
            if (!surveyId) {
                showError('Kh√¥ng t√¨m th·∫•y ID kh·∫£o s√°t');
                return;
            }
            
            // Load survey products for image fallback (same as khao-sat-dien-mat-troi.html)
            try {
                const productsResponse = await fetch('../api/get_survey_products_public.php');
                const productsData = await productsResponse.json();
                if (productsData.success && productsData.products) {
                    surveyProducts = productsData.products;
                    console.log('Loaded survey products for image fallback');
                }
            } catch (err) {
                console.error('Error loading survey products:', err);
            }
            
            await loadSurveyDetail(surveyId);
        });
        
        async function loadSurveyDetail(id) {
            try {
                console.log('Loading survey detail for ID:', id);
                
                const response = await fetch(`../api/get_survey_detail.php?id=${id}`, {
                    credentials: 'include'
                });
                
                console.log('API response:', response);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('API result:', result);
                    
                    if (result.success && result.data && result.data.survey) {
                        surveyData = result.data.survey;
                        displaySurveyDetail(surveyData);
                    } else {
                        showError(result.message || 'Kh√¥ng t√¨m th·∫•y kh·∫£o s√°t');
                    }
                } else if (response.status === 401) {
                    window.location.href = 'login.html';
                } else {
                    const errorResult = await response.json();
                    showError(errorResult.message || 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt kh·∫£o s√°t');
                }
            } catch (error) {
                console.error('Error loading survey detail:', error);
                showError('L·ªói k·∫øt n·ªëi server');
            }
        }
        
        function displaySurveyDetail(survey) {
            const loadingEl = document.getElementById('loading');
            const surveyDetailEl = document.getElementById('surveyDetail');
            const errorStateEl = document.getElementById('errorState');
            
            // Hide loading and error
            loadingEl.classList.add('hidden');
            errorStateEl.classList.add('hidden');
            
            // Show survey detail
            surveyDetailEl.classList.remove('hidden');
            
            // Show/hide edit/view mode buttons
            if (isEditMode) {
                document.getElementById('editModeButtons').classList.remove('hidden');
                document.getElementById('viewModeButtons').classList.add('hidden');
            } else {
                document.getElementById('editModeButtons').classList.add('hidden');
                document.getElementById('viewModeButtons').classList.remove('hidden');
            }
            
            // Populate data
            populateSurveyData(survey);
        }
        
        function populateSurveyData(survey) {
            // Debug: Log full API response
            console.log('populateSurveyData - Full survey object:', survey);
            console.log('populateSurveyData - Results:', survey.results);
            
            // Set quote date and number
            const createdAt = new Date(survey.createdAt);
            document.getElementById('quoteDate').textContent = createdAt.toLocaleDateString('vi-VN');
            document.getElementById('quoteNumber').textContent = survey.id;
            
            // Customer info - support edit mode
            const customerNameEl = document.getElementById('customerName');
            const customerPhoneEl = document.getElementById('customerPhone');
            const customerAddressEl = document.getElementById('customerAddress');
            
            if (isEditMode) {
                // Edit mode: hi·ªÉn th·ªã input fields
                customerNameEl.innerHTML = `<input type="text" id="editCustomerName" value="${survey.fullName || ''}" class="w-full px-2 py-1 border rounded">`;
                customerPhoneEl.innerHTML = `<input type="text" id="editCustomerPhone" value="${survey.phone || ''}" class="w-full px-2 py-1 border rounded">`;
                customerAddressEl.innerHTML = `<input type="text" id="editCustomerAddress" value="${survey.regionName || ''}" class="w-full px-2 py-1 border rounded">`;
            } else {
                // View mode: hi·ªÉn th·ªã text
                customerNameEl.textContent = survey.fullName || '-';
                customerPhoneEl.textContent = survey.phone || '-';
                customerAddressEl.textContent = `Khu v·ª±c: ${survey.regionName || '-'}`;
            }
            
            const r = survey.results;
            // Helper: suy ra th∆∞∆°ng hi·ªáu t·ª´ t√™n s·∫£n ph·∫©m
            function deriveBrandFromName(name) {
                if (!name) return '-';
                const n = name.toLowerCase();
                if (n.includes('jinko')) return 'Jinko';
                if (n.includes('luxpower') || n.includes('lux power')) return 'LuxPower';
                if (n.includes('byd')) return 'BYD';
                if (n.includes('cornex') || n.includes('a-cornex')) return 'A-Cornex';
                if (n.includes('mc4')) return 'MC4';
                if (n.includes('wifi')) return 'LuxPower';
                if (n.includes('hybrid')) return 'Hybrid';
                return name.split(' ')[0] || '-';
            }
            
            // Debug: Log image URLs from API
            console.log('populateSurveyData - panelImage:', r?.panelImage);
            console.log('populateSurveyData - inverterImage:', r?.inverterImage);
            console.log('populateSurveyData - batteryImage:', r?.batteryImage);
            console.log('populateSurveyData - cabinetImage:', r?.cabinetImage);
            
            // Helper function to find image from survey products (fallback)
            function findImageFromProductsForDisplay(productName, category, phaseType = null) {
                if (!surveyProducts) return null;
                
                let productsToSearch = [];
                
                if (category === 'solar_panel' && surveyProducts.solar_panel) {
                    productsToSearch = surveyProducts.solar_panel;
                } else if (category === 'inverter' && surveyProducts.inverter) {
                    const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                    productsToSearch = [
                        ...(surveyProducts.inverter[phaseKey] || []),
                        ...(surveyProducts.inverter['both'] || [])
                    ];
                } else if (category === 'battery' && surveyProducts.battery) {
                    productsToSearch = surveyProducts.battery;
                } else if (category === 'electrical_cabinet' && surveyProducts.electrical_cabinet) {
                    const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                    productsToSearch = [
                        ...(surveyProducts.electrical_cabinet[phaseKey] || []),
                        ...(surveyProducts.electrical_cabinet['both'] || [])
                    ];
                }
                
                // Find product by matching title
                const found = productsToSearch.find(p => {
                    const titleLower = (p.title || '').toLowerCase();
                    const nameLower = (productName || '').toLowerCase();
                    return titleLower.includes(nameLower) || nameLower.includes(titleLower);
                });
                
                if (found && found.image_url) {
                    console.log(`Found image from survey products for display '${productName}':`, found.image_url);
                    return found.image_url;
                }
                
                return null;
            }
            
            // Helper function to fix image URL path for survey_detail.html
            function fixImageUrlForDetailPage(imageUrl) {
                if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined' || imageUrl.trim() === '') {
                    return null;
                }
                
                // If already absolute URL, return as is
                if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                    return imageUrl;
                }
                
                // If starts with /assets, convert to relative path (from html/ directory)
                if (imageUrl.startsWith('/assets/')) {
                    return '..' + imageUrl;
                }
                
                // If starts with assets/ (no leading slash), add ../
                if (imageUrl.startsWith('assets/')) {
                    return '../' + imageUrl;
                }
                
                // If already relative path, return as is
                if (imageUrl.startsWith('../')) {
                    return imageUrl;
                }
                
                // Otherwise, assume it's relative to assets
                return '../assets/img/products/' + imageUrl;
            }
            
            // Helper to get image URL with fallback
            function getImageUrlForDisplay(apiImage, productName, category, phaseType = null) {
                // First, try API image
                if (apiImage && apiImage !== 'null' && apiImage.trim() !== '') {
                    return fixImageUrlForDetailPage(apiImage);
                }
                
                // Fallback: find from survey products
                const fallbackImage = findImageFromProductsForDisplay(productName, category, phaseType);
                if (fallbackImage) {
                    return fixImageUrlForDetailPage(fallbackImage);
                }
                
                return null;
            }
            
            // Trang chi ti·∫øt: hi·ªÉn th·ªã ƒë√∫ng d·ªØ li·ªáu ƒë√£ l∆∞u trong DB (kh√¥ng t√≠nh l·∫°i t·ªß ƒëi·ªán)
            let cabinetAlternatives = [];
            let selectedCabinetIdx = 0;
            // Kh√¥ng d·ª±ng danh s√°ch l·ª±a ch·ªçn; gi·ªØ tr·ªëng ƒë·ªÉ kh√¥ng hi·ªÉn th·ªã radio

            // L∆∞u v√†o window ƒë·ªÉ d√πng cho mua g√≥i
            window.currentCabinetAlternatives = cabinetAlternatives;
            window.selectedCabinetIdxFromDetail = selectedCabinetIdx;

            // Build products table
            const productsTableBody = document.getElementById('productsTableBody');
            let totalAmount = 0;
            
            // Build strictly from database fields to avoid mismatch
            // Recompute accessories from Admin configs to align with khao-sat-dien-mat-troi.html logic
            const panelCount = Number(r?.panelsNeeded ?? 0);
            const selectedBatteryUnits = Number(r?.batteryQuantity ?? 1);
            let computedAccessories = [];
            if (Array.isArray(r?.accessories) && r.accessories.length > 0) {
                computedAccessories = r.accessories.map(a => ({
                    name: a.name,
                    unit: a.unit || '',
                    quantity: Number(a.quantity || 0),
                    price: Number(a.price || 0),
                    totalPrice: Number(a.totalPrice || (Number(a.quantity||0)*Number(a.price||0))),
                    image: a.image || null
                }));
            } else if (surveyProducts && surveyProducts.accessory && Array.isArray(surveyProducts.accessory)) {
                computedAccessories = surveyProducts.accessory.map(acc => {
                    const depTarget = acc.accessory_dependent_target || 'project';
                    const baseQty = typeof acc.accessory_base_qty === 'number' ? acc.accessory_base_qty : 0;
                    const depQty = typeof acc.accessory_dependent_qty === 'number' && acc.accessory_dependent_qty !== null ? acc.accessory_dependent_qty : 1;
                    let targetCount = 1;
                    if (depTarget === 'panel') targetCount = panelCount;
                    else if (depTarget === 'inverter') targetCount = 1;
                    else if (depTarget === 'battery') targetCount = selectedBatteryUnits;
                    else if (depTarget === 'cabinet') targetCount = 1;
                    else targetCount = 1; // project
                    
                    // Logic h·ªá s·ªë ph·ª• thu·ªôc = 0: Lu√¥n d√πng s·ªë l∆∞·ª£ng b·∫£n th√¢n, b·∫•t k·ªÉ c√≥ bao nhi√™u s·∫£n ph·∫©m ph·ª• thu·ªôc
                    let qty;
                    if (depQty === 0) {
                        qty = baseQty; // Lu√¥n = s·ªë l∆∞·ª£ng b·∫£n th√¢n
                    } else if (depTarget === 'project') {
                        qty = baseQty; // Project kh√¥ng ph·ª• thu·ªôc
                    } else {
                        // H·ªá s·ªë != 0: T√≠nh theo c√¥ng th·ª©c
                        qty = baseQty * targetCount * (depQty || 1);
                    }
                    
                    const unitPrice = Number(acc.price || 0);
                    return {
                        name: acc.title,
                        unit: acc.accessory_unit || '',
                        quantity: qty,
                        price: unitPrice,
                        totalPrice: qty * unitPrice,
                        image: acc.image_url ? fixImageUrlForDetailPage(acc.image_url) : null
                    };
                });
            }

            const chosenCabinet = (cabinetAlternatives && cabinetAlternatives.length>0) ? cabinetAlternatives[selectedCabinetIdx] : null;
            // Helper to get product name with fallback (handles "0", null, undefined, empty)
            const getProductName = (name, defaultName) => {
                if (!name || name === '0' || name.trim() === '' || name === 'null' || name === 'undefined') {
                    return defaultName;
                }
                return name.trim();
            };
            
            const products = [
                {
                    name: getProductName(r?.panelName, 'T·∫•m Pin'),
                    brand: deriveBrandFromName(getProductName(r?.panelName, 'T·∫•m Pin')),
                    warranty: '12 nƒÉm',
                    unit: 'T·∫•m',
                    qty: Number(r?.panelsNeeded ?? 0),
                    image: getImageUrlForDisplay(r?.panelImage, getProductName(r?.panelName, 'T·∫•m Pin'), 'solar_panel'),
                    unitPrice: Number(r?.panelPrice ?? 0),
                    totalPrice: Number(r?.panelCost ?? 0),
                    category: 'solar_panel',
                    currentProductId: r?.panelId || null,
                    panelPower: r?.panelPower || null
                },
                {
                    name: getProductName(r?.inverterName, 'Inverter'),
                    brand: deriveBrandFromName(getProductName(r?.inverterName, 'Inverter')),
                    warranty: '5 nƒÉm',
                    unit: 'B·ªô',
                    qty: 1,
                    image: getImageUrlForDisplay(r?.inverterImage, getProductName(r?.inverterName, 'Inverter'), 'inverter', survey.phase),
                    unitPrice: Number(r?.inverterPrice ?? 0),
                    totalPrice: Number(r?.inverterPrice ?? 0),
                    category: 'inverter',
                    currentProductId: r?.inverterId || null
                },
                {
                    name: getProductName(r?.batteryName, 'Pin l∆∞u tr·ªØ'),
                    brand: deriveBrandFromName(getProductName(r?.batteryName, 'Pin l∆∞u tr·ªØ')),
                    warranty: '10 nƒÉm',
                    unit: 'B·ªô',
                    qty: Number(r?.batteryQuantity ?? 1),
                    image: getImageUrlForDisplay(r?.batteryImage, getProductName(r?.batteryName, 'Pin l∆∞u tr·ªØ'), 'battery'),
                    unitPrice: Number(r?.batteryUnitPrice ?? 0),
                    totalPrice: Number(r?.batteryCost ?? 0),
                    category: 'battery',
                    currentProductId: r?.batteryId || null
                },
                {
                    name: getProductName(r?.cabinetName, 'T·ªß ƒëi·ªán'),
                    brand: deriveBrandFromName(getProductName(r?.cabinetName, 'T·ªß ƒëi·ªán')),
                    warranty: '3 nƒÉm',
                    unit: 'T·ªß',
                    qty: 1,
                    image: getImageUrlForDisplay(r?.cabinetImage, getProductName(r?.cabinetName, 'T·ªß ƒëi·ªán'), 'electrical_cabinet', survey.phase),
                    unitPrice: Number(r?.cabinetPrice ?? 0),
                    totalPrice: Number(r?.cabinetPrice ?? 0),
                    category: 'electrical_cabinet',
                    currentProductId: r?.cabinetId || null
                },
                // Push computed accessories as individual rows (always show all configured)
                ...computedAccessories.map(a => ({
                    name: a.name,
                    brand: deriveBrandFromName(a.name),
                    warranty: '1 nƒÉm',
                    unit: a.unit || 'm·ª•c',
                    qty: a.quantity,
                    image: a.image,
                    unitPrice: a.price,
                    totalPrice: a.totalPrice
                })),
                {
                    name: 'Chi ph√≠ c√¥ng th·ª£ l·∫Øp ƒë·∫∑t tr·ªçn g√≥i',
                    brand: 'HC ECO',
                    warranty: '-',
                    unit: 'ƒê·ªôi',
                    qty: 1,
                    image: null,
                    unitPrice: Number(r?.laborCost ?? 0),
                    totalPrice: Number(r?.laborCost ?? 0)
                },
                {
                    name: 'Chi ph√≠ v·∫≠n chuy·ªÉn thi·∫øt b·ªã',
                    brand: 'HC ECO',
                    warranty: '-',
                    unit: 'Chuy·∫øn',
                    qty: 1,
                    image: null,
                    unitPrice: 0,
                    totalPrice: 0,
                    note: 'T√πy ƒëi·ªÅu ki·ªán'
                }
            ];
            
            // Render table rows with edit mode support
            productsTableBody.innerHTML = products.map((item, index) => {
                totalAmount += item.totalPrice;
                
                // Create itemKey - use category for main products, otherwise use normalized name
                let itemKey;
                let isMainProduct = false;
                if (item.category) {
                    // Map category to itemKey
                    const categoryMap = {
                        'solar_panel': 't·∫•m_pin',
                        'inverter': 'inverter',
                        'battery': 'pin_l∆∞u_tr·ªØ',
                        'electrical_cabinet': 't·ªß_ƒëi·ªán'
                    };
                    itemKey = categoryMap[item.category] || item.name.toLowerCase().replace(/\s+/g, '_');
                    isMainProduct = true;
                } else {
                    itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                    // Check if this is one of the 4 main products by name
                    isMainProduct = ['t·∫•m pin', 'inverter', 'pin l∆∞u tr·ªØ', 't·ªß ƒëi·ªán'].some(cat => 
                        item.name.toLowerCase().includes(cat.toLowerCase())
                    );
                }
                
                const itemCategory = item.category || null; // solar_panel, inverter, battery, electrical_cabinet
                
                // Edit mode: build dropdown for main products
                let nameDisplay, brandDisplay, warrantyDisplay, qtyDisplay, imageHtml, unitPriceDisplay, totalPriceDisplay;
                
                if (isEditMode && isMainProduct) {
                    // Dropdown ƒë·ªÉ ch·ªçn s·∫£n ph·∫©m
                    const categoryMap = {
                        't·∫•m_pin': 'solar_panel',
                        'inverter': 'inverter',
                        'pin_l∆∞u_tr·ªØ': 'battery',
                        't·ªß_ƒëi·ªán': 'electrical_cabinet'
                    };
                    const category = Object.entries(categoryMap).find(([key, _]) => itemKey.includes(key))?.[1] || 'solar_panel';
                    
                    // Get product list for this category
                    let productOptions = '';
                    if (surveyProducts) {
                        let productsToShow = [];
                        if (category === 'solar_panel' && surveyProducts.solar_panel) {
                            productsToShow = surveyProducts.solar_panel;
                        } else if (category === 'inverter' && surveyProducts.inverter) {
                            const phaseKey = survey.phase === 1 ? '1_phase' : survey.phase === 3 ? '3_phase' : 'both';
                            productsToShow = [
                                ...(surveyProducts.inverter[phaseKey] || []),
                                ...(surveyProducts.inverter['both'] || [])
                            ];
                        } else if (category === 'battery' && surveyProducts.battery) {
                            productsToShow = surveyProducts.battery;
                        } else if (category === 'electrical_cabinet' && surveyProducts.electrical_cabinet) {
                            const phaseKey = survey.phase === 1 ? '1_phase' : survey.phase === 3 ? '3_phase' : 'both';
                            productsToShow = [
                                ...(surveyProducts.electrical_cabinet[phaseKey] || []),
                                ...(surveyProducts.electrical_cabinet['both'] || [])
                            ];
                        }
                        
                        productsToShow.forEach(p => {
                            // Match selected product by ID first, then by name
                            const isSelected = (item.currentProductId && p.id == item.currentProductId) || 
                                             (!item.currentProductId && (p.title.trim() === item.name.trim() || 
                                              item.name.trim().includes(p.title.trim()) || 
                                              p.title.trim().includes(item.name.trim())));
                            const selected = isSelected ? 'selected' : '';
                            const brandName = p.title.split(' ')[0] || deriveBrandFromName(p.title);
                            productOptions += `<option value="${p.id}" data-price="${p.price}" data-image="${p.image_url || ''}" data-brand="${brandName}" ${selected}>${p.title}</option>`;
                        });
                    }
                    
                    const currentProductId = item.currentProductId || '';
                    nameDisplay = `<select id="edit_${itemKey}_product" class="w-full px-2 py-1 border rounded text-sm" 
                        onchange="onProductChange('${itemKey}', '${category}', this.value)">
                        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        ${productOptions}
                    </select>`;
                    brandDisplay = `<input type="text" id="edit_${itemKey}_brand" value="${item.brand}" class="w-full px-2 py-1 border rounded text-sm">`;
                    warrantyDisplay = `<input type="text" id="edit_${itemKey}_warranty" value="${item.warranty}" class="w-20 px-2 py-1 border rounded text-sm text-center">`;
                    
                    // For panels and battery, allow qty change; for inverter and cabinet, keep fixed at 1
                    const canChangeQty = category === 'solar_panel' || category === 'battery';
                    if (canChangeQty) {
                        qtyDisplay = `<input type="number" id="edit_${itemKey}_qty" value="${item.qty}" min="1" class="w-16 px-2 py-1 border rounded text-sm text-center" onchange="updateRowTotal('${itemKey}')">`;
                    } else {
                        qtyDisplay = `<span>${item.qty}</span>`;
                    }
                    
                    // Image will be updated when product is selected
                    const imgSrc = item.image ? (item.image.startsWith('/') ? '..' + item.image : (item.image.startsWith('../') ? item.image : '../' + item.image)) : '';
                    imageHtml = `<img id="edit_${itemKey}_image" src="${imgSrc || '../assets/img/logo.jpg'}" alt="${item.name}" class="w-10 h-10 object-contain mx-auto rounded" onerror="this.src='../assets/img/logo.jpg'">`;
                    
                    unitPriceDisplay = `<input type="number" id="edit_${itemKey}_unitPrice" value="${item.unitPrice}" class="w-24 px-2 py-1 border rounded text-right text-sm" onchange="updateRowTotal('${itemKey}')">`;
                    totalPriceDisplay = `<span id="edit_${itemKey}_totalPrice" class="font-semibold">${item.totalPrice > 0 ? item.totalPrice.toLocaleString('vi-VN') : '-'}</span>`;
                } else if (isEditMode && !isMainProduct && item.name !== 'Chi ph√≠ v·∫≠n chuy·ªÉn thi·∫øt b·ªã') {
                    // Edit mode: accessory items - ch·ªâ s·ª≠a warranty, qty, unitPrice, brand
                    nameDisplay = item.name;
                    brandDisplay = `<input type="text" id="edit_${itemKey}_brand" value="${item.brand}" class="w-full px-2 py-1 border rounded text-sm">`;
                    warrantyDisplay = `<input type="text" id="edit_${itemKey}_warranty" value="${item.warranty}" class="w-20 px-2 py-1 border rounded text-sm text-center">`;
                    qtyDisplay = `<input type="number" id="edit_${itemKey}_qty" value="${item.qty}" min="1" class="w-16 px-2 py-1 border rounded text-sm text-center" onchange="updateRowTotal('${itemKey}')">`;
                    
                    // Image
                    const isEmoji = item.image && item.image.length <= 3 && !item.image.includes('/');
                    if (isEmoji && item.image) {
                        imageHtml = `<div class="w-10 h-10 mx-auto flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded text-2xl">${item.image}</div>`;
                    } else if (item.image) {
                        const imgSrc = item.image.startsWith('/') ? '..' + item.image : (item.image.startsWith('../') ? item.image : '../' + item.image);
                        imageHtml = `<img src="${imgSrc}" alt="${item.name}" class="w-10 h-10 object-contain mx-auto rounded" onerror="this.src='../assets/img/logo.jpg'">`;
                    } else {
                        imageHtml = '<div class="w-10 h-10 mx-auto flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded text-[10px] text-gray-400">No Image</div>';
                    }
                    
                    unitPriceDisplay = `<input type="number" id="edit_${itemKey}_unitPrice" value="${item.unitPrice}" class="w-24 px-2 py-1 border rounded text-right text-sm" onchange="updateRowTotal('${itemKey}')">`;
                    totalPriceDisplay = `<span id="edit_${itemKey}_totalPrice" class="font-semibold">${item.totalPrice > 0 ? item.totalPrice.toLocaleString('vi-VN') : '-'}</span>`;
                } else {
                    // View mode: hi·ªÉn th·ªã text
                    nameDisplay = item.name;
                    brandDisplay = item.brand;
                    warrantyDisplay = item.warranty;
                    qtyDisplay = item.qty;
                    
                    // Image
                    const isEmoji = item.image && item.image.length <= 3 && !item.image.includes('/');
                    if (isEmoji && item.image) {
                        imageHtml = `<div class="w-10 h-10 mx-auto flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded text-2xl">${item.image}</div>`;
                    } else if (item.image) {
                        const imgSrc = item.image.startsWith('/') ? '..' + item.image : (item.image.startsWith('../') ? item.image : '../' + item.image);
                        imageHtml = `<img src="${imgSrc}" alt="${item.name}" class="w-10 h-10 object-contain mx-auto rounded" onerror="this.src='../assets/img/logo.jpg'">`;
                    } else {
                        imageHtml = '<div class="w-10 h-10 mx-auto flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded text-[10px] text-gray-400">No Image</div>';
                    }
                    
                    unitPriceDisplay = item.unitPrice > 0 ? item.unitPrice.toLocaleString('vi-VN') : (item.note || '-');
                    totalPriceDisplay = item.totalPrice > 0 ? item.totalPrice.toLocaleString('vi-VN') : (item.note || '-');
                }
                
                return `
                    <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-item-key="${itemKey}" data-item-category="${itemCategory || ''}">
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700">${nameDisplay}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700">${brandDisplay}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${warrantyDisplay}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${item.unit}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${qtyDisplay}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-center">${imageHtml}</td>
                        <td class="p-2 border-r border-gray-200 dark:border-gray-700 text-right">${unitPriceDisplay}</td>
                        <td class="p-2 text-right font-semibold">${totalPriceDisplay}</td>
                    </tr>
                `;
            }).join('');
            
            // Update totals
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString('vi-VN');

            // Kh√¥ng cho ch·ªçn t·ªß ·ªü trang chi ti·∫øt
            
            // Update system summary
            updateSystemSummary();
        }
        
        // Function to update system summary based on current values
        function updateSystemSummary() {
            if (!surveyData) return;
            
            const r = surveyData.results;
            
            // Get current values from table (edit mode) or from surveyData (view mode)
            let panelQty = Number(r?.panelsNeeded ?? 0);
            let panelPower = Number(r?.panelPower ?? 0);
            let totalCapacity = Number(r?.totalCapacity ?? 0);
            let totalCost = Number(r?.totalCost ?? 0);
            let sunHours = Number(r?.sunHours ?? 4.4);
            
            if (isEditMode) {
                // Get current values from inputs
                const panelRow = document.querySelector('tr[data-item-category="solar_panel"]');
                if (panelRow) {
                    const panelQtyInput = document.getElementById('edit_t·∫•m_pin_qty');
                    if (panelQtyInput) panelQty = Number(panelQtyInput.value) || 0;
                    
                    // Get panel power from selected product
                    const panelSelect = document.getElementById('edit_t·∫•m_pin_product');
                    if (panelSelect && panelSelect.value && surveyProducts && surveyProducts.solar_panel) {
                        const selectedProduct = surveyProducts.solar_panel.find(p => p.id == panelSelect.value);
                        if (selectedProduct && selectedProduct.panel_power_watt) {
                            panelPower = selectedProduct.panel_power_watt / 1000; // Convert to kW
                        }
                    } else {
                        // Use original panel power if no selection
                        panelPower = Number(r?.panelPower ?? 0) / 1000;
                    }
                    
                    totalCapacity = panelQty * panelPower;
                }
                
                // Recalculate total cost from table
                totalCost = 0;
                const rows = document.querySelectorAll('#productsTableBody tr');
                rows.forEach(row => {
                    const totalPriceEl = row.querySelector('[id$="_totalPrice"]');
                    if (totalPriceEl) {
                        const text = totalPriceEl.textContent.replace(/[^\d]/g, '');
                        if (text) totalCost += parseInt(text);
                    }
                });
            } else {
                // View mode: use original values
                totalCapacity = Number(r?.totalCapacity ?? 0);
                totalCost = Number(r?.totalCost ?? 0);
            }
            
            // Calculate daily and monthly kWh
            const dailyKWh = totalCapacity * sunHours;
            const monthlyKWh = dailyKWh * 30;
            
            // Calculate savings
            const monthlySavings = surveyData.monthlyBill * 0.8;
            const summerSavings = monthlySavings * 1.25;
            
            // Calculate payback
            const originalMonthlyBill = Number(surveyData.monthlyBill || 0);
            let paybackSimpleText = '-';
            if (originalMonthlyBill > 0) {
                const monthsPayback = totalCost / originalMonthlyBill;
                const yearsPayback = Math.floor(monthsPayback / 12);
                const remainingMonths = Math.ceil(monthsPayback % 12);
                paybackSimpleText = yearsPayback > 0 
                    ? `${yearsPayback} nƒÉm ${remainingMonths} th√°ng`
                    : `${remainingMonths} th√°ng`;
            }
            
            function calcLoanPayback(principal, monthlyPayment, annualRate) {
                if (monthlyPayment <= 0 || principal <= 0) return '-';
                let remainingPrincipal = principal;
                let months = 0;
                const monthlyRate = annualRate / 12;
                while (remainingPrincipal > 0.01 && months < 600) {
                    months += 1;
                    const interestThisMonth = remainingPrincipal * monthlyRate;
                    const principalPayment = monthlyPayment - interestThisMonth;
                    remainingPrincipal -= principalPayment;
                    if (remainingPrincipal < 0) remainingPrincipal = 0;
                }
                if (months >= 600) return '>50 nƒÉm';
                const years = Math.floor(months / 12);
                const remMonths = Math.ceil(months % 12);
                return years > 0 ? `${years} nƒÉm ${remMonths} th√°ng` : `${remMonths} th√°ng`;
            }
            const paybackLoanText = calcLoanPayback(totalCost, originalMonthlyBill, 0.10);
            
            // Update UI
            const dailyKWhEl = document.getElementById('dailyKWh');
            const monthlyKWhGenEl = document.getElementById('monthlyKWhGen');
            const monthlySavingsEl = document.getElementById('monthlySavings');
            const summerSavingsEl = document.getElementById('summerSavings');
            const paybackSimpleEl = document.getElementById('paybackSimple');
            const paybackLoanEl = document.getElementById('paybackLoan');
            
            if (dailyKWhEl) dailyKWhEl.textContent = `${dailyKWh.toFixed(1)} KW`;
            if (monthlyKWhGenEl) monthlyKWhGenEl.textContent = `${monthlyKWh.toFixed(0)} KW`;
            if (monthlySavingsEl) monthlySavingsEl.textContent = `${Math.round(monthlySavings).toLocaleString('vi-VN')}ƒë`;
            if (summerSavingsEl) summerSavingsEl.textContent = `${Math.round(summerSavings).toLocaleString('vi-VN')}ƒë`;
            if (paybackSimpleEl) paybackSimpleEl.textContent = paybackSimpleText;
            if (paybackLoanEl) paybackLoanEl.textContent = paybackLoanText || '-';
        }
        
        function getUsageTimeText(usageTime) {
            const timeMap = {
                'day': 'Ban ng√†y',
                'night': 'Ban ƒë√™m',
                'balanced': 'C√¢n b·∫±ng'
            };
            return timeMap[usageTime] || usageTime || '-';
        }
        
        function showError(message) {
            const loadingEl = document.getElementById('loading');
            const surveyDetailEl = document.getElementById('surveyDetail');
            const errorStateEl = document.getElementById('errorState');
            
            loadingEl.classList.add('hidden');
            surveyDetailEl.classList.add('hidden');
            errorStateEl.classList.remove('hidden');
            
            document.getElementById('errorMessage').textContent = message;
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Function to prepare survey package from detail page and go to checkout
        async function buyPackageFromDetail() {
            console.log('buyPackageFromDetail function called');
            
            if (!surveyData) {
                showNotification('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu kh·∫£o s√°t', 'error');
                return;
            }

            const survey = surveyData;
            const r = survey.results;
            
            // Debug: Log image URLs from API response
            console.log('API Response - panelImage:', r?.panelImage);
            console.log('API Response - inverterImage:', r?.inverterImage);
            console.log('API Response - batteryImage:', r?.batteryImage);
            console.log('API Response - cabinetImage:', r?.cabinetImage);
            
            try {
                showNotification('‚è≥ ƒêang chu·∫©n b·ªã g√≥i kh·∫£o s√°t...', 'info');

                // Calculate system size from panels
                const systemSizeKw = r?.totalCapacity || 0;
                const panelCount = r?.panelsNeeded || 0;
                
                // Load survey products from API (same as khao-sat-dien-mat-troi.html)
                // This ensures we can find images even if API response has null images
                let surveyProducts = null;
                try {
                    const productsResponse = await fetch('../api/get_survey_products_public.php');
                    const productsData = await productsResponse.json();
                    if (productsData.success && productsData.products) {
                        surveyProducts = productsData.products;
                        console.log('Loaded survey products for fallback:', surveyProducts);
                    }
                } catch (err) {
                    console.error('Error loading survey products:', err);
                }

                // Helper function to find image from survey products (same logic as khao-sat-dien-mat-troi.html)
                function findImageFromProducts(productName, category, phaseType = null) {
                    if (!surveyProducts) return null;
                    
                    let productsToSearch = [];
                    
                    if (category === 'solar_panel' && surveyProducts.solar_panel) {
                        productsToSearch = surveyProducts.solar_panel;
                    } else if (category === 'inverter' && surveyProducts.inverter) {
                        const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                        productsToSearch = [
                            ...(surveyProducts.inverter[phaseKey] || []),
                            ...(surveyProducts.inverter['both'] || [])
                        ];
                    } else if (category === 'battery' && surveyProducts.battery) {
                        productsToSearch = surveyProducts.battery;
                    } else if (category === 'electrical_cabinet' && surveyProducts.electrical_cabinet) {
                        const phaseKey = phaseType === 1 ? '1_phase' : phaseType === 3 ? '3_phase' : 'both';
                        productsToSearch = [
                            ...(surveyProducts.electrical_cabinet[phaseKey] || []),
                            ...(surveyProducts.electrical_cabinet['both'] || [])
                        ];
                    }
                    
                    // Find product by matching title
                    const found = productsToSearch.find(p => {
                        const titleLower = (p.title || '').toLowerCase();
                        const nameLower = (productName || '').toLowerCase();
                        return titleLower.includes(nameLower) || nameLower.includes(titleLower);
                    });
                    
                    if (found && found.image_url) {
                        console.log(`Found image from survey products for '${productName}':`, found.image_url);
                        return found.image_url;
                    }
                    
                    return null;
                }
                
                // Helper function to fix image URL path (same as khao-sat-dien-mat-troi.html)
                function fixImageUrl(imageUrl) {
                    // Debug: log original imageUrl
                    console.log('fixImageUrl input:', imageUrl);
                    
                    if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined' || imageUrl.trim() === '') {
                        console.log('fixImageUrl: returning null for empty imageUrl');
                        return null;
                    }
                    
                    // If already absolute URL, return as is
                    if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                        console.log('fixImageUrl: absolute URL, returning as is');
                        return imageUrl;
                    }
                    
                    // Remove leading '../', '..//', './', etc. (same as khao-sat-dien-mat-troi.html)
                    imageUrl = imageUrl.replace(/^(\.\.\/)+/, '').replace(/^\.\//, '');
                    
                    // Add leading slash if not present (same as khao-sat-dien-mat-troi.html)
                    if (!imageUrl.startsWith('/')) {
                        imageUrl = '/' + imageUrl;
                    }
                    
                    console.log('fixImageUrl: final result:', imageUrl);
                    return imageUrl;
                }
                
                // Helper to get image with fallback
                function getImageUrl(apiImage, productName, category, phaseType = null) {
                    // First, try API image
                    if (apiImage && apiImage !== 'null' && apiImage.trim() !== '') {
                        return fixImageUrl(apiImage);
                    }
                    
                    // Fallback: find from survey products
                    const fallbackImage = findImageFromProducts(productName, category, phaseType);
                    if (fallbackImage) {
                        return fixImageUrl(fallbackImage);
                    }
                    
                    return null;
                }

                // T√≠nh to√°n accessories t∆∞∆°ng t·ª± populateSurveyData
                const selectedBatteryUnits = Number(r?.batteryQuantity || 1);
                let computedAccessories = [];
                if (Array.isArray(r?.accessories) && r.accessories.length > 0) {
                    // S·ª≠ d·ª•ng accessories ƒë√£ l∆∞u t·ª´ database
                    computedAccessories = r.accessories.map(a => ({
                        name: a.name,
                        unit: a.unit || '',
                        quantity: Number(a.quantity || 0),
                        price: Number(a.price || 0),
                        totalPrice: Number(a.totalPrice || (Number(a.quantity||0)*Number(a.price||0))),
                        image: a.image || null
                    }));
                } else if (surveyProducts && surveyProducts.accessory && Array.isArray(surveyProducts.accessory)) {
                    // T√≠nh to√°n t·ª´ config admin (t∆∞∆°ng t·ª± khao-sat-dien-mat-troi.html)
                    computedAccessories = surveyProducts.accessory.map(acc => {
                        const depTarget = acc.accessory_dependent_target || 'project';
                        const baseQty = typeof acc.accessory_base_qty === 'number' ? acc.accessory_base_qty : 0;
                        const depQty = typeof acc.accessory_dependent_qty === 'number' && acc.accessory_dependent_qty !== null ? acc.accessory_dependent_qty : 1;
                        let targetCount = 1;
                        if (depTarget === 'panel') targetCount = panelCount;
                        else if (depTarget === 'inverter') targetCount = 1;
                        else if (depTarget === 'battery') targetCount = selectedBatteryUnits;
                        else if (depTarget === 'cabinet') targetCount = 1;
                        else targetCount = 1; // project
                        
                        // Logic h·ªá s·ªë ph·ª• thu·ªôc = 0: Lu√¥n d√πng s·ªë l∆∞·ª£ng b·∫£n th√¢n, b·∫•t k·ªÉ c√≥ bao nhi√™u s·∫£n ph·∫©m ph·ª• thu·ªôc
                        let qty;
                        if (depQty === 0) {
                            qty = baseQty; // Lu√¥n = s·ªë l∆∞·ª£ng b·∫£n th√¢n
                        } else if (depTarget === 'project') {
                            qty = baseQty; // Project kh√¥ng ph·ª• thu·ªôc
                        } else {
                            // H·ªá s·ªë != 0: T√≠nh theo c√¥ng th·ª©c
                            qty = baseQty * targetCount * (depQty || 1);
                        }
                        
                        const unitPrice = Number(acc.price || 0);
                        return {
                            name: acc.title,
                            unit: acc.accessory_unit || '',
                            quantity: qty,
                            price: unitPrice,
                            totalPrice: qty * unitPrice,
                            image: acc.image_url ? fixImageUrl(acc.image_url) : null
                        };
                    });
                }

                // Prepare survey package data v·ªõi c·∫•u tr√∫c th·ªëng nh·∫•t (items: panel, inverter, cabinet, battery; accessories: t·∫•t c·∫£ ph·ª• ki·ªán)
                const surveyPackage = {
                    fromSurvey: true,
                    items: [
                        // T·∫•m pin
                        {
                            id: r?.panelId || null,
                            title: r?.panelName || 'T·∫•m Pin',
                            price: Number(r?.panelPrice || 0),
                            quantity: panelCount,
                            image_url: getImageUrl(r?.panelImage, r?.panelName, 'solar_panel')
                        },
                        // Inverter
                        {
                            id: r?.inverterId || null,
                            title: r?.inverterName || 'Inverter',
                            price: Number(r?.inverterPrice || 0),
                            quantity: 1,
                            image_url: getImageUrl(r?.inverterImage, r?.inverterName, 'inverter', survey.phase),
                            isVirtual: true
                        },
                        // T·ªß ƒëi·ªán
                        {
                            id: r?.cabinetId || null,
                            title: r?.cabinetName || 'T·ªß ƒëi·ªán',
                            price: Number(r?.cabinetPrice || 0),
                            quantity: 1,
                            image_url: getImageUrl(r?.cabinetImage, r?.cabinetName, 'electrical_cabinet', survey.phase),
                            isVirtual: true
                        },
                        // Pin l∆∞u tr·ªØ
                        {
                            id: r?.batteryId || null,
                            title: r?.batteryName || 'Pin l∆∞u tr·ªØ',
                            price: Number(r?.batteryUnitPrice || 0),
                            quantity: Number(r?.batteryQuantity || 1),
                            image_url: getImageUrl(r?.batteryImage, r?.batteryName, 'battery')
                        }
                    ],
                    // Accessories: ph·ª• ki·ªán ƒë√£ l∆∞u/t√≠nh + lu√¥n th√™m C√¥ng th·ª£, V·∫≠n chuy·ªÉn
                    accessories: [
                        ...computedAccessories.map(a => ({
                            id: 'accessory_' + a.name.replace(/\s+/g, '_'),
                            title: a.name,
                            price: a.price,
                            quantity: a.quantity,
                            image_url: a.image,
                            isVirtual: true
                        })),
                        {
                            id: 'accessory_labor',
                            title: 'Chi ph√≠ c√¥ng th·ª£ l·∫Øp ƒë·∫∑t tr·ªçn g√≥i',
                            price: Number(r?.laborCost || 0),
                            quantity: 1,
                            image_url: 'üîß',
                            isVirtual: true
                        },
                        {
                            id: 'accessory_transport',
                            title: 'Chi ph√≠ v·∫≠n chuy·ªÉn thi·∫øt b·ªã',
                            price: 0,
                            quantity: 1,
                            image_url: 'üöõ',
                            isVirtual: true
                        }
                    ],
                    // Summary info
                    summary: {
                        inverter: r?.inverterName || 'Inverter',
                        invertorPrice: Number(r?.inverterPrice || 0),
                        cabinet: r?.cabinetName || 'T·ªß ƒëi·ªán',
                        cabinetPrice: Number(r?.cabinetPrice || 0),
                        totalEstimate: Number(r?.totalCost || 0),
                        systemSizeKw: systemSizeKw,
                        panelCount: panelCount,
                        region: survey.region,
                        phase: survey.phase
                    },
                    note: `G√≥i kh·∫£o s√°t ƒëi·ªán m·∫∑t tr·ªùi - ${systemSizeKw}kWp - ${panelCount} t·∫•m pin - Inverter: ${r?.inverterName || 'N/A'} - Pin: ${r?.batteryName || 'N/A'}`
                };

                // Save to localStorage
                localStorage.setItem('surveyPackage', JSON.stringify(surveyPackage));
                console.log('Survey package saved to localStorage:', surveyPackage);

                showNotification('‚úÖ ƒê√£ chu·∫©n b·ªã g√≥i kh·∫£o s√°t!', 'success');
                
                // Redirect to checkout page after a short delay
                setTimeout(() => {
                    window.location.href = 'dat-hang.html';
                }, 1000);

            } catch (error) {
                console.error('Error preparing package:', error);
                showNotification('‚ùå L·ªói khi chu·∫©n b·ªã g√≥i: ' + error.message, 'error');
            }
        }

        // Export to PDF function - C√°ch 2: html2canvas + jsPDF tr·ª±c ti·∫øp (lu√¥n ch·ªâ 1 trang)
        async function exportToPDF() {
            try {
                const src = document.getElementById('surveyDetail');
                if (!src) {
                    alert('Kh√¥ng t√¨m th·∫•y n·ªôi dung b√°o gi√°!');
                    return;
                }

                // Hi·ªÉn th·ªã loading
                showNotification('üîÑ ƒêang t·∫°o PDF...', 'info');

                // Clone & b·ªçc A4
                const clone = src.cloneNode(true);
                const rm = clone.querySelector('#actionButtons');
                if (rm) rm.remove();
                const bk = clone.querySelector('.back-button');
                if (bk) bk.remove();

                const wrapper = document.createElement('div');
                wrapper.style.width = '210mm';
                wrapper.style.height = '297mm';
                wrapper.style.padding = '5mm';
                wrapper.style.boxSizing = 'border-box';
                wrapper.style.background = 'white';
                wrapper.style.overflow = 'hidden';
                wrapper.appendChild(clone);

                const temp = document.createElement('div');
                temp.style.position = 'fixed';
                temp.style.left = '-10000px';
                temp.appendChild(wrapper);
                document.body.appendChild(temp);

                // Fit clone v√†o A4 (ƒë√£ c√≥ h√†m c·ªßa b·∫°n)
                fitElementToA4(clone, { marginMm: 5 });

                // ƒê·ª£i ·∫£nh
                const imgs = wrapper.querySelectorAll('img');
                await Promise.all([...imgs].map(img => img.complete ? Promise.resolve() : new Promise(r => {
                    img.onload = r;
                    img.onerror = r;
                    setTimeout(r, 2000);
                })));

                // ƒê·ª£i DOM c·∫≠p nh·∫≠t
                await new Promise(resolve => setTimeout(resolve, 300));

                // Render th√†nh canvas 1 trang
                const canvas = await html2canvas(wrapper, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);

                // Th√™m v√†o PDF 1 trang duy nh·∫•t (kh√¥ng cho ph√©p chia trang)
                // jsPDF t·ª´ CDN - UMD version expose qua window.jspdf
                let jsPDFLib;
                if (window.jspdf && window.jspdf.jsPDF) {
                    jsPDFLib = window.jspdf.jsPDF;
                } else if (window.jsPDF) {
                    jsPDFLib = window.jsPDF;
                } else {
                    throw new Error('jsPDF kh√¥ng t√¨m th·∫•y. Vui l√≤ng ki·ªÉm tra CDN.');
                }
                const pdf = new jsPDFLib({ unit: 'mm', format: 'a4', orientation: 'portrait' });
                const pageW = 210;
                const pageH = 297;
                
                // Gi·ªØ t·ªâ l·ªá ·∫£nh: fit theo chi·ªÅu n√†o ch·∫°m bi√™n tr∆∞·ªõc
                const imgRatio = canvas.width / canvas.height;
                let w = pageW;
                let h = w / imgRatio;
                if (h > pageH) {
                    h = pageH;
                    w = h * imgRatio;
                }
                const x = (pageW - w) / 2;
                const y = (pageH - h) / 2;
                pdf.addImage(imgData, 'JPEG', x, y, w, h, undefined, 'FAST');

                pdf.save(`BaoGia_${surveyId || 'survey'}_${new Date().getTime()}.pdf`);

                // D·ªçn
                document.body.removeChild(temp);

                showNotification('‚úÖ ƒê√£ xu·∫•t PDF th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showNotification('‚ùå L·ªói khi xu·∫•t PDF: ' + error.message, 'error');
            }
        }

        // Export to Image function - xu·∫•t ·∫£nh PNG/JPG
        async function exportToImage() {
            try {
                const src = document.getElementById('surveyDetail');
                if (!src) {
                    alert('Kh√¥ng t√¨m th·∫•y n·ªôi dung b√°o gi√°!');
                    return;
                }

                // Hi·ªÉn th·ªã loading
                showNotification('üîÑ ƒêang t·∫°o ·∫£nh...', 'info');

                // Clone & b·ªçc A4
                const clone = src.cloneNode(true);
                const rm = clone.querySelector('#actionButtons');
                if (rm) rm.remove();
                const bk = clone.querySelector('.back-button');
                if (bk) bk.remove();

                const wrapper = document.createElement('div');
                wrapper.style.width = '210mm';
                wrapper.style.height = '297mm';
                wrapper.style.padding = '5mm';
                wrapper.style.boxSizing = 'border-box';
                wrapper.style.background = 'white';
                wrapper.style.overflow = 'hidden';
                wrapper.appendChild(clone);

                const temp = document.createElement('div');
                temp.style.position = 'fixed';
                temp.style.left = '-10000px';
                temp.appendChild(wrapper);
                document.body.appendChild(temp);

                // Fit clone v√†o A4
                fitElementToA4(clone, { marginMm: 5 });

                // ƒê·ª£i ·∫£nh
                const imgs = wrapper.querySelectorAll('img');
                await Promise.all([...imgs].map(img => img.complete ? Promise.resolve() : new Promise(r => {
                    img.onload = r;
                    img.onerror = r;
                    setTimeout(r, 2000);
                })));

                // ƒê·ª£i DOM c·∫≠p nh·∫≠t
                await new Promise(resolve => setTimeout(resolve, 300));

                // Render th√†nh canvas
                const canvas = await html2canvas(wrapper, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Chuy·ªÉn canvas th√†nh ·∫£nh v√† download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `BaoGia_${surveyId || 'survey'}_${new Date().getTime()}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/png', 0.95);

                // D·ªçn
                document.body.removeChild(temp);

                showNotification('‚úÖ ƒê√£ xu·∫•t ·∫£nh th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error('Error exporting image:', error);
                showNotification('‚ùå L·ªói khi xu·∫•t ·∫£nh: ' + error.message, 'error');
            }
        }
        
        // Function to handle product selection change (edit mode)
        function onProductChange(itemKey, category, productId) {
            if (!productId) return;
            
            // Find product in surveyProducts
            let product = null;
            if (surveyProducts) {
                let productsToSearch = [];
                if (category === 'solar_panel' && surveyProducts.solar_panel) {
                    productsToSearch = surveyProducts.solar_panel;
                } else if (category === 'inverter' && surveyProducts.inverter) {
                    const phaseKey = surveyData.phase === 1 ? '1_phase' : surveyData.phase === 3 ? '3_phase' : 'both';
                    productsToSearch = [
                        ...(surveyProducts.inverter[phaseKey] || []),
                        ...(surveyProducts.inverter['both'] || [])
                    ];
                } else if (category === 'battery' && surveyProducts.battery) {
                    productsToSearch = surveyProducts.battery;
                } else if (category === 'electrical_cabinet' && surveyProducts.electrical_cabinet) {
                    const phaseKey = surveyData.phase === 1 ? '1_phase' : surveyData.phase === 3 ? '3_phase' : 'both';
                    productsToSearch = [
                        ...(surveyProducts.electrical_cabinet[phaseKey] || []),
                        ...(surveyProducts.electrical_cabinet['both'] || [])
                    ];
                }
                
                product = productsToSearch.find(p => p.id == productId);
            }
            
            if (product) {
                // Update unit price
                const unitPriceInput = document.getElementById(`edit_${itemKey}_unitPrice`);
                if (unitPriceInput) {
                    unitPriceInput.value = product.price;
                }
                
                // Update brand
                const brandEl = document.getElementById(`edit_${itemKey}_brand`);
                if (brandEl) {
                    // brandEl is now an input field, use value instead of textContent
                    const brandName = product.title.split(' ')[0];
                    brandEl.value = brandName;
                }
                
                // Update image
                const imageEl = document.getElementById(`edit_${itemKey}_image`);
                if (imageEl && product.image_url) {
                    const imgSrc = product.image_url.startsWith('/') ? '..' + product.image_url : 
                                  (product.image_url.startsWith('../') ? product.image_url : '../' + product.image_url);
                    imageEl.src = imgSrc;
                }
                
                // Update row total
                updateRowTotal(itemKey);
                
                // Update summary if panel changed
                if (category === 'solar_panel') {
                    updateSystemSummary();
                }
            }
        }
        
        // Function to update row total when unit price or quantity changes (edit mode)
        function updateRowTotal(itemKey) {
            const unitPriceInput = document.getElementById(`edit_${itemKey}_unitPrice`);
            const qtyInput = document.getElementById(`edit_${itemKey}_qty`);
            const totalPriceEl = document.getElementById(`edit_${itemKey}_totalPrice`);
            
            if (unitPriceInput && totalPriceEl) {
                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                // Get qty from input if exists, otherwise default to 1 (for inverter, cabinet)
                const qty = qtyInput ? (parseFloat(qtyInput.value) || 0) : 1;
                const totalPrice = unitPrice * qty;
                totalPriceEl.textContent = totalPrice > 0 ? totalPrice.toLocaleString('vi-VN') : '-';
                
                // Recalculate total amount
                recalculateTotalAmount();
                
                // Update system summary if main product changed
                const row = document.querySelector(`tr[data-item-key="${itemKey}"]`);
                if (row) {
                    const category = row.getAttribute('data-item-category');
                    if (category && ['solar_panel', 'inverter', 'battery', 'electrical_cabinet'].includes(category)) {
                        updateSystemSummary();
                    }
                }
            }
        }
        
        // Function to recalculate total amount from all rows
        function recalculateTotalAmount() {
            let total = 0;
            const totalAmountEl = document.getElementById('totalAmount');
            
            // Get all rows from table
            const rows = document.querySelectorAll('#productsTableBody tr');
            
            rows.forEach(row => {
                const totalPriceEl = row.querySelector('[id$="_totalPrice"]');
                if (totalPriceEl) {
                    const text = totalPriceEl.textContent.replace(/[^\d]/g, '');
                    if (text) {
                        total += parseInt(text);
                    }
                } else {
                    // Fallback: calculate from qty * unitPrice if inputs exist
                    const qtyInput = row.querySelector('input[type="number"][id$="_qty"]');
                    const unitPriceInput = row.querySelector('input[type="number"][id$="_unitPrice"]');
                    if (qtyInput && unitPriceInput) {
                        const qty = parseFloat(qtyInput.value) || 0;
                        const unitPrice = parseFloat(unitPriceInput.value) || 0;
                        total += qty * unitPrice;
                    }
                }
            });
            
            if (totalAmountEl) {
                totalAmountEl.textContent = total.toLocaleString('vi-VN') + 'ƒë';
            }
        }
        
        // Function to save survey changes (edit mode)
        async function saveSurveyChanges() {
            if (!isEditMode || !surveyId) {
                showNotification('‚ö†Ô∏è Kh√¥ng ·ªü ch·∫ø ƒë·ªô ch·ªânh s·ª≠a', 'error');
                return;
            }
            
            try {
                showNotification('‚è≥ ƒêang l∆∞u thay ƒë·ªïi...', 'info');
                
                // Collect updated data
                const updateData = {
                    survey_id: parseInt(surveyId),
                    full_name: document.getElementById('editCustomerName')?.value || surveyData.fullName,
                    phone: document.getElementById('editCustomerPhone')?.value || surveyData.phone,
                    results: {}
                };
                
                // Collect updated prices from table
                const r = surveyData.results;
                
                // Get updated values from main products
                const mainProducts = [
                    { key: 't·∫•m_pin', resultKeys: { price: 'panelPrice', qty: 'panelsNeeded', id: 'panelId', name: 'panelName' } },
                    { key: 'inverter', resultKeys: { price: 'inverterPrice', qty: null, id: 'inverterId', name: 'inverterName' } },
                    { key: 'pin_l∆∞u_tr·ªØ', resultKeys: { price: 'batteryUnitPrice', qty: 'batteryQuantity', id: 'batteryId', name: 'batteryName' } },
                    { key: 't·ªß_ƒëi·ªán', resultKeys: { price: 'cabinetPrice', qty: null, id: 'cabinetId', name: 'cabinetName' } }
                ];
                
                mainProducts.forEach(mp => {
                    const productSelect = document.getElementById(`edit_${mp.key}_product`);
                    const priceInput = document.getElementById(`edit_${mp.key}_unitPrice`);
                    const qtyInput = document.getElementById(`edit_${mp.key}_qty`);
                    
                    // Get product ID from dropdown (if selected new product)
                    if (productSelect && productSelect.value) {
                        updateData.results[mp.resultKeys.id] = parseInt(productSelect.value);
                        
                        // Get product name from selected option
                        const selectedOption = productSelect.options[productSelect.selectedIndex];
                        if (selectedOption && selectedOption.text) {
                            updateData.results[mp.resultKeys.name] = selectedOption.text.trim();
                        }
                    } else if (productSelect && !productSelect.value) {
                        // No new product selected - keep existing name to prevent "0" values
                        // Always ensure we have a valid name value (use original if available and not "0")
                        const originalName = r?.[mp.resultKeys.name];
                        if (originalName && originalName !== '0' && originalName !== 'null' && originalName !== 'undefined' && originalName.trim() !== '') {
                            updateData.results[mp.resultKeys.name] = originalName.trim();
                        } else {
                            // If original name is invalid, use default name based on category
                            const defaultNames = {
                                'panelName': 'T·∫•m Pin',
                                'inverterName': 'Inverter',
                                'batteryName': 'Pin l∆∞u tr·ªØ',
                                'cabinetName': 'T·ªß ƒëi·ªán'
                            };
                            updateData.results[mp.resultKeys.name] = defaultNames[mp.resultKeys.name] || 'S·∫£n ph·∫©m';
                        }
                        // Keep existing ID if no new selection
                        if (r?.[mp.resultKeys.id]) {
                            updateData.results[mp.resultKeys.id] = parseInt(r[mp.resultKeys.id]);
                        }
                    } else {
                        // productSelect doesn't exist - use original values
                        const originalName = r?.[mp.resultKeys.name];
                        if (originalName && originalName !== '0' && originalName !== 'null' && originalName !== 'undefined' && originalName.trim() !== '') {
                            updateData.results[mp.resultKeys.name] = originalName.trim();
                        }
                        if (r?.[mp.resultKeys.id]) {
                            updateData.results[mp.resultKeys.id] = parseInt(r[mp.resultKeys.id]);
                        }
                    }
                    
                    // Always get price (must have value)
                    if (priceInput) {
                        const priceValue = parseFloat(priceInput.value) || 0;
                        updateData.results[mp.resultKeys.price] = priceValue;
                    } else {
                        // Fallback to original price if input doesn't exist
                        updateData.results[mp.resultKeys.price] = parseFloat(r?.[mp.resultKeys.price]) || 0;
                    }
                    
                    // Get quantity (if applicable)
                    if (qtyInput && mp.resultKeys.qty) {
                        updateData.results[mp.resultKeys.qty] = parseInt(qtyInput.value) || 0;
                    } else if (!qtyInput && mp.resultKeys.qty) {
                        // Fallback to original quantity if input doesn't exist
                        updateData.results[mp.resultKeys.qty] = parseInt(r?.[mp.resultKeys.qty]) || 0;
                    }
                });
                
                // Get labor cost
                const laborInput = document.getElementById('edit_chi_ph√≠_c√¥ng_th·ª£_l·∫Øp_ƒë·∫∑t_tr·ªçn_g√≥i_unitPrice');
                if (laborInput) {
                    updateData.results.laborCost = parseFloat(laborInput.value) || 0;
                }
                
                // Calculate total cost from table (get from totalAmount element)
                const totalAmountText = document.getElementById('totalAmount')?.textContent || '0';
                const totalCost = parseInt(totalAmountText.replace(/[^\d]/g, '')) || 0;
                
                // Calculate individual costs
                const panelPrice = updateData.results.panelPrice || r?.panelPrice || 0;
                const panelCount = updateData.results.panelsNeeded || r?.panelsNeeded || 0;
                const panelCost = panelPrice * panelCount;
                
                const inverterPrice = updateData.results.inverterPrice || r?.inverterPrice || 0;
                const batteryUnitPrice = updateData.results.batteryUnitPrice || r?.batteryUnitPrice || 0;
                const batteryQuantity = updateData.results.batteryQuantity || r?.batteryQuantity || 1;
                const batteryCost = batteryUnitPrice * batteryQuantity;
                
                const cabinetPrice = updateData.results.cabinetPrice || r?.cabinetPrice || 0;
                const laborCost = updateData.results.laborCost || r?.laborCost || 0;
                
                // Calculate accessories cost (keep from original)
                const accessoriesCost = r?.accessoriesCost || 0;
                
                updateData.results.panelCost = panelCost;
                updateData.results.batteryCost = batteryCost;
                updateData.results.totalCost = totalCost;
                
                // Call API to save
                const response = await fetch('../api/admin/update_survey.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ L∆∞u thay ƒë·ªïi th√†nh c√¥ng!', 'success');
                    
                    // Reload survey data to reflect changes
                    setTimeout(() => {
                        loadSurveyDetail(surveyId);
                    }, 1000);
                } else {
                    showNotification('‚ùå L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi'), 'error');
                }
                
            } catch (error) {
                console.error('Error saving survey changes:', error);
                showNotification('‚ùå L·ªói khi l∆∞u: ' + error.message, 'error');
            }
        }
    </script>
    
    <script>
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        let menuJustOpened = false; // Flag to prevent immediate closing after user opens menu

        mobileMenuButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event bubbling
            menuJustOpened = true; // Set flag when user manually opens menu
            mobileMenu.classList.toggle('hidden');
            
            // Reset flag after a short delay to allow scroll handler to work again
            setTimeout(() => {
                menuJustOpened = false;
            }, 300);
        });
        
        mobileMenu.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                mobileMenu.classList.add('hidden');
            }
        });

        // Highlight active navigation item based on current page
        (function() {
            const currentPath = window.location.pathname;
            const currentPage = currentPath.split('/').pop() || 'index.html';
            
            // Select all nav links (both desktop and mobile)
            const navLinks = document.querySelectorAll('nav a[href*=".html"]');
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                const linkPage = href.split('/').pop();
                
                const isActive = linkPage === currentPage;
                
                if (isActive) {
                    // Remove default classes
                    link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-white', 'dark:hover:bg-gray-700', 'hover:bg-gray-100');
                    // Add active classes
                    link.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
                }
            });
        })();
    </script>

    <!-- Ecosystem Logos Carousel - Load from Product Categories API -->
    <script src="../assets/js/ecosystem-logos.js"></script>
</body>
</html>
