<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - HC Eco System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="../assets/img/logo.jpg" />
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        .toast-enter {
            animation: slideInRight 0.3s ease-out;
        }
        .toast-exit {
            animation: slideOutRight 0.3s ease-in;
        }
        .tab-button.active {
            background-color: #16a34a;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="../assets/img/logo.jpg" alt="Logo" class="h-12 w-12 rounded-lg">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">HC ECO SYSTEM</h1>
                    <p class="text-sm text-gray-600">Admin Panel</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="admin-name" class="text-gray-700 font-semibold"></span>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex gap-2 overflow-x-auto py-2">
                <button class="tab-button active px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('categories')">
                    üìÅ Danh m·ª•c SP
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('products')">
                    üì¶ S·∫£n ph·∫©m
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('survey')">
                    üìã Kh·∫£o s√°t
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('packages')">
                    üéÅ G√≥i s·∫£n ph·∫©m
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('orders')">
                    üõí ƒê∆°n h√†ng
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('tickets')">
                    üé´ V√© quay
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('rewards')">
                    üéÅ Ph·∫ßn th∆∞·ªüng
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" onclick="showTab('intro-posts')">
                    üìù B√†i gi·ªõi thi·ªáu
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Categories Tab -->
        <div id="tab-categories" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Danh m·ª•c s·∫£n ph·∫©m</h2>
                    <button onclick="openCategoryModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m danh m·ª•c
                    </button>
                </div>
                <div id="categories-list" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">Logo</th>
                                <th class="px-4 py-3 text-left">T√™n danh m·ª•c</th>
                                <th class="px-4 py-3 text-center">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="categories-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="tab-products" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">S·∫£n ph·∫©m</h2>
                    <button onclick="openProductModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m s·∫£n ph·∫©m
                    </button>
                </div>
                <div class="mb-4">
                    <select id="product-category-filter" class="px-4 py-2 border rounded-lg" onchange="loadProducts()">
                        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                </div>
                <div id="products-list" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">H√¨nh</th>
                                <th class="px-4 py-3 text-left">Ti√™u ƒë·ªÅ</th>
                                <th class="px-4 py-3 text-left">Danh m·ª•c</th>
                                <th class="px-4 py-3 text-right">Gi√° th·ªã tr∆∞·ªùng</th>
                                <th class="px-4 py-3 text-right" id="category-price-header">Gi√° danh m·ª•c</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Survey Products Tab -->
        <div id="tab-survey" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Qu·∫£n l√Ω s·∫£n ph·∫©m kh·∫£o s√°t</h2>
                    <div class="flex gap-2">
                        <select id="survey-filter" class="px-4 py-2 border rounded-lg" onchange="loadSurveyProducts()">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="configured">ƒê√£ c·∫•u h√¨nh</option>
                            <option value="unconfigured">Ch∆∞a c·∫•u h√¨nh</option>
                        </select>
                    </div>
                </div>
                <div id="survey-products-list" class="overflow-x-auto">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Packages Tab -->
        <div id="tab-packages" class="tab-content hidden">
            <!-- Package Categories Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Danh m·ª•c g√≥i</h2>
                    <button onclick="openPackageCategoryModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m danh m·ª•c g√≥i
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">Logo</th>
                                <th class="px-4 py-3 text-left">T√™n danh m·ª•c</th>
                                <th class="px-4 py-3 text-left">Badge</th>
                                <th class="px-4 py-3 text-center">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="package-categories-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Packages Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">G√≥i s·∫£n ph·∫©m</h2>
                    <button onclick="openPackageModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m g√≥i
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">T√™n g√≥i</th>
                                <th class="px-4 py-3 text-left">Danh m·ª•c</th>
                                <th class="px-4 py-3 text-right">Gi√°</th>
                                <th class="px-4 py-3 text-center">S·ªë items</th>
                                <th class="px-4 py-3 text-center">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="packages-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="tab-orders" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ƒê∆°n h√†ng</h2>
                    <select id="order-status-filter" class="px-4 py-2 border rounded-lg" onchange="loadOrders()">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="approved">ƒê√£ duy·ªát</option>
                        <option value="processing">ƒêang x·ª≠ l√Ω</option>
                        <option value="shipping">ƒêang giao h√†ng</option>
                        <option value="shipped">ƒê√£ giao h√†ng</option>
                        <option value="delivered">ƒê√£ nh·∫≠n h√†ng</option>
                        <option value="cancelled">ƒê√£ h·ªßy</option>
                    </select>
                </div>
                <div id="orders-list"></div>
            </div>
        </div>

        <!-- Tickets Tab -->
        <div id="tab-tickets" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">V√© quay may m·∫Øn</h2>
                    <button onclick="openTicketModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m v√©
                    </button>
                </div>
                <div id="tickets-list" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">Ng∆∞·ªùi d√πng</th>
                                <th class="px-4 py-3 text-left">Lo·∫°i v√©</th>
                                <th class="px-4 py-3 text-left">Ph·∫ßn th∆∞·ªüng set s·∫µn</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-left">Ng√†y t·∫°o</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rewards Tab -->
        <div id="tab-rewards" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">M·∫´u ph·∫ßn th∆∞·ªüng</h2>
                    <button onclick="openRewardModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m ph·∫ßn th∆∞·ªüng
                    </button>
                </div>
                <div id="rewards-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- Intro Posts Tab -->
        <div id="tab-intro-posts" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">B√†i vi·∫øt trang gi·ªõi thi·ªáu</h2>
                    <button onclick="openIntroPostModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m b√†i vi·∫øt
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-left">Ti√™u ƒë·ªÅ</th>
                                <th class="px-4 py-3 text-left">M√¥ t·∫£</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="intro-posts-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="categoryModalTitle">Th√™m danh m·ª•c</h3>
            <form id="categoryForm" onsubmit="saveCategory(event)">
                <input type="hidden" id="category_id">
                <input type="hidden" id="category_logo_url">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n danh m·ª•c *</label>
                        <input type="text" id="category_name" required class="w-full px-4 py-2 border rounded-lg"
                            placeholder="V√≠ d·ª•: NƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi, X√¢y d·ª±ng, Du l·ªãch, Coffee, Ti√™u d√πng...">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Logo (·∫¢nh) *</label>
                        <input type="file" id="category_logo" accept="image/*" 
                            class="w-full px-4 py-2 border rounded-lg" onchange="previewCategoryLogo(event)">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn ·∫£nh logo cho danh m·ª•c (PNG, JPG, JPEG, GIF, max 2MB)</p>
                        <div id="category_logo_preview" class="mt-3 hidden">
                            <img id="category_logo_preview_img" src="" alt="Logo preview" 
                                class="h-32 w-32 object-cover rounded-lg border-2 border-gray-300">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± ∆∞u ti√™n *</label>
                        <input type="number" id="category_display_order" value="1" min="1" required 
                            class="w-full px-4 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">S·ªë th·ª© t·ª± hi·ªÉn th·ªã tr√™n website (kh√¥ng ƒë∆∞·ª£c tr√πng v·ªõi danh m·ª•c kh√°c)</p>
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="category_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closeCategoryModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="productModalTitle">Th√™m s·∫£n ph·∫©m</h3>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="product_id">
                <div class="space-y-4">
                    <!-- Danh m·ª•c -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Danh m·ª•c *</label>
                        <select id="product_category_id" required class="w-full px-4 py-2 border rounded-lg" onchange="updateCategoryPriceLabel()">
                            <option value="">-- Ch·ªçn danh m·ª•c --</option>
                        </select>
                    </div>

                    <!-- Ti√™u ƒë·ªÅ/T√™n -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ/T√™n s·∫£n ph·∫©m *</label>
                        <input type="text" id="product_title" required class="w-full px-4 py-2 border rounded-lg"
                            placeholder="V√≠ d·ª•: T·∫•m Pin Jinko Solar 590W Tiger Neo">
                    </div>

                    <!-- Gi√° th·ªã tr∆∞·ªùng -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Gi√° th·ªã tr∆∞·ªùng (VNƒê) *</label>
                        <input type="number" id="product_market_price" required min="0" step="1000" 
                            class="w-full px-4 py-2 border rounded-lg" placeholder="2300000">
                    </div>

                    <!-- Gi√° danh m·ª•c (ƒë·ªông theo t√™n danh m·ª•c) -->
                    <div>
                        <label class="block text-sm font-semibold mb-2" id="product_category_price_label">Gi√° danh m·ª•c (VNƒê)</label>
                        <input type="number" id="product_category_price" min="0" step="1000" 
                            class="w-full px-4 py-2 border rounded-lg" placeholder="3500000">
                        <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥ gi√° ri√™ng cho danh m·ª•c n√†y</p>
                    </div>

                    <!-- H√¨nh ·∫£nh -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
                        <div class="space-y-2">
                            <!-- Upload ·∫£nh m·ªõi -->
                            <div class="flex gap-2">
                                <input type="file" id="product_image_file" accept="image/*" 
                                    class="flex-1 px-4 py-2 border rounded-lg" onchange="uploadProductImage(event)">
                                <button type="button" onclick="document.getElementById('product_image_file').click()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    üìÅ Upload
                                </button>
                            </div>
                            <!-- Ch·ªçn ·∫£nh c√≥ s·∫µn -->
                            <select id="product_image_url" class="w-full px-4 py-2 border rounded-lg" onchange="previewProductImage()">
                                <option value="">-- Ho·∫∑c ch·ªçn ·∫£nh c√≥ s·∫µn --</option>
                            </select>
                            <!-- Preview ·∫£nh -->
                            <div id="product_image_preview" class="hidden mt-2">
                                <img id="product_image_preview_img" src="" alt="Preview" 
                                    class="h-32 w-32 object-cover rounded-lg border-2 border-gray-300">
                            </div>
                        </div>
                    </div>

                    <!-- M√¥ t·∫£ k·ªπ thu·∫≠t -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£ k·ªπ thu·∫≠t</label>
                        <textarea id="product_technical_description" rows="6" class="w-full px-4 py-2 border rounded-lg"
                            placeholder="M√¥ t·∫£ s·∫£n ph·∫©m v√† th√¥ng s·ªë k·ªπ thu·∫≠t:&#10;&#10;C√¥ng su·∫•t: 590W&#10;C√¥ng ngh·ªá: N-Type Tiger Neo&#10;Hi·ªáu su·∫•t: 22.3%&#10;K√≠ch th∆∞·ªõc: 2278√ó1134√ó30mm&#10;B·∫£o h√†nh: 15 nƒÉm..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">G·ªôp c·∫£ m√¥ t·∫£ ng·∫Øn v√† th√¥ng s·ªë k·ªπ thu·∫≠t v√†o ƒë√¢y</p>
                    </div>

                    <!-- Tr·∫°ng th√°i -->
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="product_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t (hi·ªÉn th·ªã tr√™n website)</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u s·∫£n ph·∫©m
                    </button>
                    <button type="button" onclick="closeProductModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-2xl font-bold mb-4" id="ticketModalTitle">Th√™m v√©</h3>
            <form id="ticketForm" onsubmit="saveTicket(event)">
                <input type="hidden" id="ticket_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ng∆∞·ªùi d√πng *</label>
                        <select id="ticket_user_id" required class="w-full px-4 py-2 border rounded-lg"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i v√©</label>
                        <select id="ticket_type" class="w-full px-4 py-2 border rounded-lg">
                            <option value="purchase">Mua h√†ng</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ph·∫ßn th∆∞·ªüng set s·∫µn</label>
                        <select id="ticket_pre_assigned_reward_id" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">Kh√¥ng set s·∫µn</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Tr·∫°ng th√°i</label>
                        <select id="ticket_status" class="w-full px-4 py-2 border rounded-lg">
                            <option value="active">Ho·∫°t ƒë·ªông</option>
                            <option value="used">ƒê√£ d√πng</option>
                            <option value="expired">H·∫øt h·∫°n</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closeTicketModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reward Modal -->
    <div id="rewardModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="rewardModalTitle">Th√™m ph·∫ßn th∆∞·ªüng</h3>
            <form id="rewardForm" onsubmit="saveReward(event)">
                <input type="hidden" id="reward_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n ph·∫ßn th∆∞·ªüng *</label>
                        <input type="text" id="reward_name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i ph·∫ßn th∆∞·ªüng *</label>
                        <select id="reward_type" required class="w-full px-4 py-2 border rounded-lg" onchange="updateRewardFields()">
                            <option value="voucher">Voucher gi·∫£m gi√°</option>
                            <option value="cash">Ti·ªÅn m·∫∑t</option>
                            <option value="gift">Qu√† t·∫∑ng</option>
                        </select>
                    </div>
                    <div id="reward_value_field">
                        <label class="block text-sm font-semibold mb-2">Gi√° tr·ªã (VNƒê)</label>
                        <input type="number" id="reward_value" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea id="reward_description" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                    <div id="reward_quantity_field" style="display: none;">
                        <label class="block text-sm font-semibold mb-2">S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="reward_quantity" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="reward_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closeRewardModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Intro Post Modal -->
    <div id="introPostModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="introPostModalTitle">Th√™m b√†i vi·∫øt</h3>
            <form id="introPostForm" onsubmit="saveIntroPost(event)">
                <input type="hidden" id="intro_post_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ b√†i vi·∫øt *</label>
                        <input type="text" id="intro_post_title" required class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: HC Eco System - Gi·∫£i Ph√°p NƒÉng L∆∞·ª£ng Xanh">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£/N·ªôi dung</label>
                        <textarea id="intro_post_description" rows="4" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="M√¥ t·∫£ n·ªôi dung b√†i vi·∫øt..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">URL ·∫¢nh</label>
                        <input type="text" id="intro_post_image_url" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="https://example.com/image.jpg">
                        <p class="text-xs text-gray-500 mt-1">ƒê∆∞·ªùng d·∫´n ƒë·∫øn ·∫£nh (ƒë·ªÉ tr·ªëng n·∫øu ch∆∞a c√≥)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">URL Video</label>
                        <input type="text" id="intro_post_video_url" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="https://example.com/video.mp4">
                        <p class="text-xs text-gray-500 mt-1">ƒê∆∞·ªùng d·∫´n ƒë·∫øn video (t√πy ch·ªçn, ƒë·ªÉ tr·ªëng n·∫øu ch∆∞a c√≥)</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã *</label>
                            <input type="number" id="intro_post_display_order" value="1" min="1" required 
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="flex items-center gap-2 pt-7">
                                <input type="checkbox" id="intro_post_is_active" checked>
                                <span class="font-semibold">K√≠ch ho·∫°t (hi·ªÉn th·ªã tr√™n trang gi·ªõi thi·ªáu)</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u b√†i vi·∫øt
                    </button>
                    <button type="button" onclick="closeIntroPostModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Category Modal -->
    <div id="packageCategoryModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-2xl font-bold mb-4" id="packageCategoryModalTitle">Th√™m danh m·ª•c g√≥i</h3>
            <form id="packageCategoryForm" onsubmit="savePackageCategory(event)">
                <input type="hidden" id="package_category_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n danh m·ª•c *</label>
                        <input type="text" id="package_category_name" required class="w-full px-4 py-2 border rounded-lg" placeholder="VD: G√≥i ƒêi·ªán M·∫∑t Tr·ªùi Gia ƒê√¨nh">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Logo danh m·ª•c</label>
                        <input type="file" id="package_category_logo" accept="image/jpeg,image/png,image/gif,image/jpg" class="w-full px-4 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh JPG, PNG, GIF (t·ªëi ƒëa 2MB)</p>
                        <div id="package_category_logo_preview" class="mt-2 hidden">
                            <img src="" alt="Logo preview" class="h-20 w-20 object-contain border rounded">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Badge Text</label>
                            <input type="text" id="package_category_badge_text" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: PH·ªî BI·∫æN">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Badge Color</label>
                            <select id="package_category_badge_color" class="w-full px-4 py-2 border rounded-lg">
                                <option value="blue">Xanh d∆∞∆°ng</option>
                                <option value="green">Xanh l√°</option>
                                <option value="red">ƒê·ªè</option>
                                <option value="yellow">V√†ng</option>
                                <option value="purple">T√≠m</option>
                                <option value="orange">Cam</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input type="number" id="package_category_display_order" value="0" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="package_category_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closePackageCategoryModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="packageModalTitle">Th√™m g√≥i s·∫£n ph·∫©m</h3>
            <form id="packageForm" onsubmit="savePackage(event)">
                <input type="hidden" id="package_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Danh m·ª•c g√≥i *</label>
                        <select id="package_category_id_select" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="">-- Ch·ªçn danh m·ª•c g√≥i --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n g√≥i *</label>
                        <input type="text" id="package_name" required class="w-full px-4 py-2 border rounded-lg" placeholder="VD: G√≥i Solar 3kW">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£</label>
                        <textarea id="package_description" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ g√≥i s·∫£n ph·∫©m"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Gi√° g√≥i (VNƒê) *</label>
                        <input type="number" id="package_price" required min="0" step="1000" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Badge Text</label>
                            <input type="text" id="package_badge_text" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: TI·∫æT KI·ªÜM">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Badge Color</label>
                            <select id="package_badge_color" class="w-full px-4 py-2 border rounded-lg">
                                <option value="blue">Xanh d∆∞∆°ng</option>
                                <option value="green">Xanh l√°</option>
                                <option value="red">ƒê·ªè</option>
                                <option value="yellow">V√†ng</option>
                                <option value="purple">T√≠m</option>
                                <option value="orange">Cam</option>
                            </select>
                        </div>
                    </div>
                    <!-- Highlighted Features -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold">ƒêi·ªÉm n·ªïi b·∫≠t</label>
                            <button type="button" onclick="addPackageHighlight()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                + Th√™m ƒëi·ªÉm n·ªïi b·∫≠t
                            </button>
                        </div>
                        <div id="package-highlights-container" class="space-y-2">
                            <!-- Highlight items will be added here -->
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input type="number" id="package_display_order" value="0" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="package_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                    
                    <!-- Package Items -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold">C√°c item trong g√≥i</label>
                            <button type="button" onclick="addPackageItem()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                + Th√™m item
                            </button>
                        </div>
                        <div id="package-items-container" class="space-y-2">
                            <!-- Package items will be added here -->
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closePackageModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Survey Config Modal -->
    <div id="surveyConfigModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="surveyConfigModalTitle">C·∫•u h√¨nh kh·∫£o s√°t</h3>
            <form id="surveyConfigForm" onsubmit="saveSurveyConfig(event)">
                <input type="hidden" id="survey_product_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i s·∫£n ph·∫©m trong kh·∫£o s√°t *</label>
                        <select id="survey_category" required class="w-full px-4 py-2 border rounded-lg" onchange="updateSurveyPhaseField()">
                            <option value="">-- Ch·ªçn lo·∫°i --</option>
                            <option value="solar_panel">‚òÄÔ∏è T·∫•m Pin</option>
                            <option value="inverter">üîå Inverter</option>
                            <option value="battery">üîã Pin L∆∞u Tr·ªØ</option>
                            <option value="electrical_cabinet">‚ö° T·ªß ƒêi·ªán</option>
                            <option value="accessory">üîß Ph·ª• Ki·ªán</option>
                        </select>
                    </div>

                    <div id="survey_phase_field" class="hidden">
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i pha *</label>
                        <select id="survey_phase_type" class="w-full px-4 py-2 border rounded-lg">
                            <option value="1_phase">1 Pha</option>
                            <option value="3_phase">3 Pha</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i gi√° s·ª≠ d·ª•ng *</label>
                        <select id="survey_price_type" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="market_price">Gi√° th·ªã tr∆∞·ªùng</option>
                            <option value="category_price">Gi√° danh m·ª•c</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input type="number" id="survey_display_order" value="0" min="0" class="w-full px-4 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">S·ªë c√†ng nh·ªè c√†ng hi·ªÉn th·ªã tr∆∞·ªõc</p>
                    </div>

                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="survey_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t (hi·ªÉn th·ªã trong kh·∫£o s√°t)</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Ghi ch√∫</label>
                        <textarea id="survey_notes" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="Ghi ch√∫ th√™m v·ªÅ c·∫•u h√¨nh n√†y..."></textarea>
                    </div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u c·∫•u h√¨nh
                    </button>
                    <button type="button" onclick="closeSurveyConfigModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/cache-buster.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script src="../assets/js/admin-products.js"></script>
    <script src="../assets/js/admin-packages.js"></script>
    <script>
        // Check admin access
        async function checkAdmin() {
            try {
                const response = await fetch(`${API_BASE}/admin/check_admin.php?t=${Date.now()}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (!data.success) {
                    window.location.href = 'login.html';
                    return false;
                }
                document.getElementById('admin-name').textContent = data.user.full_name;
                return true;
            } catch (error) {
                console.error('Error checking admin:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Logout
        async function logout() {
            try {
                // Call logout API
                const response = await fetch(`${API_BASE}/logout.php`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                // Clear user from localStorage (important for auth state)
                if (window.authUtils && typeof window.authUtils.clearUser === 'function') {
                    window.authUtils.clearUser();
                } else {
                    // Fallback: manually clear localStorage if authUtils not available
                    localStorage.removeItem('authUser');
                }
                
                // Clear cart data
                localStorage.removeItem('cartItems');
                
                // Show success message if available
                if (data.success) {
                    showToast(data.message || 'ƒêƒÉng xu·∫•t th√†nh c√¥ng', 'success');
                }
                
                // Wait a bit for the toast to show
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 500);
            } catch (error) {
                console.error('Error logging out:', error);
                
                // Even if there's an error, clear user data and redirect
                if (window.authUtils && typeof window.authUtils.clearUser === 'function') {
                    window.authUtils.clearUser();
                } else {
                    localStorage.removeItem('authUser');
                }
                localStorage.removeItem('cartItems');
                
                window.location.href = 'login.html';
            }
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Find and activate the corresponding button
            const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
                         // Load data for the tab
             switch(tabName) {
                 case 'categories': loadCategories(); break;
                 case 'products': loadProducts(); break;
                 case 'survey': loadSurveyProducts(); break;
                 case 'packages': 
                     loadPackageCategories(); 
                     loadPackages(); 
                     break;
                 case 'orders': loadOrders(); break;
                 case 'tickets': loadTickets(); break;
                 case 'rewards': loadRewards(); break;
                 case 'intro-posts': loadIntroPosts(); break;
             }
         }

        // Load Categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_categories.php?t=${Date.now()}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    categoriesData = data.categories;
                    renderCategories(data.categories);
                    updateCategoryDropdowns();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderCategories(categories) {
            const tbody = document.getElementById('categories-tbody');
            if (categories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            Ch∆∞a c√≥ danh m·ª•c n√†o. Click "Th√™m danh m·ª•c" ƒë·ªÉ t·∫°o m·ªõi.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = categories.map(cat => {
                // Fix logo URL path
                let logoUrl = cat.logo_url;
                if (logoUrl && !logoUrl.startsWith('http') && !logoUrl.startsWith('/')) {
                    logoUrl = '/' + logoUrl;
                }
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${cat.id}</td>
                    <td class="px-4 py-3">
                        ${logoUrl ? `<img src="${logoUrl}" class="h-16 w-16 object-contain rounded border" onerror="this.src='../assets/img/logo.jpg'">` : '<span class="text-gray-400">Ch∆∞a c√≥</span>'}
                    </td>
                    <td class="px-4 py-3 font-semibold">${cat.name}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded font-semibold">${cat.display_order}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${cat.is_active == 1 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${cat.is_active == 1 ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editCategory(${cat.id})" class="text-blue-600 hover:underline mr-3">‚úèÔ∏è S·ª≠a</button>
                        <button onclick="deleteCategory(${cat.id})" class="text-red-600 hover:underline">üóëÔ∏è X√≥a</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function updateCategoryDropdowns() {
            const selects = [document.getElementById('product_category_id'), document.getElementById('product-category-filter')];
            selects.forEach((select, i) => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = (i === 1 ? '<option value="">T·∫•t c·∫£ danh m·ª•c</option>' : '') + 
                    categoriesData.filter(c => c.is_active).map(cat => 
                        `<option value="${cat.id}">${cat.name}</option>`
                    ).join('');
                if (currentValue) select.value = currentValue;
            });
        }

        // Category Modal Functions
        function openCategoryModal(id = null) {
            const modal = document.getElementById('categoryModal');
            const form = document.getElementById('categoryForm');
            form.reset();
            
            // Reset preview
            document.getElementById('category_logo_preview').classList.add('hidden');
            document.getElementById('category_logo_preview_img').src = '';
            
            if (id) {
                const cat = categoriesData.find(c => c.id == id);
                if (cat) {
                    document.getElementById('category_id').value = cat.id;
                    document.getElementById('category_name').value = cat.name;
                    document.getElementById('category_logo_url').value = cat.logo_url || '';
                    document.getElementById('category_display_order').value = cat.display_order;
                    document.getElementById('category_is_active').checked = cat.is_active == 1;
                    document.getElementById('categoryModalTitle').textContent = 'S·ª≠a danh m·ª•c';
                    
                    // Show existing logo
                    if (cat.logo_url) {
                        // Fix logo URL path
                        let logoUrl = cat.logo_url;
                        if (!logoUrl.startsWith('http') && !logoUrl.startsWith('/')) {
                            logoUrl = '/' + logoUrl;
                        }
                        document.getElementById('category_logo_preview_img').src = logoUrl;
                        document.getElementById('category_logo_preview').classList.remove('hidden');
                        // Remove required from file input when editing
                        document.getElementById('category_logo').removeAttribute('required');
                    }
                }
            } else {
                document.getElementById('categoryModalTitle').textContent = 'Th√™m danh m·ª•c';
                document.getElementById('category_logo').setAttribute('required', 'required');
            }
            
            modal.classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
        }

        function previewCategoryLogo(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 3MB)
                if (file.size > 3 * 1024 * 1024) {
                    showToast('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 3MB! File hi·ªán t·∫°i: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB', 'error');
                    event.target.value = '';
                    return;
                }
                
                // Check file type
                if (!file.type.match('image.*')) {
                    showToast('Vui l√≤ng ch·ªçn file ·∫£nh!', 'error');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('category_logo_preview_img').src = e.target.result;
                    document.getElementById('category_logo_preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveCategory(event) {
            event.preventDefault();
            
            const categoryId = document.getElementById('category_id').value || 0;
            const displayOrder = parseInt(document.getElementById('category_display_order').value);
            
            // Check duplicate display_order
            const isDuplicate = categoriesData.some(cat => 
                cat.display_order == displayOrder && cat.id != categoryId
            );
            
            if (isDuplicate) {
                showToast(`Th·ª© t·ª± ∆∞u ti√™n ${displayOrder} ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng! Vui l√≤ng ch·ªçn s·ªë kh√°c.`, 'warning');
                return;
            }
            
            // Get submit button and show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn?.textContent;
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="animate-spin mr-2">‚è≥</span> ƒêang l∆∞u...';
            }
            
            // Prepare form data for file upload
            const formData = new FormData();
            formData.append('id', categoryId);
            formData.append('name', document.getElementById('category_name').value);
            formData.append('display_order', displayOrder);
            formData.append('is_active', document.getElementById('category_is_active').checked ? 1 : 0);
            
            // Add logo file if selected
            const logoFile = document.getElementById('category_logo').files[0];
            if (logoFile) {
                formData.append('logo', logoFile);
            } else if (categoryId > 0) {
                // Keep existing logo URL when editing
                formData.append('logo_url', document.getElementById('category_logo_url').value);
            }

            try {
                const response = await fetch(`${API_BASE}/admin/save_category.php`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData // Don't set Content-Type header, browser will set it with boundary
                });
                
                // Check if response is 413 (Request Entity Too Large)
                if (response.status === 413) {
                    const fileSizeMB = logoFile ? (logoFile.size / 1024 / 1024).toFixed(2) : 'unknown';
                    showToast('File qu√° l·ªõn (' + fileSizeMB + 'MB)! Server ch·ªâ cho ph√©p upload file nh·ªè h∆°n. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n ho·∫∑c n√©n ·∫£nh.', 'error');
                    return;
                }
                
                // Check if response is not OK
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeCategoryModal();
                    loadCategories();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving category:', error);
                if (error.message.includes('Unexpected token')) {
                    showToast('K√≠ch th∆∞·ªõc ·∫£nh qu√° l·ªõn ho·∫∑c server kh√¥ng th·ªÉ x·ª≠ l√Ω. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 2MB.', 'error');
                } else {
                    showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u danh m·ª•c: ' + error.message, 'error');
                }
            } finally {
                // Restore button state
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        }

        function editCategory(id) {
            openCategoryModal(id);
        }

        async function deleteCategory(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_category.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadCategories();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a danh m·ª•c: ' + error.message, 'error');
            }
        }

        // Preview logo image when selected
        document.addEventListener('change', function(e) {
            if (e.target.id === 'package_category_logo') {
                const file = e.target.files[0];
                if (file) {
                    // Check file size (max 3MB)
                    if (file.size > 3 * 1024 * 1024) {
                        showToast('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 3MB! File hi·ªán t·∫°i: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB', 'error');
                        e.target.value = '';
                        return;
                    }
                    
                    // Check file type
                    if (!file.type.match('image.*')) {
                        showToast('Vui l√≤ng ch·ªçn file ·∫£nh!', 'error');
                        e.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('package_category_logo_preview');
                        const img = preview.querySelector('img');
                        img.src = e.target.result;
                        preview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const isAdmin = await checkAdmin();
            if (isAdmin) {
                                 await loadCategories();
                 await loadUsers();
                 await loadRewardTemplates();
                 showTab('categories');
            }
        });
        // ============================================
        // SURVEY PRODUCTS MANAGEMENT
        // ============================================
        
        async function loadSurveyProducts() {
            try {
                const filter = document.getElementById('survey-filter')?.value || 'all';
                const response = await fetch(`${API_BASE}/admin/get_survey_products.php?filter=${filter}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    displaySurveyProducts(data.products);
                }
            } catch (error) {
                console.error('Error loading survey products:', error);
                showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m', 'error');
            }
        }
        
                 function displaySurveyProducts(products) {
             // Store products for modal
             currentSurveyProducts = products;
             
             const container = document.getElementById('survey-products-list');
             
             if (products.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</p>';
                 return;
             }
            
            let html = '<div class="grid gap-4">';
            
            products.forEach(product => {
                const hasConfig = product.has_survey_config;
                const config = product.survey_config;
                
                // Fix image URL path
                let imageUrl = product.image_url;
                if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
                
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow ${hasConfig ? 'bg-green-50' : 'bg-gray-50'}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                                    ${imageUrl ? `<img src="${imageUrl}" alt="${product.title}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-gray-400">üì¶</div>'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-lg truncate">${product.title}</h3>
                                    <p class="text-sm text-gray-600">${product.category_name}</p>
                                    <p class="text-sm text-gray-500">Gi√°: ${(product.market_price / 1000000).toFixed(2)}M - ${(product.category_price / 1000000).toFixed(2)}M</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                ${hasConfig ? `
                                    <div class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                        ${config.survey_category === 'solar_panel' ? '‚òÄÔ∏è T·∫•m Pin' : 
                                          config.survey_category === 'inverter' ? 'üîå Inverter' : 
                                          config.survey_category === 'battery' ? 'üîã Pin' : 
                                          config.survey_category === 'electrical_cabinet' ? '‚ö° T·ªß ƒêi·ªán' : 'üîß Ph·ª• Ki·ªán'}
                                        ${config.phase_type !== 'none' ? ` (${config.phase_type})` : ''}
                                        ${!config.is_active ? ' - T·∫Øt' : ''}
                                    </div>
                                    <button onclick="openSurveyConfigModal(${product.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                        S·ª≠a
                                    </button>
                                    <button onclick="deleteSurveyConfig(${product.id})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                                        X√≥a
                                    </button>
                                ` : `
                                    <button onclick="openSurveyConfigModal(${product.id})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                        + C·∫•u h√¨nh
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
                 let currentSurveyProducts = [];
         
         async function openSurveyConfigModal(productId) {
             const modal = document.getElementById('surveyConfigModal');
             const form = document.getElementById('surveyConfigForm');
             
             // Load product info
             const product = currentSurveyProducts.find(p => p.id === productId);
             if (!product) {
                 showToast('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                 return;
             }
             
             // Reset form
             form.reset();
             document.getElementById('survey_product_id').value = productId;
             document.getElementById('surveyConfigModalTitle').textContent = `C·∫•u h√¨nh: ${product.title}`;
             
             // Fill existing config if any
             if (product.has_survey_config && product.survey_config) {
                 const config = product.survey_config;
                 document.getElementById('survey_category').value = config.survey_category;
                 document.getElementById('survey_phase_type').value = config.phase_type;
                 document.getElementById('survey_price_type').value = config.price_type;
                 document.getElementById('survey_display_order').value = config.display_order;
                 document.getElementById('survey_is_active').checked = config.is_active;
                 document.getElementById('survey_notes').value = config.notes || '';
                 
                 updateSurveyPhaseField();
             }
             
             modal.classList.add('show');
         }
         
         function closeSurveyConfigModal() {
             document.getElementById('surveyConfigModal').classList.remove('show');
         }
         
         function updateSurveyPhaseField() {
             const category = document.getElementById('survey_category').value;
             const phaseField = document.getElementById('survey_phase_field');
             const phaseInput = document.getElementById('survey_phase_type');
             
             if (category === 'inverter' || category === 'electrical_cabinet') {
                 phaseField.classList.remove('hidden');
                 phaseInput.setAttribute('required', 'required');
             } else {
                 phaseField.classList.add('hidden');
                 phaseInput.removeAttribute('required');
                 phaseInput.value = 'none';
             }
         }
         
         async function saveSurveyConfig(event) {
             event.preventDefault();
             
             const productId = parseInt(document.getElementById('survey_product_id').value);
             const surveyCategory = document.getElementById('survey_category').value;
             const phaseType = document.getElementById('survey_phase_field').classList.contains('hidden') 
                 ? 'none' 
                 : document.getElementById('survey_phase_type').value;
             const priceType = document.getElementById('survey_price_type').value;
             const displayOrder = parseInt(document.getElementById('survey_display_order').value) || 0;
             const isActive = document.getElementById('survey_is_active').checked;
             const notes = document.getElementById('survey_notes').value;
             
             try {
                 const response = await fetch(`${API_BASE}/admin/save_survey_product_config.php`, {
                     method: 'POST',
                     credentials: 'include',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         product_id: productId,
                         survey_category: surveyCategory,
                         phase_type: phaseType,
                         price_type: priceType,
                         display_order: displayOrder,
                         is_active: isActive,
                         notes: notes
                     })
                 });
                 
                 if (!response.ok) {
                     const errorText = await response.text();
                     console.error('Server error:', response.status, errorText);
                     showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                     return;
                 }
                 
                 const data = await response.json();
                 if (data.success) {
                     showToast(data.message, 'success');
                     closeSurveyConfigModal();
                     loadSurveyProducts();
                 } else {
                     showToast(data.message, 'error');
                 }
             } catch (error) {
                 console.error('Error saving survey config:', error);
                 showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u c·∫•u h√¨nh: ' + error.message, 'error');
             }
         }
        
        async function deleteSurveyConfig(productId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c·∫•u h√¨nh kh·∫£o s√°t n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_survey_product_config.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadSurveyProducts();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting survey config:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a: ' + error.message, 'error');
            }
        }

        // Toast Notification System
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast-enter flex items-center gap-3 p-4 mb-3 rounded-lg shadow-lg max-w-md ${
                type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-yellow-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            
            const icon = type === 'success' ? '‚úì' :
                        type === 'error' ? '‚úï' :
                        type === 'warning' ? '‚ö†' : '‚Ñπ';
            
            toast.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-white bg-opacity-20 text-xl font-bold">
                    ${icon}
                </div>
                <div class="flex-1 font-medium">${message}</div>
                <button onclick="this.parentElement.remove()" class="flex-shrink-0 hover:bg-white hover:bg-opacity-20 rounded p-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ============================================
        // INTRO POSTS MANAGEMENT
        // ============================================
        
        let currentIntroPosts = [];

        async function loadIntroPosts() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_intro_posts.php`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    currentIntroPosts = data.posts;
                    displayIntroPosts(data.posts);
                }
            } catch (error) {
                console.error('Error loading intro posts:', error);
                showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i vi·∫øt', 'error');
            }
        }

        function displayIntroPosts(posts) {
            const tbody = document.getElementById('intro-posts-tbody');
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Kh√¥ng c√≥ b√†i vi·∫øt n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = posts.map(post => `
                <tr class="border-t">
                    <td class="px-4 py-3">${post.display_order}</td>
                    <td class="px-4 py-3 font-semibold">${post.title}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${post.description ? post.description.substring(0, 100) + '...' : ''}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${post.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${post.is_active ? 'Hi·ªÉn th·ªã' : '·∫®n'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="openIntroPostModal(${post.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">‚úèÔ∏è</button>
                        <button onclick="deleteIntroPost(${post.id})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 ml-2">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        async function openIntroPostModal(id = 0) {
            const modal = document.getElementById('introPostModal');
            document.getElementById('introPostModalTitle').textContent = id ? 'S·ª≠a b√†i vi·∫øt' : 'Th√™m b√†i vi·∫øt';
            
            if (id > 0) {
                const post = currentIntroPosts.find(p => p.id === id);
                document.getElementById('intro_post_id').value = post.id;
                document.getElementById('intro_post_title').value = post.title;
                document.getElementById('intro_post_description').value = post.description || '';
                document.getElementById('intro_post_image_url').value = post.image_url || '';
                document.getElementById('intro_post_video_url').value = post.video_url || '';
                document.getElementById('intro_post_display_order').value = post.display_order;
                document.getElementById('intro_post_is_active').checked = post.is_active;
            } else {
                document.getElementById('introPostForm').reset();
                document.getElementById('intro_post_id').value = '';
            }
            
            modal.classList.add('show');
        }

        function closeIntroPostModal() {
            document.getElementById('introPostModal').classList.remove('show');
        }

        async function saveIntroPost(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            formData.append('id', document.getElementById('intro_post_id').value);
            formData.append('title', document.getElementById('intro_post_title').value);
            formData.append('description', document.getElementById('intro_post_description').value);
            formData.append('image_url', document.getElementById('intro_post_image_url').value);
            formData.append('video_url', document.getElementById('intro_post_video_url').value);
            formData.append('display_order', document.getElementById('intro_post_display_order').value);
            formData.append('is_active', document.getElementById('intro_post_is_active').checked ? '1' : '0');

            try {
                const response = await fetch(`${API_BASE}/admin/save_intro_post.php`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }

                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeIntroPostModal();
                    loadIntroPosts();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving intro post:', error);
                showToast('C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
            }
        }

        async function deleteIntroPost(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_intro_post.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadIntroPosts();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting intro post:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a: ' + error.message, 'error');
            }
        }
    </script>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 right-4 z-[9999] space-y-3"></div>
</body>
</html>

