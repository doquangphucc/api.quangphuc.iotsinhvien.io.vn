<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - HC Eco System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="../assets/img/logo.jpg" />
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        .toast-enter {
            animation: slideInRight 0.3s ease-out;
        }
        .toast-exit {
            animation: slideOutRight 0.3s ease-in;
        }
        .tab-button.active {
            background-color: #16a34a;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab-content.hidden {
            display: none;
        }
        .tab-content:not(.hidden) {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../index.html" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <img src="../assets/img/logo.jpg" alt="Logo" class="h-12 w-12 rounded-lg">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">HC ECO SYSTEM</h1>
                    <p class="text-sm text-gray-600">Admin Panel</p>
                </div>
            </a>
            <div class="flex items-center gap-4">
                <a id="admin-name" href="user_profile.html" class="text-gray-700 font-semibold hover:text-green-600 transition-colors cursor-pointer"></a>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap gap-2 py-2">
                <button class="tab-button active px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="categories" onclick="showTab('categories')">
                    üìÅ Danh m·ª•c SP
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="products" onclick="showTab('products')">
                    üì¶ S·∫£n ph·∫©m
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="survey" onclick="showTab('survey')">
                    üìã Kh·∫£o s√°t
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="packages" onclick="showTab('packages')">
                    üéÅ G√≥i s·∫£n ph·∫©m
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="orders" onclick="showTab('orders')">
                    üõí ƒê∆°n h√†ng
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="tickets" onclick="showTab('tickets')">
                    üé´ V√© quay
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="rewards" onclick="showTab('rewards')">
                    üéÅ Ph·∫ßn th∆∞·ªüng
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="intro-posts" onclick="showTab('intro-posts')">
                    üìù B√†i gi·ªõi thi·ªáu
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="projects" onclick="showTab('projects')">
                    üèóÔ∏è D·ª± √°n
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="dich-vu" onclick="showTab('dich-vu')">
                    üîß D·ªãch v·ª•
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="home" onclick="showTab('home')">
                    üè† Trang ch·ªß
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="contacts" onclick="showTab('contacts')">
                    üìû Li√™n h·ªá
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold whitespace-nowrap" data-module="users" onclick="showTab('users')">
                    üë• Qu·∫£n l√Ω User
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Categories Tab -->
        <div id="tab-categories" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Danh m·ª•c s·∫£n ph·∫©m</h2>
                    <button onclick="openCategoryModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m danh m·ª•c
                    </button>
                </div>
                <div id="categories-list" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">Logo</th>
                                <th class="px-4 py-3 text-left">T√™n danh m·ª•c</th>
                                <th class="px-4 py-3 text-center">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="categories-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="tab-products" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">S·∫£n ph·∫©m</h2>
                    <button onclick="openProductModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m s·∫£n ph·∫©m
                    </button>
                </div>
                <div class="mb-4">
                    <select id="product-category-filter" class="px-4 py-2 border rounded-lg" onchange="loadProducts()">
                        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                </div>
                <div id="products-list" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">H√¨nh</th>
                                <th class="px-4 py-3 text-left">Ti√™u ƒë·ªÅ</th>
                                <th class="px-4 py-3 text-left">Danh m·ª•c</th>
                                <th class="px-4 py-3 text-right">Gi√° th·ªã tr∆∞·ªùng</th>
                                <th class="px-4 py-3 text-right" id="category-price-header">Gi√° danh m·ª•c</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Survey Products Tab -->
        <div id="tab-survey" class="tab-content hidden">
            <!-- Survey History Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">üìä L·ªãch S·ª≠ Kh·∫£o S√°t</h2>
                        <p class="text-sm text-gray-600 mt-1">Xem danh s√°ch c√°c kh·∫£o s√°t ƒëi·ªán m·∫∑t tr·ªùi t·ª´ kh√°ch h√†ng</p>
                    </div>
                    <button onclick="loadSurveyHistory()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        üîÑ T·∫£i l·∫°i
                    </button>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                        <div class="text-sm opacity-90">T·ªïng kh·∫£o s√°t</div>
                        <div id="total-surveys" class="text-3xl font-bold mt-1">0</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                        <div class="text-sm opacity-90">C√≥ k·∫øt qu·∫£</div>
                        <div id="surveys-with-results" class="text-3xl font-bold mt-1">0</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                        <div class="text-sm opacity-90">H√¥m nay</div>
                        <div id="surveys-today" class="text-3xl font-bold mt-1">0</div>
                    </div>
                </div>
                
                <!-- Surveys Table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left border">ID</th>
                                <th class="px-4 py-3 text-left border">Kh√°ch h√†ng</th>
                                <th class="px-4 py-3 text-left border">Li√™n h·ªá</th>
                                <th class="px-4 py-3 text-center border">Khu v·ª±c</th>
                                <th class="px-4 py-3 text-center border">Pha</th>
                                <th class="px-4 py-3 text-right border">Ti·ªÅn ƒëi·ªán/th√°ng</th>
                                <th class="px-4 py-3 text-right border">T·ªïng chi ph√≠</th>
                                <th class="px-4 py-3 text-center border">Ng√†y kh·∫£o s√°t</th>
                                <th class="px-4 py-3 text-center border">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="survey-history-tbody">
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <svg class="w-16 h-16 text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Survey Regions Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">üó∫Ô∏è Qu·∫£n L√Ω Khu V·ª±c</h2>
                        <p class="text-sm text-gray-600 mt-1">Qu·∫£n l√Ω c√°c khu v·ª±c kh·∫£o s√°t (Mi·ªÅn B·∫Øc, Mi·ªÅn Trung, Mi·ªÅn Nam)</p>
                    </div>
                    <button onclick="saveSurveyRegions()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u khu v·ª±c
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left border">M√£ khu v·ª±c</th>
                                <th class="px-4 py-3 text-left border">T√™n khu v·ª±c</th>
                                <th class="px-4 py-3 text-left border">N·ªôi dung hi·ªÉn th·ªã</th>
                                <th class="px-4 py-3 text-center border">S·ªë gi·ªù n·∫Øng/ng√†y</th>
                                <th class="px-4 py-3 text-center border">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-center border">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="survey-regions-tbody">
                            <!-- Regions will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <p class="text-sm text-blue-800">
                        <strong>üí° L∆∞u √Ω:</strong> 
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li><strong>M√£ khu v·ª±c:</strong> Kh√¥ng thay ƒë·ªïi (mien-bac, mien-trung, mien-nam)</li>
                            <li><strong>N·ªôi dung hi·ªÉn th·ªã:</strong> VƒÉn b·∫£n m√† ng∆∞·ªùi d√πng th·∫•y trong dropdown (VD: "Mi·ªÅn B·∫Øc (4,4 gi·ªù n·∫Øng/ng√†y)")</li>
                            <li><strong>S·ªë gi·ªù n·∫Øng:</strong> S·ªë li·ªáu ƒë·ªÉ t√≠nh to√°n c√¥ng su·∫•t h·ªá th·ªëng</li>
                            <li>Thay ƒë·ªïi s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn trang kh·∫£o s√°t ƒëi·ªán m·∫∑t tr·ªùi</li>
                        </ul>
                    </p>
                </div>
            </div>

            <!-- Electricity Prices Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">‚ö° B·∫£ng Gi√° ƒêi·ªán EVN</h2>
                        <p class="text-sm text-gray-600 mt-1">Qu·∫£n l√Ω b·∫£ng gi√° ƒëi·ªán sinh ho·∫°t theo b·∫≠c thang</p>
                    </div>
                    <button onclick="saveElectricityPrices()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u b·∫£ng gi√°
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left border">B·∫≠c</th>
                                <th class="px-4 py-3 text-left border">T√™n b·∫≠c</th>
                                <th class="px-4 py-3 text-center border">T·ª´ kWh</th>
                                <th class="px-4 py-3 text-center border">ƒê·∫øn kWh</th>
                                <th class="px-4 py-3 text-right border">Gi√° ch∆∞a VAT (ƒë/kWh)</th>
                                <th class="px-4 py-3 text-right border">Gi√° c√≥ VAT 8% (ƒë/kWh)</th>
                                <th class="px-4 py-3 text-center border">Ng√†y √°p d·ª•ng</th>
                                <th class="px-4 py-3 text-center border">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="electricity-prices-tbody">
                            <!-- Prices will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <p class="text-sm text-blue-800">
                        <strong>üí° L∆∞u √Ω:</strong> 
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li>Gi√° c√≥ VAT = Gi√° ch∆∞a VAT √ó 1.08</li>
                            <li>B·∫≠c 6 ƒë·ªÉ "ƒê·∫øn kWh" = 0 ho·∫∑c ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng gi·ªõi h·∫°n</li>
                            <li>Thay ƒë·ªïi s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn trang kh·∫£o s√°t ƒëi·ªán m·∫∑t tr·ªùi</li>
                        </ul>
                    </p>
                </div>
            </div>

            <!-- Survey Products Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">üìã Qu·∫£n l√Ω s·∫£n ph·∫©m kh·∫£o s√°t</h2>
                    <div class="flex gap-2">
                        <select id="survey-filter" class="px-4 py-2 border rounded-lg" onchange="loadSurveyProducts()">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="configured">ƒê√£ c·∫•u h√¨nh</option>
                            <option value="unconfigured">Ch∆∞a c·∫•u h√¨nh</option>
                        </select>
                    </div>
                </div>
                <div id="survey-products-list" class="overflow-x-auto">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Packages Tab -->
        <div id="tab-packages" class="tab-content hidden">
            <!-- Package Categories Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Danh m·ª•c g√≥i</h2>
                    <button onclick="openPackageCategoryModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m danh m·ª•c g√≥i
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">Logo</th>
                                <th class="px-4 py-3 text-left">T√™n danh m·ª•c</th>
                                <th class="px-4 py-3 text-left">Badge</th>
                                <th class="px-4 py-3 text-center">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="package-categories-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Packages Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">G√≥i s·∫£n ph·∫©m</h2>
                    <button onclick="openPackageModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m g√≥i
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">T√™n g√≥i</th>
                                <th class="px-4 py-3 text-left">Danh m·ª•c</th>
                                <th class="px-4 py-3 text-right">Gi√°</th>
                                <th class="px-4 py-3 text-center">S·ªë items</th>
                                <th class="px-4 py-3 text-center">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="packages-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="tab-orders" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ƒê∆°n h√†ng</h2>
                    <select id="order-status-filter" class="px-4 py-2 border rounded-lg" onchange="loadOrders()">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="approved">ƒê√£ duy·ªát</option>
                        <option value="processing">ƒêang x·ª≠ l√Ω</option>
                        <option value="shipping">ƒêang giao h√†ng</option>
                        <option value="shipped">ƒê√£ giao h√†ng</option>
                        <option value="delivered">ƒê√£ nh·∫≠n h√†ng</option>
                        <option value="cancelled">ƒê√£ h·ªßy</option>
                    </select>
                </div>
                <div id="orders-list"></div>
            </div>
        </div>

        <!-- Tickets Tab -->
        <div id="tab-tickets" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">V√© quay may m·∫Øn</h2>
                    <button onclick="openTicketModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m v√©
                    </button>
                </div>
                <div id="tickets-list" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">Ng∆∞·ªùi d√πng</th>
                                <th class="px-4 py-3 text-left">Lo·∫°i v√©</th>
                                <th class="px-4 py-3 text-left">Ph·∫ßn th∆∞·ªüng set s·∫µn</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-left">Ng√†y t·∫°o</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rewards Tab -->
        <div id="tab-rewards" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">M·∫´u ph·∫ßn th∆∞·ªüng</h2>
                    <button onclick="openRewardModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m ph·∫ßn th∆∞·ªüng
                    </button>
                </div>
                <div id="rewards-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- Intro Posts Tab -->
        <div id="tab-intro-posts" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">B√†i vi·∫øt trang gi·ªõi thi·ªáu</h2>
                    <button onclick="openIntroPostModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m b√†i vi·∫øt
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-left">Ti√™u ƒë·ªÅ</th>
                                <th class="px-4 py-3 text-left">M√¥ t·∫£</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="intro-posts-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="tab-projects" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Qu·∫£n l√Ω d·ª± √°n</h2>
                    <button onclick="openProjectModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m d·ª± √°n
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-left">Ti√™u ƒë·ªÅ</th>
                                <th class="px-4 py-3 text-left">M√¥ t·∫£</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="projects-tbody-admin"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dich Vu Tab -->
        <div id="tab-dich-vu" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Qu·∫£n l√Ω d·ªãch v·ª•</h2>
                    <button onclick="openDichVuModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m d·ªãch v·ª•
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-left">Logo</th>
                                <th class="px-4 py-3 text-left">T√™n</th>
                                <th class="px-4 py-3 text-left">M√¥ t·∫£</th>
                                <th class="px-4 py-3 text-left">M√†u</th>
                                <th class="px-4 py-3 text-left">Link</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="dich-vu-tbody-admin"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Home Tab -->
        <div id="tab-home" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Qu·∫£n l√Ω b√†i ƒëƒÉng trang ch·ªß</h2>
                    <button onclick="openHomePostModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m b√†i ƒëƒÉng
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Th·ª© t·ª±</th>
                                <th class="px-4 py-3 text-left">·∫¢nh</th>
                                <th class="px-4 py-3 text-left">Ti√™u ƒë·ªÅ</th>
                                <th class="px-4 py-3 text-left">Highlight</th>
                                <th class="px-4 py-3 text-center">V·ªã tr√≠ ·∫£nh</th>
                                <th class="px-4 py-3 text-center">Section</th>
                                <th class="px-4 py-3 text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="home-posts-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Contacts Tab -->
        <div id="tab-contacts" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Qu·∫£n l√Ω k√™nh li√™n h·ªá</h2>
                    <button onclick="openContactModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m k√™nh li√™n h·ªá
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 border text-left">ID</th>
                                <th class="px-4 py-2 border text-left">T√™n</th>
                                <th class="px-4 py-2 border text-left">M√¥ t·∫£</th>
                                <th class="px-4 py-2 border text-left">N·ªôi dung</th>
                                <th class="px-4 py-2 border text-left">Danh m·ª•c</th>
                                <th class="px-4 py-2 border text-left">M√†u</th>
                                <th class="px-4 py-2 border text-left">Th·ª© t·ª±</th>
                                <th class="px-4 py-2 border text-center">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-2 border text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body">
                            <tr>
                                <td colspan="9" class="text-center py-4">ƒêang t·∫£i...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
                    <button onclick="openUserModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        + Th√™m ng∆∞·ªùi d√πng
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">H·ªç t√™n</th>
                                <th class="px-4 py-3 text-left">Username</th>
                                <th class="px-4 py-3 text-left">S·ªë ƒëi·ªán tho·∫°i</th>
                                <th class="px-4 py-3 text-center">Vai tr√≤</th>
                                <th class="px-4 py-3 text-center">Ng√†y t·∫°o</th>
                                <th class="px-4 py-3 text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="categoryModalTitle">Th√™m danh m·ª•c</h3>
            <form id="categoryForm" onsubmit="saveCategory(event)">
                <input type="hidden" id="category_id">
                <input type="hidden" id="category_logo_url">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n danh m·ª•c *</label>
                        <input type="text" id="category_name" required class="w-full px-4 py-2 border rounded-lg"
                            placeholder="V√≠ d·ª•: NƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi, X√¢y d·ª±ng, Du l·ªãch, Coffee, Ti√™u d√πng...">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Logo (·∫¢nh) *</label>
                        <input type="file" id="category_logo" accept="image/*" 
                            class="w-full px-4 py-2 border rounded-lg" onchange="previewCategoryLogo(event)">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn ·∫£nh logo cho danh m·ª•c (PNG, JPG, JPEG, GIF, max 2MB)</p>
                        <div id="category_logo_preview" class="mt-3 hidden">
                            <img id="category_logo_preview_img" src="" alt="Logo preview" 
                                class="h-32 w-32 object-cover rounded-lg border-2 border-gray-300">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± ∆∞u ti√™n *</label>
                        <input type="number" id="category_display_order" value="1" min="1" required 
                            class="w-full px-4 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">S·ªë th·ª© t·ª± hi·ªÉn th·ªã tr√™n website (kh√¥ng ƒë∆∞·ª£c tr√πng v·ªõi danh m·ª•c kh√°c)</p>
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="category_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closeCategoryModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="productModalTitle">Th√™m s·∫£n ph·∫©m</h3>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="product_id">
                <div class="space-y-4">
                    <!-- Danh m·ª•c -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Danh m·ª•c *</label>
                        <select id="product_category_id" required class="w-full px-4 py-2 border rounded-lg" onchange="updateCategoryPriceLabel()">
                            <option value="">-- Ch·ªçn danh m·ª•c --</option>
                        </select>
                    </div>

                    <!-- Ti√™u ƒë·ªÅ/T√™n -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ/T√™n s·∫£n ph·∫©m *</label>
                        <input type="text" id="product_title" required class="w-full px-4 py-2 border rounded-lg"
                            placeholder="V√≠ d·ª•: T·∫•m Pin Jinko Solar 590W Tiger Neo">
                    </div>

                    <!-- Gi√° th·ªã tr∆∞·ªùng -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Gi√° th·ªã tr∆∞·ªùng (VNƒê) *</label>
                        <input type="number" id="product_market_price" required min="0" step="1000" 
                            class="w-full px-4 py-2 border rounded-lg" placeholder="2300000">
                    </div>

                    <!-- Gi√° danh m·ª•c (ƒë·ªông theo t√™n danh m·ª•c) -->
                    <div>
                        <label class="block text-sm font-semibold mb-2" id="product_category_price_label">Gi√° danh m·ª•c (VNƒê)</label>
                        <input type="number" id="product_category_price" min="0" step="1000" 
                            class="w-full px-4 py-2 border rounded-lg" placeholder="3500000">
                        <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥ gi√° ri√™ng cho danh m·ª•c n√†y</p>
                    </div>

                    <!-- H√¨nh ·∫£nh -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
                        <div class="space-y-2">
                            <!-- Upload ·∫£nh m·ªõi -->
                            <div class="flex gap-2">
                                <input type="file" id="product_image_file" accept="image/*" 
                                    class="flex-1 px-4 py-2 border rounded-lg" onchange="uploadProductImage(event)">
                                <button type="button" onclick="document.getElementById('product_image_file').click()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    üìÅ Upload
                                </button>
                            </div>
                            <!-- Ch·ªçn ·∫£nh c√≥ s·∫µn -->
                            <select id="product_image_url" class="w-full px-4 py-2 border rounded-lg" onchange="previewProductImage()">
                                <option value="">-- Ho·∫∑c ch·ªçn ·∫£nh c√≥ s·∫µn --</option>
                            </select>
                            <!-- Preview ·∫£nh -->
                            <div id="product_image_preview" class="hidden mt-2">
                                <img id="product_image_preview_img" src="" alt="Preview" 
                                    class="h-32 w-32 object-cover rounded-lg border-2 border-gray-300">
                            </div>
                        </div>
                    </div>

                    <!-- M√¥ t·∫£ k·ªπ thu·∫≠t -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£ k·ªπ thu·∫≠t</label>
                        <textarea id="product_technical_description" rows="6" class="w-full px-4 py-2 border rounded-lg"
                            placeholder="M√¥ t·∫£ s·∫£n ph·∫©m v√† th√¥ng s·ªë k·ªπ thu·∫≠t:&#10;&#10;C√¥ng su·∫•t: 590W&#10;C√¥ng ngh·ªá: N-Type Tiger Neo&#10;Hi·ªáu su·∫•t: 22.3%&#10;K√≠ch th∆∞·ªõc: 2278√ó1134√ó30mm&#10;B·∫£o h√†nh: 15 nƒÉm..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">G·ªôp c·∫£ m√¥ t·∫£ ng·∫Øn v√† th√¥ng s·ªë k·ªπ thu·∫≠t v√†o ƒë√¢y</p>
                    </div>

                    <!-- Tr·∫°ng th√°i -->
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="product_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t (hi·ªÉn th·ªã tr√™n website)</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u s·∫£n ph·∫©m
                    </button>
                    <button type="button" onclick="closeProductModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-2xl font-bold mb-4" id="ticketModalTitle">Th√™m v√©</h3>
            <form id="ticketForm" onsubmit="saveTicket(event)">
                <input type="hidden" id="ticket_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ng∆∞·ªùi d√πng *</label>
                        <select id="ticket_user_id" required class="w-full px-4 py-2 border rounded-lg"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i v√©</label>
                        <select id="ticket_type" class="w-full px-4 py-2 border rounded-lg">
                            <option value="purchase">Mua h√†ng</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ph·∫ßn th∆∞·ªüng set s·∫µn</label>
                        <select id="ticket_pre_assigned_reward_id" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">Kh√¥ng set s·∫µn</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Tr·∫°ng th√°i</label>
                        <select id="ticket_status" class="w-full px-4 py-2 border rounded-lg">
                            <option value="active">Ho·∫°t ƒë·ªông</option>
                            <option value="used">ƒê√£ d√πng</option>
                            <option value="expired">H·∫øt h·∫°n</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closeTicketModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reward Modal -->
    <div id="rewardModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="rewardModalTitle">Th√™m ph·∫ßn th∆∞·ªüng</h3>
            <form id="rewardForm" onsubmit="saveReward(event)">
                <input type="hidden" id="reward_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n ph·∫ßn th∆∞·ªüng *</label>
                        <input type="text" id="reward_name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i ph·∫ßn th∆∞·ªüng *</label>
                        <select id="reward_type" required class="w-full px-4 py-2 border rounded-lg" onchange="updateRewardFields()">
                            <option value="voucher">Voucher gi·∫£m gi√°</option>
                            <option value="cash">Ti·ªÅn m·∫∑t</option>
                            <option value="gift">Qu√† t·∫∑ng</option>
                        </select>
                    </div>
                    <div id="reward_value_field">
                        <label class="block text-sm font-semibold mb-2">Gi√° tr·ªã (VNƒê)</label>
                        <input type="number" id="reward_value" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea id="reward_description" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                    <div id="reward_quantity_field" style="display: none;">
                        <label class="block text-sm font-semibold mb-2">S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="reward_quantity" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="reward_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closeRewardModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Intro Post Modal -->
    <div id="introPostModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="introPostModalTitle">Th√™m b√†i vi·∫øt</h3>
            <form id="introPostForm" onsubmit="saveIntroPost(event)">
                <input type="hidden" id="intro_post_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ b√†i vi·∫øt *</label>
                        <input type="text" name="title" id="intro_post_title" required class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: HC Eco System - Gi·∫£i Ph√°p NƒÉng L∆∞·ª£ng Xanh">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£/N·ªôi dung</label>
                        <textarea name="description" id="intro_post_description" rows="4" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="M√¥ t·∫£ n·ªôi dung b√†i vi·∫øt..."></textarea>
                    </div>
                    <!-- Image Section -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">·∫¢nh ƒë·∫°i di·ªán</label>
                        <div class="space-y-2">
                            <input type="file" name="image" id="intro_post_image" accept="image/*" 
                                class="w-full px-4 py-2 border rounded-lg" onchange="previewIntroPostImageFromFile(this)">
                            <p class="text-xs text-gray-500">Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh (JPG, PNG, GIF, WEBP - t·ªëi ƒëa 50MB)</p>
                            <button type="button" id="btn_remove_image" onclick="removeIntroImage()" 
                                class="hidden bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600">
                                üóëÔ∏è X√≥a ·∫£nh hi·ªán t·∫°i
                            </button>
                        </div>
                        <div id="intro_post_image_preview" class="mt-3 hidden">
                            <img src="" alt="Preview" class="h-32 w-32 object-cover rounded-lg border-2 border-gray-300">
                        </div>
                    </div>
                    
                    <!-- Video Section -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Video</label>
                        <div class="space-y-2">
                            <input type="file" name="video" id="intro_post_video" accept="video/*" 
                                class="w-full px-4 py-2 border rounded-lg" onchange="previewIntroPostVideoFromFile(this)">
                            <p class="text-xs text-gray-500">Ch·ªçn video t·ª´ m√°y t√≠nh (MP4, WEBM - t·ªëi ƒëa 50MB)</p>
                            <button type="button" id="btn_remove_video" onclick="removeIntroVideo()" 
                                class="hidden bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600">
                                üóëÔ∏è X√≥a video hi·ªán t·∫°i
                            </button>
                        </div>
                        <div id="intro_post_video_preview" class="mt-3 hidden">
                            <video controls class="h-48 w-full rounded-lg border-2 border-gray-300">
                                <source src="" type="video/mp4">
                                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
                            </video>
                        </div>
                    </div>
                    
                    <!-- Media Gallery Section -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-lg font-bold mb-3">üì∏ Th∆∞ vi·ªán Media (Nhi·ªÅu ·∫£nh/video)</h4>
                        <p class="text-sm text-gray-600 mb-3">Th√™m nhi·ªÅu ·∫£nh v√† video cho b√†i vi·∫øt. C√≥ th·ªÉ s·∫Øp x·∫øp th·ª© t·ª± hi·ªÉn th·ªã.</p>
                        <input type="hidden" id="intro_post_media_gallery">
                        <div id="intro_post_media_gallery_container"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã *</label>
                            <input type="number" name="display_order" id="intro_post_display_order" value="1" min="1" required 
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="flex items-center gap-2 pt-7">
                                <input type="checkbox" id="intro_post_is_active" checked>
                                <span class="font-semibold">K√≠ch ho·∫°t (hi·ªÉn th·ªã tr√™n trang gi·ªõi thi·ªáu)</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u b√†i vi·∫øt
                    </button>
                    <button type="button" onclick="closeIntroPostModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="projectModalTitle">Th√™m d·ª± √°n</h3>
            <form id="projectForm" onsubmit="saveProject(event)">
                <input type="hidden" id="project_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ d·ª± √°n *</label>
                        <input type="text" name="title" id="project_title" required class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: L·∫Øp ƒë·∫∑t h·ªá th·ªëng 5kW cho gia ƒë√¨nh t·∫°i ƒê√† N·∫µng">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£</label>
                        <textarea name="description" id="project_description" rows="4" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="M√¥ t·∫£ v·ªÅ d·ª± √°n..."></textarea>
                    </div>
                    <!-- Image Section -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">·∫¢nh d·ª± √°n</label>
                        <div class="space-y-2">
                            <input type="file" name="image" id="project_image" accept="image/*" 
                                class="w-full px-4 py-2 border rounded-lg" onchange="previewProjectImageFromFile(this)">
                            <p class="text-xs text-gray-500">Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh (JPG, PNG, GIF, WEBP - t·ªëi ƒëa 50MB)</p>
                            <button type="button" id="btn_remove_project_image" onclick="removeProjectImage()" 
                                class="hidden bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600">
                                üóëÔ∏è X√≥a ·∫£nh hi·ªán t·∫°i
                            </button>
                        </div>
                        <div id="project_image_preview" class="mt-3 hidden">
                            <img src="" alt="Preview" class="h-32 w-32 object-cover rounded-lg border-2 border-gray-300">
                        </div>
                    </div>
                    
                    <!-- Video Section -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">Video</label>
                        <div class="space-y-2">
                            <input type="file" name="video" id="project_video" accept="video/*" 
                                class="w-full px-4 py-2 border rounded-lg" onchange="previewProjectVideoFromFile(this)">
                            <p class="text-xs text-gray-500">Ch·ªçn video t·ª´ m√°y t√≠nh (MP4, WEBM - t·ªëi ƒëa 50MB)</p>
                            <button type="button" id="btn_remove_project_video" onclick="removeProjectVideo()" 
                                class="hidden bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600">
                                üóëÔ∏è X√≥a video hi·ªán t·∫°i
                            </button>
                        </div>
                        <div id="project_video_preview" class="mt-3 hidden">
                            <video controls class="h-48 w-full rounded-lg border-2 border-gray-300">
                                <source src="" type="video/mp4">
                                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
                            </video>
                        </div>
                    </div>
                    
                    <!-- Media Gallery Section -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-lg font-bold mb-3">üì∏ Th∆∞ vi·ªán Media (Nhi·ªÅu ·∫£nh/video)</h4>
                        <p class="text-sm text-gray-600 mb-3">Th√™m nhi·ªÅu ·∫£nh v√† video cho d·ª± √°n. C√≥ th·ªÉ s·∫Øp x·∫øp th·ª© t·ª± hi·ªÉn th·ªã.</p>
                        <input type="hidden" id="project_media_gallery">
                        <div id="project_media_gallery_container"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã *</label>
                            <input type="number" name="display_order" id="project_display_order" value="1" min="1" required 
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="flex items-center gap-2 pt-7">
                                <input type="checkbox" id="project_is_active" checked>
                                <span class="font-semibold">K√≠ch ho·∫°t (hi·ªÉn th·ªã tr√™n trang d·ª± √°n)</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u d·ª± √°n
                    </button>
                    <button type="button" onclick="closeProjectModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dich Vu Modal -->
    <div id="dichVuModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="dichVuModalTitle">Th√™m d·ªãch v·ª•</h3>
            <form id="dichVuForm" onsubmit="saveDichVu(event)">
                <input type="hidden" id="dich_vu_id">
                <input type="hidden" id="dich_vu_logo_url">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n d·ªãch v·ª• *</label>
                        <input type="text" id="dich_vu_name" required class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: B·∫£o Duy Solar">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Logo (·∫¢nh) *</label>
                        <input type="file" id="dich_vu_logo" accept="image/*" 
                            class="w-full px-4 py-2 border rounded-lg" onchange="previewDichVuLogo(this)">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn ·∫£nh logo d·ªãch v·ª• (JPG, PNG, GIF - t·ªëi ƒëa 5MB)</p>
                        <div id="dich_vu_logo_preview" class="mt-2 hidden">
                            <img src="" alt="Logo preview" class="h-24 w-24 object-cover border rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£</label>
                        <textarea id="dich_vu_description" rows="4" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="M√¥ t·∫£ d·ªãch v·ª•..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√†u n·ªïi b·∫≠t *</label>
                        <input type="color" id="dich_vu_highlight_color" value="#3FA34D" class="w-full h-12 border rounded-lg cursor-pointer">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n link</label>
                        <input type="text" id="dich_vu_link_name" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: Xem b·∫£ng gi√°">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i link</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2">
                                <input type="radio" name="dich_vu_link_type" value="page" checked onchange="toggleLinkType()">
                                <span>Ch·ªçn trang</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="radio" name="dich_vu_link_type" value="custom" onchange="toggleLinkType()">
                                <span>Nh·∫≠p link t√πy ch·ªânh</span>
                            </label>
                        </div>
                    </div>
                    <div id="dich_vu_link_page_section">
                        <label class="block text-sm font-semibold mb-2">Ch·ªçn trang</label>
                        <select id="dich_vu_link_page" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">-- Ch·ªçn trang --</option>
                        </select>
                    </div>
                    <div id="dich_vu_link_custom_section" class="hidden">
                        <label class="block text-sm font-semibold mb-2">URL (custom)</label>
                        <input type="text" id="dich_vu_link_custom" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="https://example.com">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                            <input type="number" id="dich_vu_display_order" value="1" min="1" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="flex items-center gap-2 pt-7">
                                <input type="checkbox" id="dich_vu_is_active" checked>
                                <span class="font-semibold">K√≠ch ho·∫°t</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u d·ªãch v·ª•
                    </button>
                    <button type="button" onclick="closeDichVuModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Home Post Modal -->
    <div id="homePostModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="homePostModalTitle">Th√™m b√†i ƒëƒÉng trang ch·ªß</h3>
            <form id="homePostForm" onsubmit="saveHomePost(event)">
                <input type="hidden" id="home_post_id">
                <input type="hidden" id="home_post_image_url">
                <div class="space-y-4">
                    <!-- Basic Information -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">üìù Th√¥ng tin c∆° b·∫£n</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ b√†i ƒëƒÉng *</label>
                        <input type="text" id="home_post_title" required class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: G√≥i Gia ƒê√¨nh (3-5 kWp)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£ n·ªôi dung *</label>
                        <textarea id="home_post_description" required rows="4" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ b√†i ƒëƒÉng..."></textarea>
                    </div>
                    
                    <!-- Highlight Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">‚ú® Highlight</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">VƒÉn b·∫£n Highlight</label>
                        <input type="text" id="home_post_highlight_text" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: GI·∫¢I PH√ÅP GIA ƒê√åNH">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√†u Highlight</label>
                        <input type="color" id="home_post_highlight_color" value="#3FA34D" class="w-full h-12 border rounded-lg cursor-pointer">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn m√†u cho vƒÉn b·∫£n highlight</p>
                    </div>
                    
                    <!-- Image Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">üñºÔ∏è H√¨nh ·∫£nh</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">·∫¢nh b√†i ƒëƒÉng *</label>
                        <input type="file" id="home_post_image" accept="image/*" 
                            class="w-full px-4 py-2 border rounded-lg" onchange="previewHomePostImage(this)">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn ·∫£nh (JPG, PNG, GIF, WEBP - t·ªëi ƒëa 5MB)</p>
                        <div id="home_post_image_preview" class="mt-2 hidden">
                            <img src="" alt="Image preview" class="h-32 w-auto object-cover border rounded-lg">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">V·ªã tr√≠ ·∫£nh *</label>
                        <select id="home_post_image_position" class="w-full px-4 py-2 border rounded-lg">
                            <option value="right">‚û°Ô∏è ·∫¢nh b√™n ph·∫£i, N·ªôi dung b√™n tr√°i</option>
                            <option value="left">‚¨ÖÔ∏è ·∫¢nh b√™n tr√°i, N·ªôi dung b√™n ph·∫£i</option>
                        </select>
                    </div>
                    
                    <!-- Button Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">üîò N√∫t CTA</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">VƒÉn b·∫£n n√∫t</label>
                        <input type="text" id="home_post_button_text" class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="V√≠ d·ª•: Xem b·∫£ng gi√°">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Link c·ªßa n√∫t</label>
                        <div class="flex gap-2">
                            <select id="home_post_button_url" class="flex-1 px-4 py-2 border rounded-lg">
                                <option value="">-- Ch·ªçn trang --</option>
                                <optgroup label="üìÑ Trang ch√≠nh">
                                    <option value="index.html">üè† Trang ch·ªß</option>
                                </optgroup>
                                <optgroup label="üìÅ Th√¥ng tin">
                                    <option value="html/gioi-thieu.html">üìù Gi·ªõi thi·ªáu</option>
                                    <option value="html/pricing.html">üí∞ S·∫£n ph·∫©m/B·∫£ng gi√°</option>
                                    <option value="html/du-an.html">üèóÔ∏è D·ª± √°n</option>
                                    <option value="html/tin-tuc.html">üì∞ Tin t·ª©c</option>
                                    <option value="html/dich-vu.html">üîß D·ªãch v·ª•</option>
                                    <option value="html/lien-he.html">üìû Li√™n h·ªá</option>
                                </optgroup>
                                <optgroup label="üîß Ch·ª©c nƒÉng">
                                    <option value="html/khao-sat-dien-mat-troi.html">üìã Kh·∫£o s√°t ƒëi·ªán m·∫∑t tr·ªùi</option>
                                    <option value="html/gio-hang.html">üõí Gi·ªè h√†ng</option>
                                    <option value="html/dat-hang.html">üì¶ ƒê·∫∑t h√†ng</option>
                                    <option value="html/vong-quay-may-man.html">üé∞ V√≤ng quay may m·∫Øn</option>
                                </optgroup>
                                <optgroup label="üë§ T√†i kho·∫£n">
                                    <option value="html/login.html">üîê ƒêƒÉng nh·∫≠p</option>
                                    <option value="html/register.html">‚úçÔ∏è ƒêƒÉng k√Ω</option>
                                    <option value="html/user_profile.html">üë§ Trang c√° nh√¢n</option>
                                    <option value="html/order_history.html">üìã L·ªãch s·ª≠ ƒë∆°n h√†ng</option>
                                    <option value="html/survey_history.html">üìä L·ªãch s·ª≠ kh·∫£o s√°t</option>
                                    <option value="html/my-rewards.html">üéÅ Ph·∫ßn th∆∞·ªüng c·ªßa t√¥i</option>
                                </optgroup>
                                <optgroup label="üìú Ch√≠nh s√°ch">
                                    <option value="html/tam-nhin-su-menh.html">üéØ T·∫ßm nh√¨n & S·ª© m·ªánh</option>
                                    <option value="html/dieu-khoan-dieu-kien.html">üìã ƒêi·ªÅu kho·∫£n & ƒêi·ªÅu ki·ªán</option>
                                    <option value="html/chinh-sach-doi-tra.html">‚Ü©Ô∏è Ch√≠nh s√°ch ƒë·ªïi tr·∫£</option>
                                    <option value="html/chinh-sach-bao-mat-thong-tin-ca-nhan.html">üîí B·∫£o m·∫≠t th√¥ng tin c√° nh√¢n</option>
                                    <option value="html/chinh-sach-bao-mat-thong-tin-thanh-toan.html">üí≥ B·∫£o m·∫≠t th√¥ng tin thanh to√°n</option>
                                    <option value="html/chinh-sach-bao-hanh.html">üõ°Ô∏è Ch√≠nh s√°ch b·∫£o h√†nh</option>
                                    <option value="html/tro-thanh-nha-phan-phoi.html">ü§ù Tr·ªü th√†nh nh√† ph√¢n ph·ªëi</option>
                                </optgroup>
                            </select>
                            <button type="button" onclick="toggleCustomUrlInput()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm whitespace-nowrap" title="Nh·∫≠p link t√πy ch·ªânh">
                                üîó T√πy ch·ªânh
                            </button>
                        </div>
                        <input type="text" id="home_post_button_url_custom" class="hidden w-full px-4 py-2 border rounded-lg mt-2" 
                            placeholder="Nh·∫≠p link t√πy ch·ªânh (VD: https://example.com ho·∫∑c #section)">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn trang t·ª´ danh s√°ch ho·∫∑c nh·∫≠p link t√πy ch·ªânh</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√†u n√∫t</label>
                        <input type="color" id="home_post_button_color" value="#3FA34D" class="w-full h-12 border rounded-lg cursor-pointer">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn m√†u n·ªÅn cho n√∫t CTA</p>
                    </div>
                    
                    <!-- Features Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">‚úÖ C√°c t√≠nh nƒÉng (Features)</h4>
                    </div>
                    
                    <div id="home_post_features_container">
                        <div class="space-y-2">
                            <div class="flex gap-2 feature-item">
                                <input type="text" placeholder="Feature 1" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                                <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                            </div>
                            <div class="flex gap-2 feature-item">
                                <input type="text" placeholder="Feature 2" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                                <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                            </div>
                            <div class="flex gap-2 feature-item">
                                <input type="text" placeholder="Feature 3" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                                <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                            </div>
                        </div>
                        <button type="button" onclick="addFeature()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            ‚ûï Th√™m feature
                        </button>
                    </div>
                    
                    <!-- Media Gallery Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">üì∏ Th∆∞ vi·ªán Media (Nhi·ªÅu ·∫£nh/video)</h4>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-600 mb-3">Th√™m nhi·ªÅu ·∫£nh v√† video cho b√†i ƒëƒÉng. C√≥ th·ªÉ s·∫Øp x·∫øp th·ª© t·ª± hi·ªÉn th·ªã.</p>
                        <input type="hidden" id="home_post_media_gallery">
                        <div id="home_post_media_gallery_container"></div>
                    </div>
                    
                    <!-- Display Settings -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">‚öôÔ∏è C√†i ƒë·∫∑t hi·ªÉn th·ªã</h4>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                            <input type="number" id="home_post_display_order" value="0" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Section ID</label>
                            <input type="text" id="home_post_section_id" value="solutions" class="w-full px-4 py-2 border rounded-lg" 
                                placeholder="solutions">
                        </div>
                    </div>
                    
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="home_post_is_active" checked>
                            <span class="font-semibold">‚úÖ Hi·ªÉn th·ªã tr√™n trang ch·ªß</span>
                        </label>
                    </div>
                    
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u b√†i ƒëƒÉng
                    </button>
                    <button type="button" onclick="closeHomePostModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="contactModalTitle">Th√™m k√™nh li√™n h·ªá</h3>
            <form id="contactForm" onsubmit="saveContact(event)">
                <input type="hidden" id="contact_id">
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <!-- T√™n -->
                    <div>
                        <label class="block font-semibold mb-2">T√™n k√™nh <span class="text-red-500">*</span></label>
                        <input type="text" id="contact_name" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: Hotline, Zalo" required>
                    </div>
                    
                    <!-- Danh m·ª•c -->
                    <div>
                        <label class="block font-semibold mb-2">Danh m·ª•c <span class="text-red-500">*</span></label>
                        <select id="contact_category" class="w-full px-4 py-2 border rounded-lg" required onchange="updateContactPreview()">
                            <option value="">-- Ch·ªçn danh m·ª•c --</option>
                            <option value="phone">üìû S·ªë ƒëi·ªán tho·∫°i (G·ªçi ngay)</option>
                            <option value="zalo">üí¨ Zalo (Chat Zalo)</option>
                            <option value="email">‚úâÔ∏è Email (G·ª≠i Email)</option>
                            <option value="facebook">üìò Facebook (Theo d√µi Facebook)</option>
                            <option value="tiktok">üéµ TikTok (Theo d√µi TikTok)</option>
                            <option value="youtube">üì∫ YouTube (Xem k√™nh YouTube)</option>
                            <option value="website">üåê Website (Truy c·∫≠p Website)</option>
                        </select>
                        <p class="text-sm text-gray-500 mt-1">
                            <span id="category_hint">Ch·ªçn danh m·ª•c ƒë·ªÉ xem icon v√† button text t·ª± ƒë·ªông</span>
                        </p>
                    </div>
                    
                    <!-- M√¥ t·∫£ -->
                    <div>
                        <label class="block font-semibold mb-2">M√¥ t·∫£</label>
                        <input type="text" id="contact_description" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: H·ªó tr·ª£ 24/7">
                    </div>
                    
                    <!-- N·ªôi dung -->
                    <div>
                        <label class="block font-semibold mb-2">N·ªôi dung <span class="text-red-500">*</span></label>
                        <input type="text" id="contact_content" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: 0969397434" required>
                        <p class="text-sm text-gray-500 mt-1" id="content_hint">
                            Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i, email, link ho·∫∑c username
                        </p>
                    </div>
                    
                    <!-- M√†u -->
                    <div>
                        <label class="block font-semibold mb-2">M√†u n·ªÅn card</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="contact_color" class="h-10 w-20 border rounded-lg cursor-pointer" value="#16a34a">
                            <span id="contact_color_display" class="text-sm font-mono">#16a34a</span>
                        </div>
                    </div>
                    
                    <!-- Th·ª© t·ª± hi·ªÉn th·ªã -->
                    <div>
                        <label class="block font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input type="number" id="contact_display_order" class="w-full px-4 py-2 border rounded-lg" value="0" min="0">
                    </div>
                    
                    <!-- Tr·∫°ng th√°i -->
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="contact_is_active" checked class="w-4 h-4">
                            <span class="font-semibold">Hi·ªÉn th·ªã</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        ‚úÖ L∆∞u
                    </button>
                    <button type="button" onclick="closeContactModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="userModalTitle">Th√™m ng∆∞·ªùi d√πng</h3>
            <form id="userForm" onsubmit="saveUser(event)">
                <input type="hidden" id="user_id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Th√¥ng tin c∆° b·∫£n -->
                    <div class="col-span-2 border-b pb-4">
                        <h4 class="font-bold text-lg mb-3">üìù Th√¥ng tin c∆° b·∫£n</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">H·ªç t√™n *</label>
                        <input type="text" id="user_full_name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Username *</label>
                        <input type="text" id="user_username" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">S·ªë ƒëi·ªán tho·∫°i *</label>
                        <input type="tel" id="user_phone" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">M·∫≠t kh·∫©u <span id="password-label-suffix">*</span></label>
                        <input type="password" id="user_password" class="w-full px-4 py-2 border rounded-lg" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi m·∫≠t kh·∫©u">
                        <p class="text-xs text-gray-500 mt-1">T·ªëi thi·ªÉu 6 k√Ω t·ª±</p>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="user_is_admin" onchange="toggleAdminPermissions()">
                            <span class="font-semibold">üëë Quy·ªÅn Admin (Full quy·ªÅn truy c·∫≠p t·∫•t c·∫£)</span>
                        </label>
                    </div>
                    
                    <!-- Ph√¢n quy·ªÅn chi ti·∫øt -->
                    <div class="col-span-2 border-b pb-4 mt-4" id="permissions-section">
                        <h4 class="font-bold text-lg mb-3">üîê Ph√¢n quy·ªÅn module (ch·ªâ √°p d·ª•ng khi KH√îNG ph·∫£i Admin)</h4>
                        <p class="text-sm text-gray-600 mb-4">Ch·ªçn c√°c quy·ªÅn truy c·∫≠p cho t·ª´ng module</p>
                    </div>
                    
                    <div class="col-span-2" id="permissions-grid">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Danh m·ª•c SP -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üìÅ Danh m·ª•c SP</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="categories" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="categories" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="categories" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="categories" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- S·∫£n ph·∫©m -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üì¶ S·∫£n ph·∫©m</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="products" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="products" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="products" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="products" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Kh·∫£o s√°t -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üìã Kh·∫£o s√°t</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="survey" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="survey" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="survey" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="survey" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- G√≥i s·∫£n ph·∫©m -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üéÅ G√≥i s·∫£n ph·∫©m</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="packages" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="packages" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="packages" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="packages" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- ƒê∆°n h√†ng -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üõí ƒê∆°n h√†ng</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="orders" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="orders" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="orders" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="orders" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- V√© quay -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üé´ V√© quay</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="tickets" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="tickets" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="tickets" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="tickets" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Ph·∫ßn th∆∞·ªüng -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üéÅ Ph·∫ßn th∆∞·ªüng</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="rewards" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="rewards" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="rewards" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="rewards" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- B√†i gi·ªõi thi·ªáu -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üìù B√†i gi·ªõi thi·ªáu</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="intro-posts" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="intro-posts" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="intro-posts" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="intro-posts" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- D·ª± √°n -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üèóÔ∏è D·ª± √°n</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="projects" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="projects" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="projects" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="projects" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- D·ªãch v·ª• -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üîß D·ªãch v·ª•</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="dich-vu" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="dich-vu" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="dich-vu" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="dich-vu" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Trang ch·ªß -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üè† Trang ch·ªß</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="home" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="home" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="home" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="home" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Li√™n h·ªá -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h5 class="font-bold mb-2">üìû Li√™n h·ªá</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="contacts" data-action="view">
                                        <span class="text-sm">üëÅÔ∏è Xem</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="contacts" data-action="create">
                                        <span class="text-sm">‚ûï T·∫°o m·ªõi</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="contacts" data-action="edit">
                                        <span class="text-sm">‚úèÔ∏è S·ª≠a</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="permission-checkbox" data-module="contacts" data-action="delete">
                                        <span class="text-sm">üóëÔ∏è X√≥a</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800"><strong>üí° L∆∞u √Ω:</strong> Khi check "Quy·ªÅn Admin", user s·∫Ω c√≥ to√†n quy·ªÅn truy c·∫≠p t·∫•t c·∫£ module v√† ph√¢n quy·ªÅn chi ti·∫øt s·∫Ω b·ªã b·ªè qua.</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u
                    </button>
                    <button type="button" onclick="closeUserModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Category Modal -->
    <div id="packageCategoryModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-2xl font-bold mb-4" id="packageCategoryModalTitle">Th√™m danh m·ª•c g√≥i</h3>
            <form id="packageCategoryForm" onsubmit="savePackageCategory(event)">
                <input type="hidden" id="package_category_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n danh m·ª•c *</label>
                        <input type="text" id="package_category_name" required class="w-full px-4 py-2 border rounded-lg" placeholder="VD: G√≥i ƒêi·ªán M·∫∑t Tr·ªùi Gia ƒê√¨nh">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Logo danh m·ª•c</label>
                        <input type="file" id="package_category_logo" accept="image/jpeg,image/png,image/gif,image/jpg" class="w-full px-4 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh JPG, PNG, GIF (t·ªëi ƒëa 2MB)</p>
                        <div id="package_category_logo_preview" class="mt-2 hidden">
                            <img src="" alt="Logo preview" class="h-20 w-20 object-contain border rounded">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Badge Text</label>
                        <input type="text" id="package_category_badge_text" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: PH·ªî BI·∫æN">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Badge Color</label>
                        <input type="color" id="package_category_badge_color" value="#3B82F6" class="w-full h-12 border rounded-lg cursor-pointer">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input type="number" id="package_category_display_order" value="0" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="package_category_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closePackageCategoryModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="packageModalTitle">Th√™m g√≥i s·∫£n ph·∫©m</h3>
            <form id="packageForm" onsubmit="savePackage(event)">
                <input type="hidden" id="package_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Danh m·ª•c g√≥i *</label>
                        <select id="package_category_id_select" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="">-- Ch·ªçn danh m·ª•c g√≥i --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">T√™n g√≥i *</label>
                        <input type="text" id="package_name" required class="w-full px-4 py-2 border rounded-lg" placeholder="VD: G√≥i Solar 3kW">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">M√¥ t·∫£</label>
                        <textarea id="package_description" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ g√≥i s·∫£n ph·∫©m"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Gi√° g√≥i (VNƒê) *</label>
                        <input type="number" id="package_price" required min="0" step="1000" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Badge Text</label>
                        <input type="text" id="package_badge_text" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: TI·∫æT KI·ªÜM">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Badge Color</label>
                        <input type="color" id="package_badge_color" value="#3B82F6" class="w-full h-12 border rounded-lg cursor-pointer">
                    </div>
                    <!-- Highlighted Features -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold">ƒêi·ªÉm n·ªïi b·∫≠t</label>
                            <button type="button" onclick="addPackageHighlight()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                + Th√™m ƒëi·ªÉm n·ªïi b·∫≠t
                            </button>
                        </div>
                        <div id="package-highlights-container" class="space-y-2">
                            <!-- Highlight items will be added here -->
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input type="number" id="package_display_order" value="0" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="package_is_active" checked>
                            <span class="font-semibold">K√≠ch ho·∫°t</span>
                        </label>
                    </div>
                    
                    <!-- Package Items -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold">C√°c item trong g√≥i</label>
                            <button type="button" onclick="addPackageItem()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                + Th√™m item
                            </button>
                        </div>
                        <div id="package-items-container" class="space-y-2">
                            <!-- Package items will be added here -->
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        L∆∞u
                    </button>
                    <button type="button" onclick="closePackageModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Survey Config Modal -->
    <div id="surveyConfigModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4" id="surveyConfigModalTitle">C·∫•u h√¨nh kh·∫£o s√°t</h3>
            <form id="surveyConfigForm" onsubmit="saveSurveyConfig(event)">
                <input type="hidden" id="survey_product_id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i s·∫£n ph·∫©m trong kh·∫£o s√°t *</label>
                        <select id="survey_category" required class="w-full px-4 py-2 border rounded-lg" onchange="updateSurveyPhaseField()">
                            <option value="">-- Ch·ªçn lo·∫°i --</option>
                            <option value="solar_panel">‚òÄÔ∏è T·∫•m Pin</option>
                            <option value="inverter">üîå Inverter</option>
                            <option value="battery">üîã Pin L∆∞u Tr·ªØ</option>
                            <option value="electrical_cabinet">‚ö° T·ªß ƒêi·ªán</option>
                            <option value="accessory">üîß Ph·ª• Ki·ªán</option>
                        </select>
                    </div>

                    <div id="survey_phase_field" class="hidden">
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i pha *</label>
                        <select id="survey_phase_type" class="w-full px-4 py-2 border rounded-lg">
                            <option value="1_phase">1 Pha</option>
                            <option value="3_phase">3 Pha</option>
                            <option value="both">C·∫£ 2</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Lo·∫°i gi√° s·ª≠ d·ª•ng *</label>
                        <select id="survey_price_type" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="market_price">Gi√° th·ªã tr∆∞·ªùng</option>
                            <option value="category_price">Gi√° danh m·ª•c</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                        <input type="number" id="survey_display_order" placeholder="ƒê·ªÉ tr·ªëng n·∫øu ch∆∞a s·∫Øp x·∫øp" min="0" class="w-full px-4 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ tr·ªëng n·∫øu ch∆∞a c·∫•u h√¨nh. S·ªë c√†ng nh·ªè c√†ng hi·ªÉn th·ªã tr∆∞·ªõc.</p>
                    </div>

                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="survey_is_active">
                            <span class="font-semibold">K√≠ch ho·∫°t (hi·ªÉn th·ªã trong kh·∫£o s√°t)</span>
                        </label>
                        <div id="survey_active_status_text" class="text-xs mt-1 font-semibold text-gray-600">Tr·∫°ng th√°i: Ch∆∞a k√≠ch ho·∫°t</div>
                    </div>

                    

                    <!-- Numeric spec fields (show by category) -->
                    <div id="survey_spec_panel" class="hidden">
                        <label class="block text-sm font-semibold mb-1">C√¥ng su·∫•t t·∫•m pin (W/t·∫•m)</label>
                        <input type="number" id="survey_panel_power_watt" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: 590">
                        <p class="text-xs text-gray-500 mt-1">Th√¥ng s·ªë n√†y ch·ªâ d√πng ƒë·ªÉ t√≠nh to√°n trong trang Kh·∫£o s√°t, kh√¥ng hi·ªÉn th·ªã ·ªü trang s·∫£n ph·∫©m.</p>
                    </div>
                    <div id="survey_spec_inverter" class="hidden">
                        <label class="block text-sm font-semibold mb-1">C√¥ng su·∫•t inverter (kW)</label>
                        <input type="number" step="0.01" id="survey_inverter_power_watt" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: 10 (t∆∞∆°ng ƒë∆∞∆°ng 10kW)">
                        <p class="text-xs text-gray-500 mt-1">Nh·∫≠p ƒë∆°n v·ªã kW (v√≠ d·ª• 10). H·ªá th·ªëng s·∫Ω t·ª± quy ƒë·ªïi sang W ƒë·ªÉ t√≠nh to√°n. Th√¥ng s·ªë n√†y ch·ªâ d√πng cho trang Kh·∫£o s√°t.</p>
                    </div>
                    <div id="survey_spec_battery" class="hidden">
                        <label class="block text-sm font-semibold mb-1">Dung l∆∞·ª£ng 1 b·ªô pin (kWh)</label>
                        <input type="number" step="0.01" id="survey_battery_capacity_kwh" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: 8.80">
                        <p class="text-xs text-gray-500 mt-1">Th√¥ng s·ªë n√†y ch·ªâ d√πng ƒë·ªÉ t√≠nh to√°n trong trang Kh·∫£o s√°t, kh√¥ng hi·ªÉn th·ªã ·ªü trang s·∫£n ph·∫©m.</p>
                    </div>
                    <div id="survey_spec_cabinet" class="hidden">
                        <label class="block text-sm font-semibold mb-1">C√¥ng su·∫•t t·ªß ƒëi·ªán (kW)</label>
                        <input type="number" step="0.01" id="survey_cabinet_power_kw" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: 12">
                        <p class="text-xs text-gray-500 mt-1">Th√¥ng s·ªë n√†y ch·ªâ d√πng ƒë·ªÉ t√≠nh to√°n trong trang Kh·∫£o s√°t, kh√¥ng hi·ªÉn th·ªã ·ªü trang s·∫£n ph·∫©m.</p>
                    </div>
                    <div id="survey_spec_accessory" class="hidden">
                        <label class="block text-sm font-semibold mb-2">C·∫•u h√¨nh ph·ª• ki·ªán</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold mb-1">ƒê∆°n v·ªã t√≠nh</label>
                                <select id="survey_accessory_unit" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">-- Ch·ªçn ƒë∆°n v·ªã --</option>
                                    <option value="bo">B·ªô</option>
                                    <option value="cai">C√°i</option>
                                    <option value="met">M√©t</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">S·ªë l∆∞·ª£ng b·∫£n th√¢n</label>
                                <input type="number" step="0.01" id="survey_accessory_base_qty" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: 100 (m), 6 (c√°i)">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">H·ªá s·ªë theo ph·ª• thu·ªôc</label>
                                <input type="number" step="0.01" id="survey_accessory_dependent_qty" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="VD: 6 (c√°i/t·∫•m)">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">ƒê·ªëi t∆∞·ª£ng ph·ª• thu·ªôc</label>
                                <select id="survey_accessory_dependent_target" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">-- Ch·ªçn ph·ª• thu·ªôc --</option>
                                    <option value="panel">T·∫•m pin</option>
                                    <option value="inverter">Inverter</option>
                                    <option value="battery">Pin l∆∞u tr·ªØ</option>
                                    <option value="cabinet">T·ªß ƒëi·ªán</option>
                                    <option value="project">C·∫£ c√¥ng tr√¨nh</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">C√¥ng th·ª©c: s·ªë l∆∞·ª£ng = S·ªë l∆∞·ª£ng b·∫£n th√¢n + (H·ªá s·ªë √ó s·ªë l∆∞·ª£ng ƒë·ªëi t∆∞·ª£ng ph·ª• thu·ªôc)</p>
                    </div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        üíæ L∆∞u c·∫•u h√¨nh
                    </button>
                    <button type="button" onclick="closeSurveyConfigModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        ‚ùå H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/cache-buster.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script src="../assets/js/admin-products.js"></script>
    <script src="../assets/js/admin-packages.js"></script>
    <script src="../assets/js/admin-media-gallery.js"></script>
    <script>
        // Check admin access (check both is_admin and permissions)
        async function checkAdmin() {
            try {
                const response = await fetch(`${API_BASE}/check_admin_access.php?t=${Date.now()}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                // Check if user has admin access (is_admin or has permissions)
                if (!data.success || !data.has_access) {
                    window.location.href = 'login.html';
                    return false;
                }
                
                // Get user info to display name
                try {
                    const userResponse = await fetch(`${API_BASE}/get_user_info.php`, {
                        credentials: 'include'
                    });
                    const userData = await userResponse.json();
                    if (userData.success && userData.user) {
                        document.getElementById('admin-name').textContent = userData.user.full_name;
                    }
                } catch (err) {
                    console.error('Error getting user info:', err);
                }
                
                return true;
            } catch (error) {
                console.error('Error checking admin access:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Logout
        async function logout() {
            try {
                // Call logout API
                const response = await fetch(`${API_BASE}/logout.php`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                // Clear user from localStorage (important for auth state)
                if (window.authUtils && typeof window.authUtils.clearUser === 'function') {
                    window.authUtils.clearUser();
                } else {
                    // Fallback: manually clear localStorage if authUtils not available
                    localStorage.removeItem('authUser');
                }
                
                // Clear cart data
                localStorage.removeItem('cartItems');
                
                // Show success message if available
                if (data.success) {
                    showToast(data.message || 'ƒêƒÉng xu·∫•t th√†nh c√¥ng', 'success');
                }
                
                // Wait a bit for the toast to show
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 500);
            } catch (error) {
                console.error('Error logging out:', error);
                
                // Even if there's an error, clear user data and redirect
                if (window.authUtils && typeof window.authUtils.clearUser === 'function') {
                    window.authUtils.clearUser();
                } else {
                    localStorage.removeItem('authUser');
                }
                localStorage.removeItem('cartItems');
                
                window.location.href = 'login.html';
            }
        }

        // Tab Management
        function showTab(tabName) {
            // Check permission before switching tab
            // Users tab is only for full admin
            if (tabName === 'users') {
                if (typeof isFullAdmin === 'undefined' || !isFullAdmin) {
                    showPermissionDenied('truy c·∫≠p Qu·∫£n L√Ω Users. Ch·ªâ Admin to√†n quy·ªÅn m·ªõi ƒë∆∞·ª£c ph√©p.');
                    return;
                }
            } else if (typeof hasPermission === 'function' && !hasPermission(tabName, 'view')) {
                showPermissionDenied('xem module n√†y');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Find and activate the corresponding button
            const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Apply button permissions for this tab
            applyButtonPermissions(tabName);
            
                         // Load data for the tab
             switch(tabName) {
                 case 'categories': loadCategories(); break;
                 case 'products': loadProducts(); break;
                case 'survey': 
                    loadSurveyHistory();
                    loadSurveyRegions();
                    loadElectricityPrices(); 
                    loadSurveyProducts(); 
                    break;
                 case 'packages': 
                     loadPackageCategories(); 
                     loadPackages(); 
                     break;
                 case 'orders': loadOrders(); break;
                 case 'tickets': loadTickets(); break;
                 case 'rewards': loadRewards(); break;
                 case 'intro-posts': loadIntroPosts(); break;
                case 'projects': loadProjects(); break;
                case 'dich-vu': loadDichVu(); break;
                case 'home': loadHomePosts(); break;
                case 'contacts': loadContacts(); break;
                case 'users': loadUsersManagement(); break;
            }
        }

        // Load Categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_categories.php?t=${Date.now()}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    categoriesData = data.categories;
                    renderCategories(data.categories);
                    updateCategoryDropdowns();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderCategories(categories) {
            const tbody = document.getElementById('categories-tbody');
            if (categories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            Ch∆∞a c√≥ danh m·ª•c n√†o. Click "Th√™m danh m·ª•c" ƒë·ªÉ t·∫°o m·ªõi.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = categories.map(cat => {
                // Fix logo URL path
                let logoUrl = cat.logo_url;
                if (logoUrl && !logoUrl.startsWith('http') && !logoUrl.startsWith('/')) {
                    logoUrl = '/' + logoUrl;
                }
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${cat.id}</td>
                    <td class="px-4 py-3">
                        ${logoUrl ? `<img src="${logoUrl}" class="h-16 w-16 object-contain rounded border" onerror="this.src='../assets/img/logo.jpg'">` : '<span class="text-gray-400">Ch∆∞a c√≥</span>'}
                    </td>
                    <td class="px-4 py-3 font-semibold">${cat.name}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded font-semibold">${cat.display_order}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${cat.is_active == 1 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${cat.is_active == 1 ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editCategory(${cat.id})" class="text-blue-600 hover:underline mr-3">‚úèÔ∏è S·ª≠a</button>
                        <button onclick="deleteCategory(${cat.id})" class="text-red-600 hover:underline">üóëÔ∏è X√≥a</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function updateCategoryDropdowns() {
            const selects = [document.getElementById('product_category_id'), document.getElementById('product-category-filter')];
            selects.forEach((select, i) => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = (i === 1 ? '<option value="">T·∫•t c·∫£ danh m·ª•c</option>' : '') + 
                    categoriesData.filter(c => c.is_active).map(cat => 
                        `<option value="${cat.id}">${cat.name}</option>`
                    ).join('');
                if (currentValue) select.value = currentValue;
            });
        }

        // Category Modal Functions
        function openCategoryModal(id = null) {
            const modal = document.getElementById('categoryModal');
            const form = document.getElementById('categoryForm');
            form.reset();
            
            // Reset preview
            document.getElementById('category_logo_preview').classList.add('hidden');
            document.getElementById('category_logo_preview_img').src = '';
            
            if (id) {
                const cat = categoriesData.find(c => c.id == id);
                if (cat) {
                    document.getElementById('category_id').value = cat.id;
                    document.getElementById('category_name').value = cat.name;
                    document.getElementById('category_logo_url').value = cat.logo_url || '';
                    document.getElementById('category_display_order').value = cat.display_order;
                    document.getElementById('category_is_active').checked = cat.is_active == 1;
                    document.getElementById('categoryModalTitle').textContent = 'S·ª≠a danh m·ª•c';
                    
                    // Show existing logo
                    if (cat.logo_url) {
                        // Fix logo URL path
                        let logoUrl = cat.logo_url;
                        if (!logoUrl.startsWith('http') && !logoUrl.startsWith('/')) {
                            logoUrl = '/' + logoUrl;
                        }
                        document.getElementById('category_logo_preview_img').src = logoUrl;
                        document.getElementById('category_logo_preview').classList.remove('hidden');
                        // Remove required from file input when editing
                        document.getElementById('category_logo').removeAttribute('required');
                    }
                }
            } else {
                document.getElementById('categoryModalTitle').textContent = 'Th√™m danh m·ª•c';
                document.getElementById('category_logo').setAttribute('required', 'required');
            }
            
            modal.classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
        }

        function previewCategoryLogo(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 3MB)
                if (file.size > 3 * 1024 * 1024) {
                    showToast('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 3MB! File hi·ªán t·∫°i: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB', 'error');
                    event.target.value = '';
                    return;
                }
                
                // Check file type
                if (!file.type.match('image.*')) {
                    showToast('Vui l√≤ng ch·ªçn file ·∫£nh!', 'error');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('category_logo_preview_img').src = e.target.result;
                    document.getElementById('category_logo_preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveCategory(event) {
            event.preventDefault();
            
            const categoryId = document.getElementById('category_id').value || 0;
            const displayOrder = parseInt(document.getElementById('category_display_order').value);
            
            // Check duplicate display_order
            const isDuplicate = categoriesData.some(cat => 
                cat.display_order == displayOrder && cat.id != categoryId
            );
            
            if (isDuplicate) {
                showToast(`Th·ª© t·ª± ∆∞u ti√™n ${displayOrder} ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng! Vui l√≤ng ch·ªçn s·ªë kh√°c.`, 'warning');
                return;
            }
            
            // Get submit button and show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn?.textContent;
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="animate-spin mr-2">‚è≥</span> ƒêang l∆∞u...';
            }
            
            // Prepare form data for file upload
            const formData = new FormData();
            formData.append('id', categoryId);
            formData.append('name', document.getElementById('category_name').value);
            formData.append('display_order', displayOrder);
            formData.append('is_active', document.getElementById('category_is_active').checked ? 1 : 0);
            
            // Add logo file if selected
            const logoFile = document.getElementById('category_logo').files[0];
            if (logoFile) {
                formData.append('logo', logoFile);
            } else if (categoryId > 0) {
                // Keep existing logo URL when editing
                formData.append('logo_url', document.getElementById('category_logo_url').value);
            }

            try {
                const response = await fetch(`${API_BASE}/admin/save_category.php`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData // Don't set Content-Type header, browser will set it with boundary
                });
                
                // Check if response is 413 (Request Entity Too Large)
                if (response.status === 413) {
                    const fileSizeMB = logoFile ? (logoFile.size / 1024 / 1024).toFixed(2) : 'unknown';
                    showToast('File qu√° l·ªõn (' + fileSizeMB + 'MB)! Server ch·ªâ cho ph√©p upload file nh·ªè h∆°n. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n ho·∫∑c n√©n ·∫£nh.', 'error');
                    return;
                }
                
                // Check if response is not OK
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeCategoryModal();
                    loadCategories();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving category:', error);
                if (error.message.includes('Unexpected token')) {
                    showToast('K√≠ch th∆∞·ªõc ·∫£nh qu√° l·ªõn ho·∫∑c server kh√¥ng th·ªÉ x·ª≠ l√Ω. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 2MB.', 'error');
                } else {
                    showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u danh m·ª•c: ' + error.message, 'error');
                }
            } finally {
                // Restore button state
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        }

        function editCategory(id) {
            openCategoryModal(id);
        }

        async function deleteCategory(id) {
            if (!await customConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_category.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadCategories();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a danh m·ª•c: ' + error.message, 'error');
            }
        }

        // Preview logo image when selected
        document.addEventListener('change', function(e) {
            if (e.target.id === 'package_category_logo') {
                const file = e.target.files[0];
                if (file) {
                    // Check file size (max 3MB)
                    if (file.size > 3 * 1024 * 1024) {
                        showToast('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 3MB! File hi·ªán t·∫°i: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB', 'error');
                        e.target.value = '';
                        return;
                    }
                    
                    // Check file type
                    if (!file.type.match('image.*')) {
                        showToast('Vui l√≤ng ch·ªçn file ·∫£nh!', 'error');
                        e.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('package_category_logo_preview');
                        const img = preview.querySelector('img');
                        img.src = e.target.result;
                        preview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkAdmin();
            if (hasAccess) {
                // Load permissions first
                if (typeof loadPermissions === 'function') {
                    await loadPermissions();
                }
                
                // Load data based on permissions
                // Categories is usually the first tab, load it if user has view permission
                if (typeof hasPermission === 'function' && hasPermission('categories', 'view')) {
                    await loadCategories();
                }
                
                // Only load users if full admin
                if (typeof isFullAdmin !== 'undefined' && isFullAdmin) {
                    await loadUsers();
                }
                
                // Load reward templates if user has permission to rewards
                if (typeof hasPermission === 'function' && hasPermission('rewards', 'view')) {
                    await loadRewardTemplates();
                }
                
                // applyPermissions() already shows first available tab
            }
        });
        // ============================================
        // SURVEY HISTORY
        // ============================================
        
        async function loadSurveyHistory() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_survey_history.php`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.success) {
                    // Only show error if it's not a permission issue (permission should be checked before loading)
                    if (data.message && !data.message.includes('quy·ªÅn')) {
                        showToast(data.message, 'error');
                    }
                    return;
                }
                
                const surveys = data.data.surveys;
                
                // Update stats
                document.getElementById('total-surveys').textContent = surveys.length;
                
                const surveysWithResults = surveys.filter(s => s.has_results).length;
                document.getElementById('surveys-with-results').textContent = surveysWithResults;
                
                const today = new Date().toISOString().split('T')[0];
                const surveysToday = surveys.filter(s => s.created_at.startsWith(today)).length;
                document.getElementById('surveys-today').textContent = surveysToday;
                
                // Render table
                renderSurveyHistory(surveys);
                
            } catch (error) {
                console.error('Error loading survey history:', error);
                // Only show error if it's not a permission issue
                if (!error.message.includes('quy·ªÅn')) {
                    showToast('L·ªói khi t·∫£i l·ªãch s·ª≠ kh·∫£o s√°t: ' + error.message, 'error');
                }
            }
        }
        
        function renderSurveyHistory(surveys) {
            const tbody = document.getElementById('survey-history-tbody');
            
            if (surveys.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-16 h-16 text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>Ch∆∞a c√≥ kh·∫£o s√°t n√†o</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = surveys.map(survey => {
                const createdDate = new Date(survey.created_at);
                const formattedDate = createdDate.toLocaleDateString('vi-VN') + ' ' + 
                                     createdDate.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                
                const hasResults = survey.has_results;
                const resultsBadge = hasResults 
                    ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">C√≥ k·∫øt qu·∫£</span>'
                    : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">Ch∆∞a c√≥</span>';
                
                const totalCostDisplay = hasResults && survey.total_cost
                    ? Math.round(survey.total_cost).toLocaleString('vi-VN') + 'ƒë'
                    : '-';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 border">#${survey.id}</td>
                        <td class="px-4 py-3 border">
                            <div class="font-semibold">${survey.full_name}</div>
                            <div class="text-sm text-gray-500">@${survey.username || 'N/A'}</div>
                        </td>
                        <td class="px-4 py-3 border">
                            <div class="text-sm">üìû ${survey.phone}</div>
                        </td>
                        <td class="px-4 py-3 border text-center">${survey.region_name}</td>
                        <td class="px-4 py-3 border text-center">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${survey.phase} Pha</span>
                        </td>
                        <td class="px-4 py-3 border text-right font-semibold text-orange-600">
                            ${Math.round(survey.monthly_bill).toLocaleString('vi-VN')}ƒë
                        </td>
                        <td class="px-4 py-3 border text-right">
                            <div class="font-bold text-green-600">${totalCostDisplay}</div>
                            ${hasResults ? `<div class="text-xs text-gray-500">${survey.panels_needed} t·∫•m pin, ${survey.total_capacity}kW</div>` : ''}
                        </td>
                        <td class="px-4 py-3 border text-center text-sm">
                            ${formattedDate}
                        </td>
                        <td class="px-4 py-3 border text-center">
                            <a href="../html/survey_detail.html?id=${survey.id}&source=admin" 
                               target="_blank"
                               class="inline-block bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
                                üëÅÔ∏è Xem chi ti·∫øt
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ============================================
        // SURVEY PRODUCTS MANAGEMENT
        // ============================================
        
        async function loadSurveyProducts() {
            try {
                const filter = document.getElementById('survey-filter')?.value || 'all';
                const response = await fetch(`${API_BASE}/admin/get_survey_products.php?filter=${filter}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    displaySurveyProducts(data.products);
                } else {
                    // Only show error if it's not a permission issue
                    if (data.message && !data.message.includes('quy·ªÅn')) {
                        showToast(data.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Error loading survey products:', error);
                // Only show error if it's not a permission issue
                if (!error.message.includes('quy·ªÅn')) {
                showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m', 'error');
                }
            }
        }
        
                 function displaySurveyProducts(products) {
             // Store products for modal
             currentSurveyProducts = products;
             
             const container = document.getElementById('survey-products-list');
             
             if (products.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</p>';
                 return;
             }
            
            let html = '<div class="grid gap-4">';
            
            products.forEach(product => {
                const hasConfig = product.has_survey_config;
                const config = product.survey_config;
                
                // Fix image URL path
                let imageUrl = product.image_url;
                if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
                
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow ${hasConfig ? 'bg-green-50' : 'bg-gray-50'}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                                    ${imageUrl ? `<img src="${imageUrl}" alt="${product.title}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-gray-400">üì¶</div>'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-lg truncate">${product.title}</h3>
                                    <p class="text-sm text-gray-600">${product.category_name}</p>
                                    <p class="text-sm text-gray-500">Gi√°: ${(product.market_price / 1000000).toFixed(2)}M - ${(product.category_price / 1000000).toFixed(2)}M</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                ${hasConfig ? `
                                    <div class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                        ${config.survey_category === 'solar_panel' ? '‚òÄÔ∏è T·∫•m Pin' : 
                                          config.survey_category === 'inverter' ? 'üîå Inverter' : 
                                          config.survey_category === 'battery' ? 'üîã Pin' : 
                                          config.survey_category === 'electrical_cabinet' ? '‚ö° T·ªß ƒêi·ªán' : 'üîß Ph·ª• Ki·ªán'}
                                        ${config.phase_type !== 'none' ? ` (${config.phase_type})` : ''}
                                        ${!config.is_active ? ' - T·∫Øt' : ''}
                                    </div>
                                    <button onclick="openSurveyConfigModal(${product.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                        S·ª≠a
                                    </button>
                                    <button onclick="deleteSurveyConfig(${product.id})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                                        X√≥a
                                    </button>
                                ` : `
                                    <button onclick="openSurveyConfigModal(${product.id})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                        + C·∫•u h√¨nh
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
                 let currentSurveyProducts = [];
         
         async function openSurveyConfigModal(productId) {
             const modal = document.getElementById('surveyConfigModal');
             const form = document.getElementById('surveyConfigForm');
             
             // Load product info
             const product = currentSurveyProducts.find(p => p.id === productId);
             if (!product) {
                 showToast('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                 return;
             }
             
             // Reset form
             form.reset();
             document.getElementById('survey_product_id').value = productId;
             document.getElementById('surveyConfigModalTitle').textContent = `C·∫•u h√¨nh: ${product.title}`;
             
             // Fill existing config if any
            if (product.has_survey_config && product.survey_config) {
                 const config = product.survey_config;
                 document.getElementById('survey_category').value = config.survey_category;
                 document.getElementById('survey_phase_type').value = config.phase_type;
                 document.getElementById('survey_price_type').value = config.price_type;
                document.getElementById('survey_display_order').value = (config.display_order && config.display_order !== 0) ? config.display_order : '';
                document.getElementById('survey_is_active').checked = !!config.is_active;
                 
                updateSurveyPhaseField();
               // fill numeric specs (inverter stored as W -> display as kW)
                const fill = (id, val) => { const el = document.getElementById(id); if (el) el.value = (val ?? ''); };
                fill('survey_panel_power_watt', config.panel_power_watt);
                fill('survey_inverter_power_watt', config.inverter_power_watt ? (config.inverter_power_watt/1000) : '');
                fill('survey_battery_capacity_kwh', config.battery_capacity_kwh);
                fill('survey_cabinet_power_kw', config.cabinet_power_kw);
                // accessory fields
                const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = (val ?? ''); };
                console.debug('Accessory config for product', productId, {
                    unit: config.accessory_unit,
                    base: config.accessory_base_qty,
                    dep: config.accessory_dependent_qty,
                    target: config.accessory_dependent_target
                });
                setVal('survey_accessory_unit', config.accessory_unit || '');
                setVal('survey_accessory_base_qty', (config.accessory_base_qty ?? ''));
                setVal('survey_accessory_dependent_qty', (config.accessory_dependent_qty ?? ''));
                setVal('survey_accessory_dependent_target', config.accessory_dependent_target || '');
                // Re-log applied values
                console.debug('Accessory form values applied', {
                    unit: document.getElementById('survey_accessory_unit')?.value,
                    base: document.getElementById('survey_accessory_base_qty')?.value,
                    dep: document.getElementById('survey_accessory_dependent_qty')?.value,
                    target: document.getElementById('survey_accessory_dependent_target')?.value
                });
                // IMPORTANT: re-apply is_active after fields are populated because
                // earlier validation may temporarily uncheck it
                document.getElementById('survey_is_active').checked = !!config.is_active;
            }
            // Update activation UI state initially
            updateSurveyActivationState();
             
             modal.classList.add('show');
         }
         
         function closeSurveyConfigModal() {
             document.getElementById('surveyConfigModal').classList.remove('show');
         }
         
         function updateSurveyPhaseField() {
             const category = document.getElementById('survey_category').value;
             const phaseField = document.getElementById('survey_phase_field');
             const phaseInput = document.getElementById('survey_phase_type');
             
            if (category === 'inverter' || category === 'electrical_cabinet') {
                 phaseField.classList.remove('hidden');
                 phaseInput.setAttribute('required', 'required');
             } else {
                 phaseField.classList.add('hidden');
                 phaseInput.removeAttribute('required');
                 phaseInput.value = 'none';
             }
            // Toggle spec inputs
            const specPanel = document.getElementById('survey_spec_panel');
            const specInverter = document.getElementById('survey_spec_inverter');
            const specBattery = document.getElementById('survey_battery_capacity_kwh')?.closest('div');
            const specCabinet = document.getElementById('survey_cabinet_power_kw')?.closest('div');
            const specAccessory = document.getElementById('survey_spec_accessory');
            if (specPanel && specInverter && specBattery && specCabinet) {
                specPanel.classList.add('hidden');
                specInverter.classList.add('hidden');
                specBattery.classList.add('hidden');
                specCabinet.classList.add('hidden');
                if (specAccessory) specAccessory.classList.add('hidden');
                if (category === 'solar_panel') specPanel.classList.remove('hidden');
                if (category === 'inverter') specInverter.classList.remove('hidden');
                if (category === 'battery') specBattery.classList.remove('hidden');
                if (category === 'electrical_cabinet') specCabinet.classList.remove('hidden');
                if (category === 'accessory' && specAccessory) specAccessory.classList.remove('hidden');
            }
            // Re-evaluate activation state when category/phase changes
            updateSurveyActivationState();
         }

         function updateSurveyActivationState() {
            const category = document.getElementById('survey_category').value;
            const phaseFieldHidden = document.getElementById('survey_phase_field').classList.contains('hidden');
            const phaseType = phaseFieldHidden ? 'none' : document.getElementById('survey_phase_type').value;
            const isActiveEl = document.getElementById('survey_is_active');
            const statusEl = document.getElementById('survey_active_status_text');

            const panelW = parseInt(document.getElementById('survey_panel_power_watt')?.value || '');
            const invKW = parseFloat(document.getElementById('survey_inverter_power_watt')?.value || '');
            const battKwh = parseFloat(document.getElementById('survey_battery_capacity_kwh')?.value || '');
            const cabKW = parseFloat(document.getElementById('survey_cabinet_power_kw')?.value || '');

            let ready = false;
            if (category === 'solar_panel') ready = !!panelW && panelW > 0;
            else if (category === 'inverter') ready = phaseType !== 'none' && !!invKW && invKW > 0;
            else if (category === 'battery') ready = !!battKwh && battKwh > 0;
            else if (category === 'electrical_cabinet') ready = phaseType !== 'none' && !!cabKW && cabKW > 0;
            else if (category === 'accessory') {
                const accUnit = document.getElementById('survey_accessory_unit')?.value || '';
                const accBase = parseFloat(document.getElementById('survey_accessory_base_qty')?.value || '');
                const accDep = parseFloat(document.getElementById('survey_accessory_dependent_qty')?.value || '');
                const accTarget = document.getElementById('survey_accessory_dependent_target')?.value || '';
                // depQty c√≥ th·ªÉ b·ªè tr·ªëng (m·∫∑c ƒë·ªãnh 1)
                ready = !!accUnit && !isNaN(accBase) && !!accTarget;
            } else ready = true;

            isActiveEl.disabled = !ready;
            if (!ready) {
                isActiveEl.checked = false;
                statusEl.textContent = 'Tr·∫°ng th√°i: Ch∆∞a k√≠ch ho·∫°t (c·∫ßn nh·∫≠p ƒë·ªß th√¥ng s·ªë)';
                statusEl.className = 'text-xs mt-1 font-semibold text-red-600';
            } else {
                statusEl.textContent = isActiveEl.checked ? 'Tr·∫°ng th√°i: ƒê√É k√≠ch ho·∫°t' : 'Tr·∫°ng th√°i: Ch∆∞a k√≠ch ho·∫°t';
                statusEl.className = 'text-xs mt-1 font-semibold ' + (isActiveEl.checked ? 'text-green-600' : 'text-gray-600');
            }
         }

         // Watch inputs to toggle activation availability
         document.addEventListener('input', function(e){
            if (e.target && ['survey_category','survey_phase_type','survey_panel_power_watt','survey_inverter_power_watt','survey_battery_capacity_kwh','survey_cabinet_power_kw','survey_accessory_unit','survey_accessory_base_qty','survey_accessory_dependent_qty','survey_accessory_dependent_target'].includes(e.target.id)) {
                updateSurveyActivationState();
            }
         });
         document.getElementById('survey_is_active').addEventListener('change', updateSurveyActivationState);
         
         async function saveSurveyConfig(event) {
             event.preventDefault();
             
             const productId = parseInt(document.getElementById('survey_product_id').value);
             const surveyCategory = document.getElementById('survey_category').value;
             const phaseType = document.getElementById('survey_phase_field').classList.contains('hidden') 
                 ? 'none' 
                 : document.getElementById('survey_phase_type').value;
             const priceType = document.getElementById('survey_price_type').value;
             const displayOrderRaw = (document.getElementById('survey_display_order').value || '').toString().trim();
             const displayOrder = displayOrderRaw === '' ? '' : (parseInt(displayOrderRaw) || 0);
             const isActive = document.getElementById('survey_is_active').checked;
             
            // Require full config before allowing activation
            const statusBefore = document.getElementById('survey_active_status_text');
            const panelW = parseInt(document.getElementById('survey_panel_power_watt')?.value || '');
            const invKW = parseFloat(document.getElementById('survey_inverter_power_watt')?.value || '');
            const battKwh = parseFloat(document.getElementById('survey_battery_capacity_kwh')?.value || '');
            const cabKW = parseFloat(document.getElementById('survey_cabinet_power_kw')?.value || '');
            // Accessory fields
            const accUnit = document.getElementById('survey_accessory_unit')?.value || '';
            const accBase = parseFloat(document.getElementById('survey_accessory_base_qty')?.value || '');
            const accDep = parseFloat(document.getElementById('survey_accessory_dependent_qty')?.value || '');
            const accTarget = document.getElementById('survey_accessory_dependent_target')?.value || '';
            let ready = false;
            if (surveyCategory === 'solar_panel') ready = !!panelW && panelW > 0;
            else if (surveyCategory === 'inverter') ready = phaseType !== 'none' && !!invKW && invKW > 0;
            else if (surveyCategory === 'battery') ready = !!battKwh && battKwh > 0;
            else if (surveyCategory === 'electrical_cabinet') ready = phaseType !== 'none' && !!cabKW && cabKW > 0;
            else if (surveyCategory === 'accessory') ready = !!accUnit && (!isNaN(accBase)) && !!accTarget;
            else ready = true;
            if (isActive && !ready) {
                showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng s·ªë b·∫Øt bu·ªôc tr∆∞·ªõc khi k√≠ch ho·∫°t.', 'warning');
                return;
            }

            // Duplicate display order check (only if provided)
            if (displayOrderRaw !== '') {
                const dup = currentSurveyProducts.some(p => p.has_survey_config && p.survey_config && p.id !== productId && p.survey_config.survey_category === surveyCategory && p.survey_config.display_order == parseInt(displayOrder));
                if (dup) {
                    showToast('Th·ª© t·ª± hi·ªÉn th·ªã ƒë√£ b·ªã tr√πng trong nh√≥m. Vui l√≤ng ch·ªçn s·ªë kh√°c.', 'warning');
                    return;
                }
            }
            try {
                // Convert inverter kW -> W if provided
                let inverterKW = document.getElementById('survey_inverter_power_watt')?.value;
                let inverterWattPayload = '';
                if (inverterKW !== undefined && inverterKW !== null && `${inverterKW}`.trim() !== '') {
                    const kwNum = parseFloat(inverterKW);
                    if (!isNaN(kwNum)) inverterWattPayload = Math.round(kwNum * 1000);
                }
                 const response = await fetch(`${API_BASE}/admin/save_survey_product_config.php`, {
                     method: 'POST',
                     credentials: 'include',
                     headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                         product_id: productId,
                         survey_category: surveyCategory,
                         phase_type: phaseType,
                         price_type: priceType,
                         display_order: displayOrder,
                         is_active: isActive,
                        panel_power_watt: document.getElementById('survey_panel_power_watt')?.value || '',
                        inverter_power_watt: inverterWattPayload,
                        battery_capacity_kwh: document.getElementById('survey_battery_capacity_kwh')?.value || '',
                         cabinet_power_kw: document.getElementById('survey_cabinet_power_kw')?.value || '',
                         accessory_unit: accUnit,
                         accessory_base_qty: isNaN(accBase) ? '' : accBase,
                         accessory_dependent_qty: isNaN(accDep) ? '' : accDep,
                         accessory_dependent_target: accTarget
                     })
                 });
                 
                 if (!response.ok) {
                     const errorText = await response.text();
                     console.error('Server error:', response.status, errorText);
                     showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                     return;
                 }
                 
                 const data = await response.json();
                 if (data.success) {
                     showToast(data.message, 'success');
                     closeSurveyConfigModal();
                     loadSurveyProducts();
                 } else {
                     showToast(data.message, 'error');
                 }
             } catch (error) {
                 console.error('Error saving survey config:', error);
                 showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u c·∫•u h√¨nh: ' + error.message, 'error');
             }
         }
        
        async function deleteSurveyConfig(productId) {
            if (!await customConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c·∫•u h√¨nh kh·∫£o s√°t n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_survey_product_config.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    showToast('L·ªói server: ' + response.status + '. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadSurveyProducts();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting survey config:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a: ' + error.message, 'error');
            }
        }

        // ============================================
        // SURVEY REGIONS MANAGEMENT
        // ============================================
        
        async function loadSurveyRegions() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_survey_regions.php`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load survey regions');
                }
                
                const data = await response.json();
                if (data.success) {
                    displaySurveyRegions(data.regions);
                } else {
                    // Only show error if it's not a permission issue (permission should be checked before loading)
                    if (data.message && !data.message.includes('quy·ªÅn')) {
                    showToast(data.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Error loading survey regions:', error);
                // Only show error if it's not a permission issue
                if (!error.message.includes('quy·ªÅn')) {
                showToast('C√≥ l·ªói khi t·∫£i danh s√°ch khu v·ª±c', 'error');
                }
            }
        }
        
        function displaySurveyRegions(regions) {
            const tbody = document.getElementById('survey-regions-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = regions.map(region => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 border">
                        <input type="text" 
                               class="w-full px-2 py-1 border rounded bg-gray-100" 
                               value="${region.region_code}" 
                               data-id="${region.id}" 
                               data-field="region_code" 
                               readonly 
                               title="M√£ khu v·ª±c kh√¥ng ƒë∆∞·ª£c thay ƒë·ªïi" />
                    </td>
                    <td class="px-4 py-3 border">
                        <input type="text" 
                               class="w-full px-2 py-1 border rounded" 
                               value="${region.region_name}" 
                               data-id="${region.id}" 
                               data-field="region_name" 
                               placeholder="VD: Mi·ªÅn B·∫Øc" />
                    </td>
                    <td class="px-4 py-3 border">
                        <input type="text" 
                               class="w-full px-2 py-1 border rounded" 
                               value="${region.display_content}" 
                               data-id="${region.id}" 
                               data-field="display_content" 
                               placeholder="VD: Mi·ªÅn B·∫Øc (4,4 gi·ªù n·∫Øng/ng√†y)" />
                    </td>
                    <td class="px-4 py-3 border text-center">
                        <input type="number" 
                               class="w-24 px-2 py-1 border rounded text-center" 
                               value="${region.sun_hours}" 
                               data-id="${region.id}" 
                               data-field="sun_hours" 
                               step="0.1" 
                               min="0" 
                               max="12" />
                    </td>
                    <td class="px-4 py-3 border text-center">
                        <input type="number" 
                               class="w-20 px-2 py-1 border rounded text-center" 
                               value="${region.display_order}" 
                               data-id="${region.id}" 
                               data-field="display_order" 
                               min="0" />
                    </td>
                    <td class="px-4 py-3 border text-center">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="form-checkbox h-5 w-5 text-green-600" 
                                   ${region.is_active ? 'checked' : ''} 
                                   data-id="${region.id}" 
                                   data-field="is_active" />
                            <span class="ml-2 text-sm">${region.is_active ? 'Hi·ªÉn th·ªã' : '·∫®n'}</span>
                        </label>
                    </td>
                </tr>
            `).join('');
        }
        
        async function saveSurveyRegions() {
            try {
                // Collect all data from inputs
                const regions = [];
                const rows = document.querySelectorAll('#survey-regions-tbody tr');
                
                rows.forEach(row => {
                    const id = row.querySelector('input[data-field="region_code"]').getAttribute('data-id');
                    const region_code = row.querySelector('input[data-field="region_code"]').value;
                    const region_name = row.querySelector('input[data-field="region_name"]').value;
                    const display_content = row.querySelector('input[data-field="display_content"]').value;
                    const sun_hours = parseFloat(row.querySelector('input[data-field="sun_hours"]').value);
                    const display_order = parseInt(row.querySelector('input[data-field="display_order"]').value);
                    const is_active = row.querySelector('input[data-field="is_active"]').checked;
                    
                    regions.push({
                        id: parseInt(id),
                        region_code,
                        region_name,
                        display_content,
                        sun_hours,
                        display_order,
                        is_active
                    });
                });
                
                // Send to API
                const response = await fetch(`${API_BASE}/admin/save_survey_regions.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ regions })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadSurveyRegions(); // Reload to show updated data
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving survey regions:', error);
                showToast('C√≥ l·ªói khi l∆∞u danh s√°ch khu v·ª±c', 'error');
            }
        }

        // ============================================
        // ELECTRICITY PRICES MANAGEMENT
        // ============================================
        
        async function loadElectricityPrices() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_electricity_prices.php`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load electricity prices');
                }
                
                const data = await response.json();
                if (data.success) {
                    displayElectricityPrices(data.prices);
                } else {
                    // Only show error if it's not a permission issue (permission should be checked before loading)
                    if (data.message && !data.message.includes('quy·ªÅn')) {
                    showToast(data.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Error loading electricity prices:', error);
                // Only show error if it's not a permission issue
                if (!error.message.includes('quy·ªÅn')) {
                showToast('C√≥ l·ªói khi t·∫£i b·∫£ng gi√° ƒëi·ªán', 'error');
                }
            }
        }
        
        function displayElectricityPrices(prices) {
            const tbody = document.getElementById('electricity-prices-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = prices.map(price => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 border text-center">
                        <input type="number" 
                               class="w-16 px-2 py-1 border rounded text-center" 
                               value="${price.tier}" 
                               data-id="${price.id}" 
                               data-field="tier" 
                               readonly />
                    </td>
                    <td class="px-4 py-3 border">
                        <input type="text" 
                               class="w-full px-2 py-1 border rounded" 
                               value="${price.tier_name}" 
                               data-id="${price.id}" 
                               data-field="tier_name" 
                               placeholder="VD: B·∫≠c 1: 0-50 kWh" />
                    </td>
                    <td class="px-4 py-3 border text-center">
                        <input type="number" 
                               class="w-24 px-2 py-1 border rounded text-center" 
                               value="${price.kwh_from}" 
                               data-id="${price.id}" 
                               data-field="kwh_from" 
                               min="0" />
                    </td>
                    <td class="px-4 py-3 border text-center">
                        <input type="number" 
                               class="w-24 px-2 py-1 border rounded text-center" 
                               value="${price.kwh_to || ''}" 
                               data-id="${price.id}" 
                               data-field="kwh_to" 
                               min="0" 
                               placeholder="0 = ‚àû" />
                    </td>
                    <td class="px-4 py-3 border text-right">
                        <input type="number" 
                               class="w-32 px-2 py-1 border rounded text-right" 
                               value="${price.price_no_vat}" 
                               data-id="${price.id}" 
                               data-field="price_no_vat" 
                               step="0.01" 
                               min="0" 
                               onchange="calculateVATPrice(this)" />
                    </td>
                    <td class="px-4 py-3 border text-right">
                        <input type="number" 
                               class="w-32 px-2 py-1 border rounded text-right bg-gray-50" 
                               value="${price.price_with_vat}" 
                               data-id="${price.id}" 
                               data-field="price_with_vat" 
                               step="0.01" 
                               min="0" />
                    </td>
                    <td class="px-4 py-3 border text-center">
                        <input type="date" 
                               class="px-2 py-1 border rounded" 
                               value="${price.effective_date}" 
                               data-id="${price.id}" 
                               data-field="effective_date" />
                    </td>
                    <td class="px-4 py-3 border text-center">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="form-checkbox h-5 w-5 text-green-600" 
                                   ${price.is_active ? 'checked' : ''} 
                                   data-id="${price.id}" 
                                   data-field="is_active" />
                            <span class="ml-2 text-sm">${price.is_active ? 'ƒêang d√πng' : 'Kh√¥ng d√πng'}</span>
                        </label>
                    </td>
                </tr>
            `).join('');
        }
        
        function calculateVATPrice(inputElement) {
            const priceNoVat = parseFloat(inputElement.value) || 0;
            const priceWithVat = (priceNoVat * 1.08).toFixed(2);
            
            const id = inputElement.getAttribute('data-id');
            const vatInput = document.querySelector(`input[data-id="${id}"][data-field="price_with_vat"]`);
            if (vatInput) {
                vatInput.value = priceWithVat;
            }
        }
        
        async function saveElectricityPrices() {
            try {
                // Collect all data from inputs
                const prices = [];
                const rows = document.querySelectorAll('#electricity-prices-tbody tr');
                
                rows.forEach(row => {
                    const id = row.querySelector('input[data-field="tier"]').getAttribute('data-id');
                    const tier = parseInt(row.querySelector('input[data-field="tier"]').value);
                    const tier_name = row.querySelector('input[data-field="tier_name"]').value;
                    const kwh_from = parseInt(row.querySelector('input[data-field="kwh_from"]').value);
                    const kwh_to_value = row.querySelector('input[data-field="kwh_to"]').value;
                    const kwh_to = kwh_to_value && kwh_to_value !== '0' ? parseInt(kwh_to_value) : null;
                    const price_no_vat = parseFloat(row.querySelector('input[data-field="price_no_vat"]').value);
                    const price_with_vat = parseFloat(row.querySelector('input[data-field="price_with_vat"]').value);
                    const effective_date = row.querySelector('input[data-field="effective_date"]').value;
                    const is_active = row.querySelector('input[data-field="is_active"]').checked;
                    
                    prices.push({
                        id: parseInt(id),
                        tier,
                        tier_name,
                        kwh_from,
                        kwh_to,
                        price_no_vat,
                        price_with_vat,
                        effective_date,
                        is_active
                    });
                });
                
                // Send to API
                const response = await fetch(`${API_BASE}/admin/save_electricity_prices.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ prices })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadElectricityPrices(); // Reload to show updated data
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving electricity prices:', error);
                showToast('C√≥ l·ªói khi l∆∞u b·∫£ng gi√° ƒëi·ªán', 'error');
            }
        }

        // Utility: Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Toast Notification System
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast-enter flex items-center gap-3 p-4 mb-3 rounded-lg shadow-lg max-w-md ${
                type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-yellow-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            
            const icon = type === 'success' ? '‚úì' :
                        type === 'error' ? '‚úï' :
                        type === 'warning' ? '‚ö†' : '‚Ñπ';
            
            toast.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-white bg-opacity-20 text-xl font-bold">
                    ${icon}
                </div>
                <div class="flex-1 font-medium">${message}</div>
                <button onclick="this.parentElement.remove()" class="flex-shrink-0 hover:bg-white hover:bg-opacity-20 rounded p-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ============================================
        // INTRO POSTS MANAGEMENT
        // ============================================
        
        let currentIntroPosts = [];

        async function loadIntroPosts() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_intro_posts.php`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    currentIntroPosts = data.posts;
                    displayIntroPosts(data.posts);
                }
            } catch (error) {
                console.error('Error loading intro posts:', error);
                showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i vi·∫øt', 'error');
            }
        }

        function displayIntroPosts(posts) {
            const tbody = document.getElementById('intro-posts-tbody');
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Kh√¥ng c√≥ b√†i vi·∫øt n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = posts.map(post => `
                <tr class="border-t">
                    <td class="px-4 py-3">${post.display_order}</td>
                    <td class="px-4 py-3 font-semibold">${post.title}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${post.description ? post.description.substring(0, 100) + '...' : ''}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${post.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${post.is_active ? 'Hi·ªÉn th·ªã' : '·∫®n'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="openIntroPostModal(${post.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">‚úèÔ∏è</button>
                        <button onclick="deleteIntroPost(${post.id})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 ml-2">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        async function openIntroPostModal(id = 0) {
            const modal = document.getElementById('introPostModal');
            document.getElementById('introPostModalTitle').textContent = id ? 'S·ª≠a b√†i vi·∫øt' : 'Th√™m b√†i vi·∫øt';
            
            if (id > 0) {
                // Convert id to string for comparison since API returns string IDs
                const idString = String(id);
                
                // Try to find post in current array first
                let post = currentIntroPosts.find(p => String(p.id) === idString);
                
                // If not found, reload data from server
                if (!post) {
                    try {
                        const response = await fetch(`${API_BASE}/admin/get_intro_posts.php`, {
                            credentials: 'include'
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            currentIntroPosts = data.posts;
                            post = data.posts.find(p => String(p.id) === idString);
                        }
                    } catch (error) {
                        console.error('Error loading post:', error);
                        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin b√†i vi·∫øt', 'error');
                        return;
                    }
                }
                
                // If still not found, show error
                if (!post) {
                    showToast('Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt', 'error');
                    return;
                }
                
                document.getElementById('intro_post_id').value = post.id;
                document.getElementById('intro_post_title').value = post.title;
                document.getElementById('intro_post_description').value = post.description || '';
                document.getElementById('intro_post_display_order').value = post.display_order;
                document.getElementById('intro_post_is_active').checked = post.is_active;
                
                // Clear file inputs when editing (no need to set value for file inputs)
                document.getElementById('intro_post_image').value = '';
                document.getElementById('intro_post_video').value = '';
                
                // Show previews if URLs exist
                if (post.image_url) {
                    previewIntroPostImage(post.image_url);
                    document.getElementById('btn_remove_image').classList.remove('hidden');
                } else {
                    document.getElementById('btn_remove_image').classList.add('hidden');
                }
                
                if (post.video_url) {
                    previewIntroPostVideo(post.video_url);
                    document.getElementById('btn_remove_video').classList.remove('hidden');
                } else {
                    document.getElementById('btn_remove_video').classList.add('hidden');
                }
                
                // Initialize Media Gallery for editing
                if (!window.introPostMediaGallery) {
                    window.introPostMediaGallery = initMediaGallery(
                        'intro_post_media_gallery_container',
                        API_BASE + '/admin/upload_intro_media.php'
                    );
                }
                
                // Load media gallery
                if (post.media_gallery) {
                    window.introPostMediaGallery.loadFromJSON(post.media_gallery);
                } else {
                    window.introPostMediaGallery.loadFromJSON('[]');
                }
            } else {
                // Adding new post
                document.getElementById('introPostForm').reset();
                document.getElementById('intro_post_id').value = '';
                // Hide previews when adding new post
                document.getElementById('intro_post_image_preview').classList.add('hidden');
                document.getElementById('intro_post_video_preview').classList.add('hidden');
                document.getElementById('btn_remove_image').classList.add('hidden');
                document.getElementById('btn_remove_video').classList.add('hidden');
                
                // Initialize Media Gallery for new post
                if (!window.introPostMediaGallery) {
                    window.introPostMediaGallery = initMediaGallery(
                        'intro_post_media_gallery_container',
                        API_BASE + '/admin/upload_intro_media.php'
                    );
                }
                window.introPostMediaGallery.loadFromJSON('[]');
            }
            
            modal.classList.add('show');
        }

        function closeIntroPostModal() {
            document.getElementById('introPostModal').classList.remove('show');
            // Clear previews when closing
            document.getElementById('intro_post_image_preview').classList.add('hidden');
            document.getElementById('intro_post_video_preview').classList.add('hidden');
        }
        
        function previewIntroPostImage(imageUrl) {
            const previewDiv = document.getElementById('intro_post_image_preview');
            const img = previewDiv.querySelector('img');
            
            if (imageUrl && imageUrl.trim()) {
                img.src = imageUrl;
                previewDiv.classList.remove('hidden');
            } else {
                previewDiv.classList.add('hidden');
            }
        }
        
        function previewIntroPostVideo(videoUrl) {
            const previewDiv = document.getElementById('intro_post_video_preview');
            const video = previewDiv.querySelector('video');
            
            if (videoUrl && videoUrl.trim()) {
                video.querySelector('source').src = videoUrl;
                video.load(); // Reload video with new source
                previewDiv.classList.remove('hidden');
            } else {
                previewDiv.classList.add('hidden');
            }
        }
        
        function previewIntroPostImageFromFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById('intro_post_image_preview');
                    const img = previewDiv.querySelector('img');
                    img.src = e.target.result;
                    previewDiv.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function previewIntroPostVideoFromFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const previewDiv = document.getElementById('intro_post_video_preview');
                const video = previewDiv.querySelector('video');
                const source = video.querySelector('source');
                source.src = URL.createObjectURL(file);
                video.load();
                previewDiv.classList.remove('hidden');
                document.getElementById('btn_remove_video').classList.remove('hidden');
            }
        }
        
        function removeIntroImage() {
            document.getElementById('intro_post_image').value = '';
            document.getElementById('intro_post_image_preview').classList.add('hidden');
            document.getElementById('btn_remove_image').classList.add('hidden');
            // Add hidden input to indicate image should be deleted
            const existingInput = document.getElementById('delete_image_flag');
            if (existingInput) existingInput.remove();
            const deleteFlag = document.createElement('input');
            deleteFlag.type = 'hidden';
            deleteFlag.id = 'delete_image_flag';
            deleteFlag.name = 'delete_image';
            deleteFlag.value = '1';
            document.getElementById('introPostForm').appendChild(deleteFlag);
        }
        
        function removeIntroVideo() {
            document.getElementById('intro_post_video').value = '';
            document.getElementById('intro_post_video_preview').classList.add('hidden');
            document.getElementById('btn_remove_video').classList.add('hidden');
            // Add hidden input to indicate video should be deleted
            const existingInput = document.getElementById('delete_video_flag');
            if (existingInput) existingInput.remove();
            const deleteFlag = document.createElement('input');
            deleteFlag.type = 'hidden';
            deleteFlag.id = 'delete_video_flag';
            deleteFlag.name = 'delete_video';
            deleteFlag.value = '1';
            document.getElementById('introPostForm').appendChild(deleteFlag);
        }
        
        async function uploadIntroMedia(mediaType, file) {
            if (!file) return;
            
            // Validate file size (50MB max)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showToast(`File qu√° l·ªõn. Gi·ªõi h·∫°n 50MB`, 'error');
                return;
            }
            
            // Show upload status
            const statusId = `intro_post_${mediaType}_upload_status`;
            const statusEl = document.getElementById(statusId);
            statusEl.innerHTML = '<span class="text-blue-600">üì§ ƒêang t·∫£i l√™n...</span>';
            
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            formData.append('media_type', mediaType);
            
            try {
                const response = await fetch(`${API_BASE}/admin/upload_intro_media.php`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                // Check for 413 or other HTTP errors
                if (response.status === 413) {
                    statusEl.innerHTML = '<span class="text-red-600">‚ùå File qu√° l·ªõn (v∆∞·ª£t qu√° 50MB)</span>';
                    showToast('File qu√° l·ªõn. Vui l√≤ng ch·ªçn file nh·ªè h∆°n ho·∫∑c n√©n file tr∆∞·ªõc khi upload', 'error');
                    return;
                }
                
                // Try to parse JSON, handle HTML error pages
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // Server returned HTML error page instead of JSON
                    console.error('Server returned non-JSON response:', response);
                    statusEl.innerHTML = '<span class="text-red-600">‚ùå Server l·ªói (kh√¥ng tr·∫£ v·ªÅ JSON)</span>';
                    showToast('Server l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau', 'error');
                    return;
                }
                
                if (data.success) {
                    statusEl.innerHTML = '<span class="text-green-600">‚úÖ T·∫£i l√™n th√†nh c√¥ng!</span>';
                    
                    // Set the URL in the respective input
                    const urlInputId = mediaType === 'image' ? 'intro_post_image_url' : 'intro_post_video_url';
                    const urlInput = document.getElementById(urlInputId);
                    urlInput.value = data.url;
                    
                    // Clear the upload input
                    const uploadInputId = mediaType === 'image' ? 'intro_post_image_upload' : 'intro_post_video_upload';
                    document.getElementById(uploadInputId).value = '';
                    
                    // Show preview
                    if (mediaType === 'image') {
                        previewIntroPostImage(data.url);
                    } else {
                        previewIntroPostVideo(data.url);
                    }
                    
                    showToast(`${mediaType === 'image' ? '·∫¢nh' : 'Video'} ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n th√†nh c√¥ng`, 'success');
                    
                    // Clear status after 3 seconds
                    setTimeout(() => {
                        statusEl.innerHTML = '';
                    }, 3000);
                } else {
                    statusEl.innerHTML = `<span class="text-red-600">‚ùå ${data.message || 'L·ªói khi t·∫£i l√™n'}</span>`;
                    showToast(data.message || 'L·ªói khi t·∫£i file l√™n', 'error');
                }
            } catch (error) {
                statusEl.innerHTML = '<span class="text-red-600">‚ùå L·ªói k·∫øt n·ªëi</span>';
                console.error('Upload error:', error);
                showToast('L·ªói k·∫øt n·ªëi v·ªõi server', 'error');
            }
        }

        async function saveIntroPost(event) {
            event.preventDefault();
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-spin mr-2">‚è≥</span> ƒêang l∆∞u...';
            
            try {
                // Create FormData from form (includes file uploads)
                const formData = new FormData(event.target);
                
                // Add additional fields that may not be in form directly
                formData.append('id', document.getElementById('intro_post_id').value);
                formData.append('display_order', document.getElementById('intro_post_display_order').value);
                formData.append('is_active', document.getElementById('intro_post_is_active').checked ? '1' : '0');
                
                // Add media gallery JSON
                if (window.introPostMediaGallery) {
                    formData.append('media_gallery', window.introPostMediaGallery.toJSON());
                }
                
                const response = await fetch(`${API_BASE}/admin/save_intro_post.php`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }

                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeIntroPostModal();
                    loadIntroPosts();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving intro post:', error);
                showToast('C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
            } finally {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function deleteIntroPost(id) {
            if (!await customConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_intro_post.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadIntroPosts();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting intro post:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a: ' + error.message, 'error');
            }
        }

        // ============================================
        // PROJECTS MANAGEMENT
        // ============================================
        
        let currentProjects = [];

        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_projects.php`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    currentProjects = data.projects;
                    displayProjects(data.projects);
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch d·ª± √°n', 'error');
            }
        }

        function displayProjects(projects) {
            const tbody = document.getElementById('projects-tbody-admin');
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Kh√¥ng c√≥ d·ª± √°n n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(project => `
                <tr class="border-t">
                    <td class="px-4 py-3">${project.display_order}</td>
                    <td class="px-4 py-3 font-semibold">${project.title}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${project.description ? project.description.substring(0, 100) + '...' : ''}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${project.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${project.is_active ? 'Hi·ªÉn th·ªã' : '·∫®n'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="openProjectModal(${project.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">‚úèÔ∏è</button>
                        <button onclick="deleteProject(${project.id})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 ml-2">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        async function openProjectModal(id = 0) {
            const modal = document.getElementById('projectModal');
            document.getElementById('projectModalTitle').textContent = id ? 'S·ª≠a d·ª± √°n' : 'Th√™m d·ª± √°n';
            
            if (id > 0) {
                const idString = String(id);
                
                let project = currentProjects.find(p => String(p.id) === idString);
                
                if (!project) {
                    try {
                        const response = await fetch(`${API_BASE}/admin/get_projects.php`, {
                            credentials: 'include'
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            currentProjects = data.projects;
                            project = data.projects.find(p => String(p.id) === idString);
                        }
                    } catch (error) {
                        console.error('Error loading project:', error);
                        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin d·ª± √°n', 'error');
                        return;
                    }
                }
                
                if (!project) {
                    showToast('Kh√¥ng t√¨m th·∫•y d·ª± √°n', 'error');
                    return;
                }
                
                document.getElementById('project_id').value = project.id;
                document.getElementById('project_title').value = project.title;
                document.getElementById('project_description').value = project.description || '';
                document.getElementById('project_display_order').value = project.display_order;
                document.getElementById('project_is_active').checked = project.is_active;
                
                document.getElementById('project_image').value = '';
                document.getElementById('project_video').value = '';
                
                if (project.image_url) {
                    previewProjectImage(project.image_url);
                    document.getElementById('btn_remove_project_image').classList.remove('hidden');
                } else {
                    document.getElementById('btn_remove_project_image').classList.add('hidden');
                }
                
                if (project.video_url) {
                    previewProjectVideo(project.video_url);
                    document.getElementById('btn_remove_project_video').classList.remove('hidden');
                } else {
                    document.getElementById('btn_remove_project_video').classList.add('hidden');
                }
                
                // Initialize Media Gallery for editing
                if (!window.projectMediaGallery) {
                    window.projectMediaGallery = initMediaGallery(
                        'project_media_gallery_container',
                        API_BASE + '/admin/upload_project_media.php'
                    );
                }
                
                // Load media gallery
                if (project.media_gallery) {
                    window.projectMediaGallery.loadFromJSON(project.media_gallery);
                } else {
                    window.projectMediaGallery.loadFromJSON('[]');
                }
            } else {
                // Adding new project
                document.getElementById('projectForm').reset();
                document.getElementById('project_id').value = '';
                document.getElementById('project_image_preview').classList.add('hidden');
                document.getElementById('project_video_preview').classList.add('hidden');
                document.getElementById('btn_remove_project_image').classList.add('hidden');
                document.getElementById('btn_remove_project_video').classList.add('hidden');
                
                // Initialize Media Gallery for new project
                if (!window.projectMediaGallery) {
                    window.projectMediaGallery = initMediaGallery(
                        'project_media_gallery_container',
                        API_BASE + '/admin/upload_project_media.php'
                    );
                }
                window.projectMediaGallery.loadFromJSON('[]');
            }
            
            modal.classList.add('show');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
            document.getElementById('project_image_preview').classList.add('hidden');
            document.getElementById('project_video_preview').classList.add('hidden');
        }
        
        function previewProjectImage(imageUrl) {
            const previewDiv = document.getElementById('project_image_preview');
            const img = previewDiv.querySelector('img');
            
            if (imageUrl && imageUrl.trim()) {
                img.src = imageUrl;
                previewDiv.classList.remove('hidden');
            } else {
                previewDiv.classList.add('hidden');
            }
        }
        
        function previewProjectVideo(videoUrl) {
            const previewDiv = document.getElementById('project_video_preview');
            const video = previewDiv.querySelector('video');
            
            if (videoUrl && videoUrl.trim()) {
                video.querySelector('source').src = videoUrl;
                video.load();
                previewDiv.classList.remove('hidden');
            } else {
                previewDiv.classList.add('hidden');
            }
        }
        
        function previewProjectImageFromFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById('project_image_preview');
                    const img = previewDiv.querySelector('img');
                    img.src = e.target.result;
                    previewDiv.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function previewProjectVideoFromFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const previewDiv = document.getElementById('project_video_preview');
                const video = previewDiv.querySelector('video');
                const source = video.querySelector('source');
                source.src = URL.createObjectURL(file);
                video.load();
                previewDiv.classList.remove('hidden');
                document.getElementById('btn_remove_project_video').classList.remove('hidden');
            }
        }
        
        function removeProjectImage() {
            document.getElementById('project_image').value = '';
            document.getElementById('project_image_preview').classList.add('hidden');
            document.getElementById('btn_remove_project_image').classList.add('hidden');
            const existingInput = document.getElementById('delete_project_image_flag');
            if (existingInput) existingInput.remove();
            const deleteFlag = document.createElement('input');
            deleteFlag.type = 'hidden';
            deleteFlag.id = 'delete_project_image_flag';
            deleteFlag.name = 'delete_image';
            deleteFlag.value = '1';
            document.getElementById('projectForm').appendChild(deleteFlag);
        }
        
        function removeProjectVideo() {
            document.getElementById('project_video').value = '';
            document.getElementById('project_video_preview').classList.add('hidden');
            document.getElementById('btn_remove_project_video').classList.add('hidden');
            const existingInput = document.getElementById('delete_project_video_flag');
            if (existingInput) existingInput.remove();
            const deleteFlag = document.createElement('input');
            deleteFlag.type = 'hidden';
            deleteFlag.id = 'delete_project_video_flag';
            deleteFlag.name = 'delete_video';
            deleteFlag.value = '1';
            document.getElementById('projectForm').appendChild(deleteFlag);
        }

        async function saveProject(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-spin mr-2">‚è≥</span> ƒêang l∆∞u...';
            
            try {
                const formData = new FormData(event.target);
                
                formData.append('id', document.getElementById('project_id').value);
                formData.append('display_order', document.getElementById('project_display_order').value);
                formData.append('is_active', document.getElementById('project_is_active').checked ? '1' : '0');
                
                // Add media gallery JSON
                if (window.projectMediaGallery) {
                    formData.append('media_gallery', window.projectMediaGallery.toJSON());
                }
                
                const response = await fetch(`${API_BASE}/admin/save_project.php`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }

                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeProjectModal();
                    loadProjects();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving project:', error);
                showToast('C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function deleteProject(id) {
            if (!await customConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ª± √°n n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_project.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadProjects();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a: ' + error.message, 'error');
            }
        }

        // =====================================================
        // DICH VU MANAGEMENT
        // =====================================================
        
        const availablePages = [
            { name: 'S·∫£n ph·∫©m', value: 'pricing.html' },
            { name: 'Li√™n h·ªá', value: 'lien-he.html' },
            { name: 'Gi·ªõi thi·ªáu', value: 'gioi-thieu.html' },
            { name: 'D·ª± √°n', value: 'du-an.html' },
            { name: 'Tin t·ª©c', value: 'tin-tuc.html' },
            { name: 'D·ªãch v·ª•', value: 'dich-vu.html' },
            { name: 'Kh·∫£o s√°t', value: 'khao-sat-dien-mat-troi.html' }
        ];

        async function loadDichVu() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_dich_vu.php?t=${Date.now()}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    displayDichVu(data.services || []);
                    
                    // Populate page select
                    const select = document.getElementById('dich_vu_link_page');
                    select.innerHTML = '<option value="">-- Ch·ªçn trang --</option>';
                    availablePages.forEach(page => {
                        const option = document.createElement('option');
                        option.value = page.value;
                        option.textContent = page.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading dich_vu:', error);
                showToast('L·ªói khi t·∫£i danh s√°ch d·ªãch v·ª•', 'error');
            }
        }
        
        function displayDichVu(services) {
            const tbody = document.getElementById('dich-vu-tbody-admin');
            tbody.innerHTML = '';
            
            services.forEach(service => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                const logoHtml = service.logo_url ? 
                    `<img src="${service.logo_url}" alt="${service.name}" class="h-12 w-12 object-cover rounded">` : 
                    '<span class="text-gray-400">N/A</span>';
                
                const statusHtml = service.is_active ? 
                    '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">‚úì ƒêang hi·ªÉn th·ªã</span>' : 
                    '<span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm">‚úó ·∫®n</span>';
                
                const linkHtml = service.link_type === 'custom' ? 
                    `<span class="text-blue-600">${service.link_name || service.link_value}</span>` :
                    `<span class="text-green-600">${service.link_name || service.link_value}</span>`;
                
                tr.innerHTML = `
                    <td class="px-4 py-3 font-bold text-center">${service.display_order}</td>
                    <td class="px-4 py-3">${logoHtml}</td>
                    <td class="px-4 py-3 font-semibold">${service.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 max-w-md">${(service.description || '').substring(0, 100)}...</td>
                    <td class="px-4 py-3">
                        <div class="inline-block w-8 h-8 rounded" style="background-color: ${service.highlight_color}"></div>
                    </td>
                    <td class="px-4 py-3">${linkHtml}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex gap-2 justify-center">
                            <button onclick="editDichVu(${service.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">‚úèÔ∏è S·ª≠a</button>
                            <button onclick="deleteDichVu(${service.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">üóëÔ∏è X√≥a</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openDichVuModal(id = null) {
            // Only open modal if id is null (new item)
            if (!id) {
                // Reset form for new item
                document.getElementById('dich_vu_id').value = '';
                document.getElementById('dich_vu_name').value = '';
                document.getElementById('dich_vu_description').value = '';
                document.getElementById('dich_vu_logo_url').value = '';
                document.getElementById('dich_vu_highlight_color').value = '#3FA34D';
                document.getElementById('dich_vu_link_name').value = '';
                document.getElementById('dich_vu_link_page').value = '';
                document.getElementById('dich_vu_link_custom').value = '';
                document.getElementById('dich_vu_display_order').value = '1';
                document.getElementById('dich_vu_is_active').checked = true;
                document.getElementById('dich_vu_logo').value = '';
                document.getElementById('dich_vu_logo_preview').classList.add('hidden');
                document.querySelector('input[name="dich_vu_link_type"][value="page"]').checked = true;
                document.getElementById('dich_vu_link_page_section').classList.remove('hidden');
                document.getElementById('dich_vu_link_custom_section').classList.add('hidden');
                document.getElementById('dichVuModalTitle').textContent = 'Th√™m d·ªãch v·ª•';
            }
            
            // Show modal
            document.getElementById('dichVuModal').classList.add('show');
        }
        
        function closeDichVuModal() {
            document.getElementById('dichVuModal').classList.remove('show');
        }
        
        function toggleLinkType() {
            const linkType = document.querySelector('input[name="dich_vu_link_type"]:checked').value;
            if (linkType === 'page') {
                document.getElementById('dich_vu_link_page_section').classList.remove('hidden');
                document.getElementById('dich_vu_link_custom_section').classList.add('hidden');
            } else {
                document.getElementById('dich_vu_link_page_section').classList.add('hidden');
                document.getElementById('dich_vu_link_custom_section').classList.remove('hidden');
            }
        }
        
        function previewDichVuLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById('dich_vu_logo_preview');
                    const img = previewDiv.querySelector('img');
                    img.src = e.target.result;
                    previewDiv.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function editDichVu(id) {
            // Set title for editing
            document.getElementById('dichVuModalTitle').textContent = 'S·ª≠a d·ªãch v·ª•';
            
            // Show modal first
            document.getElementById('dichVuModal').classList.add('show');
            
            // Load and populate data
            fetch(`${API_BASE}/admin/get_dich_vu.php?t=${Date.now()}`, {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const service = (data.services || []).find(s => s.id == id);
                if (service) {
                    document.getElementById('dich_vu_id').value = service.id;
                    document.getElementById('dich_vu_name').value = service.name || '';
                    document.getElementById('dich_vu_description').value = service.description || '';
                    document.getElementById('dich_vu_logo_url').value = service.logo_url || '';
                    document.getElementById('dich_vu_highlight_color').value = service.highlight_color || '#3FA34D';
                    document.getElementById('dich_vu_link_name').value = service.link_name || '';
                    document.getElementById('dich_vu_display_order').value = service.display_order || 1;
                    document.getElementById('dich_vu_is_active').checked = service.is_active == 1;
                    
                    // Set link type
                    const linkType = service.link_type || 'page';
                    document.querySelector(`input[name="dich_vu_link_type"][value="${linkType}"]`).checked = true;
                    toggleLinkType();
                    
                    if (linkType === 'page') {
                        document.getElementById('dich_vu_link_page').value = service.link_value || '';
                    } else {
                        document.getElementById('dich_vu_link_custom').value = service.link_value || '';
                    }
                    
                    // Show logo preview
                    if (service.logo_url) {
                        const previewDiv = document.getElementById('dich_vu_logo_preview');
                        const img = previewDiv.querySelector('img');
                        img.src = service.logo_url;
                        previewDiv.classList.remove('hidden');
                    }
                }
            })
            .catch(error => {
                console.error('Error loading dich_vu data:', error);
                showToast('L·ªói khi t·∫£i d·ªØ li·ªáu d·ªãch v·ª•', 'error');
            });
        }
        
        async function saveDichVu(event) {
            event.preventDefault();
            
            const id = document.getElementById('dich_vu_id').value;
            const name = document.getElementById('dich_vu_name').value;
            const description = document.getElementById('dich_vu_description').value;
            const highlightColor = document.getElementById('dich_vu_highlight_color').value;
            const linkName = document.getElementById('dich_vu_link_name').value;
            const linkType = document.querySelector('input[name="dich_vu_link_type"]:checked').value;
            const linkValue = linkType === 'page' ? 
                document.getElementById('dich_vu_link_page').value : 
                document.getElementById('dich_vu_link_custom').value;
            const displayOrder = document.getElementById('dich_vu_display_order').value;
            const isActive = document.getElementById('dich_vu_is_active').checked;
            
            const formData = {
                id: id || null,
                name,
                description,
                highlight_color: highlightColor,
                link_name: linkName,
                link_type: linkType,
                link_value: linkValue,
                display_order: displayOrder,
                is_active: isActive
            };
            
            // Handle logo upload
            const logoFile = document.getElementById('dich_vu_logo').files[0];
            let logoUrl = document.getElementById('dich_vu_logo_url').value;
            
            if (logoFile) {
                const formDataUpload = new FormData();
                formDataUpload.append('logo', logoFile);
                
                try {
                    const uploadRes = await fetch(`${API_BASE}/admin/upload_logo.php`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formDataUpload
                    });
                    const uploadData = await uploadRes.json();
                    if (uploadData.success) {
                        logoUrl = uploadData.logo_url;
                    } else {
                        showToast('L·ªói upload logo: ' + uploadData.message, 'error');
                        return;
                    }
                } catch (error) {
                    showToast('L·ªói upload logo: ' + error.message, 'error');
                    return;
                }
            }
            
            formData.logo_url = logoUrl;
            
            try {
                const response = await fetch(`${API_BASE}/admin/save_dich_vu.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeDichVuModal();
                    loadDichVu();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving dich_vu:', error);
                showToast('L·ªói khi l∆∞u d·ªãch v·ª•: ' + error.message, 'error');
            }
        }
        
        async function deleteDichVu(id) {
            if (!await customConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªãch v·ª• n√†y?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_dich_vu.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadDichVu();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting dich_vu:', error);
                showToast('L·ªói khi x√≥a d·ªãch v·ª•: ' + error.message, 'error');
            }
        }

        // =====================================================
        // USER MANAGEMENT
        // =====================================================
        
        let allUsersData = [];
        
        async function loadUsersManagement() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_all_users.php?t=${Date.now()}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    allUsersData = data.users || [];
                    displayUsers(allUsersData);
                } else {
                    showToast(data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch users', 'error');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('L·ªói khi t·∫£i danh s√°ch users', 'error');
            }
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('users-tbody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                let role;
                if (user.is_admin === 1 || user.is_admin === '1') {
                    role = '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold">üëë Full Admin</span>';
                } else if (user.permission_count > 0) {
                    role = `<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">‚öôÔ∏è Qu·∫£n tr·ªã (${user.permission_count} module)</span>`;
                } else {
                    role = '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">üë§ User</span>';
                }
                
                const createdDate = new Date(user.created_at).toLocaleDateString('vi-VN');
                
                return `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3">${user.id}</td>
                        <td class="px-4 py-3 font-semibold">${user.full_name}</td>
                        <td class="px-4 py-3">${user.username}</td>
                        <td class="px-4 py-3">${user.phone}</td>
                        <td class="px-4 py-3 text-center">${role}</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600">${createdDate}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editUser(${user.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mr-2">‚úèÔ∏è S·ª≠a</button>
                            <button onclick="deleteUser(${user.id})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function openUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const form = document.getElementById('userForm');
            form.reset();
            
            // Reset all permission checkboxes
            document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
            
            if (userId) {
                document.getElementById('userModalTitle').textContent = 'S·ª≠a ng∆∞·ªùi d√πng';
                document.getElementById('password-label-suffix').textContent = '';
                document.getElementById('user_password').removeAttribute('required');
                document.getElementById('user_password').placeholder = 'ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi m·∫≠t kh·∫©u';
                
                const user = allUsersData.find(u => u.id == userId);
                if (user) {
                    document.getElementById('user_id').value = user.id;
                    document.getElementById('user_full_name').value = user.full_name;
                    document.getElementById('user_username').value = user.username;
                    document.getElementById('user_phone').value = user.phone;
                    document.getElementById('user_is_admin').checked = user.is_admin == 1;
                    
                    toggleAdminPermissions();
                    
                    // Load permissions if not admin
                    if (user.is_admin != 1) {
                        loadUserPermissions(userId);
                    }
                }
            } else {
                document.getElementById('userModalTitle').textContent = 'Th√™m ng∆∞·ªùi d√πng';
                document.getElementById('password-label-suffix').textContent = '*';
                document.getElementById('user_password').setAttribute('required', 'required');
                document.getElementById('user_password').placeholder = 'Nh·∫≠p m·∫≠t kh·∫©u';
                document.getElementById('user_is_admin').checked = false;
                toggleAdminPermissions();
            }
            
            modal.classList.add('show');
        }
        
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }
        
        function toggleAdminPermissions() {
            const isAdmin = document.getElementById('user_is_admin').checked;
            const permissionsGrid = document.getElementById('permissions-grid');
            const permissionsSection = document.getElementById('permissions-section');
            const allCheckboxes = document.querySelectorAll('.permission-checkbox');
            
            if (isAdmin) {
                // Tick t·∫•t c·∫£ v√† disable
                allCheckboxes.forEach(cb => {
                    cb.checked = true;
                    cb.disabled = true;
                });
                permissionsGrid.style.opacity = '0.5';
                permissionsSection.querySelector('h4').innerHTML = 'üîê Ph√¢n quy·ªÅn module <span class="text-red-600">(FULL QUY·ªÄN - T·∫•t c·∫£ quy·ªÅn ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông c·∫•p)</span>';
            } else {
                // Enable l·∫°i, kh√¥ng t·ª± ƒë·ªông untick (gi·ªØ nguy√™n tr·∫°ng th√°i)
                allCheckboxes.forEach(cb => {
                    cb.disabled = false;
                });
                permissionsGrid.style.opacity = '1';
                permissionsSection.querySelector('h4').textContent = 'üîê Ph√¢n quy·ªÅn module (Ch·ªçn quy·ªÅn c·ª• th·ªÉ cho user)';
            }
        }
        
        async function loadUserPermissions(userId) {
            try {
                const response = await fetch(`${API_BASE}/admin/get_user_permissions.php?user_id=${userId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.permissions) {
                    data.permissions.forEach(perm => {
                        if (perm.can_view) {
                            const cb = document.querySelector(`.permission-checkbox[data-module="${perm.permission_key}"][data-action="view"]`);
                            if (cb) cb.checked = true;
                        }
                        if (perm.can_create) {
                            const cb = document.querySelector(`.permission-checkbox[data-module="${perm.permission_key}"][data-action="create"]`);
                            if (cb) cb.checked = true;
                        }
                        if (perm.can_edit) {
                            const cb = document.querySelector(`.permission-checkbox[data-module="${perm.permission_key}"][data-action="edit"]`);
                            if (cb) cb.checked = true;
                        }
                        if (perm.can_delete) {
                            const cb = document.querySelector(`.permission-checkbox[data-module="${perm.permission_key}"][data-action="delete"]`);
                            if (cb) cb.checked = true;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading user permissions:', error);
            }
        }
        
        async function saveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('user_id').value;
            const fullName = document.getElementById('user_full_name').value;
            const username = document.getElementById('user_username').value;
            const phone = document.getElementById('user_phone').value;
            const password = document.getElementById('user_password').value;
            const isAdmin = document.getElementById('user_is_admin').checked;
            
            // Validate password for new user
            if (!userId && (!password || password.length < 6)) {
                showToast('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
                return;
            }
            
            // Collect permissions
            const permissions = {};
            if (!isAdmin) {
                const modules = ['categories', 'products', 'survey', 'packages', 'orders', 'tickets', 'rewards', 'intro-posts', 'projects', 'dich-vu', 'home', 'contacts'];
                modules.forEach(module => {
                    permissions[module] = {
                        can_view: document.querySelector(`.permission-checkbox[data-module="${module}"][data-action="view"]`)?.checked || false,
                        can_create: document.querySelector(`.permission-checkbox[data-module="${module}"][data-action="create"]`)?.checked || false,
                        can_edit: document.querySelector(`.permission-checkbox[data-module="${module}"][data-action="edit"]`)?.checked || false,
                        can_delete: document.querySelector(`.permission-checkbox[data-module="${module}"][data-action="delete"]`)?.checked || false
                    };
                });
            }
            
            const userData = {
                id: userId || null,
                full_name: fullName,
                username: username,
                phone: phone,
                password: password || null,
                is_admin: isAdmin,
                permissions: permissions
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/save_user.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeUserModal();
                    loadUsersManagement();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showToast('L·ªói khi l∆∞u user: ' + error.message, 'error');
            }
        }
        
        function editUser(userId) {
            openUserModal(userId);
        }
        
        async function deleteUser(userId) {
            if (!await customConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y? T·∫•t c·∫£ d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã x√≥a.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/delete_user.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: userId })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadUsersManagement();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('L·ªói khi x√≥a user: ' + error.message, 'error');
            }
        }
    </script>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" class="modal" style="display: none;">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-800" id="customConfirmTitle">X√°c nh·∫≠n</h3>
            </div>
            <p class="text-gray-700 text-lg mb-8" id="customConfirmMessage"></p>
            <div class="flex gap-3">
                <button id="customConfirmCancel" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    H·ªßy
                </button>
                <button id="customConfirmOk" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 right-4 z-[9999] space-y-3"></div>

    <!-- Custom Confirm Function -->
    <script>
        // Global function for custom confirm
        async function customConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const messageEl = document.getElementById('customConfirmMessage');
                const titleEl = document.getElementById('customConfirmTitle');
                const cancelBtn = document.getElementById('customConfirmCancel');
                const okBtn = document.getElementById('customConfirmOk');
                
                messageEl.textContent = message;
                
                // Show modal
                modal.classList.add('show');
                modal.style.display = 'flex';
                
                const cleanup = () => {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                };
                
                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                okBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
            });
        }
    </script>

    <!-- Home Posts Management Functions -->
    <script>
        // ==================== HOME POSTS MODULE ====================
        
        // Load home posts
        async function loadHomePosts() {
            try {
                const response = await fetch('../api/admin/get_home_posts.php');
                const data = await response.json();
                
                if (data.success) {
                    displayHomePosts(data.posts);
                } else {
                    showToast(data.message || 'L·ªói khi t·∫£i b√†i ƒëƒÉng', 'error');
                }
            } catch (error) {
                showToast('L·ªói khi t·∫£i b√†i ƒëƒÉng: ' + error.message, 'error');
            }
        }
        
        // Display home posts in table
        function displayHomePosts(posts) {
            const tbody = document.getElementById('home-posts-tbody');
            tbody.innerHTML = '';
            
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</td></tr>';
                return;
            }
            
            posts.forEach(post => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const positionEmoji = post.image_position === 'left' ? '‚¨ÖÔ∏è' : '‚û°Ô∏è';
                const statusBadge = post.is_active 
                    ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Hi·ªÉn th·ªã</span>'
                    : '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">·∫®n</span>';
                
                // Create color swatch for highlight
                const highlightDisplay = post.highlight_text 
                    ? `<div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded border" style="background-color: ${post.highlight_color}"></div>
                        <span class="text-xs">${post.highlight_text}</span>
                       </div>`
                    : '-';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-center">${post.display_order}</td>
                    <td class="px-4 py-3">
                        <img src="${post.image_url}" alt="${post.title}" class="h-16 w-24 object-cover rounded-lg">
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-semibold">${post.title}</div>
                        <div class="text-sm text-gray-500">${post.description.substring(0, 60)}...</div>
                    </td>
                    <td class="px-4 py-3">
                        ${highlightDisplay}
                    </td>
                    <td class="px-4 py-3 text-center">${positionEmoji} ${post.image_position === 'left' ? 'Tr√°i' : 'Ph·∫£i'}</td>
                    <td class="px-4 py-3 text-center">${post.section_id}</td>
                    <td class="px-4 py-3 text-center">${statusBadge}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="openHomePostModal(${post.id})" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è S·ª≠a</button>
                        <button onclick="deleteHomePost(${post.id})" class="text-red-600 hover:text-red-800">üóëÔ∏è X√≥a</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Open modal to add/edit home post
        function openHomePostModal(postId = null) {
            const modal = document.getElementById('homePostModal');
            const form = document.getElementById('homePostForm');
            form.reset();
            
            // Reset hidden fields
            document.getElementById('home_post_id').value = '';
            document.getElementById('home_post_image_url').value = '';
            document.getElementById('home_post_image_preview').classList.add('hidden');
            
            // Reset URL input (show select, hide custom)
            document.getElementById('home_post_button_url').classList.remove('hidden');
            document.getElementById('home_post_button_url_custom').classList.add('hidden');
            document.getElementById('home_post_button_url_custom').value = '';
            
            // Reset feature inputs to default 3
            const container = document.getElementById('home_post_features_container');
            container.innerHTML = `
                <div class="space-y-2" id="features-list">
                    <div class="flex gap-2 feature-item">
                        <input type="text" placeholder="Feature 1" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                        <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                    </div>
                    <div class="flex gap-2 feature-item">
                        <input type="text" placeholder="Feature 2" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                        <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                    </div>
                    <div class="flex gap-2 feature-item">
                        <input type="text" placeholder="Feature 3" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                        <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                    </div>
                </div>
                <button type="button" onclick="addFeature()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    ‚ûï Th√™m feature
                </button>
            `;
            
            if (postId) {
                // Edit mode
                document.getElementById('homePostModalTitle').textContent = 'S·ª≠a b√†i ƒëƒÉng trang ch·ªß';
                loadHomePostData(postId);
            } else {
                // Add mode
                document.getElementById('homePostModalTitle').textContent = 'Th√™m b√†i ƒëƒÉng trang ch·ªß';
                document.getElementById('home_post_is_active').checked = true;
                document.getElementById('home_post_highlight_color').value = '#3FA34D'; // Green default
                document.getElementById('home_post_button_color').value = '#3FA34D'; // Green default
                document.getElementById('home_post_image_position').value = 'right';
                document.getElementById('home_post_section_id').value = 'solutions';
                document.getElementById('home_post_display_order').value = '0';
            }
            
            // Initialize Media Gallery
            if (!window.homePostMediaGallery) {
                window.homePostMediaGallery = initMediaGallery(
                    'home_post_media_gallery_container',
                    API_BASE + '/admin/upload_home_media.php'
                );
            } else {
                // Reset if adding new post
                if (!postId) {
                    window.homePostMediaGallery.loadFromJSON('[]');
                }
            }
            
            modal.classList.add('show');
        }
        
        // Load home post data for editing
        async function loadHomePostData(postId) {
            try {
                const response = await fetch('../api/admin/get_home_posts.php');
                const data = await response.json();
                
                if (data.success) {
                    const post = data.posts.find(p => p.id == postId);
                    if (post) {
                        document.getElementById('home_post_id').value = post.id;
                        document.getElementById('home_post_title').value = post.title;
                        document.getElementById('home_post_description').value = post.description;
                        document.getElementById('home_post_highlight_text').value = post.highlight_text || '';
                        document.getElementById('home_post_highlight_color').value = post.highlight_color || '#3FA34D';
                        document.getElementById('home_post_image_url').value = post.image_url;
                        document.getElementById('home_post_image_position').value = post.image_position;
                        document.getElementById('home_post_button_text').value = post.button_text || '';
                        
                        // Set button URL (check if it's in dropdown or custom)
                        const selectEl = document.getElementById('home_post_button_url');
                        const customInputEl = document.getElementById('home_post_button_url_custom');
                        const buttonUrl = post.button_url || '';
                        
                        // Try to find in select options
                        const matchingOption = Array.from(selectEl.options).find(opt => opt.value === buttonUrl);
                        if (matchingOption) {
                            // URL exists in dropdown
                            selectEl.value = buttonUrl;
                            customInputEl.classList.add('hidden');
                            selectEl.classList.remove('hidden');
                        } else if (buttonUrl) {
                            // Custom URL not in dropdown
                            customInputEl.value = buttonUrl;
                            selectEl.classList.add('hidden');
                            customInputEl.classList.remove('hidden');
                        } else {
                            // No URL
                            selectEl.value = '';
                            customInputEl.classList.add('hidden');
                            selectEl.classList.remove('hidden');
                        }
                        
                        document.getElementById('home_post_button_color').value = post.button_color || '#3FA34D';
                        document.getElementById('home_post_display_order').value = post.display_order;
                        document.getElementById('home_post_is_active').checked = post.is_active;
                        document.getElementById('home_post_section_id').value = post.section_id || 'solutions';
                        
                        // Show current image
                        const preview = document.getElementById('home_post_image_preview');
                        preview.querySelector('img').src = post.image_url;
                        preview.classList.remove('hidden');
                        
                        // Load features
                        if (post.features && post.features.length > 0) {
                            const container = document.getElementById('home_post_features_container');
                            container.innerHTML = `
                                <div class="space-y-2" id="features-list">
                                    ${post.features.map(f => `
                                        <div class="flex gap-2 feature-item">
                                            <input type="text" value="${f.text}" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                                            <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <button type="button" onclick="addFeature()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    ‚ûï Th√™m feature
                                </button>
                            `;
                        }
                        
                        // Load media gallery
                        if (window.homePostMediaGallery) {
                            if (post.media_gallery) {
                                window.homePostMediaGallery.loadFromJSON(post.media_gallery);
                            } else {
                                window.homePostMediaGallery.loadFromJSON('[]');
                            }
                        }
                    }
                }
            } catch (error) {
                showToast('L·ªói khi t·∫£i th√¥ng tin b√†i ƒëƒÉng: ' + error.message, 'error');
            }
        }
        
        // Close modal
        function closeHomePostModal() {
            document.getElementById('homePostModal').classList.remove('show');
        }
        
        // Preview image
        function previewHomePostImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('home_post_image_preview');
                    preview.querySelector('img').src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Add feature
        function addFeature() {
            const list = document.querySelector('#home_post_features_container #features-list') || 
                         document.querySelector('#home_post_features_container .space-y-2');
            if (!list) return;
            
            const featureDiv = document.createElement('div');
            featureDiv.className = 'flex gap-2 feature-item';
            featureDiv.innerHTML = `
                <input type="text" placeholder="Feature m·ªõi" class="flex-1 px-4 py-2 border rounded-lg feature-text">
                <button type="button" onclick="removeFeature(this)" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üóëÔ∏è</button>
            `;
            list.appendChild(featureDiv);
        }
        
        // Remove feature
        function removeFeature(button) {
            button.closest('.feature-item').remove();
        }
        
        // Toggle between select and custom URL input
        function toggleCustomUrlInput() {
            const selectEl = document.getElementById('home_post_button_url');
            const customInputEl = document.getElementById('home_post_button_url_custom');
            
            if (customInputEl.classList.contains('hidden')) {
                // Switch to custom input
                customInputEl.classList.remove('hidden');
                selectEl.classList.add('hidden');
                // Transfer value if exists
                if (selectEl.value && !customInputEl.value) {
                    customInputEl.value = selectEl.value;
                }
                customInputEl.focus();
            } else {
                // Switch back to select
                customInputEl.classList.add('hidden');
                selectEl.classList.remove('hidden');
                // Try to match custom value with select options
                const customValue = customInputEl.value;
                const matchingOption = Array.from(selectEl.options).find(opt => opt.value === customValue);
                if (matchingOption) {
                    selectEl.value = customValue;
                }
            }
        }
        
        // Save home post
        async function saveHomePost(event) {
            event.preventDefault();
            
            const postId = document.getElementById('home_post_id').value;
            let imageUrl = document.getElementById('home_post_image_url').value;
            const imageFile = document.getElementById('home_post_image').files[0];
            
            // Upload image if new file selected
            if (imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);
                
                try {
                    const uploadResponse = await fetch('../api/admin/upload_home_image.php', {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadResponse.json();
                    
                    if (uploadData.success) {
                        imageUrl = uploadData.path;
                    } else {
                        showToast(uploadData.message || 'L·ªói khi upload ·∫£nh', 'error');
                        return;
                    }
                } catch (error) {
                    showToast('L·ªói khi upload ·∫£nh: ' + error.message, 'error');
                    return;
                }
            }
            
            // Check if image exists
            if (!imageUrl) {
                showToast('Vui l√≤ng ch·ªçn ·∫£nh cho b√†i ƒëƒÉng', 'error');
                return;
            }
            
            // Get button URL (from select or custom input)
            const selectEl = document.getElementById('home_post_button_url');
            const customInputEl = document.getElementById('home_post_button_url_custom');
            let buttonUrl = '';
            
            if (customInputEl.classList.contains('hidden')) {
                // Using select dropdown
                buttonUrl = selectEl.value;
            } else {
                // Using custom input
                buttonUrl = customInputEl.value;
            }
            
            // Collect features
            const features = [];
            document.querySelectorAll('.feature-text').forEach(input => {
                if (input.value.trim()) {
                    features.push({ text: input.value.trim() });
                }
            });
            
            // Prepare data
            const postData = {
                id: postId ? parseInt(postId) : 0,
                title: document.getElementById('home_post_title').value,
                description: document.getElementById('home_post_description').value,
                highlight_text: document.getElementById('home_post_highlight_text').value,
                highlight_color: document.getElementById('home_post_highlight_color').value,
                image_url: imageUrl,
                image_position: document.getElementById('home_post_image_position').value,
                button_text: document.getElementById('home_post_button_text').value,
                button_url: buttonUrl,
                button_color: document.getElementById('home_post_button_color').value,
                features: features,
                display_order: parseInt(document.getElementById('home_post_display_order').value),
                is_active: document.getElementById('home_post_is_active').checked,
                section_id: document.getElementById('home_post_section_id').value,
                media_gallery: window.homePostMediaGallery ? window.homePostMediaGallery.toJSON() : '[]'
            };
            
            try {
                const response = await fetch('../api/admin/save_home_post.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    closeHomePostModal();
                    loadHomePosts();
                } else {
                    showToast(data.message || 'L·ªói khi l∆∞u b√†i ƒëƒÉng', 'error');
                }
            } catch (error) {
                showToast('L·ªói khi l∆∞u b√†i ƒëƒÉng: ' + error.message, 'error');
            }
        }
        
        // Delete home post
        async function deleteHomePost(postId) {
            const confirmed = await customConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i ƒëƒÉng n√†y?');
            if (!confirmed) return;
            
            try {
                const response = await fetch('../api/admin/delete_home_post.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: postId })
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadHomePosts();
                } else {
                    showToast(data.message || 'L·ªói khi x√≥a b√†i ƒëƒÉng', 'error');
                }
            } catch (error) {
                showToast('L·ªói khi x√≥a b√†i ƒëƒÉng: ' + error.message, 'error');
            }
        }

        // ============================================================
        // CONTACTS MANAGEMENT
        // ============================================================
        
        // Category metadata - icons and button texts
        const contactCategoryMeta = {
            phone: { icon: 'üìû', buttonText: 'G·ªçi Ngay', urlPrefix: 'tel:' },
            zalo: { icon: 'üí¨', buttonText: 'Chat Zalo', urlPrefix: 'https://zalo.me/' },
            email: { icon: '‚úâÔ∏è', buttonText: 'G·ª≠i Email', urlPrefix: 'mailto:' },
            facebook: { icon: 'üìò', buttonText: 'Theo D√µi Facebook', urlPrefix: '' },
            tiktok: { icon: 'üéµ', buttonText: 'Theo D√µi TikTok', urlPrefix: '' },
            youtube: { icon: 'üì∫', buttonText: 'Xem K√™nh YouTube', urlPrefix: '' },
            website: { icon: 'üåê', buttonText: 'Truy C·∫≠p Website', urlPrefix: '' }
        };
        
        // Store contacts data globally for editing
        let contactsData = [];
        
        async function loadContacts() {
            try {
                const response = await fetch('../api/admin/get_contact_channels.php');
                const data = await response.json();
                
                if (data.success) {
                    contactsData = data.channels; // Store globally
                    renderContactsTable(data.channels);
                } else {
                    // Only show error if it's not a permission issue (permission should be checked before loading)
                    if (data.message && !data.message.includes('quy·ªÅn') && !data.message.includes('Unauthorized')) {
                    showToast(data.message || 'L·ªói khi t·∫£i danh s√°ch k√™nh li√™n h·ªá', 'error');
                    }
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                // Only show error if it's not a permission issue
                if (!error.message.includes('quy·ªÅn') && !error.message.includes('Unauthorized')) {
                showToast('L·ªói khi t·∫£i danh s√°ch k√™nh li√™n h·ªá: ' + error.message, 'error');
                }
            }
        }
        
        function renderContactsTable(channels) {
            const tbody = document.getElementById('contacts-table-body');
            
            if (!channels || channels.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Ch∆∞a c√≥ k√™nh li√™n h·ªá n√†o</td></tr>';
                return;
            }
            
            tbody.innerHTML = channels.map(channel => {
                const categoryMeta = contactCategoryMeta[channel.category] || { icon: 'üì¶', buttonText: 'M·ªü' };
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 border">${channel.id}</td>
                        <td class="px-4 py-2 border font-semibold">${escapeHtml(channel.name)}</td>
                        <td class="px-4 py-2 border text-sm text-gray-600">${escapeHtml(channel.description || '')}</td>
                        <td class="px-4 py-2 border text-sm">${escapeHtml(channel.content)}</td>
                        <td class="px-4 py-2 border">
                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded text-sm">
                                ${categoryMeta.icon} ${channel.category}
                            </span>
                        </td>
                        <td class="px-4 py-2 border">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded border" style="background-color: ${channel.color}"></div>
                                <span class="text-xs font-mono">${channel.color}</span>
                            </div>
                        </td>
                        <td class="px-4 py-2 border text-center">${channel.display_order}</td>
                        <td class="px-4 py-2 border text-center">
                            <span class="px-2 py-1 rounded text-xs ${channel.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                ${channel.is_active ? '‚úì Hi·ªÉn th·ªã' : '‚úó ·∫®n'}
                            </span>
                        </td>
                        <td class="px-4 py-2 border text-center">
                            <button onclick="editContact(${channel.id})" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button>
                            <button onclick="deleteContact(${channel.id})" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function openContactModal() {
            document.getElementById('contactModalTitle').textContent = 'Th√™m k√™nh li√™n h·ªá';
            document.getElementById('contactForm').reset();
            document.getElementById('contact_id').value = '';
            document.getElementById('contact_color').value = '#16a34a';
            document.getElementById('contact_color_display').textContent = '#16a34a';
            document.getElementById('contact_is_active').checked = true;
            document.getElementById('category_hint').textContent = 'Ch·ªçn danh m·ª•c ƒë·ªÉ xem icon v√† button text t·ª± ƒë·ªông';
            document.getElementById('contactModal').classList.add('active');
        }
        
        function editContact(id) {
            // Find channel from stored data
            const channel = contactsData.find(c => c.id === id);
            if (!channel) {
                showToast('Kh√¥ng t√¨m th·∫•y k√™nh li√™n h·ªá', 'error');
                return;
            }
            
            document.getElementById('contactModalTitle').textContent = 'S·ª≠a k√™nh li√™n h·ªá';
            document.getElementById('contact_id').value = channel.id;
            document.getElementById('contact_name').value = channel.name;
            document.getElementById('contact_description').value = channel.description || '';
            document.getElementById('contact_content').value = channel.content;
            document.getElementById('contact_category').value = channel.category;
            document.getElementById('contact_color').value = channel.color;
            document.getElementById('contact_color_display').textContent = channel.color;
            document.getElementById('contact_display_order').value = channel.display_order;
            document.getElementById('contact_is_active').checked = channel.is_active;
            updateContactPreview();
            document.getElementById('contactModal').classList.add('active');
        }
        
        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
        }
        
        function updateContactPreview() {
            const category = document.getElementById('contact_category').value;
            const categoryHint = document.getElementById('category_hint');
            const contentHint = document.getElementById('content_hint');
            
            if (category && contactCategoryMeta[category]) {
                const meta = contactCategoryMeta[category];
                categoryHint.innerHTML = `<strong>${meta.icon} Icon t·ª± ƒë·ªông</strong> ‚Ä¢ Button: "<em>${meta.buttonText}</em>"`;
                
                // Update content hint based on category
                if (category === 'phone') {
                    contentHint.textContent = 'Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i (VD: 0969397434)';
                } else if (category === 'zalo') {
                    contentHint.textContent = 'Nh·∫≠p s·ªë Zalo (VD: 0969397434)';
                } else if (category === 'email') {
                    contentHint.textContent = 'Nh·∫≠p ƒë·ªãa ch·ªâ email (VD: contact@example.com)';
                } else if (category === 'tiktok') {
                    contentHint.textContent = 'Nh·∫≠p username TikTok (VD: @username ho·∫∑c link ƒë·∫ßy ƒë·ªß)';
                } else {
                    contentHint.textContent = 'Nh·∫≠p link ƒë·∫ßy ƒë·ªß (VD: https://...)';
                }
            } else {
                categoryHint.textContent = 'Ch·ªçn danh m·ª•c ƒë·ªÉ xem icon v√† button text t·ª± ƒë·ªông';
                contentHint.textContent = 'Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i, email, link ho·∫∑c username';
            }
        }
        
        // Update color display when color picker changes
        document.getElementById('contact_color')?.addEventListener('input', function() {
            document.getElementById('contact_color_display').textContent = this.value;
        });
        
        async function saveContact(event) {
            event.preventDefault();
            
            const id = document.getElementById('contact_id').value;
            const formData = new FormData();
            
            if (id) formData.append('id', id);
            formData.append('name', document.getElementById('contact_name').value);
            formData.append('description', document.getElementById('contact_description').value);
            formData.append('content', document.getElementById('contact_content').value);
            formData.append('category', document.getElementById('contact_category').value);
            formData.append('color', document.getElementById('contact_color').value);
            formData.append('display_order', document.getElementById('contact_display_order').value);
            formData.append('is_active', document.getElementById('contact_is_active').checked ? 1 : 0);
            
            try {
                const response = await fetch('../api/admin/save_contact_channel.php', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    closeContactModal();
                    loadContacts();
                } else {
                    showToast(data.message || 'L·ªói khi l∆∞u k√™nh li√™n h·ªá', 'error');
                }
            } catch (error) {
                showToast('L·ªói khi l∆∞u k√™nh li√™n h·ªá: ' + error.message, 'error');
            }
        }
        
        async function deleteContact(id) {
            const confirmed = await customConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k√™nh li√™n h·ªá n√†y?');
            if (!confirmed) return;
            
            try {
                const formData = new FormData();
                formData.append('id', id);
                
                const response = await fetch('../api/admin/delete_contact_channel.php', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadContacts();
                } else {
                    showToast(data.message || 'L·ªói khi x√≥a k√™nh li√™n h·ªá', 'error');
                }
            } catch (error) {
                showToast('L·ªói khi x√≥a k√™nh li√™n h·ªá: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // ORDERS MANAGEMENT
        // ========================================
        
        async function loadOrders() {
            try {
                const status = document.getElementById('order-status-filter').value;
                const url = `${API_BASE}/admin/get_orders.php${status ? '?status=' + status : ''}`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load orders');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    renderOrders(data.orders);
                } else {
                    showToast(data.message || 'Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng', 'error');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('L·ªói khi t·∫£i ƒë∆°n h√†ng', 'error');
            }
        }
        
        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-xl mb-2">üì¶</p>
                        <p>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const statusBadge = getOrderStatusBadge(order.order_status);
                const date = new Date(order.created_at).toLocaleDateString('vi-VN');
                const totalAmount = Math.round(order.total_amount).toLocaleString('vi-VN');
                
                // Render vouchers list
                let vouchersHtml = '';
                if (order.vouchers && order.vouchers.length > 0) {
                    vouchersHtml = `
                        <div class="mt-2">
                            <span class="text-sm text-gray-600 font-semibold">Vouchers (${order.vouchers.length}):</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${order.vouchers.map(v => `
                                    <span class="inline-block px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">
                                        ${v.voucher_code} (-${Math.round(v.discount_amount).toLocaleString('vi-VN')}‚Ç´)
                                    </span>
                                `).join('')}
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                <strong>T·ªïng gi·∫£m gi√°:</strong> <span class="text-green-600 font-semibold">-${Math.round(order.discount_amount || 0).toLocaleString('vi-VN')}‚Ç´</span>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="border rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg">ƒê∆°n h√†ng #${order.id}</h3>
                                <p class="text-sm text-gray-600">Kh√°ch h√†ng: ${order.full_name}</p>
                                <p class="text-sm text-gray-600">SƒêT: ${order.phone}</p>
                                <p class="text-sm text-gray-600">Ng√†y ƒë·∫∑t: ${date}</p>
                            </div>
                            <div class="text-right">
                                ${statusBadge}
                                <p class="text-xl font-bold text-purple-600 mt-2">${totalAmount}‚Ç´</p>
                            </div>
                        </div>
                        
                        ${vouchersHtml}
                        
                        <div class="border-t pt-3 mt-3">
                            <p class="text-sm text-gray-600 mb-2"><strong>S·∫£n ph·∫©m (${order.items ? order.items.length : 0}):</strong></p>
                            <div class="space-y-1">
                                ${order.items && order.items.length > 0 ? order.items.map(item => `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-700">${item.product_name} (x${item.quantity})</span>
                                        <span class="font-semibold">${Math.round(item.price * item.quantity).toLocaleString('vi-VN')}‚Ç´</span>
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-sm">Kh√¥ng c√≥ s·∫£n ph·∫©m</p>'}
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            ${order.order_status === 'pending' ? `
                                <button onclick="approveOrder(${order.id})" class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                    ‚úÖ Duy·ªát ƒë∆°n
                                </button>
                            ` : ''}
                            <button onclick="viewOrderDetail(${order.id})" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                üëÅÔ∏è Chi ti·∫øt
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getOrderStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'Ch·ªù x·ª≠ l√Ω', color: 'bg-yellow-100 text-yellow-800' },
                'approved': { text: 'ƒê√£ duy·ªát', color: 'bg-blue-100 text-blue-800' },
                'processing': { text: 'ƒêang x·ª≠ l√Ω', color: 'bg-purple-100 text-purple-800' },
                'shipping': { text: 'ƒêang giao', color: 'bg-cyan-100 text-cyan-800' },
                'shipped': { text: 'ƒê√£ giao', color: 'bg-indigo-100 text-indigo-800' },
                'delivered': { text: 'ƒê√£ nh·∫≠n', color: 'bg-green-100 text-green-800' },
                'cancelled': { text: 'ƒê√£ h·ªßy', color: 'bg-red-100 text-red-800' }
            };
            
            const info = statusMap[status] || { text: 'Kh√¥ng r√µ', color: 'bg-gray-100 text-gray-800' };
            return `<span class="px-3 py-1 rounded-full text-sm font-semibold ${info.color}">${info.text}</span>`;
        }
        
        async function approveOrder(orderId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát ƒë∆°n h√†ng n√†y?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/approve_order.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ order_id: orderId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c duy·ªát!', 'success');
                    loadOrders();
                } else {
                    showToast(data.message || 'Kh√¥ng th·ªÉ duy·ªát ƒë∆°n h√†ng', 'error');
                }
            } catch (error) {
                console.error('Error approving order:', error);
                showToast('L·ªói khi duy·ªát ƒë∆°n h√†ng', 'error');
            }
        }
        
        function viewOrderDetail(orderId) {
            window.open(`order_detail.html?id=${orderId}`, '_blank');
        }
    </script>
</body>
</html>

